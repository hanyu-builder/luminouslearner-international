<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Free Radical Substitution Animator</title>
    
    <!-- React & Tailwind -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Framer Motion -->
    <script src="https://unpkg.com/framer-motion@10.12.16/dist/framer-motion.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0F172A; color: #e2e8f0; margin: 0; overflow: hidden; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        
        /* UV Light Effect */
        .uv-flash {
            animation: flash 0.5s ease-in-out;
        }
        @keyframes flash {
            0% { opacity: 0; background-color: rgba(168, 85, 247, 0); }
            50% { opacity: 0.8; background-color: rgba(168, 85, 247, 0.5); }
            100% { opacity: 0; background-color: rgba(168, 85, 247, 0); }
        }

        /* Electron Dot Animation */
        .radical-dot {
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0% { r: 3; opacity: 0.8; }
            50% { r: 5; opacity: 1; }
            100% { r: 3; opacity: 0.8; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const { motion, AnimatePresence } = window.Motion;

        // --- Keep Original Icon Component Structure ---
        const Icon = ({ name, className = "", size = 20 }) => {
            const [svgHtml, setSvgHtml] = useState('');
            useEffect(() => {
                if (window.lucide && window.lucide.icons) {
                    const pascalName = name.split('-').map(part => part.charAt(0).toUpperCase() + part.slice(1)).join('');
                    const iconData = window.lucide.icons[pascalName];
                    if (iconData && typeof window.lucide.createElement === 'function') {
                        const svgElement = window.lucide.createElement(iconData);
                        svgElement.setAttribute('class', className);
                        svgElement.setAttribute('width', size);
                        svgElement.setAttribute('height', size);
                        setSvgHtml(svgElement.outerHTML);
                    }
                }
            }, [name, className, size]);
            if (!svgHtml) return <span className={className} style={{ width: size, height: size, display: 'inline-block' }}></span>;
            return <span dangerouslySetInnerHTML={{ __html: svgHtml }} className="flex items-center justify-center" />;
        };

        // --- ATOM COMPONENTS ---
        const Atom = ({ type, x, y, hasRadical }) => {
            const colors = {
                C: 'bg-slate-700 border-slate-500',
                H: 'bg-white border-slate-300',
                Cl: 'bg-green-500 border-green-400'
            };
            const sizes = { C: 40, H: 24, Cl: 36 };
            
            return (
                <div 
                    className={`absolute rounded-full flex items-center justify-center border-2 shadow-lg ${colors[type]}`}
                    style={{ width: sizes[type], height: sizes[type], left: x, top: y, transform: 'translate(-50%, -50%)' }}
                >
                    <span className={`text-xs font-bold ${type === 'H' ? 'text-slate-800' : 'text-white'}`}>{type}</span>
                    {hasRadical && (
                        <div className="absolute -top-1 -right-1 w-2 h-2 bg-yellow-400 rounded-full shadow-[0_0_8px_rgba(250,204,21,0.8)] animate-pulse"></div>
                    )}
                </div>
            );
        };

        const Bond = ({ x1, y1, x2, y2, isBreaking }) => {
            const length = Math.sqrt(Math.pow(x2-x1, 2) + Math.pow(y2-y1, 2));
            const angle = Math.atan2(y2-y1, x2-x1) * 180 / Math.PI;
            
            return (
                <div 
                    className={`absolute h-1.5 bg-slate-400 origin-left transition-opacity duration-500 ${isBreaking ? 'opacity-0' : 'opacity-100'}`}
                    style={{ 
                        left: x1, top: y1, width: length, transform: `rotate(${angle}deg)`,
                        boxShadow: '0 0 2px rgba(0,0,0,0.5)' 
                    }}
                ></div>
            );
        };

        // --- STAGE DATA (Translated) ---
        const STAGES = [
            { id: 'init', title: '1. Initiation', eq: 'Cl-Cl --UV--> 2Cl•', desc: 'UV light provides energy to break the Cl-Cl bond homolytically.' },
            { id: 'prop1', title: '2a. Propagation (Step 1)', eq: 'CH₄ + Cl• --> CH₃• + HCl', desc: 'Chlorine radical attacks Methane, stealing a Hydrogen atom.' },
            { id: 'prop2', title: '2b. Propagation (Step 2)', eq: 'CH₃• + Cl₂ --> CH₃Cl + Cl•', desc: 'Methyl radical attacks Chlorine molecule, regenerating Cl radical.' },
            { id: 'term', title: '3. Termination', eq: 'Cl• + Cl• --> Cl₂', desc: 'Two radicals collide and combine, ending the chain reaction.' }
        ];

        // --- MAIN APP ---
        const App = () => {
            const [stageIdx, setStageIdx] = useState(0);
            const [progress, setProgress] = useState(0); // 0 to 100
            const [isPlaying, setIsPlaying] = useState(false);
            const [uvFlash, setUvFlash] = useState(false);

            const currentStage = STAGES[stageIdx];

            // Animation Loop
            useEffect(() => {
                let interval;
                if (isPlaying) {
                    interval = setInterval(() => {
                        setProgress(p => {
                            if (p >= 100) {
                                setIsPlaying(false);
                                return 100;
                            }
                            // Trigger UV flash at start of init
                            if (stageIdx === 0 && p === 10) setUvFlash(true);
                            if (stageIdx === 0 && p === 20) setUvFlash(false);
                            
                            return p + 1;
                        });
                    }, 30);
                }
                return () => clearInterval(interval);
            }, [isPlaying, stageIdx]);

            const handleNext = () => {
                if (stageIdx < STAGES.length - 1) {
                    setStageIdx(s => s + 1);
                    reset();
                }
            };

            const handlePrev = () => {
                if (stageIdx > 0) {
                    setStageIdx(s => s - 1);
                    reset();
                }
            };

            const reset = () => {
                setProgress(0);
                setIsPlaying(false);
                setUvFlash(false);
            };

            const play = () => {
                if (progress >= 100) setProgress(0);
                setIsPlaying(true);
            };

            // --- RENDER SCENE BASED ON STAGE ---
            const renderScene = () => {
                const p = progress / 100;
                
                // Coordinates
                const center = { x: 400, y: 250 };

                if (stageIdx === 0) { // Initiation: Cl-Cl -> 2 Cl.
                    // Start: Bonded. End: Separated.
                    const dist = 60 + (p * 100); // Move apart
                    const cl1 = { x: center.x - dist/2, y: center.y };
                    const cl2 = { x: center.x + dist/2, y: center.y };
                    
                    return (
                        <>
                            {p < 0.2 && <Bond x1={cl1.x} y1={cl1.y} x2={cl2.x} y2={cl2.y} isBreaking={p > 0.1} />}
                            <Atom type="Cl" x={cl1.x} y={cl1.y} hasRadical={p > 0.1} />
                            <Atom type="Cl" x={cl2.x} y={cl2.y} hasRadical={p > 0.1} />
                            
                            {/* UV Energy Label */}
                            {p > 0.1 && p < 0.3 && (
                                <div className="absolute top-1/3 left-1/2 -translate-x-1/2 text-purple-400 font-bold animate-bounce">
                                    UV Energy!
                                </div>
                            )}
                        </>
                    );
                }

                if (stageIdx === 1) { // Prop 1: CH4 + Cl. -> CH3. + HCl
                    // CH4 at left, Cl. enters from right
                    // H moves from C to Cl
                    
                    // CH4 static core (CH3)
                    const c = { x: 250, y: 250 };
                    const h1 = { x: 250, y: 190 }; // Top
                    const h2 = { x: 210, y: 290 }; // Left-Bot
                    // Target H (Right-Bot) - moves
                    const hTargetStart = { x: 290, y: 290 };
                    
                    // Incoming Cl
                    const clStart = { x: 550, y: 290 };
                    const clEnd = { x: 350, y: 290 };
                    
                    // Animation Logic
                    // 0-40%: Cl approaches
                    // 40-60%: Transition state (H is between C and Cl)
                    // 60-100%: H bonds to Cl, they leave together
                    
                    let clX = clStart.x;
                    let hX = hTargetStart.x;
                    let hY = hTargetStart.y;
                    let cRadical = false;
                    let clRadical = true;
                    
                    if (p <= 0.4) {
                        clX = clStart.x - (clStart.x - clEnd.x) * (p / 0.4);
                    } else if (p <= 0.6) {
                        clX = clEnd.x;
                        hX = hTargetStart.x + (clEnd.x - 40 - hTargetStart.x) * ((p-0.4)/0.2); // H moves halfway
                    } else {
                        // Leaving together
                        const leaveProgress = (p - 0.6) / 0.4;
                        clX = clEnd.x + (100 * leaveProgress);
                        hX = (clEnd.x - 40) + (100 * leaveProgress); // Maintain H-Cl distance
                        cRadical = true;
                        clRadical = false;
                    }

                    return (
                        <>
                            {/* CH3 Framework */}
                            <Bond x1={c.x} y1={c.y} x2={h1.x} y2={h1.y} />
                            <Bond x1={c.x} y1={c.y} x2={h2.x} y2={h2.y} />
                            {/* Breaking Bond C-H */}
                            {p < 0.5 && <Bond x1={c.x} y1={c.y} x2={hX} y2={hY} isBreaking={p > 0.4} />}
                            {/* Forming Bond H-Cl */}
                            {p > 0.5 && <Bond x1={hX} y1={hY} x2={clX} y2={290} />}

                            <Atom type="H" x={h1.x} y={h1.y} />
                            <Atom type="H" x={h2.x} y={h2.y} />
                            <Atom type="C" x={c.x} y={c.y} hasRadical={cRadical} />
                            
                            {/* Moving Actors */}
                            <Atom type="H" x={hX} y={hY} />
                            <Atom type="Cl" x={clX} y={290} hasRadical={clRadical} />
                        </>
                    );
                }
                
                if (stageIdx === 2) { // Prop 2: CH3. + Cl2 -> CH3Cl + Cl.
                    // CH3. (radical) at left. Cl-Cl enters.
                    // Cl moves to CH3.
                    
                    const c = { x: 250, y: 250 };
                    // CH3 parts
                    const h1 = { x: 250, y: 190 }; 
                    const h2 = { x: 210, y: 290 };
                    const h3 = { x: 290, y: 290 };
                    
                    // Incoming Cl-Cl
                    const cl1Start = { x: 550, y: 250 }; // Will stick to C
                    const cl2Start = { x: 610, y: 250 }; // Will leave as radical
                    const clTarget = { x: 310, y: 250 }; // Cl1 bonding pos
                    
                    let cl1X = cl1Start.x;
                    let cl2X = cl2Start.x;
                    let cRadical = true;
                    let cl2Radical = false;
                    
                    if (p <= 0.4) {
                        const approach = p / 0.4;
                        cl1X = cl1Start.x - (cl1Start.x - clTarget.x) * approach;
                        cl2X = cl2Start.x - (cl2Start.x - (clTarget.x + 60)) * approach;
                    } else if (p <= 0.6) {
                        // Bond break/form
                        cl1X = clTarget.x;
                        cl2X = clTarget.x + 60;
                    } else {
                        // Cl2 leaves
                        const leave = (p - 0.6) / 0.4;
                        cl1X = clTarget.x; // Stays
                        cl2X = (clTarget.x + 60) + (100 * leave); // Leaves
                        cRadical = false;
                        cl2Radical = true;
                    }
                    
                    return (
                        <>
                            <Bond x1={c.x} y1={c.y} x2={h1.x} y2={h1.y} />
                            <Bond x1={c.x} y1={c.y} x2={h2.x} y2={h2.y} />
                            <Bond x1={c.x} y1={c.y} x2={h3.x} y2={h3.y} />
                            
                            {/* C-Cl forming */}
                            {p > 0.5 && <Bond x1={c.x} y1={c.y} x2={cl1X} y2={250} />}
                            {/* Cl-Cl breaking */}
                            {p < 0.5 && <Bond x1={cl1X} y1={250} x2={cl2X} y2={250} isBreaking={p > 0.4} />}
                            
                            <Atom type="H" x={h1.x} y={h1.y} />
                            <Atom type="H" x={h2.x} y={h2.y} />
                            <Atom type="H" x={h3.x} y={h3.y} />
                            <Atom type="C" x={c.x} y={c.y} hasRadical={cRadical} />
                            
                            <Atom type="Cl" x={cl1X} y={250} />
                            <Atom type="Cl" x={cl2X} y={250} hasRadical={cl2Radical} />
                        </>
                    );
                }
                
                if (stageIdx === 3) { // Termination: Cl. + Cl. -> Cl2 (Simple case)
                    // Two Cl. come together
                     const cl1Start = { x: 200, y: 250 };
                     const cl2Start = { x: 600, y: 250 };
                     
                     let cl1X = cl1Start.x;
                     let cl2X = cl2Start.x;
                     let hasRadical = true;
                     
                     if (p <= 0.5) {
                         const move = p / 0.5;
                         cl1X = 200 + (170 * move); // Target 370
                         cl2X = 600 - (170 * move); // Target 430
                     } else {
                         cl1X = 370;
                         cl2X = 430;
                         hasRadical = false;
                     }
                     
                     return (
                         <>
                            {p > 0.5 && <Bond x1={cl1X} y1={250} x2={cl2X} y2={250} />}
                            <Atom type="Cl" x={cl1X} y={250} hasRadical={hasRadical} />
                            <Atom type="Cl" x={cl2X} y={250} hasRadical={hasRadical} />
                            
                            {p > 0.5 && (
                                <div className="absolute top-1/3 left-1/2 -translate-x-1/2 text-emerald-400 font-bold animate-pulse">
                                    Stable Molecule Formed
                                </div>
                            )}
                         </>
                     );
                }
            };

            return (
                <div className="min-h-screen bg-[#0F172A] text-white flex flex-col md:flex-row overflow-hidden">
                    
                    {/* Sidebar */}
                    <div className="w-full md:w-80 bg-slate-900 border-r border-slate-800 flex flex-col z-10 shadow-xl h-screen shrink-0">
                        <div className="p-6 border-b border-slate-800">
                            <h1 className="text-xl font-bold flex items-center gap-2">
                                <Icon name="atom" className="text-purple-400" /> Reaction Animator
                            </h1>
                            <p className="text-xs text-slate-400 mt-1">Free Radical Substitution</p>
                        </div>

                        <div className="p-6 space-y-6">
                            
                            {/* Progress */}
                            <div>
                                <div className="flex justify-between text-xs text-slate-400 font-bold uppercase mb-2">
                                    <span>Progress</span>
                                    <span>{stageIdx + 1} / {STAGES.length}</span>
                                </div>
                                <div className="h-1.5 bg-slate-800 rounded-full overflow-hidden">
                                    <div className="h-full bg-purple-500 transition-all duration-500" style={{width: `${((stageIdx + 1) / STAGES.length) * 100}%`}}></div>
                                </div>
                            </div>

                            {/* Stage List */}
                            <div className="space-y-2">
                                {STAGES.map((s, i) => (
                                    <div 
                                        key={s.id}
                                        className={`p-4 rounded-xl border transition-all duration-300 ${stageIdx === i ? 'bg-slate-800 border-purple-500 ring-1 ring-purple-500/50' : 'bg-slate-900/50 border-slate-800 opacity-50'}`}
                                    >
                                        <div className="text-sm font-bold mb-1 text-white">{s.title}</div>
                                        <div className="text-xs font-mono text-slate-400 bg-black/30 p-1 rounded mb-2 inline-block border border-slate-700">
                                            {s.eq}
                                        </div>
                                        {stageIdx === i && (
                                            <p className="text-xs text-slate-300 leading-relaxed animate-in fade-in">
                                                {s.desc}
                                            </p>
                                        )}
                                    </div>
                                ))}
                            </div>

                        </div>
                    </div>

                    {/* Main Stage */}
                    <div className="flex-1 relative bg-[#020617] overflow-hidden flex flex-col">
                        
                        {/* Animation Viewport */}
                        <div className="flex-1 relative overflow-hidden">
                            {/* UV Flash Overlay */}
                            {uvFlash && <div className="absolute inset-0 uv-flash pointer-events-none z-20"></div>}
                            
                            <div className="w-full h-full flex items-center justify-center scale-75 md:scale-100 relative z-10">
                                {renderScene()}
                            </div>

                            {/* Legend */}
                            <div className="absolute top-6 right-6 bg-slate-900/80 backdrop-blur p-3 rounded-xl border border-slate-700 text-xs space-y-2 z-30">
                                <div className="font-bold text-slate-400 uppercase tracking-wider mb-1">Key</div>
                                <div className="flex items-center gap-2">
                                    <div className="w-3 h-3 rounded-full bg-slate-700 border border-slate-500"></div> <span className="text-slate-300">Carbon</span>
                                </div>
                                <div className="flex items-center gap-2">
                                    <div className="w-3 h-3 rounded-full bg-white border border-slate-300"></div> <span className="text-slate-300">Hydrogen</span>
                                </div>
                                <div className="flex items-center gap-2">
                                    <div className="w-3 h-3 rounded-full bg-green-500 border border-green-400"></div> <span className="text-slate-300">Chlorine</span>
                                </div>
                                <div className="flex items-center gap-2">
                                    <div className="w-3 h-3 rounded-full bg-yellow-400 shadow-[0_0_5px_rgba(250,204,21,0.8)]"></div> <span className="text-slate-300">Unpaired Electron (Radical)</span>
                                </div>
                            </div>
                        </div>

                        {/* Controls */}
                        <div className="h-24 bg-slate-800 border-t border-slate-700 flex items-center justify-center gap-6 shrink-0 z-30">
                            <button 
                                onClick={handlePrev}
                                disabled={stageIdx === 0}
                                className="p-3 rounded-full bg-slate-700 hover:bg-slate-600 text-white disabled:opacity-30 transition-all"
                            >
                                <Icon name="chevron-left" size={24} />
                            </button>

                            <button 
                                onClick={play}
                                className="px-8 py-3 rounded-full bg-purple-600 hover:bg-purple-500 text-white font-bold shadow-lg shadow-purple-500/30 flex items-center gap-2 transition-all active:scale-95"
                            >
                                <Icon name={isPlaying ? "refresh-cw" : "play"} fill="currentColor" />
                                {isPlaying ? 'Replay Step' : 'Play Animation'}
                            </button>

                            <button 
                                onClick={handleNext}
                                disabled={stageIdx === STAGES.length - 1}
                                className="p-3 rounded-full bg-slate-700 hover:bg-slate-600 text-white disabled:opacity-30 transition-all"
                            >
                                <Icon name="chevron-right" size={24} />
                            </button>
                        </div>

                    </div>

                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
