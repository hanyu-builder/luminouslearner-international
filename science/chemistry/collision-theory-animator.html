<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collision Theory Animator - LuminousLearner International</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.0.2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=JetBrains+Mono:wght@400;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0F172A; color: #e2e8f0; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        
        /* 修正 Canvas 容器，使用 aspect-ratio 來確保接近正方形 */
        .canvas-container {
            position: relative;
            width: 100%;
            /* 調整高度，使其維持在一個較矮的比例 (例如 3:4 寬高比) */
            padding-top: 75%; 
            height: 0;
            min-height: 300px;
        }
        
        #simulation-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #1e293b; 
            border-radius: 1rem;
            border: 2px solid #334155;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
        }

        .stat-card { transition: all 0.3s ease; }
        .stat-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3); }

        /* Dark Mode Slider Thumbs */
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #ffffff;
            cursor: pointer;
            border: 3px solid currentColor;
            box-shadow: 0 2px 4px rgba(0,0,0,0.4);
        }
        #temp-slider::-webkit-slider-thumb { border-color: #f87171; }
        #conc-slider::-webkit-slider-thumb { border-color: #60a5fa; }
        #ea-slider::-webkit-slider-thumb { border-color: #facc15; }

        /* Chart Styling */
        #mb-chart {
             background-color: #1e293b !important;
             border-radius: 1rem;
        }

        /* 確保左右兩側高度一致 */
        .control-panel-group {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        .right-panel-group {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <div id="root" class="flex-grow flex flex-col"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const Icon = ({ name, size = 20, className = "" }) => {
            const [svg, setSvg] = useState('');
            useEffect(() => {
                if (window.lucide && window.lucide.icons[name]) {
                    const iconNode = window.lucide.icons[name];
                    const iconSvg = window.lucide.createElement(iconNode);
                    iconSvg.setAttribute('width', size);
                    iconSvg.setAttribute('height', size); 
                    iconSvg.setAttribute('class', className);
                    setSvg(iconSvg.outerHTML);
                }
            }, [name, size, className]);
            return <span dangerouslySetInnerHTML={{ __html: svg }} className="flex items-center" />;
        };

        const App = () => {
            // Settings
            const [temperature, setTemperature] = useState(300); // Kelvin (approx range 200-600)
            const [concentration, setConcentration] = useState(40); // Number of particles (20-300)
            const [isRunning, setIsRunning] = useState(true);
            const [activationEnergy, setActivationEnergy] = useState(50); // Arbitrary unit (scaled: 20-100)

            // Stats
            const [totalCollisions, setTotalCollisions] = useState(0);
            const [effectiveCollisions, setEffectiveCollisions] = useState(0);
            const [reactionRate, setReactionRate] = useState(0);
            const [effectiveFraction, setEffectiveFraction] = useState(0); // MB fraction

            // Refs for Canvas Animation
            const canvasRef = useRef(null);
            const containerRef = useRef(null);
            const particlesRef = useRef([]);
            const requestRef = useRef();
            const statsRef = useRef({ total: 0, effective: 0, lastTime: Date.now(), rate: 0 });
            const particleCount = concentration * 2;

            // Chart Ref for MB Distribution
            const mbChartRef = useRef(null);
            const mbChartInstance = useRef(null);

            // --- Utility Functions ---

            const createParticle = (w, h, type) => {
                const baseSpeed = 1.5;
                const randomAngle = Math.random() * 2 * Math.PI;
                const baseEnergy = (Math.random() * 200) + 100; // Base energy between 100 and 300
                
                return {
                    x: Math.random() * w,
                    y: Math.random() * h,
                    vx: Math.cos(randomAngle) * baseSpeed, 
                    vy: Math.sin(randomAngle) * baseSpeed,
                    type: type,
                    radius: 4,
                    color: type === 'A' ? '#f87171' : '#60a5fa', // Red/Blue
                    energy: baseEnergy
                };
            };
            
            // Maxwell-Boltzmann Distribution Function Approximation
            const calculateMB = (temp) => {
                const data = [];
                const labels = [];
                const T = temp / 20; // Scaled temperature
                
                for (let x = 0; x <= 120; x += 1) {
                    const y = 1000 * Math.sqrt(x) * Math.exp(-x / T) / Math.pow(T, 1.5);
                    data.push(y);
                    labels.push(x);
                }
                return { labels, data };
            };

            // --- Animation & Simulation Logic ---

            const animate = () => {
                const canvas = canvasRef.current;
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                const width = canvas.width;
                const height = canvas.height;

                ctx.clearRect(0, 0, width, height);
                ctx.fillStyle = '#1e293b'; // Dark background
                ctx.fillRect(0, 0, width, height);

                const speedFactor = Math.sqrt(temperature / 300) * 1;
                // FIXED: Simplified Ea threshold logic for better reaction visibility
                // Ea slider (20-100) * 5 is the energy threshold for reaction.
                const EaThreshold = activationEnergy * 5; 

                const particles = particlesRef.current;
                
                for (let i = 0; i < particles.length; i++) {
                    let p1 = particles[i];
                    
                    // 1. Move & Boundary Bounce
                    p1.x += p1.vx * speedFactor;
                    p1.y += p1.vy * speedFactor;

                    if (p1.x < p1.radius || p1.x > width - p1.radius) p1.vx *= -1;
                    if (p1.y < p1.radius || p1.y > height - p1.radius) p1.vy *= -1;

                    p1.x = Math.max(p1.radius, Math.min(width - p1.radius, p1.x));
                    p1.y = Math.max(p1.radius, Math.min(height - p1.radius, p1.y));
                    
                    // 2. Draw
                    ctx.beginPath();
                    ctx.arc(p1.x, p1.y, p1.radius, 0, Math.PI * 2);
                    ctx.fillStyle = p1.color;
                    ctx.fill();
                    
                    // 3. Collision Detection & Reaction Check
                    for (let j = i + 1; j < particles.length; j++) {
                        let p2 = particles[j];
                        const dx = p1.x - p2.x;
                        const dy = p1.y - p2.y;
                        const distSq = dx*dx + dy*dy;
                        const minDist = (p1.radius + p2.radius);

                        if (distSq < minDist * minDist) {
                            
                            // Simple collision resolution (velocity swap + position adjust)
                            const dist = Math.sqrt(distSq);
                            const overlap = minDist - dist;
                            p1.x += dx / dist * overlap / 2;
                            p1.y += dy / dist * overlap / 2;
                            p2.x -= dx / dist * overlap / 2;
                            p2.y -= dy / dist * overlap / 2;

                            const tempVx = p1.vx; const tempVy = p1.vy;
                            p1.vx = p2.vx; p1.vy = p2.vy;
                            p2.vx = tempVx; p2.vy = tempVy;

                            // Check Reaction (A + B)
                            if (p1.type !== p2.type) {
                                statsRef.current.total++;
                                
                                // FIXED: Energy Check using average speed squared for simplified KE proxy
                                const v1Sq = p1.vx * p1.vx + p1.vy * p1.vy;
                                const v2Sq = p2.vx * p2.vx + p2.vy * p2.vy;
                                const collisionEnergy = (v1Sq + v2Sq) * temperature; 
                                
                                // Simplified Check: Collision Energy > Ea scaled by a factor
                                if (collisionEnergy > EaThreshold * 150) { // Factor 150 to make it proportional to slider/temp effect
                                    statsRef.current.effective++;
                                    
                                    // Visual Flash
                                    ctx.beginPath();
                                    ctx.arc((p1.x+p2.x)/2, (p1.y+p2.y)/2, 8, 0, Math.PI * 2);
                                    ctx.fillStyle = "rgba(255, 255, 0, 0.7)";
                                    ctx.fill();
                                }
                            }
                        }
                    }
                }

                // Update React Stats (Throttled)
                const now = Date.now();
                if (now - statsRef.current.lastTime > 500) { 
                    const totalPeriod = (now - statsRef.current.lastTime) / 1000;
                    
                    setTotalCollisions(prev => prev + statsRef.current.total);
                    setEffectiveCollisions(prev => prev + statsRef.current.effective);
                    
                    const currentRate = statsRef.current.effective / totalPeriod;

                    statsRef.current.rate = statsRef.current.rate * 0.8 + currentRate * 0.2;
                    setReactionRate(statsRef.current.rate.toFixed(1)); 

                    statsRef.current.total = 0;
                    statsRef.current.effective = 0;
                    statsRef.current.lastTime = now;
                }

                if (isRunning) {
                    requestRef.current = requestAnimationFrame(animate);
                }
            };

            const handleResize = () => {
                const canvas = canvasRef.current;
                const container = containerRef.current;
                if (canvas && container) {
                    canvas.width = container.clientWidth;
                    canvas.height = container.clientHeight;
                    // Re-initialize particles on resize to prevent clustering
                    particlesRef.current = particlesRef.current.map(p => ({
                        ...p,
                        x: Math.random() * canvas.width,
                        y: Math.random() * canvas.height,
                    }));
                }
            };
            
            // --- Chart Rendering ---
            useEffect(() => {
                if (!mbChartRef.current) return;

                const { labels, data } = calculateMB(temperature);
                
                let totalArea = 0;
                let effectiveArea = 0;
                data.forEach((y, x) => {
                    totalArea += y;
                    if (x >= activationEnergy) effectiveArea += y;
                });
                
                const percent = totalArea > 0 ? (effectiveArea / totalArea) * 100 : 0;
                setEffectiveFraction(percent.toFixed(2));

                const backgroundColors = labels.map(x => x >= activationEnergy ? 'rgba(16, 185, 129, 0.6)' : 'rgba(99, 102, 241, 0.2)');
                const borderColors = labels.map(x => x >= activationEnergy ? '#059669' : '#4f46e5');

                const ctx = mbChartRef.current.getContext('2d');

                const colorPrimary = '#e2e8f0'; 
                const gridColor = '#334155';
                const fontStyle = 'Inter';


                if (mbChartInstance.current) {
                    mbChartInstance.current.data.labels = labels;
                    mbChartInstance.current.data.datasets[0].data = data;
                    mbChartInstance.current.data.datasets[0].backgroundColor = backgroundColors;
                    mbChartInstance.current.data.datasets[0].borderColor = borderColors;
                    
                    // Update Ea line position
                    mbChartInstance.current.options.plugins.annotation.annotations[0].value = activationEnergy;
                    
                    mbChartInstance.current.update();
                } else {
                    mbChartInstance.current = new Chart(ctx, {
                        type: 'bar', // Bar chart to easily color segments
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Fraction of Molecules',
                                data: data,
                                backgroundColor: backgroundColors,
                                borderColor: borderColors,
                                borderWidth: 1,
                                barPercentage: 1.0,
                                categoryPercentage: 1.0,
                                pointRadius: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            animation: { duration: 0 }, 
                            plugins: {
                                legend: { display: false },
                                tooltip: { enabled: false },
                                annotation: {
                                    annotations: [{
                                        type: 'line',
                                        mode: 'vertical',
                                        scaleID: 'x',
                                        value: activationEnergy,
                                        borderColor: '#ef4444',
                                        borderWidth: 2,
                                        borderDash: [6, 6],
                                        label: {
                                            content: 'Ea',
                                            enabled: true,
                                            position: 'top',
                                            font: { family: fontStyle, weight: 'bold', size: 14, color: '#ef4444' }
                                        }
                                    }]
                                }
                            },
                            scales: {
                                x: { 
                                    type: 'linear',
                                    title: { display: true, text: 'Kinetic Energy (E)', font: { weight: 'bold', size: 14, color: colorPrimary } },
                                    min: 0, max: 120,
                                    grid: { display: false },
                                    ticks: { display: false }
                                },
                                y: { 
                                    title: { display: true, text: 'Fraction of Molecules (N/Ntotal)', font: { weight: 'bold', size: 14, color: colorPrimary } },
                                    display: true,
                                    min: 0,
                                    ticks: { display: false },
                                    grid: { color: gridColor, borderDash: [5, 5] }
                                }
                            },
                        },
                    });
                }
            }, [temperature, activationEnergy]);

            // --- General Effects ---
            useEffect(() => {
                // Initial setup and listener attachment
                window.addEventListener('resize', handleResize);
                handleResize(); // Call once immediately to set initial size

                if (isRunning) {
                    requestRef.current = requestAnimationFrame(animate);
                }
                return () => {
                    cancelAnimationFrame(requestRef.current);
                    window.removeEventListener('resize', handleResize);
                };
            }, [isRunning, temperature, concentration, activationEnergy]);


            return (
                <div className="flex flex-col h-full container mx-auto px-4 py-6 max-w-6xl">
                    
                    {/* Header */}
                    <div className="flex justify-between items-center mb-6 border-b border-slate-800 pb-4">
                        <div>
                            <h1 className="text-2xl font-bold text-indigo-400 flex items-center gap-2">
                                <Icon name="Activity" /> Collision Theory Animator
                            </h1>
                            <p className="text-slate-500 text-sm">Visualizing Rate Factors (A + B → Products)</p>
                        </div>
                        <button 
                            onClick={() => setIsRunning(!isRunning)}
                            className={`px-6 py-2 rounded-lg font-bold text-sm flex items-center gap-2 transition-colors shadow-lg
                                ${isRunning ? 'bg-red-600 text-white hover:bg-red-500' : 'bg-emerald-600 text-white hover:bg-emerald-500'}
                            `}
                        >
                            <Icon name={isRunning ? "Pause" : "Play"} size={16}/>
                            {isRunning ? 'Pause Simulation' : 'Resume Simulation'}
                        </button>
                    </div>

                    <div className="flex flex-col lg:flex-row gap-8 flex-grow">
                        
                        {/* Left: Controls (Group 1) */}
                        <div className="w-full lg:w-1/3 flex flex-col gap-6 control-panel-group">
                            
                            {/* Stats */}
                            <div className="bg-slate-900 p-6 rounded-2xl shadow-xl border border-slate-800">
                                <h3 className="text-xs font-bold text-slate-400 uppercase mb-4 border-b border-slate-700 pb-2">
                                    Reaction Statistics
                                </h3>
                                
                                <div className="grid grid-cols-2 gap-4">
                                    <div className="bg-slate-800 p-3 rounded-xl border border-slate-700 stat-card">
                                        <div className="text-xs font-bold text-slate-500">Total Collisions</div>
                                        <div className="text-2xl font-mono font-black text-white">{totalCollisions}</div>
                                    </div>
                                    <div className="bg-slate-800 p-3 rounded-xl border border-slate-700 stat-card">
                                        <div className="text-xs font-bold text-slate-500">Effective Collisions</div>
                                        <div className="text-2xl font-mono font-black text-emerald-400">{effectiveCollisions}</div>
                                    </div>
                                </div>
                                <div className="mt-4 p-3 bg-slate-800 rounded-xl border border-slate-700">
                                    <div className="text-xs font-bold text-slate-500">Effective Rate</div>
                                    <div className="text-3xl font-mono font-black text-indigo-400 mt-1">{reactionRate}</div>
                                </div>
                            </div>
                            
                            {/* Temperature Control */}
                            <div className="bg-slate-900 p-6 rounded-2xl shadow-xl border-l-8 border-red-500/50">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="font-bold text-slate-400 flex items-center gap-2">
                                        <Icon name="Thermometer" className="text-red-400"/> Temperature (T)
                                    </h3>
                                    <span className="font-mono font-bold text-red-400 text-2xl">{temperature} K</span>
                                </div>
                                <input 
                                    type="range" min="200" max="600" step="10"
                                    value={temperature}
                                    onChange={(e) => setTemperature(Number(e.target.value))}
                                    id="temp-slider"
                                    className="w-full h-2 bg-red-900/50 rounded-lg appearance-none cursor-pointer accent-red-500"
                                />
                                <p className="text-xs text-slate-500 mt-3">↑ T increases particle speed, boosting collision frequency and energy.</p>
                            </div>

                            {/* Concentration Control */}
                            <div className="bg-slate-900 p-6 rounded-2xl shadow-xl border-l-8 border-blue-500/50">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="font-bold text-slate-400 flex items-center gap-2">
                                        <Icon name="Users" className="text-blue-400"/> Concentration (Particles)
                                    </h3>
                                    <span className="font-mono font-bold text-blue-400 text-2xl">{concentration * 2}</span>
                                </div>
                                <input 
                                    type="range" min="10" max="150" step="10"
                                    value={concentration}
                                    onChange={(e) => setConcentration(parseInt(e.target.value))}
                                    id="conc-slider"
                                    className="w-full h-2 bg-blue-900/50 rounded-lg appearance-none cursor-pointer accent-blue-500"
                                />
                                <p className="text-xs text-slate-500 mt-3">↑ Particle count directly increases collision frequency.</p>
                            </div>

                            {/* Activation Energy Control */}
                            <div className="bg-slate-900 p-6 rounded-2xl shadow-xl border-l-8 border-amber-500/50">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="font-bold text-slate-400 flex items-center gap-2">
                                        <Icon name="Zap" className="text-amber-400"/> Activation Energy (Ea)
                                    </h3>
                                    <span className="font-mono font-bold text-amber-400 text-2xl">{activationEnergy} kJ</span>
                                </div>
                                <input 
                                    type="range" min="20" max="100" step="5"
                                    value={activationEnergy}
                                    onChange={(e) => setActivationEnergy(parseInt(e.target.value))}
                                    id="ea-slider"
                                    className="w-full h-2 bg-amber-900/50 rounded-lg appearance-none cursor-pointer accent-amber-500"
                                />
                                <p className="text-xs text-slate-500 mt-3">Sets the minimum energy required for an effective collision.</p>
                            </div>

                        </div>

                        {/* Right: Simulation & Chart (Group 2) */}
                        <div className="w-full lg:w-2/3 flex flex-col gap-6 right-panel-group">
                            
                            {/* 1. Canvas Simulation Area */}
                            <div ref={containerRef} className="bg-slate-950 rounded-3xl border-4 border-slate-800 p-4 shadow-xl relative canvas-container">
                                <canvas ref={canvasRef} id="simulation-canvas"></canvas>

                                {/* Legend */}
                                <div className="absolute bottom-4 left-4 bg-slate-800/80 p-3 rounded-xl border border-slate-700 text-xs font-bold text-slate-400 flex gap-4">
                                    <div className="flex items-center gap-2">
                                        <div className="w-3 h-3 rounded-full bg-red-400"></div> <span>Reactant A</span>
                                    </div>
                                    <div className="flex items-center gap-2">
                                        <div className="w-3 h-3 rounded-full bg-blue-400"></div> <span>Reactant B</span>
                                    </div>
                                    <div className="flex items-center gap-2">
                                        <div className="w-3 h-3 rounded-full bg-yellow-400 shadow-[0_0_8px_yellow]"></div> <span>Effective Reaction</span>
                                    </div>
                                </div>
                            </div>

                            {/* 2. Maxwell-Boltzmann Distribution Chart */}
                            <div className="bg-slate-900 rounded-3xl border-4 border-slate-800 p-4 shadow-xl">
                                <h3 className="text-xs font-bold text-slate-400 uppercase mb-2 flex items-center gap-2">
                                    <Icon name="BarChart2" className="text-emerald-400"/> Energy Distribution Curve (Maxwell-Boltzmann)
                                </h3>
                                <div className="relative h-64 w-full">
                                    <canvas ref={mbChartRef} id="mb-chart"></canvas>
                                </div>
                                <div className="text-center text-xs font-bold mt-3">
                                    <span className="text-emerald-400">{effectiveFraction}%</span> 
                                    <span className="text-slate-500"> of particles have energy &ge; Ea.</span>
                                </div>
                            </div>
                        </div>

                    </div>
                    
                    <div className="text-center text-slate-600 text-xs mt-12 border-t border-slate-800 pt-6 pb-6">
                        Luminous Learner International | IB/A-Level Chemistry
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
