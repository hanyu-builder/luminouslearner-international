<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mass Spec Fragmenter</title>
    
    <!-- React & Tailwind -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Recharts -->
    <script src="https://unpkg.com/prop-types/prop-types.min.js"></script>
    <script src="https://unpkg.com/recharts@2.12.7/umd/Recharts.js"></script>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0F172A; color: #e2e8f0; margin: 0; overflow: hidden; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        
        /* Molecule Animation */
        .atom { transition: all 0.3s ease-in-out; }
        .bond { transition: stroke-dasharray 0.3s; }
        .fragment-highlight { filter: drop-shadow(0 0 8px rgba(59, 130, 246, 0.8)); }
        .radical-dot { fill: #ef4444; animation: pulse 1s infinite; }
        
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* Custom Scrollbar for Chart Container if needed */
        .scroll-container::-webkit-scrollbar { width: 6px; }
        .scroll-container::-webkit-scrollbar-track { background: #1e293b; }
        .scroll-container::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Cell, LabelList } = window.Recharts;

        const Icon = ({ name, className = "", size = 20 }) => {
            const [svgHtml, setSvgHtml] = useState('');
            useEffect(() => {
                if (window.lucide && window.lucide.icons) {
                    const pascalName = name.split('-').map(part => part.charAt(0).toUpperCase() + part.slice(1)).join('');
                    const iconData = window.lucide.icons[pascalName];
                    if (iconData && typeof window.lucide.createElement === 'function') {
                        const svgElement = window.lucide.createElement(iconData);
                        svgElement.setAttribute('class', className);
                        svgElement.setAttribute('width', size);
                        svgElement.setAttribute('height', size);
                        setSvgHtml(svgElement.outerHTML);
                    }
                }
            }, [name, className, size]);
            if (!svgHtml) return <span className={className} style={{ width: size, height: size, display: 'inline-block' }}></span>;
            return <span dangerouslySetInnerHTML={{ __html: svgHtml }} className="flex items-center justify-center" />;
        };

        // --- DATABASE (Translated) ---
        // Simplified molecule structure for visualization
        const MOLECULES = [
            {
                id: 'pentane',
                name: 'Pentane (C₅H₁₂)',
                formula: 'CH₃CH₂CH₂CH₂CH₃',
                mw: 72,
                // Visual structure: simple chain
                atoms: [
                    { id: 'C1', label: 'CH₃', x: 50, y: 100, mass: 15 },
                    { id: 'C2', label: 'CH₂', x: 100, y: 100, mass: 14 },
                    { id: 'C3', label: 'CH₂', x: 150, y: 100, mass: 14 },
                    { id: 'C4', label: 'CH₂', x: 200, y: 100, mass: 14 },
                    { id: 'C5', label: 'CH₃', x: 250, y: 100, mass: 15 }
                ],
                bonds: [
                    { from: 'C1', to: 'C2' }, { from: 'C2', to: 'C3' }, 
                    { from: 'C3', to: 'C4' }, { from: 'C4', to: 'C5' }
                ],
                peaks: [
                    { mz: 15, type: 'fragment', label: 'Methyl', structure: 'CH₃⁺', atoms: ['C1'] },
                    { mz: 29, type: 'fragment', label: 'Ethyl', structure: 'CH₃CH₂⁺', atoms: ['C1','C2'] },
                    // UPDATED: Specific structure for propyl cation
                    { mz: 43, type: 'base', label: 'Propyl (Base)', structure: 'CH₃CH₂CH₂⁺', atoms: ['C1','C2','C3'] },
                    { mz: 57, type: 'fragment', label: 'Butyl', structure: 'CH₃CH₂CH₂CH₂⁺', atoms: ['C1','C2','C3','C4'] },
                    { mz: 72, type: 'molecular', label: 'M⁺', structure: 'CH₃(CH₂)₃CH₃⁺•', atoms: ['C1','C2','C3','C4','C5'] }
                ]
            },
            {
                id: 'propanone',
                name: 'Propanone (C₃H₆O)',
                formula: 'CH₃COCH₃',
                mw: 58,
                atoms: [
                    { id: 'C1', label: 'CH₃', x: 80, y: 120, mass: 15 },
                    { id: 'C2', label: 'C=O', x: 150, y: 80, mass: 28 }, // CO group
                    { id: 'C3', label: 'CH₃', x: 220, y: 120, mass: 15 }
                ],
                bonds: [
                    { from: 'C1', to: 'C2' }, { from: 'C2', to: 'C3' }
                ],
                peaks: [
                    { mz: 15, type: 'fragment', label: 'Methyl', structure: 'CH₃⁺', atoms: ['C1'] },
                    // UPDATED: Acylium ion structure
                    { mz: 43, type: 'base', label: 'Acyl (Base)', structure: 'CH₃-C≡O⁺', atoms: ['C1','C2'] },
                    { mz: 58, type: 'molecular', label: 'M⁺', structure: 'CH₃COCH₃⁺•', atoms: ['C1','C2','C3'] }
                ]
            },
            {
                id: 'ethanol',
                name: 'Ethanol (C₂H₆O)',
                formula: 'CH₃CH₂OH',
                mw: 46,
                atoms: [
                    { id: 'C1', label: 'CH₃', x: 100, y: 100, mass: 15 },
                    { id: 'C2', label: 'CH₂', x: 160, y: 100, mass: 14 },
                    { id: 'O1', label: 'OH', x: 220, y: 100, mass: 17 }
                ],
                bonds: [
                    { from: 'C1', to: 'C2' }, { from: 'C2', to: 'O1' }
                ],
                peaks: [
                    { mz: 15, type: 'fragment', label: 'Methyl', structure: 'CH₃⁺', atoms: ['C1'] },
                    { mz: 29, type: 'fragment', label: 'Ethyl', structure: 'CH₃CH₂⁺', atoms: ['C1','C2'] },
                    // UPDATED: Alpha-cleavage product
                    { mz: 31, type: 'base', label: 'Hydroxymethyl', structure: 'CH₂=OH⁺', atoms: ['C2','O1'] }, 
                    { mz: 45, type: 'fragment', label: 'M-1', structure: 'CH₃CH=OH⁺', atoms: ['C1','C2','O1'] }, // Loss of H
                    { mz: 46, type: 'molecular', label: 'M⁺', structure: 'CH₃CH₂OH⁺•', atoms: ['C1','C2','O1'] }
                ]
            },
            {
                id: 'butanoic_acid',
                name: 'Butanoic Acid',
                formula: 'CH₃CH₂CH₂COOH',
                mw: 88,
                atoms: [
                    { id: 'C1', label: 'CH₃', x: 50, y: 100, mass: 15 },
                    { id: 'C2', label: 'CH₂', x: 100, y: 100, mass: 14 },
                    { id: 'C3', label: 'CH₂', x: 150, y: 100, mass: 14 },
                    { id: 'C4', label: 'COOH', x: 220, y: 100, mass: 45 }
                ],
                bonds: [
                    { from: 'C1', to: 'C2' }, { from: 'C2', to: 'C3' }, { from: 'C3', to: 'C4' }
                ],
                peaks: [
                    { mz: 29, type: 'fragment', label: 'Ethyl', structure: 'CH₃CH₂⁺', atoms: ['C1','C2'] },
                    { mz: 43, type: 'fragment', label: 'Propyl', structure: 'CH₃CH₂CH₂⁺', atoms: ['C1','C2','C3'] },
                    // UPDATED: McLafferty Rearrangement product
                    { mz: 60, type: 'base', label: 'McLafferty', structure: 'CH₂=C(OH)₂⁺•', atoms: ['C2','C3','C4'] }, 
                    { mz: 71, type: 'fragment', label: 'Acyl', structure: 'CH₃CH₂CH₂C≡O⁺', atoms: ['C1','C2','C3','C4'] }, 
                    { mz: 88, type: 'molecular', label: 'M⁺', structure: 'CH₃CH₂CH₂COOH⁺•', atoms: ['C1','C2','C3','C4'] }
                ]
            }
        ];

        // --- MOLECULE VISUALIZER ---
        const MoleculeViewer = ({ molecule, activePeak }) => {
            // Determine which atoms are part of the active peak
            const activeAtomIds = activePeak ? activePeak.atoms : [];
            
            return (
                <div className="relative w-full h-64 bg-slate-900 rounded-xl border border-slate-700 flex items-center justify-center overflow-hidden">
                    <svg width="400" height="200" viewBox="0 0 300 200" className="overflow-visible">
                        {/* Bonds */}
                        {molecule.bonds.map((bond, i) => {
                            const from = molecule.atoms.find(a => a.id === bond.from);
                            const to = molecule.atoms.find(a => a.id === bond.to);
                            
                            // Check if this bond is "broken" or "internal"
                            const fromIn = activeAtomIds.includes(from.id);
                            const toIn = activeAtomIds.includes(to.id);
                            const isInternal = fromIn && toIn;
                            // Logic for displaying cleavage
                            // If a bond connects an atom IN the fragment and an atom OUT of the fragment, it's a cleavage point.
                            const isCleavage = (fromIn && !toIn) || (!fromIn && toIn);

                            return (
                                <g key={i}>
                                    <line 
                                        x1={from.x} y1={from.y} x2={to.x} y2={to.y} 
                                        stroke={isInternal ? '#3b82f6' : '#475569'} 
                                        strokeWidth={isInternal ? 4 : 2}
                                        strokeDasharray={isCleavage ? "5,5" : ""}
                                        className="bond"
                                    />
                                    {isCleavage && (
                                        <g transform={`translate(${(from.x+to.x)/2}, ${(from.y+to.y)/2})`}>
                                            <text x="0" y="-10" textAnchor="middle" fill="#ef4444" fontSize="14">⚡</text>
                                        </g>
                                    )}
                                </g>
                            );
                        })}

                        {/* Atoms */}
                        {molecule.atoms.map((atom) => {
                            const isActive = activeAtomIds.includes(atom.id);
                            return (
                                <g key={atom.id} transform={`translate(${atom.x}, ${atom.y})`} className={`atom ${isActive ? 'scale-110' : 'opacity-50'}`}>
                                    <circle r="20" fill={isActive ? '#3b82f6' : '#1e293b'} stroke={isActive ? '#60a5fa' : '#475569'} strokeWidth="2" />
                                    <text x="0" y="0" textAnchor="middle" dominantBaseline="middle" fill="white" fontSize="12" fontWeight="bold">
                                        {atom.label}
                                    </text>
                                    {isActive && atom.id === activeAtomIds[activeAtomIds.length-1] && (
                                        <circle cx="14" cy="-14" r="4" className="radical-dot" /> // Positive charge indicator
                                    )}
                                </g>
                            );
                        })}
                    </svg>
                    
                    {/* Legend */}
                    <div className="absolute top-4 right-4 bg-slate-800/80 p-2 rounded border border-slate-600 text-[10px] text-slate-400">
                        <div className="flex items-center gap-2 mb-1">
                            <div className="w-3 h-3 rounded-full bg-blue-500"></div> Fragment
                        </div>
                        <div className="flex items-center gap-2">
                            <span className="text-red-500">⚡</span> Cleavage
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [molIdx, setMolIdx] = useState(0);
            const [activePeak, setActivePeak] = useState(null);
            
            const currentMol = MOLECULES[molIdx];
            
            // Prepare Chart Data
            const chartData = currentMol.peaks.map(p => ({
                name: p.mz,
                intensity: p.type === 'base' ? 100 : p.type === 'molecular' ? 40 : Math.floor(Math.random() * 50 + 10),
                ...p
            })).sort((a,b) => a.mz - b.mz);

            return (
                <div className="h-screen bg-[#0F172A] text-white flex flex-col md:flex-row overflow-hidden">
                    
                    {/* Sidebar */}
                    <div className="w-full md:w-80 bg-slate-900 border-r border-slate-800 flex flex-col z-10 shadow-xl h-screen shrink-0">
                        <div className="p-6 border-b border-slate-800">
                            <h1 className="text-xl font-bold flex items-center gap-2">
                                <Icon name="hammer" className="text-emerald-400" /> MS Fragmenter
                            </h1>
                            <p className="text-xs text-slate-400 mt-1">Mass Spectrometry Decoding</p>
                        </div>

                        <div className="p-4 space-y-2 flex-1 overflow-y-auto">
                            <label className="text-xs font-bold text-slate-500 uppercase tracking-widest px-1 mb-2 block">Select Molecule</label>
                            {MOLECULES.map((mol, i) => (
                                <button 
                                    key={mol.id}
                                    onClick={() => { setMolIdx(i); setActivePeak(null); }}
                                    className={`w-full text-left p-4 rounded-xl border transition-all flex flex-col gap-1
                                        ${molIdx === i 
                                            ? 'bg-slate-800 border-emerald-500 ring-1 ring-emerald-500/50' 
                                            : 'bg-slate-900/50 border-slate-700 hover:bg-slate-800'}
                                    `}
                                >
                                    <div className="font-bold text-sm text-white">{mol.name}</div>
                                    <div className="text-[10px] text-slate-400 font-mono">MW: {mol.mw}</div>
                                </button>
                            ))}
                        </div>
                        
                        <div className="p-6 border-t border-slate-800 bg-slate-900">
                            <div className="text-xs font-bold text-slate-500 uppercase mb-2">Mechanism Guide</div>
                            <div className="text-xs text-slate-400 leading-relaxed space-y-2">
                                <p><strong className="text-blue-400">Fragmentation:</strong> Molecular ion (M⁺) is unstable and breaks into a cation (+) and a radical (•).</p>
                                <p><strong className="text-emerald-400">Base Peak:</strong> The most stable fragment (Tallest peak, relative abundance 100%).</p>
                            </div>
                        </div>
                    </div>

                    {/* Main Content - Scrollable Area */}
                    <div className="flex-1 relative bg-[#020617] overflow-y-auto p-6 md:p-12 flex flex-col gap-6 scroll-container">
                        
                        {/* Molecule Viewer */}
                        <div className="flex-1 max-h-[300px] shrink-0">
                            <div className="flex justify-between items-end mb-4">
                                <div>
                                    <h2 className="text-2xl font-black text-white">{currentMol.name}</h2>
                                    <p className="text-slate-400 font-mono">{currentMol.formula}</p>
                                </div>
                                {activePeak ? (
                                    <div className="text-right">
                                        <div className="text-xs text-slate-500 uppercase font-bold">Selected Fragment</div>
                                        <div className="text-xl font-bold text-blue-400">m/z = {activePeak.mz}</div>
                                        <div className="text-sm text-slate-300 font-mono">
                                            {/* Priority: Structure > Label */}
                                            {activePeak.structure} <span className="text-slate-500">({activePeak.label})</span>
                                        </div>
                                    </div>
                                ) : (
                                    <div className="text-right text-slate-500 text-sm italic animate-pulse">
                                        Click a peak to identify fragment
                                    </div>
                                )}
                            </div>
                            <MoleculeViewer molecule={currentMol} activePeak={activePeak} />
                        </div>

                        {/* MS Chart */}
                        <div className="bg-slate-800 rounded-2xl border border-slate-700 p-6 shadow-xl shrink-0 h-[450px]">
                            <h3 className="text-sm font-bold text-slate-400 uppercase mb-4 flex items-center gap-2">
                                <Icon name="bar-chart-2" size={16}/> Mass Spectrum
                            </h3>
                            <ResponsiveContainer width="100%" height="100%">
                                <BarChart data={chartData} margin={{ top: 20, right: 30, left: 20, bottom: 40 }}>
                                    <CartesianGrid strokeDasharray="3 3" stroke="#334155" vertical={false} />
                                    <XAxis 
                                        dataKey="mz" 
                                        stroke="#94a3b8" 
                                        label={{ value: 'm/z Ratio', position: 'bottom', offset: 0, fill: '#94a3b8' }} 
                                        tick={{ fontSize: 12 }}
                                    />
                                    <YAxis stroke="#94a3b8" label={{ value: 'Relative Abundance %', angle: -90, position: 'insideLeft', fill: '#94a3b8' }} />
                                    <Tooltip 
                                        cursor={{fill: 'rgba(255,255,255,0.05)'}}
                                        content={({ active, payload }) => {
                                            if (active && payload && payload.length) {
                                                const data = payload[0].payload;
                                                return (
                                                    <div className="bg-slate-900 border border-slate-600 p-2 rounded shadow-xl">
                                                        <div className="text-white font-bold">m/z: {data.mz}</div>
                                                        {/* Tooltip also shows structure now */}
                                                        <div className="text-blue-300 text-xs font-mono">{data.structure}</div>
                                                    </div>
                                                );
                                            }
                                            return null;
                                        }}
                                    />
                                    <Bar 
                                        dataKey="intensity" 
                                        fill="#3b82f6" 
                                        barSize={6} 
                                        onClick={(data) => setActivePeak(data)}
                                        className="cursor-pointer hover:opacity-80"
                                    >
                                        {chartData.map((entry, index) => (
                                            <Cell key={`cell-${index}`} fill={activePeak && activePeak.mz === entry.mz ? '#22c55e' : entry.type === 'molecular' ? '#ef4444' : '#3b82f6'} />
                                        ))}
                                        <LabelList dataKey="structure" position="top" fill="#94a3b8" fontSize={10} />
                                    </Bar>
                                </BarChart>
                            </ResponsiveContainer>
                        </div>
                        
                        {/* Extra padding at bottom */}
                        <div className="h-12"></div>

                    </div>

                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
