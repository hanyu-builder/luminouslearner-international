<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stoichiometry Calculator - LuminousLearner International</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=JetBrains+Mono:wght@400;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0F172A; color: #e2e8f0; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        
        .step-card { transition: all 0.3s ease; }
        .step-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3); }
        
        /* Flow Animation */
        @keyframes flow-right {
            0% { stroke-dashoffset: 20; }
            100% { stroke-dashoffset: 0; }
        }
        .flow-line {
            stroke-dasharray: 5;
            animation: flow-right 1s linear infinite;
        }

        /* Input Focus */
        .input-focus-within:focus-within {
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.3);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <div id="root" class="flex-grow flex flex-col"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Extended Atomic Masses
        const AtomicMasses = {
            H: 1.0, He: 4.0, Li: 6.9, Be: 9.0, B: 10.8, C: 12.0, N: 14.0, O: 16.0, F: 19.0, Ne: 20.2,
            Na: 23.0, Mg: 24.3, Al: 27.0, Si: 28.1, P: 31.0, S: 32.1, Cl: 35.5, K: 39.1, Ar: 39.9, Ca: 40.1,
            Fe: 55.8, Cu: 63.5, Zn: 65.4, Br: 79.9, Ag: 107.9, I: 126.9, Ba: 137.3, Pb: 207.2,
            Mn: 54.9, Cr: 52.0
        };

        // Categorized Examples (Internationalized)
        const ExampleCategories = [
            {
                name: 'Combustion',
                items: [
                    { name: 'Mg + O₂', a: { f: 'Mg', c: 2, m: 4.86 }, b: { f: 'MgO', c: 2 } },
                    { name: 'H₂ + O₂', a: { f: 'H2', c: 2, m: 4.0 }, b: { f: 'H2O', c: 2 } },
                    { name: 'C₃H₈ + O₂', a: { f: 'C3H8', c: 1, m: 10.0 }, b: { f: 'CO2', c: 3 } }
                ]
            },
            {
                name: 'Decomposition',
                items: [
                    { name: 'CaCO₃ → CaO', a: { f: 'CaCO3', c: 1, m: 50.0 }, b: { f: 'CaO', c: 1 } },
                    { name: '2KClO₃ → 3O₂', a: { f: 'KClO3', c: 2, m: 12.25 }, b: { f: 'O2', c: 3 } }
                ]
            },
            {
                name: 'Acid + Metal',
                items: [
                    { name: 'Mg + HCl', a: { f: 'Mg', c: 1, m: 2.43 }, b: { f: 'H2', c: 1 } },
                    { name: 'Zn + HCl', a: { f: 'Zn', c: 1, m: 6.54 }, b: { f: 'H2', c: 1 } }
                ]
            },
            {
                name: 'Neutralization',
                items: [
                    { name: 'NaOH + HCl', a: { f: 'NaOH', c: 1, m: 4.0 }, b: { f: 'NaCl', c: 1 } },
                    { name: 'Ca(OH)₂ + HCl', a: { f: 'Ca(OH)2', c: 1, m: 7.4 }, b: { f: 'CaCl2', c: 1 } }
                ]
            }
        ];

        const Icon = ({ name, size = 20, className = "" }) => {
            const [svg, setSvg] = useState('');
            useEffect(() => {
                if (window.lucide) {
                    const iconNode = window.lucide.icons[name];
                    if (iconNode) {
                        const iconSvg = window.lucide.createElement(iconNode);
                        iconSvg.setAttribute('width', size);
                        iconSvg.setAttribute('height', size);
                        iconSvg.setAttribute('class', className);
                        setSvg(iconSvg.outerHTML);
                    }
                }
            }, [name, size, className]);
            return <span dangerouslySetInnerHTML={{ __html: svg }} className="flex items-center" />;
        };

        const App = () => {
            // Inputs
            const [substanceA, setSubstanceA] = useState({ formula: 'Mg', coeff: 2, mass: '4.86' });
            const [substanceB, setSubstanceB] = useState({ formula: 'MgO', coeff: 2 });
            const [activeCategory, setActiveCategory] = useState(0);
            
            const [result, setResult] = useState(null);
            const [error, setError] = useState('');
            const [steps, setSteps] = useState(null);

            // Robust Formula Parser
            const calculateMolarMass = (formula) => {
                if (!formula) return 0;
                try {
                    const stack = [{ atoms: {} }];
                    let i = 0;
                    const len = formula.length;

                    while (i < len) {
                        const char = formula[i];
                        if (char === '(') { stack.push({ atoms: {} }); i++; }
                        else if (char === ')') {
                            if (stack.length === 1) throw new Error("Unmatched brackets");
                            const group = stack.pop();
                            i++;
                            let numStr = '';
                            while (i < len && /\d/.test(formula[i])) { numStr += formula[i]; i++; }
                            const multiplier = numStr ? parseInt(numStr) : 1;
                            const parent = stack[stack.length - 1];
                            for (const [el, count] of Object.entries(group.atoms)) {
                                parent.atoms[el] = (parent.atoms[el] || 0) + count * multiplier;
                            }
                        } else if (/[A-Z]/.test(char)) {
                            let element = char;
                            i++;
                            if (i < len && /[a-z]/.test(formula[i])) { element += formula[i]; i++; }
                            let numStr = '';
                            while (i < len && /\d/.test(formula[i])) { numStr += formula[i]; i++; }
                            const count = numStr ? parseInt(numStr) : 1;
                            const current = stack[stack.length - 1];
                            current.atoms[element] = (current.atoms[element] || 0) + count;
                        } else { i++; }
                    }

                    let mass = 0;
                    for (const [el, count] of Object.entries(stack[0].atoms)) {
                        if (AtomicMasses[el]) {
                            mass += AtomicMasses[el] * count;
                        } else {
                            throw new Error(`Unknown element: ${el}`);
                        }
                    }
                    return mass;
                } catch (e) {
                    throw e;
                }
            };

            const handleCalculate = () => {
                setError('');
                setResult(null);
                setSteps(null);

                const massA = parseFloat(substanceA.mass);
                const coeffA = parseFloat(substanceA.coeff);
                const coeffB = parseFloat(substanceB.coeff);
                
                if (isNaN(massA) || massA < 0) {
                    setError('Please enter a valid mass for Substance A.');
                    return;
                }
                if (isNaN(coeffA) || coeffA <= 0 || isNaN(coeffB) || coeffB <= 0) {
                    setError('Coefficients must be positive numbers.');
                    return;
                }

                try {
                    const mmA = calculateMolarMass(substanceA.formula.trim());
                    const mmB = calculateMolarMass(substanceB.formula.trim());

                    if (mmA === 0 || mmB === 0) {
                        setError('Please enter valid chemical formulas (e.g. Mg, O2, MgO).');
                        return;
                    }

                    // Step 1: Mass A -> Mole A
                    const moleA = massA / mmA;

                    // Step 2: Mole A -> Mole B (Mole Ratio)
                    const moleB = moleA * (coeffB / coeffA);

                    // Step 3: Mole B -> Mass B
                    const massB = moleB * mmB;

                    setResult(massB.toFixed(2));
                    setSteps({
                        massA, mmA, moleA,
                        coeffA, coeffB,
                        moleB, mmB, massB
                    });
                } catch (e) {
                    setError(`Formula Error: ${e.message}`);
                }
            };

            const loadExampleData = (ex) => {
                setSubstanceA({ formula: ex.a.f, coeff: ex.a.c, mass: ex.a.m.toString() });
                setSubstanceB({ formula: ex.b.f, coeff: ex.b.c });
                setError('');
                setResult(null);
                setSteps(null);
            };

            return (
                <div className="flex flex-col h-full container mx-auto px-4 py-6 max-w-5xl">
                    
                    {/* Header */}
                    <div className="flex justify-between items-center mb-6 border-b border-slate-800 pb-4">
                        <div>
                            <h1 className="text-2xl font-bold text-indigo-400 flex items-center gap-2">
                                <Icon name="Scale" /> Stoichiometry Calculator
                            </h1>
                            <p className="text-slate-500 text-sm">Mass-Mass Calculation Tool</p>
                        </div>
                        <button 
                            onClick={() => { setSubstanceA({...substanceA, mass: ''}); setResult(null); setSteps(null); }} 
                            className="px-4 py-2 bg-slate-800 text-slate-400 rounded-lg hover:bg-slate-700 hover:text-white font-bold text-sm flex items-center gap-2 transition-colors border border-slate-700"
                        >
                            <Icon name="RotateCcw" size={16} /> Reset
                        </button>
                    </div>

                    <div className="flex flex-col lg:flex-row gap-8 flex-grow">
                        
                        {/* Left: Input & Setup */}
                        <div className="w-full lg:w-5/12 flex flex-col gap-6">
                            
                            {/* Example Loader */}
                            <div className="bg-slate-900 p-4 rounded-2xl border border-slate-800 shadow-xl">
                                <div className="flex justify-between items-center mb-3">
                                    <h4 className="text-xs font-bold text-slate-400 uppercase flex items-center gap-2">
                                        <Icon name="Zap" size={14} /> Quick Load Preset
                                    </h4>
                                </div>
                                
                                {/* Category Dropdown */}
                                <div className="relative mb-3">
                                    <select 
                                        value={activeCategory}
                                        onChange={(e) => setActiveCategory(Number(e.target.value))}
                                        className="w-full p-2 pl-3 pr-8 bg-slate-800 border border-slate-700 rounded-lg text-indigo-400 font-bold text-sm appearance-none cursor-pointer focus:ring-2 focus:ring-indigo-500/50 outline-none transition-all"
                                    >
                                        {ExampleCategories.map((cat, idx) => (
                                            <option key={idx} value={idx}>{cat.name}</option>
                                        ))}
                                    </select>
                                    <div className="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-indigo-500">
                                        <Icon name="ChevronDown" size={16} />
                                    </div>
                                </div>
                                
                                <div className="flex gap-2 flex-wrap">
                                    {ExampleCategories[activeCategory].items.map((item, idx) => (
                                        <button 
                                            key={idx} 
                                            onClick={() => loadExampleData(item)}
                                            className="px-3 py-1.5 bg-slate-800 text-slate-300 rounded-lg border border-slate-700 hover:bg-indigo-900/30 hover:text-indigo-400 hover:border-indigo-500/50 text-xs font-bold transition-all shadow-sm"
                                        >
                                            {item.name.split(' ')[0]}
                                        </button>
                                    ))}
                                </div>
                            </div>

                            {/* Input Form */}
                            <div className="bg-slate-900 p-6 rounded-2xl shadow-xl border border-indigo-900/30">
                                <h3 className="text-lg font-bold mb-4 text-slate-300 flex items-center gap-2">
                                    <Icon name="Beaker" size={18} className="text-indigo-500"/> Input Data
                                </h3>

                                {/* Substance A (Known) */}
                                <div className="p-4 bg-blue-900/10 rounded-xl border border-blue-500/30 mb-4 relative input-focus-within transition-all">
                                    <div className="absolute -top-3 left-4 bg-blue-600 text-white px-2 py-0.5 rounded text-xs font-bold uppercase">Known Substance (A)</div>
                                    <div className="grid grid-cols-12 gap-3 items-end pt-2">
                                        <div className="col-span-3">
                                            <label className="text-xs font-bold text-blue-400 block mb-1">Coeff</label>
                                            <input 
                                                type="number" 
                                                value={substanceA.coeff} 
                                                onChange={(e) => setSubstanceA({...substanceA, coeff: e.target.value})} 
                                                className="w-full p-2 rounded text-center font-bold bg-slate-800 border border-slate-600 text-white outline-none focus:border-blue-500" 
                                            />
                                        </div>
                                        <div className="col-span-9">
                                            <label className="text-xs font-bold text-blue-400 block mb-1">Formula</label>
                                            <input 
                                                type="text" 
                                                value={substanceA.formula} 
                                                onChange={(e) => setSubstanceA({...substanceA, formula: e.target.value})} 
                                                className="w-full p-2 rounded bg-slate-800 border border-slate-600 text-white font-mono placeholder-slate-500 outline-none focus:border-blue-500" 
                                                placeholder="e.g. Mg"
                                            />
                                        </div>
                                        <div className="col-span-12">
                                            <label className="text-xs font-bold text-blue-400 block mb-1">Given Mass (g)</label>
                                            <input 
                                                type="number" 
                                                value={substanceA.mass} 
                                                onChange={(e) => setSubstanceA({...substanceA, mass: e.target.value})} 
                                                className="w-full p-3 rounded-lg border-2 border-blue-500/30 bg-slate-800 text-xl font-mono font-bold text-blue-200 outline-none focus:border-blue-500 transition-all" 
                                                placeholder="e.g. 4.86"
                                            />
                                        </div>
                                    </div>
                                </div>

                                <div className="flex justify-center -my-6 relative z-10">
                                    <div className="bg-slate-800 rounded-full p-2 border-4 border-slate-900">
                                        <Icon name="ArrowDown" className="text-slate-500" />
                                    </div>
                                </div>

                                {/* Substance B (Target) */}
                                <div className="p-4 bg-green-900/10 rounded-xl border border-green-500/30 mt-4 relative input-focus-within transition-all">
                                    <div className="absolute -top-3 left-4 bg-green-600 text-white px-2 py-0.5 rounded text-xs font-bold uppercase">Target Substance (B)</div>
                                    <div className="grid grid-cols-12 gap-3 items-end pt-2">
                                        <div className="col-span-3">
                                            <label className="text-xs font-bold text-green-400 block mb-1">Coeff</label>
                                            <input 
                                                type="number" 
                                                value={substanceB.coeff} 
                                                onChange={(e) => setSubstanceB({...substanceB, coeff: e.target.value})} 
                                                className="w-full p-2 rounded text-center font-bold bg-slate-800 border border-slate-600 text-white outline-none focus:border-green-500" 
                                            />
                                        </div>
                                        <div className="col-span-9">
                                            <label className="text-xs font-bold text-green-400 block mb-1">Formula</label>
                                            <input 
                                                type="text" 
                                                value={substanceB.formula} 
                                                onChange={(e) => setSubstanceB({...substanceB, formula: e.target.value})} 
                                                className="w-full p-2 rounded bg-slate-800 border border-slate-600 text-white font-mono placeholder-slate-500 outline-none focus:border-green-500" 
                                                placeholder="e.g. MgO"
                                            />
                                        </div>
                                    </div>
                                </div>

                                {error && (
                                    <div className="mt-4 p-3 bg-red-900/20 border border-red-500/50 text-red-400 rounded-lg text-sm font-bold flex items-center gap-2 animate-pulse">
                                        <Icon name="AlertCircle" size={16} /> {error}
                                    </div>
                                )}

                                <button 
                                    onClick={handleCalculate}
                                    className="mt-6 w-full py-4 bg-indigo-600 text-white font-bold rounded-xl shadow-lg hover:bg-indigo-500 transition-all active:scale-95 text-lg flex items-center justify-center gap-2"
                                >
                                    <Icon name="Calculator" /> Calculate Mass
                                </button>
                            </div>

                        </div>

                        {/* Right: Visual Steps & Result */}
                        <div className="w-full lg:w-7/12 flex flex-col gap-6">
                            
                            {result ? (
                                <div className="h-full flex flex-col animate-in slide-in-from-right duration-500">
                                    
                                    {/* Visualization Map */}
                                    <div className="bg-slate-800 rounded-2xl border border-slate-700 p-6 shadow-md mb-6 relative overflow-hidden">
                                        <h3 className="text-sm font-bold text-slate-400 uppercase mb-6 flex items-center gap-2">
                                            <Icon name="GitMerge" size={16} /> Calculation Map
                                        </h3>
                                        
                                        <div className="flex justify-between items-center relative z-10">
                                            {/* Step 1 */}
                                            <div className="flex flex-col items-center w-1/3">
                                                <div className="w-12 h-12 rounded-full bg-blue-900/50 text-blue-400 flex items-center justify-center border-2 border-blue-500/50 font-bold shadow-sm mb-2 text-xl">1</div>
                                                <div className="text-xs font-bold text-blue-400 mb-1">Mass A &rarr; Mole A</div>
                                                <div className="bg-slate-900 px-2 py-1 rounded border border-blue-900 text-xs font-mono text-blue-300 font-bold">
                                                    ÷ {steps.mmA.toFixed(1)}
                                                </div>
                                            </div>

                                            {/* Arrow 1 */}
                                            <div className="flex-grow h-1 bg-slate-700 relative">
                                                <div className="absolute inset-0 bg-gradient-to-r from-blue-500 to-purple-500 opacity-50 flow-line"></div>
                                            </div>

                                            {/* Step 2 */}
                                            <div className="flex flex-col items-center w-1/3">
                                                <div className="w-12 h-12 rounded-full bg-purple-900/50 text-purple-400 flex items-center justify-center border-2 border-purple-500/50 font-bold shadow-sm mb-2 text-xl">2</div>
                                                <div className="text-xs font-bold text-purple-400 mb-1">Mole Ratio</div>
                                                <div className="bg-slate-900 px-2 py-1 rounded border border-purple-900 text-xs font-mono text-purple-300 font-bold">
                                                    × ({steps.coeffB}/{steps.coeffA})
                                                </div>
                                            </div>

                                            {/* Arrow 2 */}
                                            <div className="flex-grow h-1 bg-slate-700 relative">
                                                <div className="absolute inset-0 bg-gradient-to-r from-purple-500 to-green-500 opacity-50 flow-line"></div>
                                            </div>

                                            {/* Step 3 */}
                                            <div className="flex flex-col items-center w-1/3">
                                                <div className="w-12 h-12 rounded-full bg-green-900/50 text-green-400 flex items-center justify-center border-2 border-green-500/50 font-bold shadow-sm mb-2 text-xl">3</div>
                                                <div className="text-xs font-bold text-green-400 mb-1">Mole B &rarr; Mass B</div>
                                                <div className="bg-slate-900 px-2 py-1 rounded border border-green-900 text-xs font-mono text-green-300 font-bold">
                                                    × {steps.mmB.toFixed(1)}
                                                </div>
                                            </div>
                                        </div>

                                        {/* Detailed Steps */}
                                        <div className="space-y-4 flex-grow mt-8">
                                            <div className="bg-slate-700/30 p-4 rounded-xl border-l-4 border-blue-500 shadow-sm step-card">
                                                <div className="flex justify-between items-start">
                                                    <div>
                                                        <div className="text-xs font-bold text-blue-400 uppercase mb-1">Step 1: Find Moles of {substanceA.formula}</div>
                                                        <div className="text-sm text-slate-400">
                                                            Mole = Mass / Molar Mass
                                                            <br/>
                                                            <span className="font-mono text-slate-500">= {steps.massA} / {steps.mmA.toFixed(1)}</span>
                                                        </div>
                                                    </div>
                                                    <div className="text-2xl font-mono font-bold text-blue-300">{steps.moleA.toFixed(4)} <span className="text-sm font-sans text-slate-500">mol</span></div>
                                                </div>
                                            </div>

                                            <div className="bg-slate-700/30 p-4 rounded-xl border-l-4 border-purple-500 shadow-sm step-card">
                                                <div className="flex justify-between items-start">
                                                    <div>
                                                        <div className="text-xs font-bold text-purple-400 uppercase mb-1">Step 2: Use Mole Ratio ({substanceA.coeff} : {substanceB.coeff})</div>
                                                        <div className="text-sm text-slate-400">
                                                            Mole {substanceB.formula} = Mole {substanceA.formula} × ({steps.coeffB}/{steps.coeffA})
                                                            <br/>
                                                            <span className="font-mono text-slate-500">= {steps.moleA.toFixed(4)} × {steps.coeffB/steps.coeffA}</span>
                                                        </div>
                                                    </div>
                                                    <div className="text-2xl font-mono font-bold text-purple-300">{steps.moleB.toFixed(4)} <span className="text-sm font-sans text-slate-500">mol</span></div>
                                                </div>
                                            </div>

                                            <div className="bg-slate-700/30 p-4 rounded-xl border-l-4 border-green-500 shadow-sm step-card">
                                                <div className="flex justify-between items-start">
                                                    <div>
                                                        <div className="text-xs font-bold text-green-400 uppercase mb-1">Step 3: Convert to Mass</div>
                                                        <div className="text-sm text-slate-400">
                                                            Mass = Mole × Molar Mass
                                                            <br/>
                                                            <span className="font-mono text-slate-500">= {steps.moleB.toFixed(4)} × {steps.mmB.toFixed(1)}</span>
                                                        </div>
                                                    </div>
                                                    <div className="text-4xl font-mono font-bold text-green-300">{result} <span className="text-lg font-sans text-slate-500">g</span></div>
                                                </div>
                                            </div>
                                        </div>

                                    </div>
                                </div>
                            ) : (
                                <div className="flex-grow flex flex-col items-center justify-center text-slate-500 border-4 border-dashed border-slate-700 rounded-3xl bg-slate-800/30 p-12 min-h-[400px]">
                                    <Icon name="Scale" size={64} className="mb-6 opacity-30" />
                                    <p className="text-xl text-center font-medium mb-2 text-slate-400">Waiting for Inputs...</p>
                                    <p className="text-sm text-center opacity-50">Enter mass and coefficients to calculate.</p>
                                </div>
                            )}

                        </div>
                    </div>
                    
                    <div className="text-center text-slate-600 text-xs mt-8 border-t border-slate-800 pt-4">
                        Luminous Learner International | IB/A-Level Chemistry
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
