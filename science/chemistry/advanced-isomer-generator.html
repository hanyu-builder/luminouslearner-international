<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IsoGen 3D - Advanced Isomer Explorer - LuminousLearner</title>
    
    <!-- React & Tailwind -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Three.js (For 3D Rendering) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- OrbitControls -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0F172A; color: #e2e8f0; margin: 0; overflow: hidden; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        canvas { outline: none; }
        
        .atom-legend {
             display: grid;
             grid-template-columns: repeat(auto-fit, minmax(70px, 1fr));
             gap: 0.5rem;
        }
    </style>
</head>
<body class="bg-[#0F172A] text-white min-h-screen flex flex-col">
    <div id="root" class="flex-grow flex flex-col"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- ATOM COLORS (CPK Naming) ---
        const ATOM_COLORS = {
            C: 0x808080, // Carbon - Grey (changed from 0x333333 for better visibility on dark background)
            H: 0xFFFFFF, // Hydrogen - White
            O: 0xFF0000, // Oxygen - Red
            N: 0x0000FF, // Nitrogen - Blue
            Cl: 0x00FF00, // Chlorine - Green
            Br: 0xA52A2A, // Bromine - Brown
            F: 0xFFFF00,  // Fluorine - Yellow
            Mirror: 0x88CCFF // Mirror plane
        };

        const ATOM_RADIUS = {
            C: 0.4, H: 0.25, O: 0.4, N: 0.4, Cl: 0.45, Br: 0.5, F: 0.35
        };

        const ATOM_NAMES = {
            C: 'Carbon', H: 'Hydrogen', O: 'Oxygen', N: 'Nitrogen', Cl: 'Chlorine', Br: 'Bromine', F: 'Fluorine'
        };

        // --- MOLECULE DATABASE (Internationalized) ---
        const MOLECULES = {
            structural: [
                {
                    formula: "C₄H₁₀",
                    name: "Butane Isomers (Chain/Position)",
                    variants: [
                        {
                            name: "n-Butane (Butane)",
                            atoms: [
                                { el: 'C', x: -2.2, y: 0, z: 0 }, { el: 'C', x: -0.7, y: 0.5, z: 0 },
                                { el: 'C', x: 0.7, y: -0.5, z: 0 }, { el: 'C', x: 2.2, y: 0, z: 0 },
                                { el: 'H', x: -2.2, y: -1.1, z: 0 }, { el: 'H', x: -2.7, y: 0.4, z: 0.9 }, { el: 'H', x: -2.7, y: 0.4, z: -0.9 },
                                { el: 'H', x: 2.2, y: 1.1, z: 0 }, { el: 'H', x: 2.7, y: -0.4, z: 0.9 }, { el: 'H', x: 2.7, y: -0.4, z: -0.9 },
                                { el: 'H', x: -0.7, y: 1.5, z: 0 }, { el: 'H', x: -0.7, y: 0.5, z: 1.1 },
                                { el: 'H', x: 0.7, y: -1.5, z: 0 }, { el: 'H', x: 0.7, y: -0.5, z: 1.1 }
                            ],
                            bonds: [[0,1], [1,2], [2,3]] // Note: H bonds are simplified in 3D for visualization
                        },
                        {
                            name: "Isobutane (2-methylpropane)",
                            atoms: [
                                { el: 'C', x: 0, y: 0, z: 0 }, // Central
                                { el: 'C', x: 0, y: 1.5, z: 0 }, // Top
                                { el: 'C', x: -1.3, y: -0.8, z: 0.8 }, // Left
                                { el: 'C', x: 1.3, y: -0.8, z: -0.8 }, // Right
                            ],
                            bonds: [[0,1], [0,2], [0,3]]
                        }
                    ]
                },
                {
                    formula: "C₂H₆O",
                    name: "Functional Group Isomers",
                    variants: [
                        {
                            name: "Ethanol (Alcohol)",
                            atoms: [
                                { el: 'C', x: -1.0, y: 0, z: 0 }, { el: 'C', x: 0.5, y: 0, z: 0 },
                                { el: 'O', x: 1.8, y: 0, z: 0 }, { el: 'H', x: 2.5, y: 0, z: 0 } 
                            ],
                            bonds: [[0,1], [1,2], [2,3]]
                        },
                        {
                            name: "Methoxymethane (Ether)",
                            atoms: [
                                { el: 'C', x: -1.5, y: 0.5, z: 0 }, 
                                { el: 'O', x: 0, y: 0, z: 0 }, 
                                { el: 'C', x: 1.5, y: 0.5, z: 0 }
                            ],
                            bonds: [[0,1], [1,2]]
                        }
                    ]
                }
            ],
            cistrans: [
                {
                    formula: "C₂H₂Cl₂",
                    name: "1,2-Dichloroethene (Geometric)",
                    variants: [
                        {
                            name: "Cis-1,2-dichloroethene",
                            atoms: [
                                { el: 'C', x: -0.7, y: 0, z: 0 }, { el: 'C', x: 0.7, y: 0, z: 0 },
                                { el: 'Cl', x: -1.5, y: 1.5, z: 0 }, { el: 'Cl', x: 1.5, y: 1.5, z: 0 }, // Both Up
                                { el: 'H', x: -1.5, y: -1.0, z: 0 }, { el: 'H', x: 1.5, y: -1.0, z: 0 }
                            ],
                            bonds: [[0,1, 2], [0,2], [1,3], [0,4], [1,5]] // index 2 indicates double bond
                        },
                        {
                            name: "Trans-1,2-dichloroethene",
                            atoms: [
                                { el: 'C', x: -0.7, y: 0, z: 0 }, { el: 'C', x: 0.7, y: 0, z: 0 },
                                { el: 'Cl', x: -1.5, y: 1.5, z: 0 }, { el: 'H', x: 1.5, y: 1.5, z: 0 }, // Up: Cl, H
                                { el: 'H', x: -1.5, y: -1.0, z: 0 }, { el: 'Cl', x: 1.5, y: -1.0, z: 0 } // Down: H, Cl
                            ],
                            bonds: [[0,1, 2], [0,2], [1,5], [0,4], [1,3]]
                        }
                    ]
                }
            ],
            enantiomers: [
                {
                    formula: "C₃H₆O₃",
                    name: "Lactic Acid (Optical)",
                    note: "Chiral Center required (C bonded to 4 different groups)",
                    variants: [
                        {
                            name: "R-Lactic Acid",
                            atoms: [
                                { el: 'C', x: 0, y: 0, z: 0 }, // Chiral C
                                { el: 'H', x: 0, y: 1.2, z: 0 },
                                { el: 'C', x: 1.1, y: -0.5, z: 0 }, // Methyl
                                { el: 'O', x: -0.8, y: -0.5, z: 0.9 }, // Alcohol O
                                { el: 'C', x: -0.8, y: -0.5, z: -0.9 } // COOH C
                            ],
                            bonds: [[0,1], [0,2], [0,3], [0,4]]
                        },
                        {
                            name: "S-Lactic Acid (Mirror Image)",
                            atoms: [
                                { el: 'C', x: 0, y: 0, z: 0 },
                                { el: 'H', x: 0, y: 1.2, z: 0 },
                                { el: 'C', x: -1.1, y: -0.5, z: 0 }, // Flipped Methyl
                                { el: 'O', x: 0.8, y: -0.5, z: 0.9 }, // Flipped Alcohol O
                                { el: 'C', x: 0.8, y: -0.5, z: -0.9 } // Flipped COOH C
                            ],
                            bonds: [[0,1], [0,2], [0,3], [0,4]]
                        }
                    ]
                }
            ]
        };

        const Icon = ({ name, className = "", size = 20 }) => {
            useEffect(() => { if (window.lucide) window.lucide.createIcons(); });
            return <i data-lucide={name} className={className}></i>;
        };

        // --- 3D VIEWER COMPONENT ---
        const MoleculeViewer = ({ moleculeData, showMirror }) => {
            const mountRef = useRef(null);
            const sceneRef = useRef(null);
            const rendererRef = useRef(null);
            const frameIdRef = useRef(null);

            useEffect(() => {
                if (!mountRef.current) return;

                // 1. Setup Scene
                const width = mountRef.current.clientWidth;
                const height = mountRef.current.clientHeight;
                
                // Clear previous elements if re-rendering
                if (rendererRef.current) {
                    mountRef.current.removeChild(rendererRef.current.domElement);
                    rendererRef.current = null;
                }
                
                const scene = new THREE.Scene();
                scene.background = new THREE.Color(0x1e293b); // Slate 800
                sceneRef.current = scene;

                // Camera
                const camera = new THREE.PerspectiveCamera(45, width / height, 0.1, 100);
                camera.position.set(0, 2, 8);

                // Renderer
                const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                renderer.setSize(width, height);
                mountRef.current.appendChild(renderer.domElement);
                rendererRef.current = renderer;

                // Controls
                const controls = new THREE.OrbitControls(camera, renderer.domElement);
                controls.enableDamping = true;
                controls.dampingFactor = 0.05;

                // Lights
                const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
                scene.add(ambientLight);
                const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
                dirLight.position.set(5, 10, 7);
                scene.add(dirLight);

                // --- RENDER LOGIC ---
                const renderMolecule = (mol, offsetX = 0, isMirror = false) => {
                    const group = new THREE.Group();
                    
                    // Atoms
                    mol.atoms.forEach(atom => {
                        const geometry = new THREE.SphereGeometry(ATOM_RADIUS[atom.el] || 0.3, 32, 32);
                        const material = new THREE.MeshPhysicalMaterial({ 
                            color: ATOM_COLORS[atom.el] || 0xcccccc,
                            metalness: 0.1,
                            roughness: 0.3,
                            clearcoat: 0.8
                        });
                        const sphere = new THREE.Mesh(geometry, material);
                        sphere.position.set(atom.x + offsetX, atom.y, atom.z);
                        group.add(sphere);
                    });

                    // Bonds
                    mol.bonds.forEach(bond => {
                        const startAtom = mol.atoms[bond[0]];
                        const endAtom = mol.atoms[bond[1]];
                        const isDouble = bond[2] === 2;

                        const start = new THREE.Vector3(startAtom.x + offsetX, startAtom.y, startAtom.z);
                        const end = new THREE.Vector3(endAtom.x + offsetX, endAtom.y, endAtom.z);
                        const distance = start.distanceTo(end);
                        
                        const cylinderMat = new THREE.MeshStandardMaterial({ color: 0x888888 });
                        
                        // Handle single vs double bond visualization
                        if (isDouble) {
                             // Simplified double bond visual
                             const doubleGeo = new THREE.CylinderGeometry(0.12, 0.12, distance, 12);
                             const bondMesh = new THREE.Mesh(doubleGeo, cylinderMat);
                             bondMesh.position.copy(start).lerp(end, 0.5);
                             bondMesh.lookAt(end);
                             bondMesh.rotateX(Math.PI / 2);
                             group.add(bondMesh);
                        } else {
                            const cylinderGeo = new THREE.CylinderGeometry(0.08, 0.08, distance, 12);
                            const bondMesh = new THREE.Mesh(cylinderGeo, cylinderMat);
                            bondMesh.position.copy(start).lerp(end, 0.5);
                            bondMesh.lookAt(end);
                            bondMesh.rotateX(Math.PI / 2);
                            group.add(bondMesh);
                        }
                    });

                    scene.add(group);
                };

                // Clear scene contents (excluding lights)
                const objectsToRemove = scene.children.filter(obj => obj !== ambientLight && obj !== dirLight);
                objectsToRemove.forEach(obj => scene.remove(obj));

                // Render Current Molecule
                renderMolecule(moleculeData);

                // Render Mirror Image if requested (Enantiomers only)
                if (showMirror) {
                    const PLANE_X = 3;
                    
                    // 1. Mirror Plane
                    const planeGeo = new THREE.PlaneGeometry(6, 6);
                    const planeMat = new THREE.MeshPhysicalMaterial({ 
                        color: ATOM_COLORS.Mirror, 
                        side: THREE.DoubleSide, 
                        transparent: true, 
                        opacity: 0.2, 
                        metalness: 0.5, 
                        roughness: 0.1 
                    });
                    const plane = new THREE.Mesh(planeGeo, planeMat);
                    plane.position.set(PLANE_X, 0, 0);
                    plane.rotateY(Math.PI / 2);
                    scene.add(plane);

                    // 2. Mirror Molecule (Reflect moleculeData across PLANE_X)
                    const mirrorAtoms = moleculeData.atoms.map(a => ({
                        ...a,
                        x: 2 * PLANE_X - a.x // Reflection formula: x' = 2*planeX - x
                    }));
                    
                    renderMolecule({ ...moleculeData, atoms: mirrorAtoms });
                }

                // Animation Loop
                const animate = () => {
                    frameIdRef.current = requestAnimationFrame(animate);
                    controls.update();
                    renderer.render(scene, camera);
                };
                animate();

                // Cleanup
                return () => {
                    cancelAnimationFrame(frameIdRef.current);
                    if (mountRef.current && rendererRef.current) {
                        mountRef.current.removeChild(rendererRef.current.domElement);
                        rendererRef.current.dispose();
                    }
                };
            }, [moleculeData, showMirror]);

            return <div ref={mountRef} className="w-full h-full" />;
        };

        const App = () => {
            const [mode, setMode] = useState('structural'); 
            const [groupIndex, setGroupIndex] = useState(0);
            const [variantIndex, setVariantIndex] = useState(0);
            const [showMirror, setShowMirror] = useState(false);

            // Ensure valid index access
            const currentModeMolecules = MOLECULES[mode] || MOLECULES.structural;
            const currentGroup = currentModeMolecules[groupIndex] || currentModeMolecules[0];
            const currentVariant = currentGroup.variants[variantIndex] || currentGroup.variants[0];

            // Reset when mode changes
            useEffect(() => {
                setGroupIndex(0);
                setVariantIndex(0);
                setShowMirror(false);
            }, [mode]);

            // Reset variant when group changes
            useEffect(() => {
                setVariantIndex(0);
                setShowMirror(false);
            }, [groupIndex]);

            // Adjust Mirror Visibility
            useEffect(() => {
                if (mode !== 'enantiomers') {
                    setShowMirror(false);
                }
            }, [mode]);


            return (
                <div className="min-h-screen flex flex-col md:flex-row bg-[#0F172A] text-white">
                    
                    {/* Sidebar Controls */}
                    <div className="w-full md:w-80 bg-slate-800 border-r border-slate-700 p-6 flex flex-col gap-6 z-10 shadow-xl overflow-y-auto min-h-screen">
                        
                        <div className="flex-shrink-0">
                            <div className="flex items-center gap-2 mb-6">
                                <div className="p-2 bg-emerald-500 rounded-lg"><Icon name="Box" className="w-6 h-6 text-white"/></div>
                                <h1 className="text-xl font-bold tracking-tight">IsoGen 3D</h1>
                            </div>
                            
                            {/* Mode Select */}
                            <label className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 block">Isomerism Type</label>
                            <div className="grid grid-cols-1 gap-2 mb-6">
                                {Object.keys(MOLECULES).map(m => (
                                    <button 
                                        key={m}
                                        onClick={() => setMode(m)} 
                                        className={`px-4 py-3 rounded-xl font-bold text-left flex items-center gap-3 transition-all ${mode === m ? 'bg-indigo-600 shadow-lg shadow-indigo-500/20' : 'bg-slate-700 hover:bg-slate-600 text-slate-300'}`}
                                    >
                                        <Icon name={m === 'structural' ? "Share2" : m === 'cistrans' ? "FlipHorizontal" : "Copy"} className="w-5 h-5"/> {m.charAt(0).toUpperCase() + m.slice(1)} Isomerism
                                    </button>
                                ))}
                            </div>

                            {/* Molecule Select */}
                            <label className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 block">Select Molecule</label>
                            <select 
                                className="w-full bg-slate-900 border border-slate-600 rounded-xl p-3 mb-6 outline-none focus:border-emerald-500 font-mono text-sm"
                                value={groupIndex}
                                onChange={(e) => { setGroupIndex(Number(e.target.value)); }}
                            >
                                {currentModeMolecules.map((m, i) => (
                                    <option key={i} value={i}>{m.formula} - {m.name}</option>
                                ))}
                            </select>

                            {/* Variant Toggles */}
                            <label className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 block">Select Isomer</label>
                            <div className="flex flex-col gap-2">
                                {currentGroup.variants.map((v, i) => (
                                    <button 
                                        key={i}
                                        onClick={() => setVariantIndex(i)}
                                        className={`p-3 rounded-xl text-sm font-bold border-2 text-left transition-all ${variantIndex === i ? 'border-emerald-500 bg-emerald-500/10 text-emerald-400' : 'border-slate-600 bg-slate-700 text-slate-300 hover:border-slate-500'}`}
                                    >
                                        {v.name}
                                    </button>
                                ))}
                            </div>
                        </div>

                        {/* Special Controls (Enantiomers) */}
                        {mode === 'enantiomers' && (
                            <div className="p-4 bg-slate-700 rounded-xl border border-slate-600 mt-4">
                                <div className="text-xs font-bold text-yellow-400 uppercase mb-2 flex items-center gap-2">
                                    <Icon name="AlertTriangle" className="w-4 h-4"/> Optical Isomerism
                                </div>
                                <p className="text-xs text-slate-300 mb-3">{currentGroup.note}</p>
                                <button 
                                    onClick={() => setShowMirror(!showMirror)}
                                    className={`w-full px-4 py-2 rounded-lg font-bold shadow-md flex items-center justify-center gap-2 transition-all ${showMirror ? 'bg-purple-600 text-white' : 'bg-slate-500 text-white hover:bg-slate-400'}`}
                                >
                                    <Icon name="Layers" className="w-5 h-5"/> {showMirror ? 'Hide Mirror Plane' : 'Show Mirror Plane'}
                                </button>
                            </div>
                        )}

                        {/* Legend */}
                        <div className="mt-auto pt-6 border-t border-slate-700">
                            <div className="text-xs font-bold text-slate-500 mb-3">Atom Color Key (CPK)</div>
                            <div className="atom-legend">
                                {Object.keys(ATOM_NAMES).map(key => (
                                    <span key={key} className="flex items-center gap-1 text-[10px] text-slate-400">
                                        <span className="w-3 h-3 rounded-full border border-slate-600" style={{ backgroundColor: `#${ATOM_COLORS[key].toString(16).padStart(6, '0')}` }}></span> {key} ({ATOM_NAMES[key]})
                                    </span>
                                ))}
                            </div>
                        </div>
                    </div>

                    {/* Main 3D View */}
                    <div className="flex-1 relative bg-slate-900 overflow-hidden">
                        <div className="absolute top-6 left-6 z-10 pointer-events-none">
                            <h2 className="text-3xl font-black text-white drop-shadow-lg">{currentVariant.name}</h2>
                            <p className="text-emerald-400 font-mono mt-1 text-lg">{currentGroup.formula}</p>
                        </div>
                        
                        <MoleculeViewer moleculeData={currentVariant} showMirror={showMirror} />
                        
                        <div className="absolute bottom-6 right-6 text-slate-600 text-xs pointer-events-none">
                            Click & Drag to Rotate • Scroll to Zoom
                        </div>
                    </div>

                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
