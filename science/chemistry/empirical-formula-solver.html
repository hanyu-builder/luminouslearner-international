<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Empirical Formula Solver - LuminousLearner International</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=JetBrains+Mono:wght@400;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0F172A; color: #e2e8f0; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        
        .step-card { transition: all 0.3s ease; }
        .step-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        
        /* Input Focus */
        input:focus {
            box-shadow: 0 0 0 3px rgba(45, 212, 191, 0.3); /* Teal-400 */
            border-color: #2dd4bf;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <div id="root" class="flex-grow flex flex-col"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Expanded Atomic Masses (Internationalized)
        const AtomicMasses = {
            H: 1.0, He: 4.0, Li: 6.9, Be: 9.0, B: 10.8, C: 12.0, N: 14.0, O: 16.0, F: 19.0, Ne: 20.2,
            Na: 23.0, Mg: 24.3, Al: 27.0, Si: 28.1, P: 31.0, S: 32.1, Cl: 35.5, K: 39.1, Ar: 39.9, Ca: 40.1,
            Fe: 55.8, Cu: 63.5, Zn: 65.4, Br: 79.9, Ag: 107.9, I: 126.9, Ba: 137.3, Pb: 207.2, Hg: 200.6,
            Au: 197.0, Mn: 54.9, Cr: 52.0, Sn: 118.7
        };

        const Icon = ({ name, size = 20, className = "" }) => {
            const [svg, setSvg] = useState('');
            useEffect(() => {
                if (window.lucide) {
                    const iconNode = window.lucide.icons[name];
                    if (iconNode) {
                        const iconSvg = window.lucide.createElement(iconNode);
                        iconSvg.setAttribute('width', size);
                        iconSvg.setAttribute('height', size);
                        iconSvg.setAttribute('class', className);
                        setSvg(iconSvg.outerHTML);
                    }
                }
            }, [name, size, className]);
            return <span dangerouslySetInnerHTML={{ __html: svg }} className="flex items-center" />;
        };

        const App = () => {
            const [elements, setElements] = useState([
                { id: 1, symbol: '', mass: '' },
                { id: 2, symbol: '', mass: '' }
            ]);
            const [result, setResult] = useState(null);
            const [error, setError] = useState('');
            const [steps, setSteps] = useState(null);

            const handleInputChange = (id, field, value) => {
                setElements(prev => prev.map(el => 
                    el.id === id ? { ...el, [field]: value } : el
                ));
            };

            const addElement = () => {
                const newId = elements.length > 0 ? Math.max(...elements.map(e => e.id)) + 1 : 1;
                setElements([...elements, { id: newId, symbol: '', mass: '' }]);
            };

            const removeElement = (id) => {
                if (elements.length > 1) {
                    setElements(elements.filter(e => e.id !== id));
                }
            };

            const calculate = () => {
                setError('');
                setResult(null);
                setSteps(null);

                // Validation
                const validElements = elements.filter(e => e.symbol && e.mass);
                if (validElements.length < 1) {
                    setError('Please enter data for at least one element.');
                    return;
                }

                try {
                    // Step 1: Calculate Moles
                    const moleData = validElements.map(e => {
                        const sym = e.symbol.trim(); 
                        // Try to find atomic mass (case insensitive search)
                        const lookupSym = Object.keys(AtomicMasses).find(k => k.toLowerCase() === sym.toLowerCase());
                        const atomicMass = lookupSym ? AtomicMasses[lookupSym] : null;
                        
                        if (!atomicMass) throw new Error(`Unknown element symbol: ${sym}`);

                        const massVal = parseFloat(e.mass);
                        if (isNaN(massVal) || massVal <= 0) throw new Error(`Invalid mass value: ${e.mass}`);

                        const moles = massVal / atomicMass;
                        return { symbol: lookupSym, mass: massVal, atomicMass, moles }; 
                    });

                    // Step 2: Divide by Smallest
                    const minMole = Math.min(...moleData.map(d => d.moles));
                    const ratioData = moleData.map(d => ({
                        ...d,
                        rawRatio: d.moles / minMole
                    }));

                    // Step 3: Find Simplest Integer Ratio
                    let multiplier = 1;
                    const fractions = ratioData.map(d => d.rawRatio % 1);
                    
                    const isClose = (val, target) => Math.abs(val - target) < 0.1 || Math.abs(val - target) > 0.9;
                    
                    if (fractions.some(f => isClose(f, 0.5))) multiplier = 2;
                    else if (fractions.some(f => isClose(f, 0.33) || isClose(f, 0.67))) multiplier = 3;
                    else if (fractions.some(f => isClose(f, 0.25) || isClose(f, 0.75))) multiplier = 4;
                    
                    // Just in case, try up to 6
                    for (let m = 1; m <= 6; m++) {
                         const allIntegers = ratioData.every(d => {
                             const val = d.rawRatio * m;
                             return Math.abs(val - Math.round(val)) < 0.1;
                          });
                          if (allIntegers) {
                              multiplier = m;
                              break;
                          }
                    }

                    const finalData = ratioData.map(d => ({
                        ...d,
                        intRatio: Math.round(d.rawRatio * multiplier)
                    }));

                    // Construct Formula
                    let formula = '';
                    finalData.forEach(d => {
                        formula += d.symbol;
                        if (d.intRatio > 1) formula += `<sub>${d.intRatio}</sub>`;
                    });

                    setResult(formula);
                    setSteps({ moleData, minMole, ratioData, multiplier, finalData });

                } catch (err) {
                    setError(err.message);
                }
            };

            const clear = () => {
                setElements([
                    { id: 1, symbol: '', mass: '' },
                    { id: 2, symbol: '', mass: '' }
                ]);
                setResult(null);
                setSteps(null);
                setError('');
            };

            // Example Loader
            const loadExample = (type) => {
                if (type === 'water') {
                    setElements([
                        { id: 1, symbol: 'H', mass: '11.1' },
                        { id: 2, symbol: 'O', mass: '88.9' }
                    ]);
                } else if (type === 'glucose') {
                    setElements([
                        { id: 1, symbol: 'C', mass: '40.0' },
                        { id: 2, symbol: 'H', mass: '6.7' },
                        { id: 3, symbol: 'O', mass: '53.3' }
                    ]);
                } else if (type === 'iron_oxide') {
                    setElements([
                        { id: 1, symbol: 'Fe', mass: '70.0' },
                        { id: 2, symbol: 'O', mass: '30.0' }
                    ]);
                }
                setResult(null);
                setSteps(null);
                setError('');
            };

            return (
                <div className="flex flex-col h-full container mx-auto px-4 py-6 max-w-5xl">
                    
                    {/* Header */}
                    <div className="flex justify-between items-center mb-6 border-b border-slate-700 pb-4">
                        <div>
                            <h1 className="text-2xl font-bold text-teal-400 flex items-center gap-2">
                                <Icon name="FlaskConical" /> Empirical Formula Solver
                            </h1>
                            <p className="text-slate-400 text-sm">Calculate Formulas from Mass or % Composition</p>
                        </div>
                        <button onClick={clear} className="px-4 py-2 bg-slate-800 text-slate-400 rounded-lg hover:bg-slate-700 hover:text-white font-bold text-sm flex items-center gap-2 transition-colors border border-slate-700">
                            <Icon name="RotateCcw" size={16} /> Clear
                        </button>
                    </div>

                    <div className="flex flex-col lg:flex-row gap-8 flex-grow">
                        
                        {/* Left: Input Area */}
                        <div className="w-full lg:w-5/12 flex flex-col gap-4">
                            
                            <div className="bg-slate-900 p-6 rounded-2xl shadow-xl border border-slate-800">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-lg font-bold text-slate-300 flex items-center gap-2">
                                        <Icon name="Table2" /> Input Data
                                    </h3>
                                    <div className="flex gap-2">
                                        <button onClick={() => loadExample('water')} className="text-xs bg-blue-900/30 text-blue-400 px-2 py-1 rounded border border-blue-800 hover:bg-blue-900/50">Water</button>
                                        <button onClick={() => loadExample('iron_oxide')} className="text-xs bg-orange-900/30 text-orange-400 px-2 py-1 rounded border border-orange-800 hover:bg-orange-900/50">Rust</button>
                                        <button onClick={() => loadExample('glucose')} className="text-xs bg-green-900/30 text-green-400 px-2 py-1 rounded border border-green-800 hover:bg-green-900/50">Glucose</button>
                                    </div>
                                </div>

                                <div className="space-y-3">
                                    <div className="grid grid-cols-12 gap-2 text-xs font-bold text-slate-500 uppercase px-2">
                                        <div className="col-span-4">Symbol</div>
                                        <div className="col-span-6">Mass / %</div>
                                        <div className="col-span-2"></div>
                                    </div>
                                    
                                    {elements.map((el) => (
                                        <div key={el.id} className="grid grid-cols-12 gap-2 items-center p-2 bg-slate-800 rounded-lg border border-slate-700">
                                            <div className="col-span-4">
                                                <input 
                                                    type="text" 
                                                    placeholder="e.g. Cu"
                                                    value={el.symbol}
                                                    onChange={(e) => handleInputChange(el.id, 'symbol', e.target.value)}
                                                    className="w-full p-2 bg-slate-900 border border-slate-600 rounded text-white font-mono focus:border-teal-500 outline-none"
                                                />
                                            </div>
                                            <div className="col-span-6">
                                                <input 
                                                    type="number" 
                                                    placeholder="e.g. 80.0"
                                                    value={el.mass}
                                                    onChange={(e) => handleInputChange(el.id, 'mass', e.target.value)}
                                                    className="w-full p-2 bg-slate-900 border border-slate-600 rounded text-white font-mono focus:border-teal-500 outline-none"
                                                />
                                            </div>
                                            <div className="col-span-2 flex justify-center">
                                                {elements.length > 1 && (
                                                    <button 
                                                        onClick={() => removeElement(el.id)}
                                                        className="text-red-400 hover:text-red-300 p-1 rounded hover:bg-red-900/20 transition-colors"
                                                    >
                                                        <Icon name="Trash2" size={18} />
                                                    </button>
                                                )}
                                            </div>
                                        </div>
                                    ))}
                                </div>

                                <button 
                                    onClick={addElement}
                                    className="mt-4 w-full py-2 border-2 border-dashed border-slate-600 text-slate-400 rounded-lg hover:border-teal-500 hover:text-teal-400 transition-all font-bold text-sm flex items-center justify-center gap-2"
                                >
                                    <Icon name="Plus" size={16} /> Add Element
                                </button>

                                {error && (
                                    <div className="mt-4 p-3 bg-red-900/20 border border-red-500/50 text-red-400 rounded-lg text-sm font-bold flex items-center gap-2 animate-pulse">
                                        <Icon name="AlertTriangle" size={16} /> {error}
                                    </div>
                                )}

                                <button 
                                    onClick={calculate}
                                    className="mt-6 w-full py-4 bg-teal-600 text-white font-bold rounded-xl shadow-lg hover:bg-teal-500 transition-all active:scale-95 text-lg flex items-center justify-center gap-2"
                                >
                                    <Icon name="Calculator" /> Calculate Formula
                                </button>
                            </div>
                            
                            <div className="bg-teal-900/20 p-4 rounded-xl border border-teal-500/30 text-sm text-teal-200">
                                <h4 className="font-bold mb-2 flex items-center gap-2 text-teal-400"><Icon name="Lightbulb" size={16}/> Tips</h4>
                                <ul className="list-disc list-inside space-y-1 opacity-80 text-xs">
                                    <li>Enter <strong>Mass (g)</strong> or <strong>Percentage (%)</strong>.</li>
                                    <li>If results are decimals (e.g., 1.5), the solver automatically multiplies to find the simplest whole number ratio.</li>
                                </ul>
                            </div>

                        </div>

                        {/* Right: Result Breakdown */}
                        <div className="w-full lg:w-7/12 flex flex-col gap-6">
                            
                            {result ? (
                                <div className="animate-in slide-in-from-right duration-500 h-full flex flex-col gap-6">
                                    
                                    {/* Result Card */}
                                    <div className="bg-slate-800 rounded-2xl p-6 shadow-xl text-white border border-slate-700 relative overflow-hidden">
                                        <div className="relative z-10">
                                            <div className="text-xs text-slate-400 font-bold uppercase mb-2 tracking-wider">Empirical Formula</div>
                                            <div className="text-6xl font-mono font-black text-teal-400 tracking-wider" dangerouslySetInnerHTML={{ __html: result }}></div>
                                        </div>
                                        <div className="absolute right-0 top-0 p-6 opacity-5">
                                            <Icon name="Microscope" size={120} />
                                        </div>
                                    </div>

                                    {/* Calculation Table */}
                                    <div className="bg-slate-800 rounded-2xl border border-slate-700 overflow-hidden shadow-lg flex-grow">
                                        <div className="bg-slate-900 p-4 border-b border-slate-700 font-bold text-slate-300 flex items-center gap-2">
                                            <Icon name="ListOrdered" size={18} /> Step-by-Step Calculation
                                        </div>
                                        
                                        <div className="overflow-x-auto">
                                            <table className="w-full text-sm text-left text-slate-300">
                                                <thead className="bg-slate-950 text-slate-400 uppercase font-bold text-xs border-b border-slate-700">
                                                    <tr>
                                                        <th className="p-3">Element</th>
                                                        <th className="p-3">Mass (m)</th>
                                                        <th className="p-3">A.R.M.</th>
                                                        <th className="p-3">Moles (n = m÷Ar)</th>
                                                        <th className="p-3">÷ Smallest</th>
                                                        <th className="p-3 text-right">Ratio</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="divide-y divide-slate-700/50">
                                                    {steps.moleData.map((d, idx) => (
                                                        <tr key={idx} className="hover:bg-slate-700/30 transition-colors">
                                                            <td className="p-3 font-bold text-teal-400 text-lg">{d.symbol}</td>
                                                            <td className="p-3 font-mono">{d.mass}</td>
                                                            <td className="p-3 text-slate-500 font-mono">{d.atomicMass}</td>
                                                            <td className="p-3 font-mono font-bold text-white">{d.moles.toFixed(3)}</td>
                                                            <td className="p-3 font-mono text-slate-400">
                                                                {d.moles.toFixed(3)} ÷ {steps.minMole.toFixed(3)} = <strong className="text-white">{steps.ratioData[idx].rawRatio.toFixed(2)}</strong>
                                                            </td>
                                                            <td className="p-3 text-right font-mono font-black text-xl text-teal-400">
                                                                {steps.finalData[idx].intRatio}
                                                            </td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>

                                        {steps.multiplier > 1 && (
                                            <div className="p-4 bg-yellow-900/20 border-t border-yellow-500/30 text-yellow-200 text-sm">
                                                <strong>Note:</strong> The initial ratio contained decimals (e.g. x.5 or x.33).
                                                We multiplied all values by <strong>{steps.multiplier}</strong> to get whole numbers.
                                            </div>
                                        )}
                                    </div>

                                </div>
                            ) : (
                                <div className="flex-grow flex flex-col items-center justify-center text-slate-500 border-4 border-dashed border-slate-700 rounded-3xl bg-slate-800/30 p-12 min-h-[400px]">
                                    <Icon name="BarChart2" size={64} className="mb-6 opacity-20" />
                                    <p className="text-xl text-center font-medium mb-2 text-slate-400">Waiting for Data...</p>
                                    <p className="text-sm text-center opacity-50">Enter mass or % composition on the left to calculate.</p>
                                </div>
                            )}

                        </div>
                    </div>
                    
                    <div className="text-center text-slate-600 text-xs mt-8 border-t border-slate-800 pt-4">
                        Luminous Learner International | IB/A-Level Chemistry
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
