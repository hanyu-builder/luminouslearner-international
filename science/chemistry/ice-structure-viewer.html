<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ice Structure Viewer - LuminousLearner International</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Load Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=JetBrains+Mono:wght@400;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0F172A; color: #e2e8f0; }
        
        #canvas-container {
            width: 100%;
            height: 100%;
            overflow: hidden;
            outline: none;
            background: radial-gradient(circle at center, #1e293b 0%, #0f172a 100%);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <div id="root" class="flex-grow flex flex-col"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const IceScene = ({ showHBonds, state }) => { // state: 'solid' or 'liquid'
            const mountRef = useRef(null);
            const sceneRef = useRef(null);
            const moleculesRef = useRef([]);
            const hBondsRef = useRef([]);
            const controlsRef = useRef(null);
            const frameIdRef = useRef(null);
            const rendererRef = useRef(null);

            useEffect(() => {
                // 1. Setup Scene
                const scene = new THREE.Scene();
                scene.fog = new THREE.FogExp2(0x0f172a, 0.03);
                sceneRef.current = scene;

                // 2. Camera
                const camera = new THREE.PerspectiveCamera(60, mountRef.current.clientWidth / mountRef.current.clientHeight, 0.1, 1000);
                camera.position.set(0, 5, 15);

                // 3. Renderer
                const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                renderer.setSize(mountRef.current.clientWidth, mountRef.current.clientHeight);
                renderer.setPixelRatio(window.devicePixelRatio);
                mountRef.current.appendChild(renderer.domElement);
                rendererRef.current = renderer;

                // 4. Lights
                const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
                scene.add(ambientLight);
                const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
                dirLight.position.set(10, 20, 10);
                scene.add(dirLight);
                const pointLight = new THREE.PointLight(0x38bdf8, 0.5);
                pointLight.position.set(-5, 0, 5);
                scene.add(pointLight);

                // 5. Controls
                const controls = new THREE.OrbitControls(camera, renderer.domElement);
                controls.enableDamping = true;
                controls.autoRotate = true;
                controls.autoRotateSpeed = 0.5;
                controlsRef.current = controls;

                // --- Materials & Geometries ---
                const geoO = new THREE.SphereGeometry(0.6, 32, 32);
                const matO = new THREE.MeshPhongMaterial({ color: 0xff4444, shininess: 80 }); // Red Oxygen
                
                const geoH = new THREE.SphereGeometry(0.35, 32, 32);
                const matH = new THREE.MeshPhongMaterial({ color: 0xffffff, shininess: 80 }); // White Hydrogen
                
                const geoBond = new THREE.CylinderGeometry(0.1, 0.1, 1, 8);
                const matBond = new THREE.MeshPhongMaterial({ color: 0x94a3b8 }); // Covalent Grey

                const matHBond = new THREE.LineDashedMaterial({ 
                    color: 0x38bdf8, // Cyan
                    dashSize: 0.2, 
                    gapSize: 0.1, 
                    linewidth: 2,
                    opacity: 0.6,
                    transparent: true
                });

                // --- Build Molecules ---
                const molecules = [];
                const hBondLines = [];
                
                const createWaterMolecule = (x, y, z, rotX=0, rotY=0, rotZ=0) => {
                    const group = new THREE.Group();
                    group.position.set(x, y, z);
                    group.rotation.set(rotX, rotY, rotZ);

                    // Oxygen
                    const meshO = new THREE.Mesh(geoO, matO);
                    group.add(meshO);

                    // Hydrogens (Bent shape ~104.5 deg)
                    const distOH = 0.95;
                    const angle = 104.5 * Math.PI / 180 / 2;
                    
                    const h1Pos = new THREE.Vector3(Math.sin(angle)*distOH, Math.cos(angle)*distOH, 0);
                    const h2Pos = new THREE.Vector3(-Math.sin(angle)*distOH, Math.cos(angle)*distOH, 0);
                    
                    const meshH1 = new THREE.Mesh(geoH, matH);
                    meshH1.position.copy(h1Pos);
                    group.add(meshH1);

                    const meshH2 = new THREE.Mesh(geoH, matH);
                    meshH2.position.copy(h2Pos);
                    group.add(meshH2);

                    // Covalent Bonds (O-H)
                    const bond1 = new THREE.Mesh(geoBond, matBond);
                    bond1.position.copy(h1Pos).multiplyScalar(0.5);
                    bond1.quaternion.setFromUnitVectors(new THREE.Vector3(0, 1, 0), h1Pos.clone().normalize());
                    bond1.scale.y = distOH;
                    group.add(bond1);

                    const bond2 = new THREE.Mesh(geoBond, matBond);
                    bond2.position.copy(h2Pos).multiplyScalar(0.5);
                    bond2.quaternion.setFromUnitVectors(new THREE.Vector3(0, 1, 0), h2Pos.clone().normalize());
                    bond2.scale.y = distOH;
                    group.add(bond2);
                    
                    // Store absolute positions for H-bond drawing
                    group.userData = { 
                        type: 'water',
                        h1Local: h1Pos, 
                        h2Local: h2Pos,
                        oLocal: new THREE.Vector3(0,0,0)
                    };

                    scene.add(group);
                    molecules.push(group);
                };

                // --- Generate Structure ---
                
                if (state === 'solid') {
                    // Ice Ih Structure (Simplified Hexagonal)
                    const r = 2.8; // distance between O-O
                    
                    // Layer 1 (Puckered Hexagon)
                    for(let i=0; i<6; i++) {
                        const angle = (i / 6) * Math.PI * 2;
                        const x = Math.cos(angle) * r;
                        const z = Math.sin(angle) * r;
                        const y = (i % 2 === 0) ? 0 : 1; 
                        
                        const rotX = Math.random() * 0.5; 
                        const rotY = angle + Math.PI/2;
                        
                        createWaterMolecule(x, y, z, rotX, rotY, 0);
                    }

                    // Layer 2 (Stacked directly above for channel view)
                    for(let i=0; i<6; i++) {
                        const angle = (i / 6) * Math.PI * 2;
                        const x = Math.cos(angle) * r;
                        const z = Math.sin(angle) * r;
                        const y = (i % 2 === 0) ? 4 : 5; // Shifted up
                        
                        createWaterMolecule(x, y, z, 0, angle + Math.PI/2, Math.PI); 
                    }
                    
                } else {
                    // Liquid Water (Random packing)
                    for(let i=0; i<15; i++) {
                        const x = (Math.random() - 0.5) * 6;
                        const y = (Math.random() - 0.5) * 6;
                        const z = (Math.random() - 0.5) * 6;
                        const rx = Math.random() * Math.PI;
                        const ry = Math.random() * Math.PI;
                        createWaterMolecule(x, y, z, rx, ry, 0);
                    }
                }
                
                moleculesRef.current = molecules;

                // 6. Animation & H-Bond Update Loop
                const animate = () => {
                    frameIdRef.current = requestAnimationFrame(animate);
                    controls.update();

                    // Update H-Bonds
                    hBondsRef.current.forEach(line => scene.remove(line));
                    hBondsRef.current = [];

                    if (showHBonds) {
                        const worldPositions = molecules.map(mol => {
                            mol.updateMatrixWorld();
                            const oPos = mol.userData.oLocal.clone().applyMatrix4(mol.matrixWorld);
                            const h1Pos = mol.userData.h1Local.clone().applyMatrix4(mol.matrixWorld);
                            const h2Pos = mol.userData.h2Local.clone().applyMatrix4(mol.matrixWorld);
                            return { mol, o: oPos, h: [h1Pos, h2Pos] };
                        });

                        for (let i = 0; i < worldPositions.length; i++) {
                            for (let j = 0; j < worldPositions.length; j++) {
                                if (i === j) continue;
                                const molA = worldPositions[i];
                                const molB = worldPositions[j];

                                const dist1 = molA.h[0].distanceTo(molB.o);
                                if (dist1 < 2.5 && dist1 > 1.2) addHBondLine(molA.h[0], molB.o);
                                
                                const dist2 = molA.h[1].distanceTo(molB.o);
                                if (dist2 < 2.5 && dist2 > 1.2) addHBondLine(molA.h[1], molB.o);
                            }
                        }
                    }
                    
                    // Liquid motion
                    if (state === 'liquid') {
                        molecules.forEach(mol => {
                            mol.position.y += Math.sin(Date.now() * 0.001 + mol.id) * 0.01;
                            mol.rotation.y += 0.005;
                        });
                    }

                    renderer.render(scene, camera);
                };

                const addHBondLine = (start, end) => {
                    const geometry = new THREE.BufferGeometry().setFromPoints([start, end]);
                    const line = new THREE.Line(geometry, matHBond);
                    line.computeLineDistances(); 
                    scene.add(line);
                    hBondsRef.current.push(line);
                };

                animate();

                // Cleanup
                return () => {
                    cancelAnimationFrame(frameIdRef.current);
                    if (mountRef.current && rendererRef.current) {
                         mountRef.current.removeChild(rendererRef.current.domElement);
                         rendererRef.current.dispose();
                    }
                };
            }, [showHBonds, state]);

            return <div ref={mountRef} id="canvas-container" />;
        };

        const Icon = ({ name, size = 20, className = "" }) => {
            const [svg, setSvg] = useState('');
            useEffect(() => {
                if (window.lucide) {
                    const iconNode = window.lucide.icons[name];
                    if (iconNode) {
                        const iconSvg = window.lucide.createElement(iconNode);
                        iconSvg.setAttribute('width', size);
                        iconSvg.setAttribute('height', size);
                        iconSvg.setAttribute('class', className);
                        setSvg(iconSvg.outerHTML);
                    }
                }
            }, [name, size, className]);
            return <span dangerouslySetInnerHTML={{ __html: svg }} className="flex items-center" />;
        };

        const App = () => {
            const [showHBonds, setShowHBonds] = useState(true);
            const [state, setState] = useState('solid'); // solid, liquid

            return (
                <div className="flex flex-col h-full container mx-auto px-4 py-6 max-w-6xl">
                    
                    {/* Header */}
                    <div className="flex justify-between items-center mb-6 border-b border-slate-700 pb-4">
                        <div>
                            <h1 className="text-3xl font-bold text-sky-400 flex items-center gap-2">
                                <Icon name="Snowflake" size={32} /> Ice Structure Viewer
                            </h1>
                            <p className="text-slate-400 text-sm">Visualizing Hydrogen Bonding & Open Structure</p>
                        </div>
                        
                        <div className="flex gap-3">
                            <div className="bg-slate-800 p-1 rounded-lg flex">
                                <button 
                                    onClick={() => setState('solid')}
                                    className={`px-4 py-2 rounded-md text-sm font-bold transition-all ${state === 'solid' ? 'bg-sky-600 text-white shadow' : 'text-slate-400 hover:text-white'}`}
                                >
                                    Solid Ice
                                </button>
                                <button 
                                    onClick={() => setState('liquid')}
                                    className={`px-4 py-2 rounded-md text-sm font-bold transition-all ${state === 'liquid' ? 'bg-blue-600 text-white shadow' : 'text-slate-400 hover:text-white'}`}
                                >
                                    Liquid Water
                                </button>
                            </div>
                            
                            <button 
                                onClick={() => setShowHBonds(!showHBonds)}
                                className={`px-4 py-2 rounded-lg border text-sm font-bold flex items-center gap-2 transition-all
                                    ${showHBonds ? 'bg-sky-900/50 border-sky-500 text-sky-300' : 'bg-slate-800 border-slate-600 text-slate-400'}
                                `}
                            >
                                {showHBonds ? <Icon name="Eye" size={16} /> : <Icon name="EyeOff" size={16} />}
                                Hydrogen Bonds
                            </button>
                        </div>
                    </div>

                    <div className="flex flex-col lg:flex-row gap-8 flex-grow">
                        
                        {/* 3D Viewport */}
                        <div className="w-full lg:w-3/4 h-[500px] lg:h-[650px] bg-slate-800 rounded-3xl border-4 border-slate-700 relative shadow-2xl overflow-hidden">
                            <IceScene showHBonds={showHBonds} state={state} key={state} />
                            
                            {/* Overlay Info */}
                            <div className="absolute bottom-6 right-6 flex flex-col gap-2 text-right pointer-events-none">
                                <div className="flex items-center justify-end gap-2">
                                    <span className="text-xs text-slate-300 font-bold">Hydrogen (H)</span>
                                    <div className="w-4 h-4 rounded-full bg-white border border-slate-500"></div>
                                </div>
                                <div className="flex items-center justify-end gap-2">
                                    <span className="text-xs text-slate-300 font-bold">Oxygen (O)</span>
                                    <div className="w-4 h-4 rounded-full bg-red-500 border border-red-700"></div>
                                </div>
                                <div className="flex items-center justify-end gap-2">
                                    <span className="text-xs text-sky-300 font-bold">Hydrogen Bond</span>
                                    <div className="w-8 h-0 border-t-2 border-dashed border-sky-400"></div>
                                </div>
                            </div>

                            {/* Hint */}
                            <div className="absolute top-4 left-4 text-xs text-slate-500 bg-black/40 px-3 py-2 rounded-lg backdrop-blur-sm">
                                <span className="flex items-center gap-2"><Icon name="Move" size={12} className="inline"/> Drag to Rotate</span>
                                <span className="flex items-center gap-2 mt-1"><Icon name="ZoomIn" size={12} className="inline"/> Scroll to Zoom</span>
                            </div>
                        </div>

                        {/* Info Panel */}
                        <div className="w-full lg:w-1/4 flex flex-col gap-6">
                            <div className="bg-slate-800 p-6 rounded-2xl border border-slate-700 shadow-lg flex-grow animate-in slide-in-from-right duration-500">
                                <div className="mb-6 border-b border-slate-700 pb-4">
                                    <div className="text-sm text-slate-400 uppercase font-bold mb-2 tracking-wider">
                                        Structure Type
                                    </div>
                                    <div className="text-3xl font-bold text-white leading-tight">
                                        {state === 'solid' ? 'Open Hexagonal Lattice' : 'Disordered Packing'}
                                    </div>
                                </div>
                                
                                <div className="space-y-6 text-sm text-slate-300 leading-relaxed">
                                    {state === 'solid' ? (
                                        <>
                                            <div className="p-4 bg-slate-900/50 rounded-xl border-l-4 border-sky-500 shadow-inner">
                                                <strong className="text-white block mb-2 text-base">1. Open Structure</strong>
                                                Each water molecule forms 4 hydrogen bonds in a <strong>tetrahedral</strong> arrangement. This creates large hexagonal channels with lots of <strong>empty space</strong>.
                                            </div>
                                            <div className="p-4 bg-slate-900/50 rounded-xl border-l-4 border-green-500">
                                                <strong className="text-white block mb-2 text-base">2. Low Density</strong>
                                                Because of the empty space, ice occupies more volume than the same mass of liquid water. This is why <strong>Ice Floats</strong>.
                                            </div>
                                        </>
                                    ) : (
                                        <>
                                            <div className="p-4 bg-slate-900/50 rounded-xl border-l-4 border-blue-500 shadow-inner">
                                                <strong className="text-white block mb-2 text-base">1. Broken Bonds</strong>
                                                In liquid water, molecules have enough energy to break some hydrogen bonds. Molecules can slide past each other.
                                            </div>
                                            <div className="p-4 bg-slate-900/50 rounded-xl border-l-4 border-yellow-500">
                                                <strong className="text-white block mb-2 text-base">2. Higher Density</strong>
                                                Without the rigid open framework, water molecules can pack closer together (filling the gaps), making liquid water denser than ice.
                                            </div>
                                        </>
                                    )}
                                </div>
                            </div>
                        </div>

                    </div>
                    
                    <div className="text-center text-slate-600 text-xs mt-8 border-t border-slate-800 pt-4">
                        Luminous Learner International | IB/A-Level Chemistry
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
