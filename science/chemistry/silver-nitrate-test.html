<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Halide Detective: Silver Nitrate Lab - LuminousLearner International</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=JetBrains+Mono:wght@400;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0F172A; color: #e2e8f0; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        
        /* Test Tube Liquid & Precipitate Animation */
        .liquid { transition: height 0.5s ease, background-color 0.5s ease; }
        
        /* Precipitate Texture */
        .precipitate {
            background-image: url("data:image/svg+xml,%3Csvg width='4' height='4' viewBox='0 0 4 4' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 3h1v1H1V3zm2-2h1v1H3V1z' fill='%23ffffff' fill-opacity='0.4' fill-rule='evenodd'/%3E%3C/svg%3E");
            backdrop-filter: blur(2px);
        }

        /* Formation Animation (Cloudy) */
        @keyframes form-ppt {
            0% { opacity: 0; transform: translateY(10px) scale(0.9); }
            100% { opacity: 1; transform: translateY(0) scale(1); }
        }
        .ppt-anim { animation: form-ppt 1s ease-out forwards; }

        /* Dissolve Animation */
        @keyframes dissolve {
            0% { opacity: 1; }
            100% { opacity: 0; }
        }
        .dissolve-anim { animation: dissolve 1s ease-out forwards; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <div id="root" class="flex-grow flex flex-col"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Sample Definitions (Hidden from user initially)
        const Samples = [
            { id: 'A', ion: 'Cl⁻', name: 'Chloride Ion', pptColor: 'bg-white', pptName: 'White Precipitate (AgCl)', solubility: 'dilute' },
            { id: 'B', ion: 'I⁻', name: 'Iodide Ion', pptColor: 'bg-yellow-200', pptName: 'Yellow Precipitate (AgI)', solubility: 'none' },
            { id: 'C', ion: 'F⁻', name: 'Fluoride Ion', pptColor: null, pptName: 'No Precipitate (AgF is soluble)', solubility: 'n/a' },
            { id: 'D', ion: 'Br⁻', name: 'Bromide Ion', pptColor: 'bg-amber-100', pptName: 'Cream Precipitate (AgBr)', solubility: 'conc' }
        ];

        const Icon = ({ name, size = 20, className = "" }) => {
            const [svg, setSvg] = useState('');
            useEffect(() => {
                if (window.lucide) {
                    const iconNode = window.lucide.icons[name];
                    if (iconNode) {
                        const iconSvg = window.lucide.createElement(iconNode);
                        iconSvg.setAttribute('width', size);
                        iconSvg.setAttribute('height', size);
                        iconSvg.setAttribute('class', className);
                        setSvg(iconSvg.outerHTML);
                    }
                }
            }, [name, size, className]);
            return <span dangerouslySetInnerHTML={{ __html: svg }} className="flex items-center" />;
        };

        const App = () => {
            // State
            const [currentSample, setCurrentSample] = useState(null);
            const [tubeState, setTubeState] = useState({
                acidified: false,
                hasSilver: false,
                ammoniaLevel: 0, // 0: none, 1: dilute, 2: conc
                pptVisible: false,
                volume: 10 // Initial volume %
            });
            const [history, setHistory] = useState([]);
            const [guess, setGuess] = useState(null); // User's guess
            const [result, setResult] = useState(null); // Feedback

            // Reset for new sample
            const selectSample = (sample) => {
                setCurrentSample(sample);
                setTubeState({
                    acidified: false,
                    hasSilver: false,
                    ammoniaLevel: 0,
                    pptVisible: false,
                    volume: 10
                });
                setGuess(null);
                setResult(null);
                setHistory([{ text: `Selected Unknown Sample ${sample.id}`, type: 'info' }]);
            };

            // Actions
            const addAcid = () => {
                if (!currentSample) return;
                setTubeState(prev => ({ ...prev, acidified: true, volume: Math.min(90, prev.volume + 10) }));
                setHistory(prev => [...prev, { text: 'Added Dilute Nitric Acid (HNO₃) - Acidified', type: 'action' }]);
            };

            const addSilver = () => {
                if (!currentSample) return;
                // Logic: Only form ppt if correct ion AND not already dissolved
                const formsPPT = currentSample.ion !== 'F⁻'; 
                
                setTubeState(prev => ({ 
                    ...prev, 
                    hasSilver: true, 
                    pptVisible: formsPPT,
                    volume: Math.min(90, prev.volume + 10) 
                }));
                
                if (currentSample.ion === 'F⁻') {
                    setHistory(prev => [...prev, { text: 'Added Silver Nitrate (AgNO₃) -> No visible change', type: 'obs' }]);
                } else {
                    setHistory(prev => [...prev, { text: `Added Silver Nitrate (AgNO₃) -> Precipitate formed`, type: 'obs' }]);
                }
            };

            const addAmmonia = (type) => {
                if (!currentSample || !tubeState.hasSilver) return;
                
                let newLevel = type === 'dilute' ? 1 : 2;
                let dissolves = false;

                // Solubility Logic
                if (currentSample.solubility === 'dilute' && newLevel >= 1) dissolves = true;
                if (currentSample.solubility === 'conc' && newLevel >= 2) dissolves = true;
                
                // Special case: If already dissolved, it stays dissolved
                if (!tubeState.pptVisible) dissolves = true; 
                // Re-check for F- (never had ppt)
                if (currentSample.ion === 'F⁻') dissolves = true; 

                setTubeState(prev => ({ 
                    ...prev, 
                    ammoniaaLevel: newLevel, 
                    pptVisible: !dissolves && prev.pptVisible, // If it dissolves, pptVisible becomes false
                    volume: Math.min(90, prev.volume + 15) 
                }));

                const reagentName = type === 'dilute' ? 'Dilute Ammonia (NH₃)' : 'Conc. Ammonia (NH₃)';
                const obsText = (dissolves && tubeState.pptVisible) ? 'Precipitate dissolves (Soluble)' : 'Precipitate remains (Insoluble)';
                
                if (currentSample.ion !== 'F⁻') {
                    setHistory(prev => [...prev, { text: `Added ${reagentName} -> ${obsText}`, type: 'obs' }]);
                } else {
                    setHistory(prev => [...prev, { text: `Added ${reagentName} -> No change`, type: 'obs' }]);
                }
            };

            const checkAnswer = (selectedIon) => {
                if (selectedIon === currentSample.ion) {
                    setResult({ correct: true, msg: `Correct! Sample ${currentSample.id} contains ${currentSample.name}.` });
                } else {
                    setResult({ correct: false, msg: `Incorrect. Look closely at the precipitate color and solubility.` });
                }
                setGuess(selectedIon);
            };

            // Get current visual color
            const getVisuals = () => {
                if (!currentSample) return { liquid: 'bg-transparent', ppt: null };
                
                // Base liquid is clear
                let liquidClass = 'bg-blue-50/10'; 
                let pptClass = null;

                if (tubeState.pptVisible) {
                    pptClass = currentSample.pptColor;
                    // If yellow ppt, liquid looks slightly yellow too
                    if (currentSample.ion === 'I⁻') liquidClass = 'bg-yellow-50/20';
                }

                return { liquid: liquidClass, ppt: pptClass };
            };

            const visuals = getVisuals();

            return (
                <div className="flex flex-col h-full container mx-auto px-4 py-6 max-w-6xl">
                    
                    {/* Header */}
                    <div className="flex justify-between items-center mb-6 border-b border-slate-700 pb-4">
                        <div>
                            <h1 className="text-2xl font-bold text-blue-400 flex items-center gap-2">
                                <Icon name="Search" /> Halide Detective: Silver Nitrate Lab
                            </h1>
                            <p className="text-slate-400 text-sm">Qualitative Analysis of Halides</p>
                        </div>
                        <div className="text-xs text-slate-500 bg-slate-800 px-3 py-1 rounded border border-slate-700">
                            Topic 15/26
                        </div>
                    </div>

                    {!currentSample ? (
                        /* Sample Selection Screen */
                        <div className="flex-grow flex flex-col justify-center items-center animate-in zoom-in duration-300">
                            <h2 className="text-xl font-bold text-slate-200 mb-8">Select an Unknown Sample to Analyze:</h2>
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-6">
                                {Samples.map(s => (
                                    <button 
                                        key={s.id}
                                        onClick={() => selectSample(s)}
                                        className="w-32 h-40 bg-slate-800 border-2 border-slate-700 hover:border-blue-500 hover:bg-slate-700 rounded-xl flex flex-col items-center justify-center gap-4 transition-all shadow-lg group"
                                    >
                                        <div className="text-4xl font-bold text-slate-600 group-hover:text-white">?</div>
                                        <div className="font-bold text-blue-400">Sample {s.id}</div>
                                    </button>
                                ))}
                            </div>
                        </div>
                    ) : (
                        /* Main Lab Interface */
                        <div className="flex flex-col lg:flex-row gap-8 flex-grow animate-in fade-in">
                            
                            {/* Left: Visual & Controls */}
                            <div className="w-full lg:w-1/2 flex flex-col gap-6">
                                
                                {/* Test Tube Visual */}
                                <div className="bg-slate-800 rounded-2xl border border-slate-700 p-8 flex justify-center items-end relative min-h-[400px] shadow-2xl overflow-hidden">
                                    
                                    {/* Background Glow */}
                                    <div className="absolute inset-0 bg-gradient-to-t from-blue-900/20 to-transparent pointer-events-none"></div>

                                    {/* The Test Tube */}
                                    <div className="w-24 h-80 border-x-4 border-b-4 border-slate-400/50 rounded-b-full relative bg-white/5 backdrop-blur-sm overflow-hidden z-10">
                                        
                                        {/* Liquid Content */}
                                        <div 
                                            className={`absolute bottom-0 w-full liquid ${visuals.liquid}`} 
                                            style={{ height: `${tubeState.volume}%` }}
                                        >
                                            {/* Precipitate Layer */}
                                            {tubeState.pptVisible && (
                                                <div className={`absolute bottom-0 w-full h-full ppt-anim ${visuals.ppt} precipitate opacity-90`}>
                                                    {/* Particles effect */}
                                                    <div className="w-full h-full opacity-50 bg-noise"></div>
                                                </div>
                                            )}
                                        </div>

                                        {/* Highlight/Reflection */}
                                        <div className="absolute top-0 left-2 w-2 h-full bg-white/10 rounded-full"></div>
                                    </div>

                                    {/* Labels */}
                                    <div className="absolute top-4 left-4 bg-slate-900/80 px-3 py-1 rounded text-sm border border-slate-600 text-blue-300">
                                        Sample {currentSample.id}
                                    </div>
                                </div>

                                {/* Reagent Controls */}
                                <div className="grid grid-cols-2 gap-3">
                                    <button 
                                        onClick={addAcid} 
                                        disabled={tubeState.acidified || result?.correct}
                                        className="p-3 bg-slate-700 hover:bg-slate-600 disabled:opacity-50 disabled:cursor-not-allowed rounded-lg border border-slate-600 text-left transition-colors"
                                    >
                                        <div className="text-xs text-slate-400 mb-1">Step 1: Acidify</div>
                                        <div className="font-bold text-white flex items-center gap-2">
                                            <Icon name="FlaskConical" size={16} /> Add Dilute HNO₃
                                        </div>
                                    </button>

                                    <button 
                                        onClick={addSilver} 
                                        disabled={!tubeState.acidified || tubeState.hasSilver || result?.correct}
                                        className="p-3 bg-blue-600 hover:bg-blue-500 disabled:opacity-50 disabled:cursor-not-allowed rounded-lg text-left transition-colors shadow-lg shadow-blue-900/20"
                                    >
                                        <div className="text-xs text-blue-200 mb-1">Step 2: Test</div>
                                        <div className="font-bold text-white flex items-center gap-2">
                                            <Icon name="PlusCircle" size={16} /> Add AgNO₃
                                        </div>
                                    </button>

                                    <button 
                                        onClick={() => addAmmonia('dilute')} 
                                        disabled={!tubeState.hasSilver || tubeState.ammoniaLevel >= 1 || result?.correct}
                                        className="p-3 bg-purple-600 hover:bg-purple-500 disabled:opacity-50 disabled:cursor-not-allowed rounded-lg text-left transition-colors"
                                    >
                                        <div className="text-xs text-purple-200 mb-1">Step 3a: Distinguish</div>
                                        <div className="font-bold text-white">Add Dilute NH₃</div>
                                    </button>

                                    <button 
                                        onClick={() => addAmmonia('conc')} 
                                        disabled={!tubeState.hasSilver || tubeState.ammoniaLevel >= 2 || result?.correct}
                                        className="p-3 bg-purple-800 hover:bg-purple-700 disabled:opacity-50 disabled:cursor-not-allowed rounded-lg text-left transition-colors"
                                    >
                                        <div className="text-xs text-purple-300 mb-1">Step 3b: Force Dissolve</div>
                                        <div className="font-bold text-white">Add Conc. NH₃</div>
                                    </button>
                                </div>
                            </div>

                            {/* Right: Observation Log & Guessing */}
                            <div className="w-full lg:w-1/2 flex flex-col gap-4">
                                
                                {/* Notebook / Log */}
                                <div className="bg-white rounded-xl p-5 text-slate-800 shadow-lg flex-grow flex flex-col min-h-[300px]">
                                    <h3 className="font-bold border-b pb-2 mb-3 flex items-center gap-2 text-slate-700">
                                        <Icon name="ClipboardList" /> Lab Notebook
                                    </h3>
                                    <div className="space-y-2 font-mono text-sm flex-grow overflow-y-auto max-h-[250px]">
                                        {history.map((h, idx) => (
                                            <div key={idx} className={`p-2 rounded ${
                                                h.type === 'action' ? 'bg-slate-100 text-slate-600' :
                                                h.type === 'obs' ? 'bg-yellow-50 text-slate-800 border-l-4 border-yellow-400' :
                                                'text-slate-400 italic'
                                            }`}>
                                                {h.text}
                                            </div>
                                        ))}
                                        {history.length === 0 && <p className="text-slate-400 text-center mt-10">Waiting to start...</p>}
                                    </div>
                                </div>

                                {/* Deduction Area */}
                                <div className="bg-slate-800 rounded-xl p-5 border border-slate-700">
                                    <h3 className="font-bold text-blue-400 mb-4 flex items-center gap-2">
                                        <Icon name="BrainCircuit" /> Conclusion: What is Sample {currentSample.id}?
                                    </h3>
                                    
                                    {!result?.correct ? (
                                        <div className="grid grid-cols-2 gap-2">
                                            {['Cl⁻', 'Br⁻', 'I⁻', 'F⁻'].map(ion => (
                                                <button
                                                    key={ion}
                                                    onClick={() => checkAnswer(ion)}
                                                    className="bg-slate-700 hover:bg-slate-600 p-3 rounded-lg text-white font-bold transition-all border border-slate-600 hover:border-blue-400"
                                                >
                                                    {ion}
                                                </button>
                                            ))}
                                        </div>
                                    ) : (
                                        <div className="bg-green-600/20 border border-green-500 text-green-400 p-4 rounded-lg animate-in zoom-in">
                                            <div className="font-bold text-lg flex items-center gap-2 mb-1">
                                                <Icon name="CheckCircle" /> Correct!
                                            </div>
                                            <p>{result.msg}</p>
                                            <button 
                                                onClick={() => setCurrentSample(null)}
                                                className="mt-4 w-full py-2 bg-green-600 text-white rounded-lg hover:bg-green-500 font-bold transition-colors"
                                            >
                                                Next Sample
                                            </button>
                                        </div>
                                    )}

                                    {result && !result.correct && (
                                        <div className="mt-3 text-red-400 text-sm bg-red-900/20 p-2 rounded border border-red-800 flex items-center gap-2">
                                            <Icon name="XCircle" size={16} /> {result.msg}
                                        </div>
                                    )}
                                </div>

                            </div>
                        </div>
                    )}

                    <div className="text-center text-slate-600 text-xs mt-8 border-t border-slate-800 pt-4">
                        Designed for HKDSE Chemistry | Luminous Learner Science Tools
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
