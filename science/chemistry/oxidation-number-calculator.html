<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Oxidation Number Calculator - LuminousLearner</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=JetBrains+Mono:wght@400;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0F172A; color: #e2e8f0; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        
        /* Card Hover Effect */
        .hover-card { transition: transform 0.2s, box-shadow 0.2s; }
        .hover-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3); }

        /* Input Animation */
        .input-focus-ring { transition: box-shadow 0.2s; }
        .input-focus-ring:focus-within { box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.3); }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <div id="root" class="flex-grow flex flex-col"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- Chemistry Logic ---

        const PRIORITY_RULES = [
            { id: 'elem', check: (el, atomCount, totalCharge) => atomCount === 1 && totalCharge === 0 ? 0 : null, desc: 'Element in standard state is 0' },
            { id: 'mono', check: (el, atomCount, totalCharge) => atomCount === 1 && totalCharge !== 0 ? totalCharge : null, desc: 'Monoatomic ion charge' },
            { id: 'F', check: (el) => el === 'F' ? -1 : null, desc: 'Fluorine is always -1' },
            { id: 'Gp1', check: (el) => ['Li', 'Na', 'K', 'Rb', 'Cs'].includes(el) ? 1 : null, desc: 'Group 1 Metal is +1' },
            { id: 'Gp2', check: (el) => ['Be', 'Mg', 'Ca', 'Sr', 'Ba'].includes(el) ? 2 : null, desc: 'Group 2 Metal is +2' },
            { id: 'Al', check: (el) => el === 'Al' ? 3 : null, desc: 'Aluminum is +3' },
            { id: 'H', check: (el) => el === 'H' ? 1 : null, desc: 'Hydrogen is usually +1' },
            { id: 'O', check: (el) => el === 'O' ? -2 : null, desc: 'Oxygen is usually -2' },
            { id: 'Halogen', check: (el) => ['Cl', 'Br', 'I'].includes(el) ? -1 : null, desc: 'Halogen is usually -1' }
        ];

        const COMMON_COMPOUNDS = [
            { f: 'KMnO4', n: 'Potassium Permanganate' },
            { f: 'K2Cr2O7', n: 'Potassium Dichromate' },
            { f: 'Na2S2O3', n: 'Sodium Thiosulfate' },
            { f: 'NO3^-', n: 'Nitrate Ion' },
            { f: 'SO4^2-', n: 'Sulfate Ion' },
            { f: 'NH4^+', n: 'Ammonium Ion' },
            { f: 'H2O2', n: 'Hydrogen Peroxide' },
            { f: 'Fe3O4', n: 'Magnetite (Mixed)' }
        ];

        const Icon = ({ name, size = 20, className = "" }) => {
            const [svg, setSvg] = useState('');
            useEffect(() => {
                if (window.lucide && window.lucide.icons[name]) {
                    const iconNode = window.lucide.icons[name];
                    const iconSvg = window.lucide.createElement(iconNode);
                    iconSvg.setAttribute('width', size);
                    iconSvg.setAttribute('height', size);
                    iconSvg.setAttribute('class', className);
                    setSvg(iconSvg.outerHTML);
                }
            }, [name, size, className]);
            return <span dangerouslySetInnerHTML={{ __html: svg }} className="flex items-center" />;
        };

        const App = () => {
            const [input, setInput] = useState('KMnO4');
            const [parsedData, setParsedData] = useState(null);
            const [calculation, setCalculation] = useState(null);

            // Parser
            const parseInput = (str) => {
                const clean = str.trim();
                if (!clean) return null;

                // Extract Charge
                let charge = 0;
                let formulaPart = clean;
                // Regex for charge at end like ^2-, 2+, +, -
                const chargeMatch = clean.match(/(\^)?(\d*)([\+\-])$/);
                if (chargeMatch) {
                    const mag = chargeMatch[2] ? parseInt(chargeMatch[2]) : 1;
                    const sign = chargeMatch[3] === '+' ? 1 : -1;
                    charge = mag * sign;
                    formulaPart = clean.replace(/(\^)?(\d*)([\+\-])$/, '');
                }

                // Parse Elements
                // Simple parsing: separate by Capital letters. Handling parenthesis is complex, 
                // so we simplify by "flattening" assumption or simple element count for this specific tool.
                // Let's support simple flattening for now.
                
                const elementMap = {};
                const regex = /([A-Z][a-z]?)(\d*)/g;
                let match;
                while ((match = regex.exec(formulaPart)) !== null) {
                    const el = match[1];
                    const count = match[2] ? parseInt(match[2]) : 1;
                    elementMap[el] = (elementMap[el] || 0) + count;
                }

                return { elements: elementMap, charge, displayFormula: clean };
            };

            // Calculation Logic
            useEffect(() => {
                const data = parseInput(input);
                if (!data || Object.keys(data.elements).length === 0) {
                    setParsedData(null);
                    setCalculation(null);
                    return;
                }
                setParsedData(data);

                const { elements, charge } = data;
                const elementList = Object.keys(elements);
                const results = {};
                const details = [];
                const unknowns = [];

                // 1. Apply Priority Rules
                let knownSum = 0;

                elementList.forEach(el => {
                    let assigned = false;
                    
                    // Special case for single element (e.g. O2, Fe)
                    if (elementList.length === 1) {
                        results[el] = { val: charge / elements[el], rule: 'Charge / Count' };
                        return;
                    }

                    for (let rule of PRIORITY_RULES) {
                        // Skip mono/elem rule for compounds
                        if (rule.id === 'elem' || rule.id === 'mono') continue;

                        const val = rule.check(el);
                        if (val !== null) {
                            // Check for conflicts? No, priority means first match wins.
                            // BUT: Halogens are -1 UNLESS with O/F.
                            if (rule.id === 'Halogen' && (elements['O'] || elements['F'])) {
                                continue; // Skip, it's variable
                            }
                            // O is -2 UNLESS with F.
                            if (rule.id === 'O' && elements['F']) {
                                continue; 
                            }
                            // H is +1 UNLESS metal hydride (simple check: only H and a metal?)
                            // Let's keep it simple for now.

                            results[el] = { val, rule: rule.desc };
                            knownSum += val * elements[el];
                            assigned = true;
                            break;
                        }
                    }
                    if (!assigned) unknowns.push(el);
                });

                // 2. Solve Unknowns
                if (unknowns.length === 0) {
                    // All assigned by rules. Check sum.
                    if (knownSum !== charge) {
                        // Conflict! Usually implies Peroxide or similar exception.
                        // If O is present, adjust O.
                        if (elements['O']) {
                            const oldOVal = results['O'].val;
                            const neededSumForOthers = knownSum - (oldOVal * elements['O']);
                            // neededSumForOthers + (newO * count) = charge
                            const newO = (charge - neededSumForOthers) / elements['O'];
                            results['O'] = { val: newO, rule: 'Calculated from Charge (Exception)' };
                            setCalculation({ results, target: 'O (Exception)', equation: `${neededSumForOthers} + ${elements['O']}x = ${charge}` });
                            return;
                        }
                    }
                    setCalculation({ results, target: 'Check', equation: `${knownSum} = ${charge}` });
                } else if (unknowns.length === 1) {
                    // Algebra solve
                    const target = unknowns[0];
                    const count = elements[target];
                    const x = (charge - knownSum) / count;
                    results[target] = { val: x, rule: 'Calculated via Algebra' };
                    setCalculation({ results, target, equation: `${knownSum} + ${count}x = ${charge}` });
                } else {
                    // Too many unknowns
                    setCalculation({ results, error: "Too many unknown variables. Can't solve automatically." });
                }

            }, [input]);

            // Helper to format formula for display (HTML)
            const renderFormula = (text) => {
                // Split by numbers and signs
                const parts = text.split(/(\d+)|([\+\-]+\d*)/g).filter(Boolean);
                return (
                    <span className="font-mono text-4xl font-bold tracking-wider text-white">
                        {text.replace(/\^/g, '').split(/(\d+)|([\+\-])/g).filter(Boolean).map((part, i) => {
                            if (part.match(/^\d+$/)) return <sub key={i} className="text-2xl text-slate-400">{part}</sub>;
                            if (part.match(/^[\+\-]$/)) return <sup key={i} className="text-2xl text-yellow-400">{part}</sup>;
                            return <span key={i}>{part}</span>;
                        })}
                    </span>
                );
            };

            return (
                <div className="flex flex-col h-full container mx-auto px-4 py-8 max-w-5xl">
                    
                    {/* Top Bar */}
                    <div className="flex justify-between items-center mb-8">
                        <div>
                            <h1 className="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-emerald-400 flex items-center gap-3">
                                <Icon name="FlaskConical" size={32} className="text-blue-400" /> 
                                Oxidation Calculator
                            </h1>
                            <p className="text-slate-400 mt-1">Determine oxidation states instantly</p>
                        </div>
                        <div className="bg-slate-800/50 p-2 rounded-lg border border-slate-700">
                            <button onClick={() => setInput('')} className="flex items-center gap-2 text-sm text-slate-300 hover:text-white px-3 py-1 rounded transition-colors">
                                <Icon name="RefreshCw" size={14}/> Reset
                            </button>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
                        
                        {/* LEFT COLUMN: Input & Presets */}
                        <div className="lg:col-span-4 flex flex-col gap-6">
                            
                            {/* Input Box */}
                            <div className="bg-slate-900 p-6 rounded-3xl shadow-xl border border-slate-800 input-focus-ring">
                                <label className="text-xs font-bold text-blue-400 uppercase tracking-widest mb-3 block">Chemical Formula</label>
                                <div className="relative">
                                    <input 
                                        type="text" 
                                        value={input}
                                        onChange={(e) => setInput(e.target.value)}
                                        placeholder="e.g. KMnO4"
                                        className="w-full bg-slate-800 text-white text-xl p-4 rounded-xl border-2 border-slate-700 outline-none focus:border-blue-500 placeholder:text-slate-600 font-mono"
                                    />
                                    {input && (
                                        <div className="absolute right-4 top-1/2 -translate-y-1/2">
                                            <div className={`w-3 h-3 rounded-full ${calculation?.error ? 'bg-red-500' : 'bg-emerald-500'} shadow-[0_0_10px_currentColor]`}></div>
                                        </div>
                                    )}
                                </div>
                                <p className="text-xs text-slate-500 mt-3 flex gap-2">
                                    <Icon name="Info" size={12} className="mt-0.5"/>
                                    Supports ions (e.g., SO4^2-) and complex molecules.
                                </p>
                            </div>

                            {/* Common Library */}
                            <div className="bg-slate-900 p-6 rounded-3xl shadow-lg border border-slate-800">
                                <h3 className="text-sm font-bold text-slate-400 uppercase mb-4 flex items-center gap-2">
                                    <Icon name="Book" size={16}/> Common Compounds
                                </h3>
                                <div className="grid grid-cols-2 gap-2">
                                    {COMMON_COMPOUNDS.map((item, idx) => (
                                        <button 
                                            key={idx}
                                            onClick={() => setInput(item.f)}
                                            className="text-left px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 border border-slate-700 transition-all text-xs group"
                                        >
                                            <div className="font-mono font-bold text-blue-300 group-hover:text-blue-200">{item.f}</div>
                                            <div className="text-slate-500 truncate">{item.n}</div>
                                        </button>
                                    ))}
                                </div>
                            </div>

                        </div>

                        {/* RIGHT COLUMN: Results & Visualization */}
                        <div className="lg:col-span-8 flex flex-col gap-6">
                            
                            {/* Main Result Display */}
                            <div className="bg-gradient-to-br from-slate-800 to-slate-900 p-8 rounded-3xl shadow-2xl border border-slate-700 min-h-[300px] flex flex-col items-center justify-center relative overflow-hidden">
                                
                                {/* Background Decoration */}
                                <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500 via-purple-500 to-emerald-500"></div>
                                <div className="absolute inset-0 opacity-10 bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-blue-900 via-slate-900 to-slate-900"></div>

                                {parsedData ? (
                                    <div className="relative z-10 w-full">
                                        {/* Formula Render */}
                                        <div className="text-center mb-10">
                                            {renderFormula(parsedData.displayFormula)}
                                            {parsedData.charge !== 0 && (
                                                <div className="mt-2 inline-block px-3 py-1 rounded-full bg-slate-700/50 border border-slate-600 text-xs font-bold text-slate-300">
                                                    Total Charge: {parsedData.charge > 0 ? '+' : ''}{parsedData.charge}
                                                </div>
                                            )}
                                        </div>

                                        {/* Error State */}
                                        {calculation?.error ? (
                                            <div className="bg-red-500/10 border border-red-500/50 text-red-200 p-4 rounded-xl text-center">
                                                <div className="font-bold flex items-center justify-center gap-2 mb-1">
                                                    <Icon name="AlertTriangle" size={20}/> Calculation Error
                                                </div>
                                                {calculation.error}
                                            </div>
                                        ) : (
                                            /* Atom Cards */
                                            <div className="flex flex-wrap justify-center gap-4">
                                                {Object.keys(parsedData.elements).map((el) => {
                                                    const res = calculation?.results[el];
                                                    if (!res) return null;
                                                    const val = res.val;
                                                    const count = parsedData.elements[el];
                                                    
                                                    return (
                                                        <div key={el} className="hover-card group relative bg-slate-800 border-2 border-slate-600 rounded-2xl w-32 p-4 text-center cursor-help">
                                                            
                                                            {/* Count Badge */}
                                                            {count > 1 && (
                                                                <div className="absolute top-2 right-2 text-xs font-mono text-slate-500">
                                                                    x{count}
                                                                </div>
                                                            )}

                                                            <div className="text-3xl font-bold text-white mb-2">{el}</div>
                                                            
                                                            <div className={`text-2xl font-mono font-black ${val > 0 ? 'text-blue-400' : val < 0 ? 'text-emerald-400' : 'text-slate-400'}`}>
                                                                {val > 0 ? '+' : ''}{val}
                                                            </div>

                                                            {/* Tooltip on Hover */}
                                                            <div className="absolute inset-0 bg-slate-900/95 backdrop-blur rounded-xl flex items-center justify-center p-2 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">
                                                                <span className="text-xs text-blue-200 font-medium">
                                                                    {res.rule}
                                                                </span>
                                                            </div>
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        )}
                                    </div>
                                ) : (
                                    <div className="text-center text-slate-500">
                                        <Icon name="Atom" size={64} className="mx-auto mb-4 opacity-20"/>
                                        <p className="text-lg">Waiting for input...</p>
                                    </div>
                                )}
                            </div>

                            {/* Math Breakdown Panel */}
                            {calculation && !calculation.error && (
                                <div className="bg-slate-900 rounded-2xl border border-slate-800 p-6 shadow-lg animate-fade-in">
                                    <h4 className="text-sm font-bold text-slate-400 uppercase mb-4 flex items-center gap-2">
                                        <Icon name="Calculator" size={16} /> Calculation Breakdown
                                    </h4>
                                    
                                    <div className="flex flex-col md:flex-row items-center justify-between gap-6 bg-slate-800/50 p-6 rounded-xl border border-slate-700/50">
                                        
                                        <div className="flex-1 space-y-2">
                                            <div className="text-xs text-slate-500 uppercase tracking-widest">Algebraic Equation</div>
                                            <div className="font-mono text-xl text-white">
                                                {calculation.equation}
                                            </div>
                                        </div>

                                        <div className="hidden md:block w-px h-12 bg-slate-700"></div>

                                        <div className="flex-1 space-y-2 md:text-right">
                                            <div className="text-xs text-slate-500 uppercase tracking-widest">Target Element</div>
                                            <div className="font-bold text-lg text-emerald-400">
                                                {calculation.target}
                                            </div>
                                        </div>

                                    </div>
                                </div>
                            )}

                        </div>
                    </div>
                    
                    <div className="text-center text-slate-600 text-xs mt-12 border-t border-slate-800 pt-6">
                        Luminous Learner International | IB/A-Level Chemistry
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
