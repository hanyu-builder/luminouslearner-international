<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Isomer Hunter - LuminousLearner International</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=JetBrains+Mono:wght@400;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0F172A; color: #e2e8f0; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        
        .atom-btn { transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .atom-btn:hover { transform: scale(1.1); }
        .atom-btn:active { transform: scale(0.95); }
        
        @keyframes pop-success {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        .animate-pop { animation: pop-success 0.5s ease-out forwards; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <div id="root" class="flex-grow flex flex-col"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const Icon = ({ name, size = 20, className = "" }) => {
            const [svg, setSvg] = useState('');
            useEffect(() => {
                if (window.lucide) {
                    const iconNode = window.lucide.icons[name];
                    if (iconNode) {
                        const iconSvg = window.lucide.createElement(iconNode);
                        iconSvg.setAttribute('width', size);
                        iconSvg.setAttribute('height', size);
                        iconSvg.setAttribute('class', className);
                        setSvg(iconSvg.outerHTML);
                    }
                }
            }, [name, size, className]);
            return <span dangerouslySetInnerHTML={{ __html: svg }} className="flex items-center" />;
        };

        // --- Game Data (Internationalized) ---
        const Levels = {
            C4: { formula: 'C₄H₁₀', target: 4, isomers: ['Butane', '2-methylpropane'] },
            C5: { formula: 'C₅H₁₂', target: 5, isomers: ['Pentane', '2-methylbutane', '2,2-dimethylpropane'] },
            C6: { formula: 'C₆H₁₄', target: 6, isomers: ['Hexane', '2-methylpentane', '3-methylpentane', '2,2-dimethylbutane', '2,3-dimethylbutane'] }
        };

        // --- IUPAC Naming Logic Helper ---
        const analyzeStructure = (chainLength, branches) => {
            // 1. Build Graph
            const nodes = [];
            for(let i=0; i<chainLength; i++) nodes.push({ id: i, neighbors: [] });
            
            // Connect Main Chain
            for(let i=0; i<chainLength-1; i++) {
                nodes[i].neighbors.push(i+1);
                nodes[i+1].neighbors.push(i);
            }

            // Add Branches
            let nextId = chainLength;
            Object.entries(branches).forEach(([posStr, type]) => {
                const pos = parseInt(posStr);
                
                if (type === 'methyl') {
                    nodes.push({ id: nextId, neighbors: [pos] });
                    nodes[pos].neighbors.push(nextId);
                    nextId++;
                } 
                else if (type === 'dimethyl') {
                    // Add 2 separate methyls
                    nodes.push({ id: nextId, neighbors: [pos] });
                    nodes[pos].neighbors.push(nextId);
                    nextId++;
                    
                    nodes.push({ id: nextId, neighbors: [pos] });
                    nodes[pos].neighbors.push(nextId);
                    nextId++;
                }
                else if (type === 'ethyl') {
                    // Add Ethyl chain (C-C) attached to pos
                    const c1 = nextId++;
                    const c2 = nextId++;
                    
                    nodes.push({ id: c1, neighbors: [pos, c2] }); // Attached to main
                    nodes.push({ id: c2, neighbors: [c1] });      // Attached to c1
                    
                    nodes[pos].neighbors.push(c1);
                }
            });

            const totalCarbons = nodes.length;

            // 2. Find Longest Path (Diameter of Tree)
            const getFurthest = (startNode) => {
                const visited = new Set();
                const stack = [{ node: startNode, dist: 1, path: [startNode] }];
                let max = { node: startNode, dist: 0, path: [] };
                
                while(stack.length > 0) {
                    const current = stack.pop();
                    visited.add(current.node);
                    if (current.dist > max.dist) max = current;
                    nodes[current.node].neighbors.forEach(n => {
                        if (!visited.has(n)) {
                            stack.push({ node: n, dist: current.dist + 1, path: [...current.path, n] });
                        }
                    });
                }
                return max;
            };

            const endA = getFurthest(0);
            const endB = getFurthest(endA.node);
            
            const longestChainLen = endB.dist;
            const longestPath = endB.path; 

            // 3. Identify Branches
            const calculateName = (path) => {
                const pathSet = new Set(path);
                const substituents = []; 
                
                path.forEach((nodeId, idx) => {
                    // Check neighbors of this node
                    nodes[nodeId].neighbors.forEach(n => {
                        if (!pathSet.has(n)) {
                            // Found a branch. Is it Methyl or Ethyl?
                            // Check if this branch node has neighbors not in path
                            const subNeighbors = nodes[n].neighbors.filter(sn => sn !== nodeId);
                            if (subNeighbors.length > 0) {
                                substituents.push({ pos: idx + 1, type: 'ethyl' }); // Simplified: In this game, complex branch = ethyl
                            } else {
                                substituents.push({ pos: idx + 1, type: 'methyl' });
                            }
                        }
                    });
                });
                return substituents;
            };

            const subsForward = calculateName(longestPath);
            const subsBackward = calculateName([...longestPath].reverse());

            // Compare locants
            let finalSubs = subsForward;
            // Simple comparison logic (lexicographical on sorted pos)
            const getScore = (subs) => subs.map(s => s.pos).sort((a,b)=>a-b).join('');
            const scoreF = getScore(subsForward);
            const scoreB = getScore(subsBackward);
            
            if (scoreB < scoreF) finalSubs = subsBackward; // Simplified rule

            // Construct Name
            const rootNames = ['', 'Methane', 'Ethane', 'Propane', 'Butane', 'Pentane', 'Hexane', 'Heptane', 'Octane'];
            const parentName = rootNames[longestChainLen] || `C${longestChainLen}-alkane`;
            
            if (finalSubs.length === 0) return { name: parentName, carbons: totalCarbons };

            // Group substituents
            const counts = { methyl: [], ethyl: [] };
            finalSubs.forEach(s => counts[s.type].push(s.pos));
            
            let nameParts = [];
            
            // Ethyls
            if (counts.ethyl.length > 0) {
                counts.ethyl.sort((a,b)=>a-b);
                const prefix = ['', '', 'di', 'tri'][counts.ethyl.length];
                nameParts.push(`${counts.ethyl.join(',')}-${prefix}ethyl`);
            }
            
            // Methyls
            if (counts.methyl.length > 0) {
                counts.methyl.sort((a,b)=>a-b);
                const prefix = ['', '', 'di', 'tri', 'tetra'][counts.methyl.length];
                nameParts.push(`${counts.methyl.join(',')}-${prefix}methyl`);
            }
            
            const fullName = `${nameParts.join('-')}${parentName.toLowerCase()}`;
            return { name: fullName.charAt(0).toUpperCase() + fullName.slice(1), carbons: totalCarbons };
        };

        const App = () => {
            const [level, setLevel] = useState('C6');
            const [found, setFound] = useState([]); 
            const [message, setMessage] = useState({ text: 'Start building!', type: 'info' });
            
            const [chainLen, setChainLen] = useState(4);
            const [branches, setBranches] = useState({}); // { index: 'methyl' | 'dimethyl' | 'ethyl' }

            useEffect(() => {
                setFound([]);
                setBranches({});
                setChainLen(Math.max(1, Levels[level].target - 2));
                setMessage({ text: `Target: Find ${Levels[level].isomers.length} Isomers (${Levels[level].formula})`, type: 'info' });
            }, [level]);

            // Updated Toggle Logic
            const toggleBranch = (idx) => {
                setBranches(prev => {
                    const current = prev[idx];
                    let next;
                    if (!current) next = 'methyl';
                    else if (current === 'methyl') next = 'dimethyl';
                    else if (current === 'dimethyl') next = 'ethyl';
                    else next = null; // Clear
                    
                    // Clean up
                    const newBranches = { ...prev };
                    if (next) newBranches[idx] = next;
                    else delete newBranches[idx];
                    
                    return newBranches;
                });
            };

            const handleCheck = () => {
                const result = analyzeStructure(chainLen, branches);

                if (result.carbons !== Levels[level].target) {
                    setMessage({ text: `Wrong Carbon count! You have ${result.carbons}, target is ${Levels[level].target}.`, type: 'error' });
                    return;
                }

                const targetIsomers = Levels[level].isomers;
                // Case-insensitive check
                const match = targetIsomers.find(iso => iso.toLowerCase() === result.name.toLowerCase());

                if (match) {
                    if (found.includes(match)) {
                        setMessage({ text: `You already found this one! It's ${match}.`, type: 'warning' });
                    } else {
                        setFound(prev => [...prev, match]);
                        setMessage({ text: `Great! Found new isomer: ${match}`, type: 'success' });
                    }
                } else {
                    console.log("Generated:", result.name);
                    setMessage({ text: `This is ${result.name}, but it's not in the target list (duplicate or invalid).`, type: 'warning' });
                }
            };

            const renderAtom = (index, branchType) => (
                <div 
                    key={index}
                    onClick={() => !branchType && toggleBranch(index)}
                    className={`
                        relative flex items-center justify-center w-14 h-14 rounded-full border-4 shadow-lg z-10 select-none
                        ${branchType 
                            ? (branchType === 'ethyl' ? 'bg-blue-500 border-blue-600 text-white w-12 h-12 mt-2' : 'bg-teal-500 border-teal-600 text-teal-100 w-10 h-10 mt-2') 
                            : 'bg-slate-700 border-slate-500 text-slate-300 cursor-pointer hover:bg-slate-600 hover:scale-105 active:scale-95 atom-btn'}
                    `}
                >
                    <span className="font-bold font-mono text-xs md:text-base">
                        {branchType === 'ethyl' ? 'C₂H₅' : branchType ? 'CH₃' : 'C'}
                    </span>
                    {!branchType && branches[index] === 'dimethyl' && (
                        <div className="absolute -top-2 -right-2 bg-teal-500 text-white text-[10px] font-bold w-5 h-5 flex items-center justify-center rounded-full border-2 border-slate-800">
                            x2
                        </div>
                    )}
                </div>
            );

            return (
                <div className="flex flex-col h-full container mx-auto px-4 py-6 max-w-6xl">
                    
                    {/* Header */}
                    <div className="flex justify-between items-center mb-6 border-b border-slate-700 pb-4">
                        <div>
                            <h1 className="text-2xl font-bold text-teal-400 flex items-center gap-2">
                                <Icon name="Crosshair" /> Isomer Hunter
                            </h1>
                            <p className="text-slate-400 text-sm">Build & Find Structural Isomers</p>
                        </div>
                        
                        <div className="flex bg-slate-800 rounded-lg p-1">
                            {Object.keys(Levels).map(lvl => (
                                <button
                                    key={lvl}
                                    onClick={() => setLevel(lvl)}
                                    className={`px-4 py-1 rounded font-bold text-sm transition-all
                                        ${level === lvl ? 'bg-teal-600 text-white shadow' : 'text-slate-400 hover:text-white'}
                                    `}
                                >
                                    {lvl}
                                </button>
                            ))}
                        </div>
                    </div>

                    <div className="flex flex-col lg:flex-row gap-8 flex-grow">
                        
                        {/* Left: Builder */}
                        <div className="w-full lg:w-2/3 flex flex-col gap-4">
                            <div className="bg-slate-800 p-8 rounded-3xl border border-slate-700 shadow-inner flex-grow flex flex-col items-center justify-center relative min-h-[400px]">
                                <div className="absolute inset-0 opacity-10" style={{backgroundImage: 'radial-gradient(#2dd4bf 1px, transparent 1px)', backgroundSize: '20px 20px'}}></div>
                                
                                <div className="flex items-start gap-1 relative z-10">
                                    {Array.from({length: chainLen}).map((_, i) => (
                                        <div key={i} className="flex flex-col items-center">
                                            {renderAtom(i)}
                                            {i < chainLen - 1 && <div className="absolute w-8 h-2 bg-slate-600 top-6 -right-4 -z-10"></div>}
                                            
                                            {/* Branches */}
                                            <div className="flex flex-col items-center transition-all duration-300">
                                                {branches[i] && (
                                                    <>
                                                        <div className="h-4 w-1 bg-slate-500 my-1"></div>
                                                        {renderAtom(`b-${i}`, branches[i])}
                                                    </>
                                                )}
                                            </div>
                                        </div>
                                    ))}
                                </div>

                                <div className="absolute bottom-4 flex flex-col items-center text-xs text-slate-500 gap-1">
                                    <div className="flex gap-4">
                                        <span className="flex items-center gap-1"><span className="w-3 h-3 rounded-full bg-teal-500"></span> Methyl</span>
                                        <span className="flex items-center gap-1"><span className="w-3 h-3 rounded-full bg-blue-500"></span> Ethyl</span>
                                    </div>
                                    <p>Click carbon to toggle branches</p>
                                </div>
                            </div>

                            <div className="bg-white p-4 rounded-2xl flex flex-col md:flex-row items-center justify-between gap-4 border border-slate-200 shadow-lg">
                                <div className="flex items-center gap-4 w-full md:w-auto">
                                    <label className="text-sm font-bold text-slate-600">Main Chain Length:</label>
                                    <input 
                                        type="range" min="1" max="6" 
                                        value={chainLen} onChange={(e) => setChainLen(parseInt(e.target.value))}
                                        className="accent-teal-600 h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer flex-grow"
                                    />
                                    <span className="text-xl font-mono font-bold text-teal-600 w-8 text-center">{chainLen}</span>
                                </div>
                                <button 
                                    onClick={handleCheck}
                                    className="px-8 py-3 bg-teal-600 hover:bg-teal-500 text-white font-bold rounded-xl shadow-md transition-transform active:scale-95 w-full md:w-auto"
                                >
                                    Check Structure
                                </button>
                            </div>

                            <div className={`p-4 rounded-xl border-l-4 text-sm font-bold flex items-center gap-3 transition-all
                                ${message.type === 'success' ? 'bg-green-900/30 border-green-500 text-green-300' : 
                                  message.type === 'error' ? 'bg-red-900/30 border-red-500 text-red-300' : 
                                  'bg-slate-800 border-slate-600 text-slate-400'}
                            `}>
                                {message.type === 'success' ? <Icon name="CheckCircle"/> : 
                                 message.type === 'error' ? <Icon name="XCircle"/> : <Icon name="Info"/>}
                                {message.text}
                            </div>
                        </div>

                        {/* Right: Collection */}
                        <div className="w-full lg:w-1/3 flex flex-col gap-4">
                            <div className="bg-slate-800 p-6 rounded-2xl border border-slate-700 shadow-lg flex-grow">
                                <div className="flex justify-between items-end mb-4">
                                    <h3 className="text-lg font-bold text-white">Collection</h3>
                                    <span className="text-sm font-mono text-teal-400 font-bold">{found.length} / {Levels[level].isomers.length}</span>
                                </div>
                                <div className="w-full bg-slate-700 h-2 rounded-full overflow-hidden mb-6">
                                    <div className="h-full bg-teal-500 transition-all duration-1000" style={{width: `${(found.length / Levels[level].isomers.length) * 100}%`}}></div>
                                </div>
                                <div className="space-y-3">
                                    {Levels[level].isomers.map((iso, idx) => (
                                        <div key={iso} className={`p-3 rounded-xl border transition-all flex items-center gap-3 ${found.includes(iso) ? 'bg-teal-900/20 border-teal-500/50 text-teal-100 animate-pop' : 'bg-slate-900/50 border-slate-700 text-slate-600'}`}>
                                            <div className={`w-6 h-6 rounded-full flex items-center justify-center font-bold text-xs ${found.includes(iso) ? 'bg-teal-600 text-white' : 'bg-slate-700 text-slate-500'}`}>{idx + 1}</div>
                                            <div className="font-mono text-sm">{found.includes(iso) ? iso : '???????'}</div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div className="text-center text-slate-500 text-xs mt-8 border-t border-slate-800 pt-4">
                        Luminous Learner Science Tools | HKDSE Topic XI
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
