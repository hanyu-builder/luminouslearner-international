<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fission Chain Reaction Lab | Luminous Learner</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@0.263.1"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #e2e8f0; }
        .slider-thumb::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none; width: 16px; height: 16px;
            border-radius: 50%; cursor: pointer; border: 2px solid #ffffff;
        }
        .canvas-container { cursor: crosshair; }
        .control-rod-container { cursor: ns-resize; }
    </style>
</head>
<body>

<div id="root"></div>

<script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const CANVAS_WIDTH = 800;
    const CANVAS_HEIGHT = 500;
    const ATOM_RADIUS = 13; // Slightly reduced for denser grid
    const NEUTRON_RADIUS = 3;
    const ROD_WIDTH = 40;
    const ROD_SPACING = 120;
    
    const App = () => {
        // --- State ---
        const [controlRodLevel, setControlRodLevel] = useState(50); // 0 (Out) to 100 (In)
        const [power, setPower] = useState(0); // Current Fission Rate
        const [temperature, setTemperature] = useState(300); // Kelvin
        const [simState, setSimState] = useState('running'); // running, meltdown

        const canvasRef = useRef(null);
        const requestRef = useRef();
        
        // Physics Objects (Mutable)
        const atomsRef = useRef([]);
        const neutronsRef = useRef([]);
        const particlesRef = useRef([]); // Visual effects (energy flash)
        
        // --- Initialization ---
        const initReactor = () => {
            const atoms = [];
            // Create Grid of U-235 (Increased density)
            const cols = 12; // Increased from 8
            const rows = 10; // Increased from 6
            const xStep = CANVAS_WIDTH / (cols + 1);
            const yStep = CANVAS_HEIGHT / (rows + 1);

            for(let i=1; i<=cols; i++) {
                for(let j=1; j<=rows; j++) {
                    // Jitter position
                    const x = i * xStep + (Math.random() - 0.5) * 15;
                    const y = j * yStep + (Math.random() - 0.5) * 15;
                    
                    atoms.push({
                        x, y,
                        type: 'U-235', // U-235 or Splitting or Waste
                        life: 1.0 // For splitting animation
                    });
                }
            }
            atomsRef.current = atoms;
            neutronsRef.current = [];
            particlesRef.current = [];
            setPower(0);
            setTemperature(300);
            setSimState('running');
        };

        useEffect(() => {
            initReactor();
        }, []);

        // --- Actions ---
        const fireNeutron = () => {
            if (simState !== 'running') return;
            // Fire from left
            neutronsRef.current.push({
                x: 0,
                y: CANVAS_HEIGHT / 2,
                vx: 6,
                vy: (Math.random() - 0.5) * 1.5,
                active: true
            });
        };

        const reset = () => {
            initReactor();
            setControlRodLevel(50);
        };

        // --- Physics Loop ---
        const loop = () => {
            if (simState === 'meltdown') return;

            // 1. Update Neutrons
            neutronsRef.current.forEach(n => {
                if (!n.active) return;
                
                n.x += n.vx;
                n.y += n.vy;

                // Bounds
                if (n.x < 0 || n.x > CANVAS_WIDTH || n.y < 0 || n.y > CANVAS_HEIGHT) {
                    n.active = false;
                    return;
                }

                // Rod Collision
                const rodY = (controlRodLevel / 100) * CANVAS_HEIGHT;
                const rodX1 = CANVAS_WIDTH * 0.25;
                const rodX2 = CANVAS_WIDTH * 0.5;
                const rodX3 = CANVAS_WIDTH * 0.75;
                const rods = [rodX1, rodX2, rodX3];
                
                if (n.y < rodY) {
                    for (let rx of rods) {
                        if (Math.abs(n.x - rx) < ROD_WIDTH/2) {
                            n.active = false; // Absorbed!
                            return;
                        }
                    }
                }

                // Atom Collision
                atomsRef.current.forEach(atom => {
                    if (atom.type === 'U-235' && Math.hypot(n.x - atom.x, n.y - atom.y) < ATOM_RADIUS) {
                        n.active = false; // Absorbed by nucleus
                        triggerFission(atom);
                    }
                });
            });

            // Cleanup Neutrons
            neutronsRef.current = neutronsRef.current.filter(n => n.active);

            // 2. Update Atoms (Animation)
            let fissionCount = 0;
            atomsRef.current.forEach(atom => {
                if (atom.type === 'Splitting') {
                    atom.life -= 0.1;
                    if (atom.life <= 0) {
                        atom.type = 'Waste'; // Become stable waste (Ba, Kr)
                        // Emit 2-3 neutrons
                        const numNeutrons = 2 + Math.floor(Math.random() * 2); // 2 or 3
                        for(let i=0; i<numNeutrons; i++) {
                            const angle = Math.random() * Math.PI * 2;
                            const speed = 4 + Math.random() * 2;
                            neutronsRef.current.push({
                                x: atom.x,
                                y: atom.y,
                                vx: Math.cos(angle) * speed,
                                vy: Math.sin(angle) * speed,
                                active: true
                            });
                        }
                        // Visual flash
                        particlesRef.current.push({ x: atom.x, y: atom.y, r: 1, maxR: 40, alpha: 1 });
                    }
                    fissionCount++;
                }
            });
            
            // 3. Update Particles (Explosions)
            particlesRef.current.forEach(p => {
                p.r += 2;
                p.alpha -= 0.05;
            });
            particlesRef.current = particlesRef.current.filter(p => p.alpha > 0);

            // 4. Update Stats
            // Power proportional to fissions happening
            setPower(p => p * 0.9 + fissionCount * 10);
            
            // Temperature logic
            const cooling = (temperature - 300) * 0.02;
            const heating = fissionCount * 0.5;
            let newTemp = temperature + heating - cooling;
            
            if (newTemp > 1200) {
                setSimState('meltdown');
                newTemp = 1200;
            }
            setTemperature(newTemp);

            draw();
            requestRef.current = requestAnimationFrame(loop);
        };

        const triggerFission = (atom) => {
            atom.type = 'Splitting';
            atom.life = 1.0; // Frames to split
        };

        // --- Rendering ---
        const draw = () => {
            const ctx = canvasRef.current?.getContext('2d');
            if (!ctx) return;

            ctx.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);

            // 1. Draw Core Background
            const heatRatio = Math.min(1, (temperature - 300) / 900);
            const r = Math.floor(30 + heatRatio * 50);
            ctx.fillStyle = `rgb(${r}, 40, 60)`; 
            ctx.fillRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);

            // 2. Draw Atoms
            atomsRef.current.forEach(atom => {
                ctx.beginPath();
                ctx.arc(atom.x, atom.y, ATOM_RADIUS, 0, Math.PI * 2);
                
                if (atom.type === 'U-235') {
                    ctx.fillStyle = '#22c55e'; // Green Uranium
                    ctx.strokeStyle = '#15803d';
                } else if (atom.type === 'Splitting') {
                    ctx.fillStyle = '#fbbf24'; // Yellow exciting
                    ctx.strokeStyle = '#fff';
                    // Jitter
                    const jx = (Math.random()-0.5)*5;
                    const jy = (Math.random()-0.5)*5;
                    ctx.beginPath(); ctx.arc(atom.x+jx, atom.y+jy, ATOM_RADIUS + 2, 0, Math.PI*2);
                } else {
                    ctx.fillStyle = '#475569'; // Grey Waste
                    ctx.strokeStyle = '#1e293b';
                }
                ctx.fill();
                ctx.lineWidth = 2;
                ctx.stroke();
            });

            // 3. Draw Control Rods
            const rodY = (controlRodLevel / 100) * CANVAS_HEIGHT;
            const rodX1 = CANVAS_WIDTH * 0.25;
            const rodX2 = CANVAS_WIDTH * 0.5;
            const rodX3 = CANVAS_WIDTH * 0.75;
            
            ctx.fillStyle = '#64748b'; // Rod Grey
            ctx.strokeStyle = '#94a3b8';
            ctx.lineWidth = 2;
            
            [rodX1, rodX2, rodX3].forEach(x => {
                ctx.fillRect(x - ROD_WIDTH/2, 0, ROD_WIDTH, rodY);
                ctx.strokeRect(x - ROD_WIDTH/2, 0, ROD_WIDTH, rodY);
                
                // Handle/Top
                ctx.fillStyle = '#334155';
                ctx.fillRect(x - ROD_WIDTH/2 - 5, -10, ROD_WIDTH + 10, 20);
                ctx.fillStyle = '#64748b'; // Reset for next rect
            });

            // 4. Draw Neutrons
            ctx.fillStyle = '#f472b6'; // Pink neutrons
            neutronsRef.current.forEach(n => {
                ctx.beginPath();
                ctx.arc(n.x, n.y, NEUTRON_RADIUS, 0, Math.PI * 2);
                ctx.fill();
            });

            // 5. Draw Explosions
            particlesRef.current.forEach(p => {
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(251, 191, 36, ${p.alpha})`; // Amber flash
                ctx.fill();
            });

            // 6. Meltdown Warning
            if (simState === 'meltdown') {
                ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                ctx.fillRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
                ctx.fillStyle = '#ef4444';
                ctx.font = 'bold 60px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText("MELTDOWN DETECTED", CANVAS_WIDTH/2, CANVAS_HEIGHT/2);
                ctx.font = '20px sans-serif';
                ctx.fillStyle = '#fff';
                ctx.fillText("Core Temperature Critical", CANVAS_WIDTH/2, CANVAS_HEIGHT/2 + 40);
            }
        };

        useEffect(() => {
            requestRef.current = requestAnimationFrame(loop);
            return () => cancelAnimationFrame(requestRef.current);
        });

        useEffect(() => {
            if (window.lucide) window.lucide.createIcons();
        });

        // Helper for temperature color
        const getTempColor = (t) => {
            if (t < 500) return 'text-emerald-400';
            if (t < 900) return 'text-yellow-400';
            return 'text-red-500 animate-pulse';
        };

        return (
            <div className="min-h-screen bg-slate-900 text-slate-200 font-sans pb-12">
                <nav className="bg-slate-800 border-b border-slate-700 px-6 py-4 flex items-center justify-between sticky top-0 z-10">
                    <div className="flex items-center space-x-3">
                        <div className="bg-orange-500/20 p-2 rounded-lg">
                            <i data-lucide="atom" className="w-6 h-6 text-orange-400"></i>
                        </div>
                        <h1 className="text-xl font-bold text-white tracking-wide">Fission Chain Reaction Lab</h1>
                    </div>
                    <div className="text-xs text-slate-400 font-mono bg-slate-900 px-3 py-1 rounded-full border border-slate-700">
                        Topic: Nuclear Physics
                    </div>
                </nav>

                <main className="max-w-6xl mx-auto p-4 md:p-6 grid grid-cols-1 lg:grid-cols-12 gap-8">
                    
                    {/* Left: Simulation Canvas */}
                    <div className="lg:col-span-9 flex flex-col gap-6">
                        <div className="bg-slate-950 rounded-2xl border border-slate-700 p-1 shadow-2xl relative overflow-hidden h-[500px]">
                            <canvas 
                                ref={canvasRef} 
                                width={CANVAS_WIDTH} 
                                height={CANVAS_HEIGHT}
                                className="w-full h-full object-contain bg-slate-950 rounded-xl canvas-container"
                                onClick={fireNeutron}
                            />
                            
                            <div className="absolute top-4 left-4 bg-slate-900/80 px-4 py-2 rounded-lg border border-slate-700 text-xs shadow-lg space-y-1 pointer-events-none">
                                <div className="flex justify-between gap-4">
                                    <span className="text-slate-400">Neutron Count</span>
                                    <span className="text-pink-400 font-mono font-bold">{neutronsRef.current.length}</span>
                                </div>
                                <div className="text-[10px] text-slate-500">Click canvas to fire neutron</div>
                            </div>
                        </div>

                        {/* Controls */}
                        <div className="bg-slate-800 p-6 rounded-2xl border border-slate-700 flex flex-wrap gap-8 items-center">
                            
                            {/* Rod Control */}
                            <div className="flex-1 min-w-[200px]">
                                <label className="flex justify-between text-xs text-slate-300 font-bold mb-2">
                                    <span>Control Rods Depth</span>
                                    <span className="text-blue-400">{controlRodLevel}%</span>
                                </label>
                                <input 
                                    type="range" min="0" max="100" step="1" 
                                    value={controlRodLevel} onChange={(e) => setControlRodLevel(Number(e.target.value))}
                                    className="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer slider-thumb"
                                />
                                <div className="flex justify-between text-[10px] text-slate-500 mt-1">
                                    <span>Retracted (High Reactivity)</span>
                                    <span>Inserted (Safe)</span>
                                </div>
                            </div>

                            <div className="flex gap-3">
                                <button 
                                    onClick={fireNeutron}
                                    className="px-6 py-3 bg-orange-600 hover:bg-orange-500 text-white rounded-xl font-bold shadow-lg transition-all flex items-center gap-2"
                                >
                                    <i data-lucide="zap" className="w-5 h-5"></i> Fire Neutron
                                </button>
                                <button onClick={reset} className="px-4 py-3 bg-slate-700 hover:bg-slate-600 rounded-xl text-white font-bold transition-colors">
                                    <i data-lucide="rotate-ccw" className="w-5 h-5"></i> Reset
                                </button>
                            </div>

                        </div>
                    </div>

                    {/* Right: Monitoring */}
                    <div className="lg:col-span-3 space-y-6">
                        
                        <div className="bg-slate-800 p-6 rounded-2xl border border-slate-700">
                            <h2 className="text-white font-bold mb-6 flex items-center">
                                <i data-lucide="gauge" className="w-5 h-5 mr-2 text-indigo-400"></i>
                                Reactor Status
                            </h2>
                            
                            <div className="space-y-6">
                                {/* Power Meter */}
                                <div>
                                    <div className="flex justify-between text-xs mb-1">
                                        <span className="text-slate-400">Power Output</span>
                                        <span className="text-white font-mono font-bold">{power.toFixed(0)} MW</span>
                                    </div>
                                    <div className="w-full h-4 bg-slate-900 rounded-full overflow-hidden border border-slate-700">
                                        <div className="h-full bg-gradient-to-r from-emerald-500 to-yellow-400 transition-all duration-300" style={{width: `${Math.min(100, power/5)}%`}}></div>
                                    </div>
                                </div>

                                {/* Temperature Meter */}
                                <div>
                                    <div className="flex justify-between text-xs mb-1">
                                        <span className="text-slate-400">Core Temp</span>
                                        <span className={`font-mono font-bold ${getTempColor(temperature)}`}>{temperature.toFixed(0)} K</span>
                                    </div>
                                    <div className="w-full h-4 bg-slate-900 rounded-full overflow-hidden border border-slate-700 relative">
                                        {/* Warning Zone */}
                                        <div className="absolute right-0 top-0 bottom-0 w-[20%] bg-red-900/30"></div>
                                        <div className={`h-full transition-all duration-300 ${temperature > 900 ? 'bg-red-500' : 'bg-blue-500'}`} style={{width: `${Math.min(100, (temperature-300)/9)}%`}}></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div className="bg-blue-900/10 border border-blue-500/20 p-5 rounded-2xl">
                            <h3 className="text-blue-300 font-bold text-sm mb-2 flex items-center">
                                <i data-lucide="shield-check" className="w-4 h-4 mr-2"></i> Safety System
                            </h3>
                            <p className="text-xs text-slate-300 leading-relaxed">
                                <strong>Control Rods</strong> are made of Boron or Cadmium. They absorb neutrons like a sponge.
                                <br/><br/>
                                If the reaction gets too hot, drop the rods to 100% to stop the chain reaction instantly (SCRAM)!
                            </p>
                        </div>

                    </div>

                </main>
            </div>
        );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
</script>
</body>
</html>
