<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Refraction Blocks Lab | Luminous Learner</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@0.263.1"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #e2e8f0; }
        .slider-thumb::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none; width: 16px; height: 16px;
            border-radius: 50%; cursor: pointer; border: 2px solid #ffffff;
        }
        .thumb-blue::-webkit-slider-thumb { background: #3b82f6; }
        .thumb-cyan::-webkit-slider-thumb { background: #06b6d4; }
        .canvas-container { cursor: pointer; }
    </style>
</head>
<body>

<div id="root"></div>

<script type="text/babel">
    const { useState, useEffect, useRef, useMemo } = React;

    const CANVAS_WIDTH = 800;
    const CANVAS_HEIGHT = 500;
    const CENTER_X = CANVAS_WIDTH / 2;
    const CENTER_Y = CANVAS_HEIGHT / 2;
    
    const MATERIALS = {
        'Air': 1.00,
        'Water': 1.33,
        'Glass': 1.50,
        'Diamond': 2.42
    };

    const App = () => {
        // --- State ---
        const [n1, setN1] = useState(1.00); // Medium 1 (Top)
        const [n2, setN2] = useState(1.50); // Medium 2 (Bottom)
        const [angle, setAngle] = useState(45); // Incidence Angle (Degrees)
        
        const [showNormal, setShowNormal] = useState(true);
        const [showAngles, setShowAngles] = useState(true);
        const [isTIR, setIsTIR] = useState(false); // Total Internal Reflection
        const [refractedAngle, setRefractedAngle] = useState(0);

        const canvasRef = useRef(null);

        // --- Physics Logic ---
        useEffect(() => {
            const theta1Rad = angle * Math.PI / 180;
            
            // Snell's Law: n1 * sin(theta1) = n2 * sin(theta2)
            // sin(theta2) = (n1 / n2) * sin(theta1)
            
            const sinTheta2 = (n1 / n2) * Math.sin(theta1Rad);
            
            if (Math.abs(sinTheta2) > 1.0000001) {
                // Total Internal Reflection
                setIsTIR(true);
                setRefractedAngle(null);
            } else {
                // Refraction
                setIsTIR(false);
                const theta2Rad = Math.asin(Math.min(1, Math.max(-1, sinTheta2)));
                setRefractedAngle(theta2Rad * 180 / Math.PI);
            }
        }, [n1, n2, angle]);

        // --- Drawing ---
        useEffect(() => {
            const ctx = canvasRef.current?.getContext('2d');
            if (!ctx) return;

            // Clear
            ctx.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);

            // 1. Draw Media Backgrounds
            // Top Medium (n1)
            ctx.fillStyle = getColorForIndex(n1, true);
            ctx.fillRect(0, 0, CANVAS_WIDTH, CENTER_Y);
            
            // Bottom Medium (n2)
            ctx.fillStyle = getColorForIndex(n2, false);
            ctx.fillRect(0, CENTER_Y, CANVAS_WIDTH, CENTER_Y);

            // Interface Line
            ctx.strokeStyle = '#64748b';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(0, CENTER_Y);
            ctx.lineTo(CANVAS_WIDTH, CENTER_Y);
            ctx.stroke();

            // 2. Draw Normal Line
            if (showNormal) {
                ctx.strokeStyle = '#94a3b8';
                ctx.setLineDash([5, 5]);
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(CENTER_X, 50);
                ctx.lineTo(CENTER_X, CANVAS_HEIGHT - 50);
                ctx.stroke();
                ctx.setLineDash([]);
            }

            // 3. Draw Rays
            const rayLen = 300;
            const theta1Rad = angle * Math.PI / 180;

            // Incident Ray (From Top-Left if angle > 0)
            // Angle is measured from Normal. 
            // x = -sin(theta), y = -cos(theta) for origin vector
            const startX = CENTER_X - rayLen * Math.sin(theta1Rad);
            const startY = CENTER_Y - rayLen * Math.cos(theta1Rad);
            
            drawLaser(ctx, startX, startY, CENTER_X, CENTER_Y, '#ef4444'); // Red Laser

            if (isTIR) {
                // Total Internal Reflection
                // Reflects at same angle theta1
                const endX = CENTER_X + rayLen * Math.sin(theta1Rad);
                const endY = CENTER_Y - rayLen * Math.cos(theta1Rad); // Upwards
                
                drawLaser(ctx, CENTER_X, CENTER_Y, endX, endY, '#ef4444', 0.8); // Slightly dimmer
                
            } else {
                // Refraction
                const theta2Rad = refractedAngle * Math.PI / 180;
                const endX = CENTER_X + rayLen * Math.sin(theta2Rad);
                const endY = CENTER_Y + rayLen * Math.cos(theta2Rad); // Downwards
                
                drawLaser(ctx, CENTER_X, CENTER_Y, endX, endY, '#ef4444', 0.9);
                
                // Partial Reflection (Always happens in reality)
                const reflX = CENTER_X + rayLen * Math.sin(theta1Rad);
                const reflY = CENTER_Y - rayLen * Math.cos(theta1Rad);
                drawLaser(ctx, CENTER_X, CENTER_Y, reflX, reflY, '#ef4444', 0.2); // Very faint
            }

            // 4. Draw Angles & Labels
            if (showAngles) {
                // Incident Angle
                drawAngleArc(ctx, CENTER_X, CENTER_Y, -90 - angle, -90, 40, '#fcd34d', `θ₁=${angle.toFixed(0)}°`);
                
                if (isTIR) {
                     // Reflection Angle
                     drawAngleArc(ctx, CENTER_X, CENTER_Y, -90, -90 + angle, 40, '#fcd34d', `θ'=${angle.toFixed(0)}°`);
                } else {
                     // Refracted Angle
                     drawAngleArc(ctx, CENTER_X, CENTER_Y, 90 - refractedAngle, 90, 40, '#fcd34d', `θ₂=${refractedAngle.toFixed(1)}°`);
                }
            }
            
            // Labels for n
            ctx.fillStyle = '#fff';
            ctx.font = 'bold 14px sans-serif';
            ctx.fillText(`n₁ = ${n1.toFixed(2)}`, 20, 30);
            ctx.fillText(`n₂ = ${n2.toFixed(2)}`, 20, CANVAS_HEIGHT - 20);

        }, [n1, n2, angle, isTIR, refractedAngle, showNormal, showAngles]);

        // Helper: Color based on Density (n)
        const getColorForIndex = (n, isTop) => {
            // Map n (1.0 - 2.5) to opacity of blue
            // 1.0 -> 0.05, 2.5 -> 0.5
            const opacity = 0.05 + ((n - 1) / 1.5) * 0.4;
            return isTop ? `rgba(147, 197, 253, ${opacity})` : `rgba(59, 130, 246, ${opacity})`;
        };

        const drawLaser = (ctx, x1, y1, x2, y2, color, alpha = 1) => {
            ctx.save();
            ctx.strokeStyle = color;
            ctx.globalAlpha = alpha;
            ctx.lineWidth = 4;
            ctx.shadowColor = color;
            ctx.shadowBlur = 10;
            ctx.beginPath();
            ctx.moveTo(x1, y1);
            ctx.lineTo(x2, y2);
            ctx.stroke();
            ctx.restore();
        };

        const drawAngleArc = (ctx, x, y, startDeg, endDeg, radius, color, label) => {
            const startRad = startDeg * Math.PI / 180;
            const endRad = endDeg * Math.PI / 180;
            
            ctx.beginPath();
            ctx.arc(x, y, radius, startRad, endRad);
            ctx.strokeStyle = color;
            ctx.lineWidth = 2;
            ctx.stroke();
            
            // Text Label position
            const midRad = (startRad + endRad) / 2;
            const tx = x + (radius + 20) * Math.cos(midRad);
            const ty = y + (radius + 20) * Math.sin(midRad);
            
            ctx.fillStyle = color;
            ctx.font = '12px Inter';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(label, tx, ty);
        };
        
        // Interactive Canvas control for angle
        const handleMouseMove = (e) => {
            if (e.buttons !== 1) return; // Only drag
            const rect = canvasRef.current.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            // Only allow dragging in top half
            if (y > CENTER_Y) return;

            // Calculate angle from normal (Y axis)
            const dx = x - CENTER_X;
            const dy = y - CENTER_Y;
            // Angle from Up (-Y) axis
            // atan2(dx, -dy) gives angle from vertical up, clockwise positive
            let deg = Math.atan2(dx, -dy) * 180 / Math.PI;
            
            // Clamp to -85 to 85
            if (deg > 85) deg = 85;
            if (deg < -85) deg = -85;
            
            // We only support positive incidence in UI slider usually, but canvas allows both sides
            // Let's stick to absolute angle 0-90 for simplicity or mirror it
            setAngle(Math.abs(deg));
        };

        // Init icons
        useEffect(() => {
            if (window.lucide) window.lucide.createIcons();
        });

        return (
            <div className="min-h-screen bg-slate-900 text-slate-200 font-sans pb-12">
                <nav className="bg-slate-800 border-b border-slate-700 px-6 py-4 flex items-center justify-between sticky top-0 z-10">
                    <div className="flex items-center space-x-3">
                        <div className="bg-blue-500/20 p-2 rounded-lg">
                            <i data-lucide="sun" className="w-6 h-6 text-blue-400"></i>
                        </div>
                        <h1 className="text-xl font-bold text-white tracking-wide">Refraction Blocks Lab</h1>
                    </div>
                    <div className="text-xs text-slate-400 font-mono bg-slate-900 px-3 py-1 rounded-full border border-slate-700">
                        Topic: Light & Optics
                    </div>
                </nav>

                <main className="max-w-6xl mx-auto p-4 md:p-6 grid grid-cols-1 lg:grid-cols-12 gap-8">
                    
                    {/* Left: Simulation Canvas */}
                    <div className="lg:col-span-8 flex flex-col gap-6">
                        <div className="bg-slate-800 rounded-2xl border border-slate-700 p-1 shadow-2xl relative overflow-hidden">
                            <canvas 
                                ref={canvasRef} 
                                width={CANVAS_WIDTH} 
                                height={CANVAS_HEIGHT}
                                onMouseMove={handleMouseMove}
                                className="w-full h-auto bg-black rounded-xl canvas-container"
                            />
                            
                            <div className="absolute top-4 right-4 bg-slate-900/90 px-4 py-2 rounded-lg border border-slate-700 text-xs text-slate-400 shadow-lg pointer-events-none">
                                Drag mouse in top area to change angle
                            </div>

                            {isTIR && (
                                <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-red-600/90 text-white px-6 py-3 rounded-xl shadow-2xl font-bold border border-red-400 animate-pulse pointer-events-none">
                                    TOTAL INTERNAL REFLECTION
                                </div>
                            )}
                        </div>
                        
                        {/* Speed Info */}
                        <div className="bg-slate-800 p-4 rounded-xl border border-slate-700 flex justify-between items-center text-sm">
                            <div className="flex items-center gap-3">
                                <span className="text-slate-400">Speed in Top ($v_1$):</span>
                                <span className="font-mono text-blue-300">{(100/n1).toFixed(0)}% c</span>
                            </div>
                            <div className="h-4 w-px bg-slate-600"></div>
                            <div className="flex items-center gap-3">
                                <span className="text-slate-400">Speed in Bottom ($v_2$):</span>
                                <span className="font-mono text-cyan-300">{(100/n2).toFixed(0)}% c</span>
                            </div>
                        </div>
                    </div>

                    {/* Right: Controls */}
                    <div className="lg:col-span-4 space-y-6">
                        
                        <div className="bg-slate-800 p-6 rounded-2xl border border-slate-700 space-y-8">
                            <h2 className="text-white font-bold text-sm flex items-center mb-4">
                                <i data-lucide="sliders" className="w-4 h-4 mr-2 text-indigo-400"></i>
                                Material Settings
                            </h2>

                            {/* Medium 1 */}
                            <div className="space-y-3">
                                <div className="flex justify-between items-center">
                                    <label className="text-xs font-bold text-blue-300 uppercase">Top Medium ($n_1$)</label>
                                    <span className="text-white font-mono">{n1.toFixed(2)}</span>
                                </div>
                                <input 
                                    type="range" min="1.00" max="3.00" step="0.01" 
                                    value={n1} onChange={(e) => setN1(Number(e.target.value))}
                                    className="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer slider-thumb thumb-blue" 
                                />
                                <div className="flex gap-2">
                                    {['Air', 'Water', 'Glass'].map(m => (
                                        <button key={m} onClick={() => setN1(MATERIALS[m])} className="px-2 py-1 text-[10px] bg-slate-700 hover:bg-slate-600 rounded text-slate-300 transition-colors">
                                            {m}
                                        </button>
                                    ))}
                                </div>
                            </div>

                            <div className="h-px bg-slate-700"></div>

                            {/* Medium 2 */}
                            <div className="space-y-3">
                                <div className="flex justify-between items-center">
                                    <label className="text-xs font-bold text-cyan-300 uppercase">Bottom Medium ($n_2$)</label>
                                    <span className="text-white font-mono">{n2.toFixed(2)}</span>
                                </div>
                                <input 
                                    type="range" min="1.00" max="3.00" step="0.01" 
                                    value={n2} onChange={(e) => setN2(Number(e.target.value))}
                                    className="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer slider-thumb thumb-cyan" 
                                />
                                <div className="flex gap-2">
                                    {['Water', 'Glass', 'Diamond'].map(m => (
                                        <button key={m} onClick={() => setN2(MATERIALS[m])} className="px-2 py-1 text-[10px] bg-slate-700 hover:bg-slate-600 rounded text-slate-300 transition-colors">
                                            {m}
                                        </button>
                                    ))}
                                </div>
                            </div>

                            <div className="h-px bg-slate-700"></div>

                            {/* Angle */}
                            <div className="space-y-3">
                                <div className="flex justify-between items-center">
                                    <label className="text-xs font-bold text-rose-400 uppercase">Incidence Angle ($ \theta_1 $)</label>
                                    <span className="text-white font-mono">{angle}°</span>
                                </div>
                                <input 
                                    type="range" min="0" max="85" step="1" 
                                    value={angle} onChange={(e) => setAngle(Number(e.target.value))}
                                    className="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer slider-thumb" 
                                />
                            </div>

                        </div>

                        {/* View Options */}
                        <div className="bg-slate-800 p-5 rounded-2xl border border-slate-700">
                             <div className="space-y-3">
                                <label className="flex items-center justify-between cursor-pointer">
                                    <span className="text-sm text-slate-300">Show Normal Line</span>
                                    <input type="checkbox" checked={showNormal} onChange={() => setShowNormal(!showNormal)} className="w-4 h-4 rounded text-blue-600 focus:ring-0 bg-slate-700 border-slate-600" />
                                </label>
                                <label className="flex items-center justify-between cursor-pointer">
                                    <span className="text-sm text-slate-300">Show Angles</span>
                                    <input type="checkbox" checked={showAngles} onChange={() => setShowAngles(!showAngles)} className="w-4 h-4 rounded text-blue-600 focus:ring-0 bg-slate-700 border-slate-600" />
                                </label>
                             </div>
                        </div>

                        {/* Calculation Box */}
                        <div className="bg-indigo-900/10 border border-indigo-500/20 p-5 rounded-2xl">
                            <h3 className="text-indigo-300 font-bold text-sm mb-3 flex items-center">
                                <i data-lucide="calculator" className="w-4 h-4 mr-2"></i> Snell's Law Check
                            </h3>
                            <div className="font-mono text-xs space-y-2 text-slate-300">
                                <div className="flex justify-between">
                                    <span>$n_1 \sin\theta_1$</span>
                                    <span className="text-white">{(n1 * Math.sin(angle * Math.PI/180)).toFixed(3)}</span>
                                </div>
                                <div className="flex justify-between border-t border-indigo-500/30 pt-2">
                                    <span>$n_2 \sin\theta_2$</span>
                                    <span className="text-white">{isTIR ? 'Undefined' : (n2 * Math.sin(refractedAngle * Math.PI/180)).toFixed(3)}</span>
                                </div>
                                {!isTIR && (
                                    <div className="text-right text-[10px] text-emerald-400 mt-1">✓ Balanced</div>
                                )}
                            </div>
                        </div>

                    </div>

                </main>
            </div>
        );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
</script>
</body>
</html>
