<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magnetic Field Lab | Luminous Learner</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@0.263.1"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #e2e8f0; }
        .canvas-container { cursor: move; }
        .slider-thumb::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none; width: 16px; height: 16px;
            border-radius: 50%; cursor: pointer; border: 2px solid #ffffff;
        }
        .thumb-red::-webkit-slider-thumb { background: #ef4444; }
    </style>
</head>
<body>

<div id="root"></div>

<script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const CANVAS_WIDTH = 800;
    const CANVAS_HEIGHT = 500;
    const FILING_COUNT = 3000;
    
    const App = () => {
        // --- State ---
        const [magnetPos, setMagnetPos] = useState({ x: 400, y: 250, angle: 0 });
        const [magnetStrength, setMagnetStrength] = useState(50); // Relative strength
        const [viewMode, setViewMode] = useState('filings'); // filings, lines
        const [showCompass, setShowCompass] = useState(false);
        const [compassPos, setCompassPos] = useState({ x: 100, y: 100 });

        const canvasRef = useRef(null);
        const filingsRef = useRef([]);
        const requestRef = useRef();
        const isDraggingRef = useRef(null); // 'magnet' or 'compass' or 'rotate'

        // --- Init Filings ---
        useEffect(() => {
            const filings = [];
            for (let i = 0; i < FILING_COUNT; i++) {
                filings.push({
                    x: Math.random() * CANVAS_WIDTH,
                    y: Math.random() * CANVAS_HEIGHT,
                    angle: Math.random() * Math.PI * 2,
                    len: 2 + Math.random() * 4,
                    color: `rgba(200, 200, 200, ${0.3 + Math.random()*0.5})`
                });
            }
            filingsRef.current = filings;
            updateFilings(true); // Force initial update
        }, []);

        // --- Physics Logic ---
        const getFieldAt = (x, y, mx, my, mAngle, strength) => {
            // Model magnet as two monopoles (N and S) separated by length L
            const L = 100;
            const rad = mAngle * Math.PI / 180;
            
            // North Pole Position
            const nx = mx + (L/2) * Math.cos(rad);
            const ny = my + (L/2) * Math.sin(rad);
            
            // South Pole Position
            const sx = mx - (L/2) * Math.cos(rad);
            const sy = my - (L/2) * Math.sin(rad);

            // Distance vectors
            const dnx = x - nx;
            const dny = y - ny;
            const distN2 = dnx*dnx + dny*dny;
            const distN = Math.sqrt(distN2);

            const dsx = x - sx;
            const dsy = y - sy;
            const distS2 = dsx*dsx + dsy*dsy;
            const distS = Math.sqrt(distS2);

            // B field = k * q / r^2
            // N is positive charge, S is negative
            const scale = strength * 500;
            
            // Avoid singularity
            const rMin = 20;
            
            // Field from N
            const Bnx = (scale * dnx) / Math.pow(Math.max(distN, rMin), 3);
            const Bny = (scale * dny) / Math.pow(Math.max(distN, rMin), 3);

            // Field from S
            const Bsx = (-scale * dsx) / Math.pow(Math.max(distS, rMin), 3);
            const Bsy = (-scale * dsy) / Math.pow(Math.max(distS, rMin), 3);

            return { Bx: Bnx + Bsx, By: Bny + Bsy };
        };

        const updateFilings = (isTapping = false) => {
            if (viewMode !== 'filings') return;

            const { x: mx, y: my, angle: ma } = magnetPos;
            
            filingsRef.current.forEach(f => {
                // Calculate B field at filing position
                const { Bx, By } = getFieldAt(f.x, f.y, mx, my, ma, magnetStrength);
                const targetAngle = Math.atan2(By, Bx);

                // Align filing
                // Friction logic: Filings don't move instantly unless "tapped" or very close
                // If tapping, alignment is fast. If not, alignment is slow/stuck.
                
                const B_mag = Math.sqrt(Bx*Bx + By*By);
                
                // Rotation speed depends on Field Strength (Torque)
                let rotSpeed = B_mag * 0.05;
                if (isTapping) rotSpeed += 0.5; // Tapping overcomes friction
                
                // Smoothly rotate towards target
                let diff = targetAngle - f.angle;
                // Normalize diff to -PI to PI
                while (diff > Math.PI) diff -= 2*Math.PI;
                while (diff < -Math.PI) diff += 2*Math.PI;
                
                f.angle += diff * Math.min(1, rotSpeed);
                
                // Optional: Magnetic attraction (Movement)
                // Real filings move towards poles if tapped
                if (isTapping) {
                    // Force ~ Gradient of B. Simplified: Move towards stronger field?
                    // Or just visual alignment is enough for this classic experiment.
                    // Let's add slight jitter
                    f.x += (Math.random() - 0.5) * 2;
                    f.y += (Math.random() - 0.5) * 2;
                }
            });
        };

        const tapTable = () => {
            // Animate over a few frames
            let frames = 0;
            const shake = () => {
                updateFilings(true);
                draw();
                frames++;
                if (frames < 20) requestAnimationFrame(shake);
            };
            shake();
        };

        // --- Main Loop ---
        useEffect(() => {
            updateFilings(false); // Passive update
            draw();
            // We don't need a constant loop unless moving things, to save battery.
            // But if magnet moves, we need loop.
            requestRef.current = requestAnimationFrame(() => {}); // Dummy
        }, [magnetPos, magnetStrength, viewMode, showCompass, compassPos]);

        // --- Interaction ---
        const handleMouseDown = (e) => {
            const rect = canvasRef.current.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            // Check Magnet Body
            const dx = x - magnetPos.x;
            const dy = y - magnetPos.y;
            // Unrotate to check rect
            const rad = -magnetPos.angle * Math.PI / 180;
            const rx = dx * Math.cos(rad) - dy * Math.sin(rad);
            const ry = dx * Math.sin(rad) + dy * Math.cos(rad);
            
            if (Math.abs(rx) < 55 && Math.abs(ry) < 25) {
                isDraggingRef.current = 'magnet';
                return;
            }

            // Check Compass
            if (showCompass && Math.hypot(x - compassPos.x, y - compassPos.y) < 30) {
                isDraggingRef.current = 'compass';
                return;
            }
        };

        const handleMouseMove = (e) => {
            if (!isDraggingRef.current) return;
            const rect = canvasRef.current.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            if (isDraggingRef.current === 'magnet') {
                setMagnetPos(prev => ({ ...prev, x, y }));
            } else if (isDraggingRef.current === 'compass') {
                setCompassPos({ x, y });
            }
        };

        const handleMouseUp = () => {
            isDraggingRef.current = null;
            // Re-settle filings if magnet moved
            tapTable(); 
        };
        
        const handleWheel = (e) => {
            // Rotate magnet with scroll
            e.preventDefault(); // Stop page scroll
            setMagnetPos(prev => ({ ...prev, angle: prev.angle + e.deltaY * 0.1 }));
        };

        // --- Rendering ---
        const draw = () => {
            const ctx = canvasRef.current?.getContext('2d');
            if (!ctx) return;

            ctx.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);

            // 1. Draw Field (Filings or Lines)
            if (viewMode === 'filings') {
                ctx.lineWidth = 1;
                filingsRef.current.forEach(f => {
                    ctx.strokeStyle = f.color;
                    ctx.beginPath();
                    const dx = Math.cos(f.angle) * f.len;
                    const dy = Math.sin(f.angle) * f.len;
                    ctx.moveTo(f.x - dx, f.y - dy);
                    ctx.lineTo(f.x + dx, f.y + dy);
                    ctx.stroke();
                });
            } else {
                // Field Lines Mode
                // Trace lines from N pole
                const L = 100;
                const rad = magnetPos.angle * Math.PI / 180;
                const nx = magnetPos.x + (L/2) * Math.cos(rad);
                const ny = magnetPos.y + (L/2) * Math.sin(rad);

                ctx.strokeStyle = 'rgba(56, 189, 248, 0.5)'; // Sky blue
                ctx.lineWidth = 2;

                const numLines = 24;
                for (let i = 0; i < numLines; i++) {
                    const startAngle = (i / numLines) * Math.PI * 2;
                    let cx = nx + 10 * Math.cos(startAngle);
                    let cy = ny + 10 * Math.sin(startAngle);
                    
                    ctx.beginPath();
                    ctx.moveTo(cx, cy);
                    
                    // RK4 or Euler integration
                    for (let step = 0; step < 200; step++) {
                        const { Bx, By } = getFieldAt(cx, cy, magnetPos.x, magnetPos.y, magnetPos.angle, magnetStrength);
                        const B = Math.sqrt(Bx*Bx + By*By);
                        if (B === 0) break;
                        
                        // Normalize and step
                        const dx = (Bx / B) * 10;
                        const dy = (By / B) * 10;
                        
                        cx += dx;
                        cy += dy;
                        ctx.lineTo(cx, cy);

                        // Stop if hit South pole approx
                        // S pos
                        const sx = magnetPos.x - (L/2) * Math.cos(rad);
                        const sy = magnetPos.y - (L/2) * Math.sin(rad);
                        if (Math.hypot(cx - sx, cy - sy) < 20) break;
                        if (cx < 0 || cx > CANVAS_WIDTH || cy < 0 || cy > CANVAS_HEIGHT) break;
                    }
                    ctx.stroke();
                }
            }

            // 2. Draw Magnet
            ctx.save();
            ctx.translate(magnetPos.x, magnetPos.y);
            ctx.rotate(magnetPos.angle * Math.PI / 180);
            
            // Body
            const w = 110;
            const h = 40;
            
            // South Half (Blue) - Left in local coords
            ctx.fillStyle = '#3b82f6'; 
            ctx.fillRect(-w/2, -h/2, w/2, h);
            
            // North Half (Red) - Right in local coords
            ctx.fillStyle = '#ef4444'; 
            ctx.fillRect(0, -h/2, w/2, h);
            
            // Text
            ctx.fillStyle = 'white';
            ctx.font = 'bold 20px sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.save();
            ctx.rotate(Math.PI/2); // Vertical text usually better on horiz magnet? No.
            ctx.restore();
            ctx.fillText('S', -w/4, 0);
            ctx.fillText('N', w/4, 0);
            
            ctx.restore();

            // 3. Draw Compass
            if (showCompass) {
                const { Bx, By } = getFieldAt(compassPos.x, compassPos.y, magnetPos.x, magnetPos.y, magnetPos.angle, magnetStrength);
                const needleAngle = Math.atan2(By, Bx);
                
                ctx.save();
                ctx.translate(compassPos.x, compassPos.y);
                
                // Case
                ctx.fillStyle = 'white';
                ctx.beginPath(); ctx.arc(0, 0, 25, 0, Math.PI*2); ctx.fill();
                ctx.strokeStyle = '#334155'; ctx.lineWidth=2; ctx.stroke();
                
                // Needle
                ctx.rotate(needleAngle);
                ctx.beginPath();
                ctx.fillStyle = '#ef4444'; // Red Tip (N)
                ctx.moveTo(20, 0); ctx.lineTo(-5, 8); ctx.lineTo(-5, -8); ctx.fill();
                
                ctx.beginPath();
                ctx.fillStyle = '#cbd5e1'; // Silver Tail (S)
                ctx.moveTo(-20, 0); ctx.lineTo(5, 8); ctx.lineTo(5, -8); ctx.fill();
                
                ctx.restore();
            }
        };

        useEffect(() => {
            if (window.lucide) window.lucide.createIcons();
        });

        return (
            <div className="min-h-screen bg-slate-900 text-slate-200 font-sans pb-12">
                <nav className="bg-slate-800 border-b border-slate-700 px-6 py-4 flex items-center justify-between sticky top-0 z-10">
                    <div className="flex items-center space-x-3">
                        <div className="bg-red-500/20 p-2 rounded-lg">
                            <i data-lucide="magnet" className="w-6 h-6 text-red-400"></i>
                        </div>
                        <h1 className="text-xl font-bold text-white tracking-wide">Magnetic Field Lab</h1>
                    </div>
                    <div className="text-xs text-slate-400 font-mono bg-slate-900 px-3 py-1 rounded-full border border-slate-700">
                        Topic: Magnetism
                    </div>
                </nav>

                <main className="max-w-6xl mx-auto p-4 md:p-6 grid grid-cols-1 lg:grid-cols-12 gap-8">
                    
                    {/* Left: Canvas */}
                    <div className="lg:col-span-9 flex flex-col gap-6">
                        <div className="bg-slate-950 rounded-2xl border border-slate-700 p-1 shadow-2xl relative overflow-hidden h-[500px]">
                            <canvas 
                                ref={canvasRef} 
                                width={CANVAS_WIDTH} 
                                height={CANVAS_HEIGHT}
                                onMouseDown={handleMouseDown}
                                onMouseMove={handleMouseMove}
                                onMouseUp={handleMouseUp}
                                onMouseLeave={handleMouseUp}
                                onWheel={handleWheel}
                                className="w-full h-full object-contain bg-slate-950 rounded-xl canvas-container"
                            />
                            
                            <div className="absolute top-4 left-4 bg-slate-900/80 px-4 py-2 rounded-lg border border-slate-700 text-sm text-slate-300 pointer-events-none">
                                Drag Magnet to move â€¢ Scroll to rotate
                            </div>
                        </div>

                        {/* Controls */}
                        <div className="bg-slate-800 p-6 rounded-2xl border border-slate-700 flex flex-wrap gap-8 items-center justify-between">
                            
                            <div className="flex gap-4">
                                <button 
                                    onClick={() => { setViewMode('filings'); setTimeout(tapTable, 50); }}
                                    className={`px-4 py-2 rounded-lg font-bold text-sm transition-colors ${viewMode === 'filings' ? 'bg-slate-200 text-slate-900' : 'bg-slate-700 text-slate-400 hover:text-white'}`}
                                >
                                    Iron Filings
                                </button>
                                <button 
                                    onClick={() => setViewMode('lines')}
                                    className={`px-4 py-2 rounded-lg font-bold text-sm transition-colors ${viewMode === 'lines' ? 'bg-blue-600 text-white' : 'bg-slate-700 text-slate-400 hover:text-white'}`}
                                >
                                    Field Lines
                                </button>
                            </div>

                            <div className="flex-1 max-w-xs">
                                <label className="flex justify-between text-xs font-bold text-slate-400 mb-1">
                                    Magnet Strength
                                </label>
                                <input 
                                    type="range" min="10" max="100" step="5" 
                                    value={magnetStrength} onChange={(e) => { setMagnetStrength(Number(e.target.value)); tapTable(); }}
                                    className="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer slider-thumb thumb-red" 
                                />
                            </div>

                            <div className="flex gap-4">
                                <label className="flex items-center gap-2 cursor-pointer bg-slate-700/50 px-3 py-2 rounded-lg border border-slate-600 hover:bg-slate-700 transition">
                                    <input type="checkbox" checked={showCompass} onChange={() => setShowCompass(!showCompass)} className="rounded text-red-500 bg-slate-800 border-slate-500 focus:ring-0" />
                                    <span className="text-xs font-bold text-slate-300 flex items-center gap-2"><i data-lucide="compass" className="w-3 h-3"></i> Compass</span>
                                </label>
                                <button 
                                    onClick={tapTable}
                                    className="px-6 py-2 bg-emerald-600 hover:bg-emerald-500 rounded-lg text-white font-bold transition-all shadow-lg flex items-center gap-2"
                                >
                                    <i data-lucide="vibrate" className="w-4 h-4"></i> Tap Table
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* Right: Info */}
                    <div className="lg:col-span-3 space-y-6">
                        
                        <div className="bg-slate-800 p-6 rounded-2xl border border-slate-700">
                            <h2 className="text-white font-bold mb-4 flex items-center">
                                <i data-lucide="book-open" className="w-5 h-5 mr-2 text-indigo-400"></i>
                                Guide
                            </h2>
                            <ul className="text-sm text-slate-400 space-y-3 list-disc pl-4">
                                <li>
                                    <strong>Iron Filings:</strong> Small pieces of iron that act like tiny magnets.
                                </li>
                                <li>
                                    <strong>Alignment:</strong> They align themselves with the magnetic field lines.
                                </li>
                                <li>
                                    <strong>Tapping:</strong> Friction prevents filings from moving perfectly. Tapping the table shakes them loose so they can align!
                                </li>
                            </ul>
                        </div>

                        <div className="bg-red-900/10 border border-red-500/20 p-5 rounded-2xl">
                            <h3 className="text-red-300 font-bold text-sm mb-2 flex items-center">
                                <i data-lucide="lightbulb" className="w-4 h-4 mr-2"></i> Direction Rule
                            </h3>
                            <p className="text-xs text-slate-300 leading-relaxed">
                                Magnetic field lines always travel from the <strong>North Pole</strong> to the <strong>South Pole</strong> outside the magnet.
                                <br/><br/>
                                Use the <strong>Compass</strong> tool to verify this! The Red needle (North) points in the direction of the field.
                            </p>
                        </div>

                    </div>

                </main>
            </div>
        );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
</script>
</body>
</html>
