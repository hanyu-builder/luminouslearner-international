<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Charged Particle Lab | Luminous Learner</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@0.263.1"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #e2e8f0; }
        .slider-thumb::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none; width: 16px; height: 16px;
            border-radius: 50%; cursor: pointer; border: 2px solid #ffffff;
        }
        .thumb-indigo::-webkit-slider-thumb { background: #6366f1; }
        .thumb-cyan::-webkit-slider-thumb { background: #06b6d4; }
    </style>
</head>
<body>

<div id="root"></div>

<script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const CANVAS_WIDTH = 800;
    const CANVAS_HEIGHT = 500;
    const CENTER_X = CANVAS_WIDTH / 2;
    const CENTER_Y = CANVAS_HEIGHT / 2;
    const PIXELS_PER_METER = 50; // Scale

    // Physics Constants (Scaled for visual)
    const Q_SCALE = 1; 
    const M_SCALE = 1;

    const App = () => {
        // --- State ---
        const [velocity, setVelocity] = useState(5.0); // m/s
        const [magneticField, setMagneticField] = useState(1.0); // Tesla
        const [particleType, setParticleType] = useState('proton'); // proton, electron, alpha
        
        // Particle Properties
        const [mass, setMass] = useState(1.0); // kg (relative)
        const [charge, setCharge] = useState(1.0); // C (relative)

        // Real-time Data
        const [radius, setRadius] = useState(0);
        const [period, setPeriod] = useState(0);
        
        // Sim State
        const [particles, setParticles] = useState([]); // {x, y, vx, vy, trail: []}
        const [isRunning, setIsRunning] = useState(true);

        const canvasRef = useRef(null);
        const requestRef = useRef();
        const prevTimeRef = useRef(0);

        // --- Presets ---
        useEffect(() => {
            if (particleType === 'proton') {
                setMass(1.0); setCharge(1.0);
            } else if (particleType === 'electron') {
                setMass(0.1); setCharge(-1.0); // Electron mass scaled up for visibility
            } else if (particleType === 'alpha') {
                setMass(4.0); setCharge(2.0);
            }
        }, [particleType]);

        // --- Physics Logic ---
        useEffect(() => {
            // r = mv / qB
            // T = 2 * pi * m / qB
            
            if (Math.abs(magneticField) < 0.01 || Math.abs(charge) < 0.01) {
                setRadius(Infinity);
                setPeriod(Infinity);
            } else {
                const r = (mass * velocity) / (Math.abs(charge) * Math.abs(magneticField));
                const T = (2 * Math.PI * mass) / (Math.abs(charge) * Math.abs(magneticField));
                setRadius(r);
                setPeriod(T);
            }
        }, [velocity, magneticField, mass, charge]);

        // --- Actions ---
        const fireParticle = () => {
            setParticles(prev => [...prev, {
                x: 50, // Start from left edge
                y: CENTER_Y,
                vx: velocity * PIXELS_PER_METER, // Scale to pixels/s
                vy: 0,
                m: mass,
                q: charge,
                trail: [],
                color: charge > 0 ? '#ef4444' : '#3b82f6',
                active: true
            }]);
        };

        const clear = () => setParticles([]);

        // --- Animation Loop ---
        const loop = (timestamp) => {
            const dt = (timestamp - prevTimeRef.current) / 1000;
            prevTimeRef.current = timestamp;
            
            // Limit dt for stability
            const safeDt = Math.min(dt, 0.05);

            setParticles(prev => prev.map(p => {
                if (!p.active) return p;

                // Lorentz Force: F = q(v x B)
                // In 2D: Fx = q * vy * B, Fy = -q * vx * B
                // a = F/m
                
                // B is perpendicular to screen (Z axis)
                // If B > 0 (Out), v = (vx, vy, 0), B = (0, 0, B)
                // v x B = (vy*B - 0, 0 - vx*B, 0) = (vy*B, -vx*B, 0)
                // F = q * (vy*B, -vx*B)
                
                // Let's use B value directly (positive or negative)
                // Force in pixels/s^2. B is in Tesla. q in C. m in kg.
                // We need to be careful with units scaling.
                // Physics: a = (q/m) * (v x B)
                
                // In simulation units:
                // v is in pixels/s.
                // We want r (pixels) = (m * v_px) / (q * B_sim)
                // So a_px = (q * B_sim / m) * v_perp
                // Let B_sim = magneticField.
                
                const B = magneticField;
                const ax = (p.q * B / p.m) * p.vy;
                const ay = -(p.q * B / p.m) * p.vx;
                
                const newVx = p.vx + ax * safeDt;
                const newVy = p.vy + ay * safeDt;
                const newX = p.x + newVx * safeDt;
                const newY = p.y + newVy * safeDt;

                // Trail
                const newTrail = [...p.trail];
                if (newTrail.length === 0 || Math.hypot(newX - newTrail[newTrail.length-1].x, newY - newTrail[newTrail.length-1].y) > 5) {
                    newTrail.push({x: newX, y: newY});
                }
                if (newTrail.length > 200) newTrail.shift();

                // Boundary check (Despawn if far out)
                const isActive = newX > -100 && newX < CANVAS_WIDTH + 100 && newY > -100 && newY < CANVAS_HEIGHT + 100;

                return { ...p, x: newX, y: newY, vx: newVx, vy: newVy, trail: newTrail, active: isActive };
            }).filter(p => p.active));

            draw();
            if (isRunning) {
                requestRef.current = requestAnimationFrame(loop);
            }
        };

        // --- Rendering ---
        const draw = () => {
            const ctx = canvasRef.current?.getContext('2d');
            if (!ctx) return;

            ctx.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);

            // 1. Draw Magnetic Field
            // Cross (x) for Into (Negative B), Dot (.) for Out (Positive B)
            ctx.fillStyle = 'rgba(255, 255, 255, 0.1)';
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.2)';
            ctx.lineWidth = 2;
            
            const spacing = 50;
            const size = 6;
            
            if (Math.abs(magneticField) > 0.1) {
                for (let x = 20; x < CANVAS_WIDTH; x += spacing) {
                    for (let y = 20; y < CANVAS_HEIGHT; y += spacing) {
                        if (magneticField < 0) {
                            // Into Page (X)
                            ctx.beginPath();
                            ctx.moveTo(x - size, y - size); ctx.lineTo(x + size, y + size);
                            ctx.moveTo(x + size, y - size); ctx.lineTo(x - size, y + size);
                            ctx.stroke();
                        } else {
                            // Out of Page (Dot)
                            ctx.beginPath();
                            ctx.arc(x, y, 2, 0, Math.PI*2);
                            ctx.fill();
                            ctx.beginPath();
                            ctx.arc(x, y, size, 0, Math.PI*2);
                            ctx.stroke();
                        }
                    }
                }
                // Label
                ctx.fillStyle = '#94a3b8';
                ctx.font = 'bold 16px sans-serif';
                ctx.textAlign = 'right';
                ctx.fillText(magneticField < 0 ? "B Field: INTO Page (x)" : "B Field: OUT of Page (•)", CANVAS_WIDTH - 20, 30);
            }

            // 2. Draw Particles
            particles.forEach(p => {
                // Trail
                ctx.beginPath();
                ctx.strokeStyle = p.color;
                ctx.lineWidth = 2;
                if (p.trail.length > 0) {
                    ctx.moveTo(p.trail[0].x, p.trail[0].y);
                    for (let i=1; i<p.trail.length; i++) ctx.lineTo(p.trail[i].x, p.trail[i].y);
                }
                ctx.lineTo(p.x, p.y);
                ctx.stroke();

                // Particle Body
                ctx.beginPath();
                ctx.arc(p.x, p.y, 6 + p.m, 0, Math.PI*2); // Size by mass
                ctx.fillStyle = p.color;
                ctx.fill();
                ctx.strokeStyle = 'white';
                ctx.lineWidth = 1;
                ctx.stroke();
                
                // Charge sign
                ctx.fillStyle = 'white';
                ctx.font = '10px sans-serif';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(p.q > 0 ? '+' : p.q < 0 ? '-' : 'n', p.x, p.y);
            });
            
            // 3. Draw Gun
            ctx.fillStyle = '#334155';
            ctx.fillRect(0, CENTER_Y - 15, 60, 30);
            ctx.fillStyle = '#475569';
            ctx.fillRect(50, CENTER_Y - 10, 10, 20); // Nozzle
        };

        useEffect(() => {
            if (isRunning) {
                requestRef.current = requestAnimationFrame(loop);
            } else {
                cancelAnimationFrame(requestRef.current);
            }
            return () => cancelAnimationFrame(requestRef.current);
        }, [isRunning, magneticField, particles]); // Re-bind on state change? No, use refs in loop. 
        // But particles state is updated via setParticles functional update, so it's safe.
        // Magnetic field is used in loop from state closure?
        // Yes, `loop` captures `magneticField`. This is a stale closure bug risk.
        // FIX: Use Ref for Magnetic Field
        
        // --- Ref Syncing ---
        const paramsRef = useRef({ B: 1.0 });
        useEffect(() => {
            paramsRef.current = { B: magneticField };
        }, [magneticField]);
        
        // Override Loop to use Ref
        const safeLoop = (timestamp) => {
            const dt = (timestamp - prevTimeRef.current) / 1000;
            prevTimeRef.current = timestamp;
            const safeDt = Math.min(dt, 0.05);

            setParticles(prev => prev.map(p => {
                if (!p.active) return p;

                const B = paramsRef.current.B;
                const ax = (p.q * B / p.m) * p.vy;
                const ay = -(p.q * B / p.m) * p.vx;
                
                const newVx = p.vx + ax * safeDt;
                const newVy = p.vy + ay * safeDt;
                const newX = p.x + newVx * safeDt;
                const newY = p.y + newVy * safeDt;

                const newTrail = [...p.trail];
                if (newTrail.length === 0 || Math.hypot(newX - newTrail[newTrail.length-1].x, newY - newTrail[newTrail.length-1].y) > 5) {
                    newTrail.push({x: newX, y: newY});
                }
                if (newTrail.length > 200) newTrail.shift();

                const isActive = newX > -100 && newX < CANVAS_WIDTH + 100 && newY > -100 && newY < CANVAS_HEIGHT + 100;

                return { ...p, x: newX, y: newY, vx: newVx, vy: newVy, trail: newTrail, active: isActive };
            }).filter(p => p.active));

            draw();
            if (isRunning) {
                requestRef.current = requestAnimationFrame(safeLoop);
            }
        };
        
        // Initial start
        useEffect(() => {
            if (isRunning) {
                prevTimeRef.current = performance.now();
                requestRef.current = requestAnimationFrame(safeLoop);
            }
            return () => cancelAnimationFrame(requestRef.current);
        }, [isRunning]); // Only restart loop if pause/play toggled

        useEffect(() => {
            if (window.lucide) window.lucide.createIcons();
        });
        
        useEffect(() => {
             draw(); // Draw initial state
        }, [magneticField, particles]);

        return (
            <div className="min-h-screen bg-slate-900 text-slate-200 font-sans pb-12">
                <nav className="bg-slate-800 border-b border-slate-700 px-6 py-4 flex items-center justify-between sticky top-0 z-10">
                    <div className="flex items-center space-x-3">
                        <div className="bg-indigo-500/20 p-2 rounded-lg">
                            <i data-lucide="atom" className="w-6 h-6 text-indigo-400"></i>
                        </div>
                        <h1 className="text-xl font-bold text-white tracking-wide">Charged Particle Lab</h1>
                    </div>
                    <div className="text-xs text-slate-400 font-mono bg-slate-900 px-3 py-1 rounded-full border border-slate-700">
                        Topic: Electromagnetism
                    </div>
                </nav>

                <main className="max-w-6xl mx-auto p-4 md:p-6 grid grid-cols-1 lg:grid-cols-12 gap-8">
                    
                    {/* Left: Simulation */}
                    <div className="lg:col-span-9 flex flex-col gap-6">
                        <div className="bg-slate-950 rounded-2xl border border-slate-700 p-1 shadow-2xl relative overflow-hidden h-[450px]">
                            <canvas 
                                ref={canvasRef} 
                                width={CANVAS_WIDTH} 
                                height={CANVAS_HEIGHT}
                                className="w-full h-full object-contain bg-slate-950 rounded-xl"
                            />
                            
                            <div className="absolute top-4 left-4 flex gap-2">
                                <button 
                                    onClick={fireParticle}
                                    className="px-6 py-2 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg font-bold shadow-lg transition-all flex items-center gap-2"
                                >
                                    <i data-lucide="crosshair" className="w-4 h-4"></i> Fire
                                </button>
                                <button 
                                    onClick={clear}
                                    className="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg font-bold transition-all"
                                >
                                    Clear
                                </button>
                            </div>
                        </div>

                        {/* Controls */}
                        <div className="bg-slate-800 p-6 rounded-2xl border border-slate-700 space-y-6">
                            
                            <div className="flex gap-4 mb-4 border-b border-slate-700 pb-4">
                                <button onClick={() => setParticleType('proton')} className={`flex-1 py-2 rounded text-sm font-bold transition-colors ${particleType === 'proton' ? 'bg-red-600 text-white' : 'bg-slate-700 text-slate-400'}`}>Proton (+)</button>
                                <button onClick={() => setParticleType('electron')} className={`flex-1 py-2 rounded text-sm font-bold transition-colors ${particleType === 'electron' ? 'bg-blue-600 text-white' : 'bg-slate-700 text-slate-400'}`}>Electron (-)</button>
                                <button onClick={() => setParticleType('alpha')} className={`flex-1 py-2 rounded text-sm font-bold transition-colors ${particleType === 'alpha' ? 'bg-purple-600 text-white' : 'bg-slate-700 text-slate-400'}`}>Alpha (++)</button>
                            </div>

                            <div className="grid grid-cols-2 gap-8">
                                <div>
                                    <label className="flex justify-between text-xs font-bold text-cyan-300 mb-2">
                                        Velocity ($v$) <span className="text-white">{velocity} m/s</span>
                                    </label>
                                    <input 
                                        type="range" min="1" max="10" step="0.5" 
                                        value={velocity} onChange={(e) => setVelocity(Number(e.target.value))}
                                        className="w-full h-2 bg-slate-700 rounded-lg slider-thumb thumb-cyan" 
                                    />
                                </div>
                                <div>
                                    <label className="flex justify-between text-xs font-bold text-indigo-300 mb-2">
                                        Magnetic Field ($B$) <span className="text-white">{magneticField} T</span>
                                    </label>
                                    <input 
                                        type="range" min="-2.0" max="2.0" step="0.1" 
                                        value={magneticField} onChange={(e) => setMagneticField(Number(e.target.value))}
                                        className="w-full h-2 bg-slate-700 rounded-lg slider-thumb thumb-indigo" 
                                    />
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Right: Analysis */}
                    <div className="lg:col-span-3 space-y-6">
                        
                        <div className="bg-slate-800 p-6 rounded-2xl border border-slate-700">
                            <h2 className="text-white font-bold mb-4 flex items-center">
                                <i data-lucide="calculator" className="w-5 h-5 mr-2 text-indigo-400"></i>
                                Properties
                            </h2>
                            <div className="space-y-4 font-mono text-sm">
                                <div className="flex justify-between border-b border-slate-700 pb-1">
                                    <span className="text-slate-400">Mass ($m$)</span>
                                    <span className="text-white">{mass} u</span>
                                </div>
                                <div className="flex justify-between border-b border-slate-700 pb-1">
                                    <span className="text-slate-400">Charge ($q$)</span>
                                    <span className="text-white">{charge > 0 ? '+' : ''}{charge} e</span>
                                </div>
                                <div className="p-3 bg-slate-900 rounded border border-slate-700 mt-2">
                                    <div className="text-[10px] text-slate-500 uppercase mb-1">Radius ($r = mv/qB$)</div>
                                    <div className="text-xl font-bold text-emerald-400">
                                        {Math.abs(radius) === Infinity ? "∞" : Math.abs(radius).toFixed(2)} <span className="text-xs text-slate-500">m</span>
                                    </div>
                                </div>
                                <div className="p-3 bg-slate-900 rounded border border-slate-700">
                                    <div className="text-[10px] text-slate-500 uppercase mb-1">Period ($T$)</div>
                                    <div className="text-lg font-bold text-white">
                                        {Math.abs(period) === Infinity ? "∞" : Math.abs(period).toFixed(2)} <span className="text-xs text-slate-500">s</span>
                                    </div>
                                    <div className="text-[9px] text-indigo-300 mt-1 italic">Note: Independent of Velocity!</div>
                                </div>
                            </div>
                        </div>

                        <div className="bg-indigo-900/10 border border-indigo-500/20 p-5 rounded-2xl">
                            <h3 className="text-indigo-300 font-bold text-sm mb-2 flex items-center">
                                <i data-lucide="lightbulb" className="w-4 h-4 mr-2"></i> Hand Rule
                            </h3>
                            <p className="text-xs text-slate-300 leading-relaxed">
                                Use <strong>Fleming's Left Hand Rule</strong> for positive charges (Proton).
                                <br/><br/>
                                For negative charges (Electron), use your <strong>Right Hand</strong> (or reverse the result).
                            </p>
                        </div>

                    </div>

                </main>
            </div>
        );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
</script>
</body>
</html>
