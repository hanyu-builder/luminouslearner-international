<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Terminal Velocity Lab | Luminous Learner</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Prop Types -->
    <script src="https://unpkg.com/prop-types/prop-types.min.js"></script>
    
    <!-- Recharts -->
    <script src="https://unpkg.com/recharts@2.12.7/umd/Recharts.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@0.263.1"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #e2e8f0; overflow-y: hidden; }
        .slider-thumb::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none; width: 16px; height: 16px;
            border-radius: 50%; cursor: pointer; border: 2px solid #ffffff;
        }
        .thumb-sky::-webkit-slider-thumb { background: #0ea5e9; }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #1e293b; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
    </style>
</head>
<body>

<div id="root"></div>

<script type="text/babel">
    const { useState, useEffect, useRef, useMemo } = React;
    const { LineChart, Line, XAxis, YAxis, Tooltip, ResponsiveContainer, CartesianGrid, ReferenceLine } = Recharts;

    const CANVAS_WIDTH = 900;
    const CANVAS_HEIGHT = 550;
    
    // Physics Constants
    const G = 9.8; // m/s^2
    const MASS = 80; // kg (Skydiver + Gear)
    
    const App = () => {
        // --- State ---
        const [isJumping, setIsJumping] = useState(false);
        const [parachuteOpen, setParachuteOpen] = useState(false);
        const [position, setPosition] = useState("Dive"); // Dive (Low Area) vs Spread (High Area)
        const [airDensity, setAirDensity] = useState(1.2); // kg/m^3
        
        // Physics Real-time Data
        const [velocity, setVelocity] = useState(0);
        const [acceleration, setAcceleration] = useState(0);
        const [height, setHeight] = useState(2000); // m
        const [time, setTime] = useState(0);

        const canvasRef = useRef(null);
        const requestRef = useRef();
        
        // Simulation Ref
        const simRef = useRef({
            y: 2000, // Height in m
            v: 0, // Velocity m/s (down is positive for calc, displayed as positive speed)
            t: 0,
            history: [] // Data for graph
        });

        // Derived Values
        // Drag Coefficient * Area (CdA)
        // Dive: Small area, low drag. Spread: Medium area. Parachute: Huge area.
        const getCdA = () => {
            if (parachuteOpen) return 40; // Parachute deployed
            return position === "Dive" ? 0.3 : 0.8; // Dive vs Spread
        };

        const CdA = getCdA();
        // Terminal Velocity Calculation: mg = 0.5 * rho * CdA * v^2
        // v_term = sqrt( (2mg) / (rho * CdA) )
        const v_terminal = Math.sqrt((2 * MASS * G) / (airDensity * CdA));

        // --- Physics Engine ---
        const updatePhysics = () => {
            if (!isJumping) return;

            const dt = 0.05; // Time step
            const state = simRef.current;
            
            // Forces
            const weight = MASS * G;
            // Drag = 0.5 * rho * v^2 * CdA
            const drag = 0.5 * airDensity * state.v * state.v * CdA;
            
            const netForce = weight - drag;
            const acc = netForce / MASS;
            
            // Update State
            state.v += acc * dt;
            state.y -= state.v * dt;
            state.t += dt;
            
            // Ground Collision
            if (state.y <= 0) {
                state.y = 0;
                state.v = 0;
                setIsJumping(false);
            }

            // Sync React State (Throttled for performance in real app, here direct is fine for simple sim)
            setVelocity(state.v);
            setAcceleration(acc);
            setHeight(state.y);
            setTime(state.t);
            
            // Graph Data (Downsample)
            if (Math.floor(state.t * 10) % 2 === 0) { // Every ~0.2s game time
                 // Limit history length
                 if (state.history.length > 200) state.history.shift();
                 state.history.push({ t: state.t.toFixed(1), v: state.v.toFixed(1) });
            }
        };

        const loop = () => {
            updatePhysics();
            draw();
            requestRef.current = requestAnimationFrame(loop);
        };

        const reset = () => {
            setIsJumping(false);
            setParachuteOpen(false);
            setHeight(2000);
            setVelocity(0);
            setAcceleration(0);
            setTime(0);
            simRef.current = { y: 2000, v: 0, t: 0, history: [] };
        };

        // --- Drawing ---
        const draw = () => {
            const ctx = canvasRef.current?.getContext('2d');
            if (!ctx) return;

            // Clear
            ctx.fillStyle = '#0f172a'; // Dark sky
            // Gradient Sky
            const grad = ctx.createLinearGradient(0, 0, 0, CANVAS_HEIGHT);
            grad.addColorStop(0, '#020617'); // Space
            grad.addColorStop(1, '#1e3a8a'); // Lower sky
            ctx.fillStyle = grad;
            ctx.fillRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);

            // Cloud Parallax (Visual Cue for Speed)
            const speedVisual = simRef.current.v * 0.5; // Scale for visual
            const timeOffset = Date.now() / 1000;
            
            drawCloud(ctx, 100, (timeOffset * speedVisual * 0.5) % CANVAS_HEIGHT, 0.5);
            drawCloud(ctx, 500, ((timeOffset * speedVisual * 0.8) + 200) % CANVAS_HEIGHT, 0.8);
            drawCloud(ctx, 300, ((timeOffset * speedVisual * 1.2) + 400) % CANVAS_HEIGHT, 1.2);

            // Ground Indicator (Altitude Meter Visual)
            if (simRef.current.y < 500) {
                // Ground approaching
                const groundY = CANVAS_HEIGHT + (simRef.current.y * 2) - 100; // Map 0m to bottom
                ctx.fillStyle = '#166534'; // Green ground
                ctx.fillRect(0, groundY, CANVAS_WIDTH, 500);
            }

            // Draw Skydiver
            const cx = 300; // Fixed horizontal position
            const cy = CANVAS_HEIGHT / 2; // Fixed vertical center
            
            ctx.save();
            ctx.translate(cx, cy);
            
            // Draw Parachute
            if (parachuteOpen) {
                ctx.fillStyle = '#ef4444'; // Red Chute
                ctx.beginPath();
                ctx.arc(0, -60, 80, Math.PI, 0); // Semi circle
                ctx.fill();
                // Strings
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(-80, -60); ctx.lineTo(0, 0);
                ctx.moveTo(80, -60); ctx.lineTo(0, 0);
                ctx.moveTo(-40, -60); ctx.lineTo(0, 0);
                ctx.moveTo(40, -60); ctx.lineTo(0, 0);
                ctx.stroke();
            }

            // Draw Human
            ctx.fillStyle = '#38bdf8'; // Blue suit
            if (position === "Dive" && !parachuteOpen) {
                // Diving pose (Vertical)
                ctx.fillRect(-10, -20, 20, 50); // Body
                ctx.beginPath(); ctx.arc(0, -20, 10, 0, Math.PI*2); ctx.fillStyle='#fcd34d'; ctx.fill(); // Head
            } else {
                // Spread pose (Horizontal)
                ctx.fillRect(-30, -10, 60, 20); // Body
                ctx.beginPath(); ctx.arc(0, -15, 10, 0, Math.PI*2); ctx.fillStyle='#fcd34d'; ctx.fill(); // Head
                // Arms/Legs
                ctx.strokeStyle='#38bdf8'; ctx.lineWidth=8;
                ctx.beginPath(); ctx.moveTo(-30, 0); ctx.lineTo(-50, -10); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(30, 0); ctx.lineTo(50, -10); ctx.stroke();
            }
            
            // Force Vectors
            // Gravity (Constant Down)
            drawArrow(ctx, 0, 0, 0, 60, '#22c55e', 'Weight');
            
            // Air Resistance (Variable Up)
            const dragForce = 0.5 * airDensity * simRef.current.v * simRef.current.v * CdA;
            const dragVisual = Math.min(150, drag / 10); // Scale
            if (simRef.current.v > 1) {
                drawArrow(ctx, 0, -20, 0, -dragVisual, '#f43f5e', 'Drag');
            }

            ctx.restore();
        };

        const drawCloud = (ctx, x, y, scale) => {
            ctx.fillStyle = `rgba(255, 255, 255, ${0.1 * scale})`;
            ctx.beginPath();
            ctx.arc(x, y, 40*scale, 0, Math.PI*2);
            ctx.arc(x+30*scale, y-20*scale, 50*scale, 0, Math.PI*2);
            ctx.arc(x+80*scale, y, 40*scale, 0, Math.PI*2);
            ctx.fill();
        };

        const drawArrow = (ctx, x, y, dx, dy, color, label) => {
            ctx.save();
            ctx.strokeStyle = color;
            ctx.fillStyle = color;
            ctx.lineWidth = 3;
            
            ctx.beginPath();
            ctx.moveTo(x, y);
            ctx.lineTo(x + dx, y + dy);
            ctx.stroke();
            
            // Head
            const angle = Math.atan2(dy, dx);
            const headLen = 10;
            ctx.beginPath();
            ctx.moveTo(x + dx, y + dy);
            ctx.lineTo(x + dx - headLen * Math.cos(angle - Math.PI/6), y + dy - headLen * Math.sin(angle - Math.PI/6));
            ctx.lineTo(x + dx - headLen * Math.cos(angle + Math.PI/6), y + dy - headLen * Math.sin(angle + Math.PI/6));
            ctx.fill();
            
            // Label
            ctx.font = 'bold 12px sans-serif';
            ctx.fillText(label, x + dx + 10, y + dy);
            ctx.restore();
        };

        useEffect(() => {
            requestRef.current = requestAnimationFrame(loop);
            return () => cancelAnimationFrame(requestRef.current);
        }, [isJumping, parachuteOpen, position, airDensity]);

        useEffect(() => {
            if (window.lucide) window.lucide.createIcons();
        });

        return (
            <div className="h-screen bg-slate-900 text-slate-200 font-sans overflow-hidden flex flex-col">
                <nav className="bg-slate-800 border-b border-slate-700 px-4 py-2 flex items-center justify-between shrink-0 h-14">
                    <div className="flex items-center space-x-3">
                        <div className="bg-sky-500/20 p-1.5 rounded-lg">
                            <i data-lucide="cloud" className="w-5 h-5 text-sky-400"></i>
                        </div>
                        <h1 className="text-lg font-bold text-white tracking-wide">Terminal Velocity Lab</h1>
                    </div>
                    <div className="text-[10px] text-slate-400 font-mono bg-slate-900 px-2 py-1 rounded-full border border-slate-700">
                        Topic: Mechanics
                    </div>
                </nav>

                <main className="flex-1 overflow-hidden">
                    <div className="h-full max-w-[1200px] mx-auto grid grid-cols-1 lg:grid-cols-4">
                        
                        {/* LEFT: Canvas */}
                        <div className="lg:col-span-3 bg-slate-950 relative border-r border-slate-700">
                            <canvas 
                                ref={canvasRef} 
                                width={CANVAS_WIDTH} 
                                height={CANVAS_HEIGHT}
                                className="w-full h-full object-contain"
                            />
                            
                            {/* Overlay Stats */}
                            <div className="absolute top-4 left-4 grid grid-cols-3 gap-4">
                                <div className="bg-slate-900/80 backdrop-blur p-3 rounded-xl border border-slate-700">
                                    <div className="text-[10px] text-slate-400 uppercase">Velocity</div>
                                    <div className="text-2xl font-mono font-bold text-white">{velocity.toFixed(1)} m/s</div>
                                </div>
                                <div className="bg-slate-900/80 backdrop-blur p-3 rounded-xl border border-slate-700">
                                    <div className="text-[10px] text-slate-400 uppercase">Acceleration</div>
                                    <div className={`text-2xl font-mono font-bold ${acceleration > 0 ? 'text-green-400' : 'text-red-400'}`}>
                                        {acceleration.toFixed(2)} m/s²
                                    </div>
                                </div>
                                <div className="bg-slate-900/80 backdrop-blur p-3 rounded-xl border border-slate-700">
                                    <div className="text-[10px] text-slate-400 uppercase">Altitude</div>
                                    <div className="text-2xl font-mono font-bold text-sky-400">{height.toFixed(0)} m</div>
                                </div>
                            </div>
                        </div>

                        {/* RIGHT: Controls */}
                        <div className="lg:col-span-1 bg-slate-900 border-l border-slate-700 flex flex-col h-full overflow-y-auto custom-scroll">
                            
                            {/* 1. v-t Graph */}
                            <div className="h-48 w-full bg-slate-950 border-b border-slate-700 p-2 relative">
                                <div className="text-[9px] text-slate-500 absolute top-2 left-2 z-10">Velocity-Time Graph</div>
                                <ResponsiveContainer width="100%" height="100%">
                                    <LineChart data={simRef.current.history}>
                                        <CartesianGrid strokeDasharray="3 3" stroke="#334155" />
                                        <XAxis dataKey="t" tick={{fontSize: 9}} hide />
                                        <YAxis domain={[0, 60]} tick={{fontSize: 9}} />
                                        <Tooltip 
                                            contentStyle={{backgroundColor: '#1e293b', border: '1px solid #475569', fontSize: '10px'}}
                                            itemStyle={{color: '#38bdf8'}}
                                        />
                                        <ReferenceLine y={v_terminal} stroke="#ef4444" strokeDasharray="3 3" label={{ value: 'V-term', position: 'insideTopRight', fill: '#ef4444', fontSize: 10 }} />
                                        <Line type="monotone" dataKey="v" stroke="#38bdf8" strokeWidth={2} dot={false} isAnimationActive={false} />
                                    </LineChart>
                                </ResponsiveContainer>
                            </div>

                            {/* 2. Controls */}
                            <div className="p-5 space-y-6 flex-1">
                                
                                {/* Jump Controls */}
                                <div className="grid grid-cols-2 gap-2">
                                    <button 
                                        onClick={isJumping ? reset : () => setIsJumping(true)}
                                        className={`py-3 rounded-lg font-bold text-sm flex items-center justify-center gap-2 border transition-all 
                                            ${isJumping ? 'bg-red-600 border-red-500 text-white' : 'bg-green-600 border-green-500 text-white'}`}
                                    >
                                        <i data-lucide={isJumping ? "rotate-ccw" : "plane"} className="w-4 h-4"></i>
                                        {isJumping ? "Reset" : "Jump!"}
                                    </button>
                                    <button 
                                        onClick={() => setParachuteOpen(!parachuteOpen)}
                                        disabled={!isJumping}
                                        className={`py-3 rounded-lg font-bold text-sm flex items-center justify-center gap-2 border transition-all 
                                            ${parachuteOpen ? 'bg-indigo-600 border-indigo-500 text-white' : 'bg-slate-700 text-slate-300'}`}
                                    >
                                        <i data-lucide="umbrella" className="w-4 h-4"></i>
                                        {parachuteOpen ? "Cut Chute" : "Open Chute"}
                                    </button>
                                </div>

                                {/* Body Position */}
                                <div>
                                    <label className="text-xs font-bold text-slate-300 mb-2 block">Body Position</label>
                                    <div className="grid grid-cols-2 gap-2">
                                        <button 
                                            onClick={() => setPosition("Dive")}
                                            className={`py-2 px-1 text-xs rounded border transition-all
                                                ${position === "Dive" 
                                                    ? 'bg-sky-600 border-sky-500 text-white' 
                                                    : 'bg-slate-800 border-slate-700 text-slate-400'}
                                            `}
                                        >
                                            Head Dive (Fast)
                                        </button>
                                        <button 
                                            onClick={() => setPosition("Spread")}
                                            className={`py-2 px-1 text-xs rounded border transition-all
                                                ${position === "Spread" 
                                                    ? 'bg-sky-600 border-sky-500 text-white' 
                                                    : 'bg-slate-800 border-slate-700 text-slate-400'}
                                            `}
                                        >
                                            Spread Eagle (Slow)
                                        </button>
                                    </div>
                                </div>

                                {/* Air Density */}
                                <div>
                                    <label className="flex justify-between text-xs font-bold text-slate-300 mb-1">
                                        Air Density
                                        <span>{airDensity} kg/m³</span>
                                    </label>
                                    <input 
                                        type="range" min="0.5" max="2.0" step="0.1" 
                                        value={airDensity} onChange={(e) => setAirDensity(Number(e.target.value))}
                                        className="w-full h-2 bg-slate-700 rounded-lg slider-thumb thumb-sky" 
                                    />
                                </div>

                                <div className="mt-auto p-3 bg-indigo-900/10 border border-indigo-500/20 rounded-lg">
                                    <h4 className="text-indigo-400 font-bold text-xs mb-1">
                                        Current Terminal Velocity
                                    </h4>
                                    <div className="font-mono text-xl font-bold text-white">
                                        {v_terminal.toFixed(1)} m/s
                                    </div>
                                    <p className="text-[9px] text-slate-400 mt-1">
                                        At this speed, Drag Force = Gravity. Acceleration = 0.
                                    </p>
                                </div>

                            </div>
                        </div>

                    </div>
                </main>
            </div>
        );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
</script>
</body>
</html>
