<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Action-Reaction Lab | Luminous Learner</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@0.263.1"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #e2e8f0; }
        .slider-thumb::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none; width: 16px; height: 16px;
            border-radius: 50%; background: #ffffff; cursor: pointer; border: 2px solid #3b82f6;
        }
        .slider-thumb-red::-webkit-slider-thumb { border-color: #ef4444; }
        .slider-thumb-blue::-webkit-slider-thumb { border-color: #3b82f6; }
    </style>
</head>
<body>

<div id="root"></div>

<script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const CANVAS_WIDTH = 800;
    const CANVAS_HEIGHT = 350;
    const TRACK_Y = 250;
    const CART_WIDTH = 80;
    const CART_HEIGHT = 50;
    const PIXELS_PER_METER = 50; 
    const SPRING_IMPULSE = 10; // Newton-seconds (Change in momentum)

    const App = () => {
        // --- State ---
        const [massA, setMassA] = useState(2.0); // kg
        const [massB, setMassB] = useState(1.0); // kg
        
        // Sim State
        const [simState, setSimState] = useState('ready'); // ready, pushing, moving, finished
        const [posA, setPosA] = useState(-60); // Relative to center
        const [posB, setPosB] = useState(60);  // Relative to center
        const [velA, setVelA] = useState(0);
        const [velB, setVelB] = useState(0);
        const [time, setTime] = useState(0);

        // Refs
        const requestRef = useRef();
        const startTimeRef = useRef(0);
        const physicsRef = useRef({ xA: -60, xB: 60, vA: 0, vB: 0 });

        // --- Logic ---
        const startExplosion = () => {
            if (simState !== 'ready') return;
            
            // 1. Calculate Velocities based on Conservation of Momentum
            // Initial P = 0. Final P = mA*vA + mB*vB = 0.
            // Impulse J acts on B (+J) and A (-J).
            // vA = -J / mA
            // vB = +J / mB
            
            const vA = -SPRING_IMPULSE / massA;
            const vB = SPRING_IMPULSE / massB;

            physicsRef.current = { 
                xA: -50, // Initial spacing
                xB: 50, 
                vA: vA * PIXELS_PER_METER, // Convert to pixels/s for visual
                vB: vB * PIXELS_PER_METER 
            };

            setSimState('pushing');
            
            // Short delay to show the "Force" arrows before moving
            setTimeout(() => {
                setSimState('moving');
                startTimeRef.current = Date.now();
                loop();
            }, 600);
        };

        const resetSim = () => {
            setSimState('ready');
            cancelAnimationFrame(requestRef.current);
            setPosA(-50);
            setPosB(50);
            setVelA(0);
            setVelB(0);
            setTime(0);
            physicsRef.current = { xA: -50, xB: 50, vA: 0, vB: 0 };
        };

        const loop = () => {
            const now = Date.now();
            const dt = 0.016; // Fixed timestep approx
            
            // Update positions
            physicsRef.current.xA += physicsRef.current.vA * dt;
            physicsRef.current.xB += physicsRef.current.vB * dt;
            
            // Wall collisions (Stop)
            const limit = CANVAS_WIDTH / 2 - CART_WIDTH;
            if (physicsRef.current.xA < -limit || physicsRef.current.xB > limit) {
                setSimState('finished');
                return;
            }

            // Sync UI
            setPosA(physicsRef.current.xA);
            setPosB(physicsRef.current.xB);
            setVelA(physicsRef.current.vA / PIXELS_PER_METER); // Convert back to m/s
            setVelB(physicsRef.current.vB / PIXELS_PER_METER);
            setTime(t => t + dt);

            requestRef.current = requestAnimationFrame(loop);
        };

        useEffect(() => {
            return () => cancelAnimationFrame(requestRef.current);
        }, []);

        // Init icons
        useEffect(() => {
            if (window.lucide) window.lucide.createIcons();
        });

        // --- Rendering ---
        const canvasRef = useRef(null);
        
        useEffect(() => {
            const ctx = canvasRef.current?.getContext('2d');
            if (!ctx) return;

            // Clear
            ctx.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
            const CX = CANVAS_WIDTH / 2; // Center X

            // 1. Draw Track
            ctx.fillStyle = '#334155';
            ctx.fillRect(0, TRACK_Y, CANVAS_WIDTH, 10);
            // Ruler Ticks
            ctx.fillStyle = '#475569';
            for(let x = 0; x <= CANVAS_WIDTH; x+=50) {
                ctx.fillRect(x, TRACK_Y, 2, 10);
            }
            // Center Marker
            ctx.fillStyle = '#ef4444';
            ctx.fillRect(CX - 1, TRACK_Y - 10, 2, 20);

            // 2. Draw Cart A (Left)
            const cartAX = CX + posA - CART_WIDTH; // posA is center-relative right edge of cart A? No, let's say posA is center of cart A
            // Let's define pos as Center of Cart
            const drawPosA = CX + posA - CART_WIDTH/2;
            const drawPosB = CX + posB - CART_WIDTH/2;

            drawCart(ctx, drawPosA, TRACK_Y - CART_HEIGHT - 5, massA, '#3b82f6', 'A');
            
            // 3. Draw Cart B (Right)
            drawCart(ctx, drawPosB, TRACK_Y - CART_HEIGHT - 5, massB, '#ef4444', 'B');

            // 4. Draw Spring (Between Carts)
            if (simState === 'ready' || simState === 'pushing') {
                const springStartX = drawPosA + CART_WIDTH;
                const springEndX = drawPosB;
                drawSpring(ctx, springStartX, TRACK_Y - 25, springEndX - springStartX, 10);
            }

            // 5. Draw Force Vectors (During Push)
            if (simState === 'pushing') {
                const fY = TRACK_Y - 40;
                // Force on A (Left)
                drawArrow(ctx, drawPosA + CART_WIDTH, fY, -80, 0, '#ef4444', 'F_BA'); // Force on A by B
                // Force on B (Right)
                drawArrow(ctx, drawPosB, fY, 80, 0, '#3b82f6', 'F_AB'); // Force on B by A
            }

            // 6. Draw Velocity Vectors (During Motion)
            if (simState === 'moving' || simState === 'finished') {
                const vY = TRACK_Y - 70;
                // Velocity A
                drawArrow(ctx, drawPosA + CART_WIDTH/2, vY, velA * 20, 0, '#93c5fd', `vA = ${velA.toFixed(1)}`);
                // Velocity B
                drawArrow(ctx, drawPosB + CART_WIDTH/2, vY, velB * 20, 0, '#fca5a5', `vB = ${velB.toFixed(1)}`);
            }

        }, [posA, posB, massA, massB, simState, velA, velB]);

        const drawCart = (ctx, x, y, mass, color, label) => {
            // Wheels
            ctx.fillStyle = '#1e293b';
            ctx.beginPath(); ctx.arc(x + 15, y + CART_HEIGHT + 5, 8, 0, Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.arc(x + CART_WIDTH - 15, y + CART_HEIGHT + 5, 8, 0, Math.PI*2); ctx.fill();

            // Body
            ctx.fillStyle = color;
            ctx.fillRect(x, y, CART_WIDTH, CART_HEIGHT);
            
            // Label
            ctx.fillStyle = 'rgba(255,255,255,0.9)';
            ctx.font = 'bold 16px sans-serif';
            ctx.fillText(label, x + CART_WIDTH/2 - 6, y + 25);
            ctx.font = '12px sans-serif';
            ctx.fillText(`${mass}kg`, x + CART_WIDTH/2 - 12, y + 42);
        };

        const drawSpring = (ctx, x, y, width, coils) => {
            ctx.strokeStyle = '#94a3b8';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(x, y);
            for (let i = 1; i <= coils; i++) {
                const cx = x + (width / coils) * i;
                const cy = y + (i % 2 === 0 ? 5 : -5);
                ctx.lineTo(cx, cy);
            }
            ctx.stroke();
        };

        const drawArrow = (ctx, x, y, len, angle, color, label) => {
            if (Math.abs(len) < 5) return;
            const toX = x + len;
            const toY = y; // Horizontal only for this sim
            
            ctx.beginPath();
            ctx.strokeStyle = color;
            ctx.lineWidth = 3;
            ctx.moveTo(x, y);
            ctx.lineTo(toX, toY);
            ctx.stroke();

            // Arrowhead
            const dir = len > 0 ? 1 : -1;
            ctx.beginPath();
            ctx.fillStyle = color;
            ctx.moveTo(toX, toY);
            ctx.lineTo(toX - 8 * dir, y - 6);
            ctx.lineTo(toX - 8 * dir, y + 6);
            ctx.fill();

            // Label
            ctx.fillStyle = color;
            ctx.font = 'bold 12px sans-serif';
            ctx.fillText(label, x + len/2 - 10, y - 10);
        };

        // Momentum Calculation
        const pA = massA * velA;
        const pB = massB * velB;
        const pTotal = pA + pB;

        return (
            <div className="min-h-screen bg-slate-900 text-slate-200 font-sans pb-12">
                <nav className="bg-slate-800 border-b border-slate-700 px-6 py-4 flex items-center justify-between sticky top-0 z-10">
                    <div className="flex items-center space-x-3">
                        <div className="bg-purple-500/20 p-2 rounded-lg">
                            <i data-lucide="arrow-left-right" className="w-6 h-6 text-purple-400"></i>
                        </div>
                        <h1 className="text-xl font-bold text-white tracking-wide">Action-Reaction Lab</h1>
                    </div>
                    <div className="text-xs text-slate-400 font-mono bg-slate-900 px-3 py-1 rounded-full border border-slate-700">
                        Topic: Newton's 3rd Law
                    </div>
                </nav>

                <main className="max-w-6xl mx-auto p-4 md:p-6 grid grid-cols-1 lg:grid-cols-12 gap-8">
                    
                    {/* Top: Simulation */}
                    <div className="lg:col-span-12">
                        <div className="bg-slate-800 rounded-2xl border border-slate-700 p-1 shadow-2xl relative overflow-hidden h-[350px]">
                            <canvas 
                                ref={canvasRef} 
                                width={CANVAS_WIDTH} 
                                height={CANVAS_HEIGHT}
                                className="w-full h-full object-contain bg-slate-950 rounded-xl"
                            />
                            
                            <div className="absolute top-4 left-1/2 -translate-x-1/2 bg-slate-900/80 px-4 py-2 rounded-full border border-slate-600 font-mono text-sm">
                                {simState === 'ready' ? 'Ready to Release' : simState === 'pushing' ? 'EXPLOSION!' : `Time: ${time.toFixed(2)}s`}
                            </div>
                        </div>
                    </div>

                    {/* Bottom Left: Controls */}
                    <div className="lg:col-span-5 space-y-6">
                        <div className="bg-slate-800 p-6 rounded-2xl border border-slate-700">
                            <h2 className="text-white font-bold mb-6 flex items-center">
                                <i data-lucide="settings-2" className="w-5 h-5 mr-2 text-slate-400"></i>
                                Cart Settings
                            </h2>

                            {/* Mass A */}
                            <div className="mb-6">
                                <div className="flex justify-between mb-2">
                                    <label className="text-sm font-bold text-blue-300">Mass A (Left)</label>
                                    <span className="font-mono text-white">{massA} kg</span>
                                </div>
                                <input 
                                    type="range" min="0.5" max="5.0" step="0.5"
                                    value={massA}
                                    onChange={(e) => { setMassA(Number(e.target.value)); resetSim(); }}
                                    disabled={simState !== 'ready'}
                                    className="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer slider-thumb slider-thumb-blue"
                                />
                            </div>

                            {/* Mass B */}
                            <div className="mb-8">
                                <div className="flex justify-between mb-2">
                                    <label className="text-sm font-bold text-red-300">Mass B (Right)</label>
                                    <span className="font-mono text-white">{massB} kg</span>
                                </div>
                                <input 
                                    type="range" min="0.5" max="5.0" step="0.5"
                                    value={massB}
                                    onChange={(e) => { setMassB(Number(e.target.value)); resetSim(); }}
                                    disabled={simState !== 'ready'}
                                    className="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer slider-thumb slider-thumb-red"
                                />
                            </div>

                            <button 
                                onClick={simState === 'ready' ? startExplosion : resetSim}
                                className={`w-full py-4 rounded-xl font-bold flex items-center justify-center transition-all ${
                                    simState === 'ready'
                                    ? 'bg-purple-600 hover:bg-purple-500 text-white shadow-lg shadow-purple-500/20' 
                                    : 'bg-slate-700 hover:bg-slate-600 text-slate-200'
                                }`}
                            >
                                <i data-lucide={simState === 'ready' ? "scaling" : "rotate-ccw"} className="w-5 h-5 mr-2"></i>
                                {simState === 'ready' ? 'Release Spring' : 'Reset Experiment'}
                            </button>
                        </div>
                    </div>

                    {/* Bottom Right: Analysis */}
                    <div className="lg:col-span-7 space-y-6">
                        
                        <div className="grid grid-cols-2 gap-4">
                            {/* Data A */}
                            <div className="bg-slate-800 p-5 rounded-2xl border border-slate-700 relative overflow-hidden">
                                <div className="absolute top-0 left-0 w-1 h-full bg-blue-500"></div>
                                <h3 className="text-blue-400 text-xs font-bold uppercase tracking-wider mb-2">Cart A Data</h3>
                                <div className="space-y-2 font-mono text-sm">
                                    <div className="flex justify-between">
                                        <span className="text-slate-500">Velocity</span>
                                        <span className="text-white">{velA.toFixed(2)} m/s</span>
                                    </div>
                                    <div className="flex justify-between">
                                        <span className="text-slate-500">Momentum</span>
                                        <span className="text-blue-300">{pA.toFixed(2)} kg·m/s</span>
                                    </div>
                                </div>
                            </div>

                            {/* Data B */}
                            <div className="bg-slate-800 p-5 rounded-2xl border border-slate-700 relative overflow-hidden">
                                <div className="absolute top-0 left-0 w-1 h-full bg-red-500"></div>
                                <h3 className="text-red-400 text-xs font-bold uppercase tracking-wider mb-2">Cart B Data</h3>
                                <div className="space-y-2 font-mono text-sm">
                                    <div className="flex justify-between">
                                        <span className="text-slate-500">Velocity</span>
                                        <span className="text-white">+{velB.toFixed(2)} m/s</span>
                                    </div>
                                    <div className="flex justify-between">
                                        <span className="text-slate-500">Momentum</span>
                                        <span className="text-red-300">+{pB.toFixed(2)} kg·m/s</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Momentum Check */}
                        <div className="bg-indigo-900/10 border border-indigo-500/20 p-6 rounded-2xl">
                            <h3 className="text-indigo-300 font-bold mb-4 flex items-center">
                                <i data-lucide="scale" className="w-5 h-5 mr-2"></i>
                                Momentum Conservation Check
                            </h3>
                            
                            <div className="flex items-center justify-center gap-4 text-xl font-mono mb-4">
                                <span className="text-blue-400">{pA.toFixed(1)}</span>
                                <span className="text-slate-500">+</span>
                                <span className="text-red-400">{pB.toFixed(1)}</span>
                                <span className="text-slate-500">=</span>
                                <span className={`font-bold ${Math.abs(pTotal) < 0.1 ? 'text-emerald-400' : 'text-white'}`}>
                                    {Math.abs(pTotal) < 0.01 ? "0.0" : pTotal.toFixed(1)}
                                </span>
                            </div>

                            <p className="text-xs text-center text-slate-400">
                                Total momentum remains zero because the forces were equal and opposite!
                            </p>
                        </div>

                    </div>

                </main>
            </div>
        );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
</script>
</body>
</html>
