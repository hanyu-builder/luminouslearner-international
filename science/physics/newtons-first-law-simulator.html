<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Newton's Inertia Bus | Luminous Learner</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@0.263.1"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700;900&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #e2e8f0; }
        .road-stripes {
            background-image: linear-gradient(90deg, transparent 50%, #ffffff 50%);
            background-size: 100px 100%;
        }
    </style>
</head>
<body>

<div id="root"></div>

<script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const CANVAS_WIDTH = 800;
    const CANVAS_HEIGHT = 400;
    const GROUND_Y = 320;
    const BUS_WIDTH = 400;
    const BUS_HEIGHT = 180;
    
    const App = () => {
        // --- State ---
        const [simState, setSimState] = useState('idle'); // idle, moving, braking, crashed
        const [speed, setSpeed] = useState(0); // Bus speed (pixels/frame)
        const [showVectors, setShowVectors] = useState(true);
        const [playbackSpeed, setPlaybackSpeed] = useState(1.0); // 1.0 or 0.2

        // Physics State Refs (Mutable source of truth for animation loop)
        const simStateRef = useRef('idle'); // Fixed: Ref for loop access
        const playbackSpeedRef = useRef(1.0); // Fixed: Ref for loop access
        
        const busRef = useRef({ x: 50, v: 0 });
        const personARef = useRef({ x: 0, v: 0, state: 'sitting' });
        const personBRef = useRef({ x: 0, v: 0, state: 'standing' });
        const ballRef = useRef({ x: 0, v: 0 });
        const roadOffsetRef = useRef(0);
        
        const historyRef = useRef([]); 
        const timeRef = useRef(0);
        const requestRef = useRef();

        // --- Constants ---
        const CRUISE_SPEED = 8;
        const BRAKE_DECEL = 0.3;
        const ACCEL = 0.1;
        const BUS_START_X = 100;

        // --- Sync Refs with State ---
        useEffect(() => {
            playbackSpeedRef.current = playbackSpeed;
        }, [playbackSpeed]);

        // --- Logic ---
        const resetSim = () => {
            setSimState('idle');
            simStateRef.current = 'idle'; // Sync Ref
            setSpeed(0);
            busRef.current = { x: BUS_START_X, v: 0 };
            personARef.current = { x: 50, v: 0, state: 'sitting' };
            personBRef.current = { x: 200, v: 0, state: 'standing' };
            ballRef.current = { x: 300, v: 0 };
            roadOffsetRef.current = 0;
            timeRef.current = 0;
            historyRef.current = [];
            cancelAnimationFrame(requestRef.current);
            draw(); 
        };

        const startDriving = () => {
            if (simState === 'idle') {
                setSimState('moving');
                simStateRef.current = 'moving'; // Sync Ref immediately
                loop();
            }
        };

        const applyBrakes = () => {
            if (simState === 'moving') {
                setSimState('braking');
                simStateRef.current = 'braking'; // Sync Ref immediately
            }
        };

        const loop = () => {
            // Use Ref values inside the loop to avoid stale closures
            const currentState = simStateRef.current;
            const currentPlaybackSpeed = playbackSpeedRef.current;

            const dt = 1 * currentPlaybackSpeed;
            timeRef.current += dt;

            // 1. Bus Physics
            if (currentState === 'moving') {
                if (busRef.current.v < CRUISE_SPEED) busRef.current.v += ACCEL * dt;
            } else if (currentState === 'braking') {
                if (busRef.current.v > 0) {
                    busRef.current.v -= BRAKE_DECEL * dt;
                    if (busRef.current.v < 0) busRef.current.v = 0;
                }
            }

            // Move Road
            roadOffsetRef.current -= busRef.current.v * dt;

            // 2. Objects Physics
            if (currentState === 'moving') {
                personBRef.current.v_ground = busRef.current.v;
                ballRef.current.v_ground = busRef.current.v;
            } else if (currentState === 'braking') {
                // Newton's 1st Law: v_ground stays constant for loose objects
                
                const dX_B = (personBRef.current.v_ground - busRef.current.v) * dt;
                personBRef.current.x += dX_B;

                const dX_Ball = (ballRef.current.v_ground - busRef.current.v) * dt;
                ballRef.current.x += dX_Ball;

                // Collision
                if (personBRef.current.x > 330) {
                    personBRef.current.x = 330;
                    personBRef.current.v_ground = 0;
                    personBRef.current.state = 'crashed';
                }
                if (ballRef.current.x > 360) {
                    ballRef.current.x = 360;
                    ballRef.current.v_ground = 0;
                }
            }

            setSpeed(busRef.current.v);

            if (timeRef.current % 5 < 1) {
                historyRef.current.push({
                    t: timeRef.current,
                    vBus: busRef.current.v,
                    vPerson: personBRef.current.v_ground
                });
            }

            draw();

            // Continue loop condition
            if (busRef.current.v > 0 || currentState === 'moving' || (currentState === 'braking' && personBRef.current.state !== 'crashed' && personBRef.current.v_ground > 0)) {
                requestRef.current = requestAnimationFrame(loop);
            }
        };

        // --- Rendering ---
        const draw = () => {
            const canvas = document.getElementById('simCanvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');

            // Use Ref value for rendering logic too
            const currentState = simStateRef.current;

            ctx.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);

            // 1. Draw Background
            ctx.fillStyle = '#87ceeb';
            ctx.fillRect(0, 0, CANVAS_WIDTH, GROUND_Y);
            
            ctx.fillStyle = '#cbd5e1';
            const bgOffset = roadOffsetRef.current * 0.5;
            for(let i=0; i<10; i++) {
                const x = (i * 200 + bgOffset) % (CANVAS_WIDTH + 200);
                const h = 100 + Math.sin(i)*50;
                ctx.fillRect(x - 200, GROUND_Y - h, 80, h);
            }

            // 2. Draw Road
            ctx.fillStyle = '#334155';
            ctx.fillRect(0, GROUND_Y, CANVAS_WIDTH, CANVAS_HEIGHT - GROUND_Y);
            ctx.fillStyle = '#ffffff';
            const stripeOffset = roadOffsetRef.current % 100;
            for(let i=0; i<CANVAS_WIDTH/50; i++) {
                ctx.fillRect(i * 100 + stripeOffset, GROUND_Y + 30, 40, 10);
            }

            // 3. Draw Bus
            const bx = busRef.current.x;
            const by = GROUND_Y - BUS_HEIGHT - 10;
            
            ctx.fillStyle = '#f59e0b';
            ctx.fillRect(bx, by, BUS_WIDTH, BUS_HEIGHT);
            ctx.fillStyle = '#e0f2fe';
            ctx.fillRect(bx + 20, by + 20, 80, 60);
            ctx.fillRect(bx + 120, by + 20, 200, 60);
            ctx.fillStyle = '#1e293b';
            ctx.beginPath(); ctx.arc(bx + 80, GROUND_Y - 10, 25, 0, Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.arc(bx + 320, GROUND_Y - 10, 25, 0, Math.PI*2); ctx.fill();

            // 4. Draw Objects
            drawPerson(ctx, bx + personARef.current.x, by + BUS_HEIGHT - 10, '#10b981', false, false);
            ctx.beginPath();
            ctx.moveTo(bx + personARef.current.x, by + BUS_HEIGHT - 90);
            ctx.lineTo(bx + personARef.current.x + 10, by + 10);
            ctx.strokeStyle = '#64748b';
            ctx.lineWidth = 3;
            ctx.stroke();

            drawPerson(ctx, bx + personBRef.current.x, by + BUS_HEIGHT - 10, '#ef4444', personBRef.current.state === 'crashed', true);

            const ballX = bx + ballRef.current.x;
            const ballY = by + BUS_HEIGHT - 10;
            ctx.beginPath();
            ctx.arc(ballX, ballY, 10, 0, Math.PI*2);
            ctx.fillStyle = '#3b82f6';
            ctx.fill();

            // 5. Vectors
            if (showVectors && currentState !== 'idle') {
                drawVector(ctx, bx + BUS_WIDTH/2, by - 30, busRef.current.v * 10, '#f59e0b', 'v_bus');
                
                if (currentState === 'braking') {
                    drawVector(ctx, bx + personBRef.current.x, by + 40, personBRef.current.v_ground * 10, '#ef4444', 'Inertia');
                }
            }
        };

        const drawPerson = (ctx, x, footY, color, isCrashed, isLoose) => {
            ctx.fillStyle = color;
            ctx.strokeStyle = color;
            ctx.lineWidth = 4;
            
            if (isCrashed) {
                ctx.beginPath();
                ctx.moveTo(x, footY);
                ctx.lineTo(x + 40, footY);
                ctx.stroke();
                ctx.beginPath(); ctx.arc(x + 50, footY - 5, 8, 0, Math.PI*2); ctx.fill();
            } else {
                ctx.beginPath();
                ctx.moveTo(x, footY); 
                ctx.lineTo(x, footY - 40);
                ctx.lineTo(x, footY - 80);
                ctx.stroke();
                ctx.beginPath(); ctx.arc(x, footY - 90, 10, 0, Math.PI*2); ctx.fill();
                
                ctx.beginPath();
                ctx.moveTo(x, footY - 70);
                if (!isLoose) ctx.lineTo(x + 10, footY - 100);
                else ctx.lineTo(x + 10, footY - 50);
                ctx.stroke();
            }
        };

        const drawVector = (ctx, x, y, len, color, label) => {
            if (len < 5) return;
            ctx.beginPath();
            ctx.moveTo(x, y);
            ctx.lineTo(x + len, y);
            ctx.strokeStyle = color;
            ctx.lineWidth = 3;
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(x + len, y);
            ctx.lineTo(x + len - 5, y - 5);
            ctx.lineTo(x + len - 5, y + 5);
            ctx.fillStyle = color;
            ctx.fill();
            ctx.fillStyle = color;
            ctx.font = '12px sans-serif';
            ctx.fillText(label, x + len/2, y - 8);
        };

        useEffect(() => {
            draw();
            if (window.lucide) window.lucide.createIcons();
            return () => cancelAnimationFrame(requestRef.current);
        }, []);

        const Graph = () => {
            const h = 100;
            const w = 300;
            const maxV = CRUISE_SPEED + 2;
            const maxT = timeRef.current > 50 ? timeRef.current : 50;

            const mapX = t => (t / maxT) * w;
            const mapY = v => h - (v / maxV) * h;

            return (
                <div className="w-full h-full bg-slate-900 border border-slate-700 rounded relative overflow-hidden">
                    <svg width="100%" height="100%" viewBox={`0 0 ${w} ${h}`} preserveAspectRatio="none">
                        <polyline 
                            points={historyRef.current.map(d => `${mapX(d.t)},${mapY(d.vBus)}`).join(' ')}
                            fill="none" stroke="#f59e0b" strokeWidth="2"
                        />
                        <polyline 
                            points={historyRef.current.map(d => `${mapX(d.t)},${mapY(d.vPerson)}`).join(' ')}
                            fill="none" stroke="#ef4444" strokeWidth="2" strokeDasharray="4 2"
                        />
                    </svg>
                    <div className="absolute top-1 left-1 text-[10px] text-amber-500">Bus Speed</div>
                    <div className="absolute top-4 left-1 text-[10px] text-red-500">Passenger Speed</div>
                </div>
            );
        };

        return (
            <div className="min-h-screen bg-slate-900 text-slate-200 font-sans pb-12">
                <nav className="bg-slate-800 border-b border-slate-700 px-6 py-4 flex items-center justify-between sticky top-0 z-10">
                    <div className="flex items-center space-x-3">
                        <div className="bg-amber-500/20 p-2 rounded-lg">
                            <i data-lucide="bus" className="w-6 h-6 text-amber-400"></i>
                        </div>
                        <h1 className="text-xl font-bold text-white tracking-wide">Newton's Inertia Bus</h1>
                    </div>
                    <div className="text-xs text-slate-400 font-mono bg-slate-900 px-3 py-1 rounded-full border border-slate-700">
                        Topic: Dynamics
                    </div>
                </nav>

                <main className="max-w-6xl mx-auto p-4 md:p-6 space-y-6">
                    
                    {/* Simulation Area */}
                    <div className="bg-slate-800 rounded-2xl border border-slate-700 p-2 shadow-2xl relative">
                        <canvas id="simCanvas" width={CANVAS_WIDTH} height={CANVAS_HEIGHT} className="w-full h-auto rounded-xl bg-slate-950"></canvas>
                        
                        {/* Status Overlay */}
                        <div className="absolute top-4 left-4 bg-black/50 backdrop-blur px-4 py-2 rounded-lg border border-white/10 text-white font-mono">
                            Speed: {(speed * 5).toFixed(0)} km/h
                        </div>

                        {/* Playback Controls */}
                        <div className="absolute top-4 right-4 flex gap-2">
                            <button 
                                onClick={() => setPlaybackSpeed(playbackSpeed === 1 ? 0.2 : 1)}
                                className={`px-3 py-1 rounded text-xs font-bold border ${playbackSpeed < 1 ? 'bg-indigo-600 border-indigo-400 text-white' : 'bg-slate-900/50 border-slate-600 text-slate-300'}`}
                            >
                                <i data-lucide="clock" className="w-3 h-3 inline mr-1"></i> Slow Mo
                            </button>
                        </div>
                    </div>

                    {/* Controls & Graph */}
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        
                        {/* Control Panel */}
                        <div className="bg-slate-800 p-6 rounded-2xl border border-slate-700 space-y-4">
                            <h2 className="text-white font-bold mb-2 flex items-center">
                                <i data-lucide="gamepad-2" className="w-5 h-5 mr-2 text-indigo-400"></i> Driver Controls
                            </h2>
                            
                            <div className="grid grid-cols-2 gap-3">
                                <button 
                                    onClick={startDriving}
                                    disabled={simState !== 'idle'}
                                    className={`py-4 rounded-xl font-bold flex flex-col items-center justify-center transition-all ${simState === 'idle' ? 'bg-emerald-600 hover:bg-emerald-500 text-white shadow-lg' : 'bg-slate-700 text-slate-500'}`}
                                >
                                    <i data-lucide="play" className="w-6 h-6 mb-1"></i>
                                    Accelerate
                                </button>
                                <button 
                                    onClick={applyBrakes}
                                    disabled={simState !== 'moving'}
                                    className={`py-4 rounded-xl font-bold flex flex-col items-center justify-center transition-all ${simState === 'moving' ? 'bg-red-600 hover:bg-red-500 text-white shadow-lg animate-pulse' : 'bg-slate-700 text-slate-500'}`}
                                >
                                    <i data-lucide="octagon" className="w-6 h-6 mb-1"></i>
                                    BRAKE!
                                </button>
                            </div>
                            
                            <button 
                                onClick={resetSim}
                                className="w-full py-3 bg-slate-700 hover:bg-slate-600 text-slate-200 rounded-xl font-medium transition-colors flex items-center justify-center"
                            >
                                <i data-lucide="rotate-ccw" className="w-4 h-4 mr-2"></i> Reset Scenario
                            </button>
                        </div>

                        {/* Legend / Key */}
                        <div className="bg-slate-800 p-6 rounded-2xl border border-slate-700 text-sm">
                            <h3 className="text-slate-400 font-bold mb-4 uppercase tracking-wider text-xs">Passengers</h3>
                            <ul className="space-y-4">
                                <li className="flex items-center gap-3">
                                    <div className="w-3 h-3 rounded-full bg-emerald-500"></div>
                                    <div>
                                        <div className="font-bold text-white">Smart Sam</div>
                                        <div className="text-xs text-slate-400">Holding strap (Force applied)</div>
                                    </div>
                                </li>
                                <li className="flex items-center gap-3">
                                    <div className="w-3 h-3 rounded-full bg-red-500"></div>
                                    <div>
                                        <div className="font-bold text-white">Careless Carl</div>
                                        <div className="text-xs text-slate-400">Not holding (Inertia dominates)</div>
                                    </div>
                                </li>
                            </ul>
                        </div>

                        {/* Graph */}
                        <div className="bg-slate-800 p-4 rounded-2xl border border-slate-700 h-48">
                            <Graph />
                        </div>

                    </div>

                </main>
            </div>
        );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);

    if (typeof lucide !== 'undefined') {
        setTimeout(() => lucide.createIcons(), 100);
    }
</script>
</body>
</html>
