<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultrasound A-Scan vs B-Scan | Luminous Learner</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@0.263.1"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #e2e8f0; overflow-y: hidden; }
        .slider-thumb::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none; width: 16px; height: 16px;
            border-radius: 50%; cursor: pointer; border: 2px solid #ffffff;
        }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #1e293b; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        .scan-line {
            background: linear-gradient(to bottom, rgba(16, 185, 129, 0) 0%, rgba(16, 185, 129, 0.8) 100%);
        }
    </style>
</head>
<body>

<div id="root"></div>

<script type="text/babel">
    const { useState, useEffect, useRef, useMemo } = React;

    const CANVAS_WIDTH = 400; // Width of tissue canvas
    const CANVAS_HEIGHT = 400; // Height of tissue canvas
    const GRAPH_HEIGHT = 200; // Height of A-Scan Scope

    const App = () => {
        // --- State ---
        const [probeX, setProbeX] = useState(50); // 0 to 100%
        const [gain, setGain] = useState(50); // Amplification
        const [isSweeping, setIsSweeping] = useState(false);
        const [showTissue, setShowTissue] = useState(false); // Hide/Show the "Answer"
        
        // Canvas Refs
        const tissueCanvasRef = useRef(null);
        const aScanCanvasRef = useRef(null);
        const bScanCanvasRef = useRef(null);
        const requestRef = useRef();
        
        // Data Store for B-Scan Memory
        // Array of 100 columns (representing 0-100% width), each containing pixel brightness data
        const bScanMemory = useRef(new Array(100).fill(null));

        // --- Physics Logic: Ray Tracing ---
        // Define objects in the tissue
        const getIntersections = (xPct) => {
            const x = xPct * CANVAS_WIDTH / 100;
            const intersections = [];
            
            // 1. Skin Surface (Always at y=20)
            intersections.push({ y: 20, strength: 0.8 });

            // 2. Muscle Layer Boundary (y=120)
            intersections.push({ y: 120, strength: 0.4 });

            // 3. Round Object (Tumor/Organ)
            // Circle centered at (200, 250) with radius 60
            const cx = 200, cy = 250, r = 60;
            // Check if scan line intersects circle: |x - cx| < r
            if (Math.abs(x - cx) < r) {
                const dy = Math.sqrt(r*r - (x-cx)*(x-cx));
                // Top surface
                intersections.push({ y: cy - dy, strength: 0.7 });
                // Bottom surface
                intersections.push({ y: cy + dy, strength: 0.5 });
            }

            // 4. Bone/Bottom Layer (y=380)
            intersections.push({ y: 380, strength: 0.9 });

            return intersections.sort((a, b) => a.y - b.y);
        };

        // --- Loop ---
        const loop = () => {
            // Auto Sweep Logic
            if (isSweeping) {
                setProbeX(prev => {
                    if (prev >= 100) {
                        setIsSweeping(false);
                        return 100;
                    }
                    return prev + 0.5;
                });
            }

            drawTissue();
            drawAScan();
            drawBScan();
            requestRef.current = requestAnimationFrame(loop);
        };

        // --- 1. Draw Tissue (The "Reality") ---
        const drawTissue = () => {
            const ctx = tissueCanvasRef.current?.getContext('2d');
            if (!ctx) return;

            // Clear
            ctx.fillStyle = '#0f172a';
            ctx.fillRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);

            if (showTissue) {
                // Draw Layers
                // Skin to Muscle
                ctx.fillStyle = '#334155';
                ctx.fillRect(0, 20, CANVAS_WIDTH, 100);
                // Muscle
                ctx.fillStyle = '#1e293b';
                ctx.fillRect(0, 120, CANVAS_WIDTH, 260);
                // Bone
                ctx.fillStyle = '#e2e8f0';
                ctx.fillRect(0, 380, CANVAS_WIDTH, 20);

                // Draw Object (Tumor)
                ctx.beginPath();
                ctx.arc(200, 250, 60, 0, Math.PI * 2);
                ctx.fillStyle = '#9f1239'; // Reddish
                ctx.fill();
                ctx.strokeStyle = '#f43f5e';
                ctx.stroke();
            } else {
                // Hidden mode hint
                ctx.fillStyle = '#1e293b';
                ctx.fillRect(0, 20, CANVAS_WIDTH, 380);
                ctx.fillStyle = '#334155';
                ctx.font = '20px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText("Tissue (Hidden)", CANVAS_WIDTH/2, CANVAS_HEIGHT/2);
            }

            // Draw Probe
            const px = probeX * CANVAS_WIDTH / 100;
            ctx.fillStyle = '#38bdf8'; // Sky blue probe
            ctx.fillRect(px - 10, 0, 20, 20);
            
            // Draw Ultrasound Beam
            const grad = ctx.createLinearGradient(0, 20, 0, CANVAS_HEIGHT);
            grad.addColorStop(0, 'rgba(56, 189, 248, 0.5)');
            grad.addColorStop(1, 'rgba(56, 189, 248, 0)');
            ctx.fillStyle = grad;
            ctx.fillRect(px - 2, 20, 4, CANVAS_HEIGHT);
        };

        // --- 2. Draw A-Scan (The Graph) ---
        const drawAScan = () => {
            const ctx = aScanCanvasRef.current?.getContext('2d');
            if (!ctx) return;

            // Clear
            ctx.fillStyle = '#020617'; // Darker for scope
            ctx.fillRect(0, 0, CANVAS_WIDTH, GRAPH_HEIGHT);

            // Grid
            ctx.strokeStyle = '#1e293b';
            ctx.lineWidth = 1;
            ctx.beginPath();
            for(let i=0; i<CANVAS_WIDTH; i+=40) { ctx.moveTo(i, 0); ctx.lineTo(i, GRAPH_HEIGHT); }
            for(let i=0; i<GRAPH_HEIGHT; i+=40) { ctx.moveTo(0, i); ctx.lineTo(CANVAS_WIDTH, i); }
            ctx.stroke();

            // Calculate Signal
            const intersections = getIntersections(probeX);
            
            ctx.beginPath();
            ctx.strokeStyle = '#34d399'; // Emerald Green Trace
            ctx.lineWidth = 2;
            
            // Plot Amplitude vs Time (Depth)
            // Time axis is vertical in the B-Scan, but Horizontal in A-Scan usually?
            // Actually, usually A-scan X-axis is Depth (Time), Y-axis is Amplitude.
            // But to align with the B-Scan visually (which is vertical depth), 
            // let's rotate the A-scan? Or keep standard?
            // Standard: X=Time(Depth). Let's use the width of the scope canvas for depth.
            
            // Map tissue depth (0-400) to Scope Width (0-400)
            
            ctx.moveTo(0, GRAPH_HEIGHT - 10); // Baseline

            // Generate a noisy signal
            for (let x = 0; x < CANVAS_WIDTH; x++) {
                let amp = Math.random() * 2; // Noise base
                
                // Check for echoes
                intersections.forEach(hit => {
                    // hit.y is the depth.
                    // If x is close to hit.y
                    const dist = Math.abs(x - hit.y);
                    if (dist < 5) {
                        // Gaussian peak
                        amp += hit.strength * gain * Math.exp(-dist*dist/2); 
                    }
                });

                const y = GRAPH_HEIGHT - 10 - Math.min(amp, GRAPH_HEIGHT - 20);
                ctx.lineTo(x, y);
            }
            ctx.stroke();

            // Labels
            ctx.fillStyle = '#34d399';
            ctx.font = '10px monospace';
            ctx.fillText("Amplitude (V)", 10, 20);
            ctx.fillText("Time / Depth (t)", CANVAS_WIDTH - 80, GRAPH_HEIGHT - 10);
        };

        // --- 3. Draw B-Scan (The Image) ---
        const drawBScan = () => {
            const ctx = bScanCanvasRef.current?.getContext('2d');
            if (!ctx) return;

            // Clear
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);

            // Update Memory for current probe position
            const colIndex = Math.floor(probeX); // 0-100
            if (colIndex >= 0 && colIndex < 100) {
                const intersections = getIntersections(probeX);
                // Create a vertical strip of pixel data
                const strip = new Uint8ClampedArray(CANVAS_HEIGHT); // 0-255 brightness
                
                // Fill strip
                for(let y=0; y<CANVAS_HEIGHT; y++) {
                    let brightness = 0;
                    intersections.forEach(hit => {
                        const dist = Math.abs(y - hit.y);
                        if (dist < 4) {
                            brightness += hit.strength * gain * 4 * Math.exp(-dist*dist/4);
                        }
                    });
                    strip[y] = Math.min(255, brightness);
                }
                bScanMemory.current[colIndex] = strip;
            }

            // Draw from Memory
            // We need to stretch 100 columns to CANVAS_WIDTH (400px)
            const colWidth = CANVAS_WIDTH / 100;

            bScanMemory.current.forEach((strip, i) => {
                if (!strip) return;
                
                const x = i * colWidth;
                
                // Draw pixels for this column
                // Optimization: Draw small rects for bright spots only
                for(let y=0; y<CANVAS_HEIGHT; y+=2) { // Step 2 for perf
                    const b = strip[y];
                    if (b > 10) { // Threshold
                        ctx.fillStyle = `rgb(${b}, ${b}, ${b})`;
                        ctx.fillRect(x, y, colWidth, 2);
                    }
                }
            });

            // Draw current probe line indicator
            const px = probeX * CANVAS_WIDTH / 100;
            ctx.strokeStyle = 'rgba(56, 189, 248, 0.5)';
            ctx.beginPath(); ctx.moveTo(px, 0); ctx.lineTo(px, CANVAS_HEIGHT); ctx.stroke();
        };

        const clearScan = () => {
            bScanMemory.current = new Array(100).fill(null);
            setProbeX(0);
        };

        useEffect(() => {
            requestRef.current = requestAnimationFrame(loop);
            return () => cancelAnimationFrame(requestRef.current);
        }, [probeX, gain, isSweeping, showTissue]);

        useEffect(() => {
            if (window.lucide) window.lucide.createIcons();
        });

        return (
            <div className="h-screen bg-slate-900 text-slate-200 font-sans overflow-hidden flex flex-col">
                <nav className="bg-slate-800 border-b border-slate-700 px-4 py-2 flex items-center justify-between shrink-0 h-14">
                    <div className="flex items-center space-x-3">
                        <div className="bg-emerald-500/20 p-1.5 rounded-lg">
                            <i data-lucide="activity" className="w-5 h-5 text-emerald-400"></i>
                        </div>
                        <h1 className="text-lg font-bold text-white tracking-wide">Ultrasound Lab: A-Scan vs B-Scan</h1>
                    </div>
                    <div className="text-[10px] text-slate-400 font-mono bg-slate-900 px-2 py-1 rounded-full border border-slate-700">
                        Topic: Medical Physics
                    </div>
                </nav>

                <main className="flex-1 overflow-hidden">
                    <div className="h-full max-w-[1200px] mx-auto grid grid-cols-1 lg:grid-cols-12">
                        
                        {/* LEFT: Tissue Simulation (3 cols) */}
                        <div className="lg:col-span-4 bg-slate-950 relative border-r border-slate-700 flex flex-col">
                            <div className="p-2 border-b border-slate-700 text-center">
                                <h3 className="text-xs font-bold text-slate-400 uppercase">1. Patient / Tissue</h3>
                            </div>
                            <div className="flex-1 relative flex items-center justify-center p-4">
                                <canvas 
                                    ref={tissueCanvasRef} 
                                    width={CANVAS_WIDTH} 
                                    height={CANVAS_HEIGHT}
                                    className="w-full max-w-[350px] object-contain rounded border border-slate-800 shadow-lg cursor-crosshair"
                                />
                            </div>
                            <div className="p-4 bg-slate-900 border-t border-slate-700">
                                <label className="flex items-center justify-between text-xs font-bold text-slate-300 mb-2">
                                    <span>Probe Position</span>
                                    <span>{probeX.toFixed(0)}%</span>
                                </label>
                                <input 
                                    type="range" min="0" max="100" step="0.5" 
                                    value={probeX} onChange={(e) => setProbeX(Number(e.target.value))}
                                    className="w-full h-2 bg-slate-700 rounded-lg slider-thumb mb-4" 
                                />
                                <div className="flex gap-2">
                                    <button 
                                        onClick={() => setIsSweeping(!isSweeping)}
                                        className={`flex-1 py-2 rounded text-xs font-bold flex items-center justify-center gap-2 ${isSweeping ? 'bg-emerald-600 text-white' : 'bg-slate-700 text-slate-300'}`}
                                    >
                                        <i data-lucide="scan" className="w-3 h-3"></i> {isSweeping ? "Stop" : "Auto Sweep"}
                                    </button>
                                    <button 
                                        onClick={() => setShowTissue(!showTissue)}
                                        className="flex-1 py-2 bg-slate-700 hover:bg-slate-600 rounded text-xs font-bold text-slate-300 flex items-center justify-center gap-2"
                                    >
                                        <i data-lucide="eye" className="w-3 h-3"></i> {showTissue ? "Hide" : "Reveal"}
                                    </button>
                                </div>
                            </div>
                        </div>

                        {/* MIDDLE: A-Scan (4 cols) */}
                        <div className="lg:col-span-4 bg-slate-900 relative border-r border-slate-700 flex flex-col">
                            <div className="p-2 border-b border-slate-700 text-center">
                                <h3 className="text-xs font-bold text-emerald-400 uppercase">2. A-Scan (Amplitude)</h3>
                            </div>
                            <div className="flex-1 relative flex flex-col items-center justify-center p-4 gap-4">
                                <div className="w-full max-w-[350px] bg-black rounded border-2 border-slate-700 shadow-[0_0_20px_rgba(16,185,129,0.1)] relative overflow-hidden">
                                    {/* Screen Glare */}
                                    <div className="absolute inset-0 bg-gradient-to-br from-white/5 to-transparent pointer-events-none"></div>
                                    <canvas 
                                        ref={aScanCanvasRef} 
                                        width={CANVAS_WIDTH} 
                                        height={GRAPH_HEIGHT}
                                        className="w-full object-contain"
                                    />
                                </div>
                                
                                <div className="w-full max-w-[350px] bg-slate-800 p-3 rounded border border-slate-700">
                                    <label className="flex items-center justify-between text-xs font-bold text-emerald-300 mb-1">
                                        <span>Signal Gain</span>
                                        <span>{gain}%</span>
                                    </label>
                                    <input 
                                        type="range" min="10" max="100" 
                                        value={gain} onChange={(e) => setGain(Number(e.target.value))}
                                        className="w-full h-1.5 bg-slate-900 rounded-lg slider-thumb appearance-none" 
                                    />
                                    <p className="text-[10px] text-slate-500 mt-2">
                                        <strong>A-Scan:</strong> 1D graph. Peaks show depth of boundaries. Used for eye length measurement.
                                    </p>
                                </div>
                            </div>
                        </div>

                        {/* RIGHT: B-Scan (4 cols) */}
                        <div className="lg:col-span-4 bg-slate-900 relative flex flex-col">
                            <div className="p-2 border-b border-slate-700 text-center">
                                <h3 className="text-xs font-bold text-white uppercase">3. B-Scan (Brightness)</h3>
                            </div>
                            <div className="flex-1 relative flex flex-col items-center justify-center p-4">
                                <div className="relative">
                                    <canvas 
                                        ref={bScanCanvasRef} 
                                        width={CANVAS_WIDTH} 
                                        height={CANVAS_HEIGHT}
                                        className="w-full max-w-[350px] object-contain rounded border-2 border-slate-600 bg-black shadow-2xl"
                                    />
                                    {/* Ruler Overlay */}
                                    <div className="absolute top-0 bottom-0 left-0 w-4 border-r border-slate-700/50 flex flex-col justify-between py-2 text-[8px] text-slate-500 font-mono select-none">
                                        <span>0cm</span>
                                        <span>5cm</span>
                                        <span>10cm</span>
                                    </div>
                                </div>

                                <div className="mt-4 flex gap-2 w-full max-w-[350px]">
                                    <button 
                                        onClick={clearScan}
                                        className="w-full py-2 bg-slate-800 hover:bg-slate-700 border border-slate-700 rounded text-xs font-bold text-slate-300 flex items-center justify-center gap-2 transition"
                                    >
                                        <i data-lucide="eraser" className="w-3 h-3"></i> Clear Image
                                    </button>
                                </div>
                                
                                <div className="mt-4 p-3 bg-slate-800/50 rounded border border-slate-700/50 w-full max-w-[350px]">
                                    <p className="text-[10px] text-slate-400">
                                        <strong>B-Scan:</strong> 2D Image. Built by combining many A-Scans. Bright spots = strong echoes. Used for fetal imaging.
                                    </p>
                                </div>
                            </div>
                        </div>

                    </div>
                </main>
            </div>
        );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
</script>
</body>
</html>
