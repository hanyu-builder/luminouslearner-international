<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nuclear Fusion Lab | Luminous Learner</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@0.263.1"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #e2e8f0; }
        .digital-font { font-family: 'Orbitron', sans-serif; }
        .slider-thumb::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none; width: 16px; height: 16px;
            border-radius: 50%; cursor: pointer; border: 2px solid #ffffff;
        }
        .thumb-orange::-webkit-slider-thumb { background: #f97316; }
        .thumb-cyan::-webkit-slider-thumb { background: #06b6d4; }
        
        .plasma-glow {
            box-shadow: 0 0 30px 10px rgba(249, 115, 22, 0.2);
        }
    </style>
</head>
<body>

<div id="root"></div>

<script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const CANVAS_WIDTH = 800;
    const CANVAS_HEIGHT = 450;
    const MAX_PARTICLES = 30; // Keep low for performance in JS loop

    const App = () => {
        // --- State ---
        const [temperature, setTemperature] = useState(10); // Million Kelvin (10 - 200)
        const [pressure, setPressure] = useState(1.0); // atm (compression factor 1.0 - 3.0)
        const [isRunning, setIsRunning] = useState(false);
        const [energyOutput, setEnergyOutput] = useState(0); // Total energy produced
        const [fusionCount, setFusionCount] = useState(0);

        const canvasRef = useRef(null);
        const requestRef = useRef();
        
        // Physics Objects
        const particlesRef = useRef([]); // {x, y, vx, vy, type: 'D'|'T'|'He'|'n', r}
        const effectsRef = useRef([]); // {x, y, life, maxLife}
        const containerRef = useRef({ w: 600, h: 300 }); // Dynamic size based on pressure

        // --- Init ---
        const resetSim = () => {
            setIsRunning(false);
            cancelAnimationFrame(requestRef.current);
            setEnergyOutput(0);
            setFusionCount(0);
            
            // Spawn D and T
            const ps = [];
            const w = CANVAS_WIDTH * 0.8;
            const h = CANVAS_HEIGHT * 0.8;
            
            for(let i=0; i<MAX_PARTICLES; i++) {
                ps.push({
                    x: CANVAS_WIDTH/2 + (Math.random()-0.5)*w*0.5,
                    y: CANVAS_HEIGHT/2 + (Math.random()-0.5)*h*0.5,
                    vx: (Math.random()-0.5),
                    vy: (Math.random()-0.5),
                    type: i % 2 === 0 ? 'D' : 'T',
                    r: 8
                });
            }
            particlesRef.current = ps;
            effectsRef.current = [];
            
            // Force one draw
            setTimeout(draw, 50);
        };

        const toggleSim = () => {
            if (!isRunning) {
                setIsRunning(true);
                requestRef.current = requestAnimationFrame(loop);
            } else {
                setIsRunning(false);
                cancelAnimationFrame(requestRef.current);
            }
        };

        // --- Physics Loop ---
        const loop = () => {
            if (!isRunning) return;

            // 1. Update Container Size (Pressure)
            // Higher pressure = Smaller box
            const targetW = 700 / pressure;
            const targetH = 400 / pressure;
            containerRef.current.w += (targetW - containerRef.current.w) * 0.1;
            containerRef.current.h += (targetH - containerRef.current.h) * 0.1;
            
            const bounds = {
                left: (CANVAS_WIDTH - containerRef.current.w)/2,
                right: (CANVAS_WIDTH + containerRef.current.w)/2,
                top: (CANVAS_HEIGHT - containerRef.current.h)/2,
                bottom: (CANVAS_HEIGHT + containerRef.current.h)/2
            };

            // 2. Update Particles
            // Speed factor based on Temperature
            // KE ~ T -> v ~ sqrt(T)
            const speedScale = Math.sqrt(temperature) * 0.5;

            const ps = particlesRef.current;
            
            for (let i = 0; i < ps.length; i++) {
                let p1 = ps[i];
                
                // Move
                // If He or n (products), they move very fast
                const typeScale = (p1.type === 'He' || p1.type === 'n') ? 3.0 : 1.0;
                
                p1.x += p1.vx * speedScale * typeScale;
                p1.y += p1.vy * speedScale * typeScale;

                // Wall Bounce
                if (p1.x < bounds.left + p1.r) { p1.x = bounds.left + p1.r; p1.vx *= -1; }
                if (p1.x > bounds.right - p1.r) { p1.x = bounds.right - p1.r; p1.vx *= -1; }
                if (p1.y < bounds.top + p1.r) { p1.y = bounds.top + p1.r; p1.vy *= -1; }
                if (p1.y > bounds.bottom - p1.r) { p1.y = bounds.bottom - p1.r; p1.vy *= -1; }

                // Particle Interactions (Fusion Check)
                // Only check D + T
                if (p1.type === 'D' || p1.type === 'T') {
                    for (let j = i + 1; j < ps.length; j++) {
                        let p2 = ps[j];
                        if ((p1.type === 'D' && p2.type === 'T') || (p1.type === 'T' && p2.type === 'D')) {
                            const dx = p2.x - p1.x;
                            const dy = p2.y - p1.y;
                            const distSq = dx*dx + dy*dy;
                            const minDist = p1.r + p2.r;
                            
                            if (distSq < minDist * minDist) {
                                // Collision!
                                // Check if energy is high enough to overcome Coulomb Barrier
                                // Threshold is arbitrary for simulation feel
                                // Temp > 100M K is usually needed. Let's set threshold around 80 in our scale.
                                
                                // Coulomb Repulsion Effect:
                                // If energy low, they bounce off BEFORE touching (Visual repulsion)
                                // If energy high, they touch and fuse.
                                
                                if (temperature > 60 && Math.random() < (temperature/200)) {
                                    // FUSION!
                                    // Replace p1 with He, p2 with n
                                    p1.type = 'He';
                                    p1.r = 10;
                                    p1.vx = (Math.random()-0.5)*5; // High energy release
                                    p1.vy = (Math.random()-0.5)*5;
                                    
                                    p2.type = 'n';
                                    p2.r = 4;
                                    p2.vx = -p1.vx * 4; // Conservation approx (He is 4x mass of n)
                                    p2.vy = -p1.vy * 4;
                                    
                                    // Add Effect
                                    effectsRef.current.push({
                                        x: (p1.x+p2.x)/2, y: (p1.y+p2.y)/2,
                                        life: 1.0, maxLife: 1.0
                                    });
                                    
                                    setFusionCount(c => c + 1);
                                    setEnergyOutput(e => e + 17.6); // MeV
                                } else {
                                    // Repulsion Bounce
                                    // Swap velocities (elastic-ish)
                                    const tempVx = p1.vx; p1.vx = p2.vx; p2.vx = tempVx;
                                    const tempVy = p1.vy; p1.vy = p2.vy; p2.vy = tempVy;
                                    
                                    // Push apart to prevent sticking
                                    const angle = Math.atan2(dy, dx);
                                    const overlap = minDist - Math.sqrt(distSq) + 1;
                                    p2.x += Math.cos(angle) * overlap;
                                    p2.y += Math.sin(angle) * overlap;
                                }
                            }
                        }
                    }
                }
            }
            
            // Remove escaped neutrons? No keep them bouncing.
            
            draw();
            requestRef.current = requestAnimationFrame(loop);
        };

        // --- Rendering ---
        const draw = () => {
            const ctx = canvasRef.current?.getContext('2d');
            if (!ctx) return;

            ctx.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
            
            // 1. Draw Container (Tokamak)
            const b = {
                x: (CANVAS_WIDTH - containerRef.current.w)/2,
                y: (CANVAS_HEIGHT - containerRef.current.h)/2,
                w: containerRef.current.w,
                h: containerRef.current.h
            };
            
            // Glow effect proportional to Temp
            const glowOpacity = Math.min(0.8, temperature / 200);
            const glowColor = `rgba(249, 115, 22, ${glowOpacity})`;
            
            ctx.shadowBlur = 40;
            ctx.shadowColor = glowColor;
            ctx.strokeStyle = `rgba(148, 163, 184, 0.5)`;
            ctx.lineWidth = 10;
            ctx.strokeRect(b.x, b.y, b.w, b.h);
            ctx.shadowBlur = 0; // Reset
            
            // Fill background
            ctx.fillStyle = `rgba(15, 23, 42, 0.8)`;
            ctx.fillRect(b.x, b.y, b.w, b.h);

            // 2. Draw Particles
            particlesRef.current.forEach(p => {
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
                
                if (p.type === 'D') ctx.fillStyle = '#3b82f6'; // Blue
                else if (p.type === 'T') ctx.fillStyle = '#ef4444'; // Red
                else if (p.type === 'He') {
                    ctx.fillStyle = '#facc15'; // Yellow
                    ctx.shadowColor = '#facc15';
                    ctx.shadowBlur = 10;
                }
                else if (p.type === 'n') ctx.fillStyle = '#9ca3af'; // Grey
                
                ctx.fill();
                ctx.shadowBlur = 0;
            });

            // 3. Draw Effects (Explosions)
            effectsRef.current.forEach(e => {
                e.life -= 0.05;
                if (e.life > 0) {
                    ctx.beginPath();
                    ctx.arc(e.x, e.y, 40 * (1 - e.life), 0, Math.PI*2);
                    ctx.fillStyle = `rgba(255, 255, 255, ${e.life})`;
                    ctx.fill();
                    
                    ctx.beginPath();
                    ctx.arc(e.x, e.y, 20 * (1 - e.life), 0, Math.PI*2);
                    ctx.strokeStyle = `rgba(250, 204, 21, ${e.life})`;
                    ctx.lineWidth = 4;
                    ctx.stroke();
                }
            });
            effectsRef.current = effectsRef.current.filter(e => e.life > 0);
        };

        useEffect(() => {
            resetSim();
            return () => cancelAnimationFrame(requestRef.current);
        }, []);

        useEffect(() => {
            if (window.lucide) window.lucide.createIcons();
        });

        return (
            <div className="min-h-screen bg-slate-900 text-slate-200 font-sans pb-12">
                <nav className="bg-slate-800 border-b border-slate-700 px-6 py-4 flex items-center justify-between sticky top-0 z-10">
                    <div className="flex items-center space-x-3">
                        <div className="bg-orange-500/20 p-2 rounded-lg">
                            <i data-lucide="sun" className="w-6 h-6 text-orange-400"></i>
                        </div>
                        <h1 className="text-xl font-bold text-white tracking-wide">Nuclear Fusion Lab</h1>
                    </div>
                    <div className="text-xs text-slate-400 font-mono bg-slate-900 px-3 py-1 rounded-full border border-slate-700">
                        Topic: Nuclear Physics
                    </div>
                </nav>

                <main className="max-w-6xl mx-auto p-4 md:p-6 grid grid-cols-1 lg:grid-cols-12 gap-8">
                    
                    {/* Left: Simulation Canvas */}
                    <div className="lg:col-span-9 flex flex-col gap-6">
                        <div className="bg-slate-950 rounded-2xl border border-slate-700 p-1 shadow-2xl relative overflow-hidden h-[450px] flex items-center justify-center">
                            <canvas 
                                ref={canvasRef} 
                                width={CANVAS_WIDTH} 
                                height={CANVAS_HEIGHT}
                                className="rounded-xl"
                            />
                            
                            {/* Overlay Info */}
                            <div className="absolute top-4 left-4 flex flex-col gap-2 pointer-events-none">
                                <div className="bg-slate-900/80 px-4 py-2 rounded-lg border border-slate-700 backdrop-blur-sm">
                                    <div className="text-xs text-slate-400 font-bold uppercase mb-1">Total Energy Output</div>
                                    <div className="text-2xl font-mono text-emerald-400 digital-font tracking-wider">
                                        {energyOutput.toFixed(1)} <span className="text-sm text-slate-500">MeV</span>
                                    </div>
                                </div>
                                <div className="bg-slate-900/80 px-4 py-2 rounded-lg border border-slate-700 backdrop-blur-sm">
                                    <div className="text-xs text-slate-400 font-bold uppercase mb-1">Fusion Events</div>
                                    <div className="text-xl font-mono text-white digital-font">{fusionCount}</div>
                                </div>
                            </div>
                        </div>

                        {/* Controls */}
                        <div className="bg-slate-800 p-6 rounded-2xl border border-slate-700 flex flex-wrap gap-8 items-center">
                            
                            {/* Temperature */}
                            <div className="flex-1 min-w-[200px]">
                                <label className="flex justify-between text-xs font-bold text-orange-400 mb-2">
                                    <span>Core Temperature</span>
                                    <span>{temperature} M Kelvin</span>
                                </label>
                                <input 
                                    type="range" min="10" max="200" step="10" 
                                    value={temperature} onChange={(e) => setTemperature(Number(e.target.value))}
                                    className="w-full h-2 bg-slate-700 rounded-lg slider-thumb thumb-orange"
                                />
                                <div className="flex justify-between text-[10px] text-slate-500 mt-1">
                                    <span>Cold (10M)</span>
                                    <span>Ignition (~100M)</span>
                                    <span>Extreme (200M)</span>
                                </div>
                            </div>

                            {/* Pressure */}
                            <div className="flex-1 min-w-[200px]">
                                <label className="flex justify-between text-xs font-bold text-cyan-400 mb-2">
                                    <span>Magnetic Pressure</span>
                                    <span>{pressure.toFixed(1)} atm</span>
                                </label>
                                <input 
                                    type="range" min="1.0" max="3.0" step="0.1" 
                                    value={pressure} onChange={(e) => setPressure(Number(e.target.value))}
                                    className="w-full h-2 bg-slate-700 rounded-lg slider-thumb thumb-cyan"
                                />
                                <div className="flex justify-between text-[10px] text-slate-500 mt-1">
                                    <span>Low Density</span>
                                    <span>High Density</span>
                                </div>
                            </div>

                            <div className="flex gap-3">
                                <button 
                                    onClick={toggleSim}
                                    className={`px-8 py-3 rounded-xl font-bold flex items-center gap-2 transition-all shadow-lg ${isRunning ? 'bg-slate-700 text-slate-300' : 'bg-orange-600 hover:bg-orange-500 text-white'}`}
                                >
                                    <i data-lucide={isRunning ? "pause" : "play"} className="w-5 h-5"></i>
                                    {isRunning ? "Pause" : "Ignite"}
                                </button>
                                <button onClick={resetSim} className="px-4 py-3 bg-slate-700 hover:bg-slate-600 rounded-xl text-white font-bold transition-colors">
                                    <i data-lucide="rotate-ccw" className="w-5 h-5"></i>
                                </button>
                            </div>

                        </div>
                    </div>

                    {/* Right: Legend & Info */}
                    <div className="lg:col-span-3 space-y-6">
                        
                        <div className="bg-slate-800 p-6 rounded-2xl border border-slate-700">
                            <h2 className="text-white font-bold mb-4 flex items-center">
                                <i data-lucide="list" className="w-5 h-5 mr-2 text-indigo-400"></i>
                                Particles
                            </h2>
                            <ul className="space-y-3 text-sm">
                                <li className="flex items-center gap-3">
                                    <div className="w-4 h-4 rounded-full bg-blue-500 shadow shadow-blue-500/50"></div>
                                    <span className="text-slate-300">Deuterium ($^2H$)</span>
                                </li>
                                <li className="flex items-center gap-3">
                                    <div className="w-4 h-4 rounded-full bg-red-500 shadow shadow-red-500/50"></div>
                                    <span className="text-slate-300">Tritium ($^3H$)</span>
                                </li>
                                <li className="h-px bg-slate-700 my-2"></li>
                                <li className="flex items-center gap-3">
                                    <div className="w-5 h-5 rounded-full bg-yellow-400 shadow shadow-yellow-400/50 border border-white"></div>
                                    <span className="text-white font-bold">Helium ($^4He$)</span>
                                </li>
                                <li className="flex items-center gap-3">
                                    <div className="w-2 h-2 rounded-full bg-slate-400"></div>
                                    <span className="text-slate-400">Neutron ($n$)</span>
                                </li>
                            </ul>
                        </div>

                        <div className="bg-indigo-900/10 border border-indigo-500/20 p-5 rounded-2xl">
                            <h3 className="text-indigo-300 font-bold text-sm mb-2 flex items-center">
                                <i data-lucide="lightbulb" className="w-4 h-4 mr-2"></i> The Coulomb Barrier
                            </h3>
                            <p className="text-xs text-slate-300 leading-relaxed">
                                Protons repel each other. To get them to touch and fuse, they must be moving FAST (High Temperature) and be packed CLOSE (High Pressure).
                                <br/><br/>
                                Try raising Temp to <strong>100M K</strong> and Pressure to <strong>Max</strong>!
                            </p>
                        </div>

                    </div>

                </main>
            </div>
        );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
</script>
</body>
</html>
