<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Circuit Builder Lab | Luminous Learner</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@0.263.1"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #e2e8f0; }
        .slider-thumb::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none; width: 16px; height: 16px;
            border-radius: 50%; cursor: pointer; border: 2px solid #ffffff;
        }
        .thumb-yellow::-webkit-slider-thumb { background: #facc15; }
    </style>
</head>
<body>

<div id="root"></div>

<script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const CANVAS_WIDTH = 800;
    const CANVAS_HEIGHT = 450;
    
    // Physics
    const BULB_RESISTANCE = 10; // Ohms

    const App = () => {
        // --- State ---
        const [mode, setMode] = useState('series'); // 'series' or 'parallel'
        const [bulbCount, setBulbCount] = useState(2);
        const [voltage, setVoltage] = useState(9.0); // Volts
        const [isSwitchClosed, setIsSwitchClosed] = useState(true);
        
        // Calculated Physics Data
        const [totalCurrent, setTotalCurrent] = useState(0);
        const [totalResistance, setTotalResistance] = useState(0);
        const [bulbData, setBulbData] = useState([]); // [{v, i, p}]

        const canvasRef = useRef(null);
        const requestRef = useRef();
        const electronOffsetRef = useRef(0);

        // --- Physics Engine ---
        useEffect(() => {
            if (!isSwitchClosed) {
                setTotalCurrent(0);
                setTotalResistance(Infinity);
                setBulbData(Array(bulbCount).fill({ v: 0, i: 0, p: 0 }));
                return;
            }

            let R_eq = 0;
            let I_total = 0;
            const newBulbData = [];

            if (mode === 'series') {
                // Series: R_eq = R1 + R2 + ...
                R_eq = bulbCount * BULB_RESISTANCE;
                I_total = voltage / R_eq;
                
                // In series, Current is same for all, Voltage splits
                const V_drop = voltage / bulbCount;
                const Power = I_total * V_drop;
                
                for(let i=0; i<bulbCount; i++) {
                    newBulbData.push({ v: V_drop, i: I_total, p: Power });
                }

            } else {
                // Parallel: 1/R_eq = 1/R1 + 1/R2 + ...
                // Since all R are equal: R_eq = R / N
                R_eq = BULB_RESISTANCE / bulbCount;
                I_total = voltage / R_eq;
                
                // In parallel, Voltage is same for all, Current splits
                const I_branch = voltage / BULB_RESISTANCE;
                const Power = I_branch * voltage;
                
                for(let i=0; i<bulbCount; i++) {
                    newBulbData.push({ v: voltage, i: I_branch, p: Power });
                }
            }

            setTotalResistance(R_eq);
            setTotalCurrent(I_total);
            setBulbData(newBulbData);

        }, [mode, bulbCount, voltage, isSwitchClosed]);

        // --- Animation Loop ---
        const loop = () => {
            // Electron speed proportional to current
            // Limit speed visually
            const speed = Math.min(10, totalCurrent * 2); 
            electronOffsetRef.current = (electronOffsetRef.current - speed) % 20; // Flow negative to positive (electron flow)
            // Wait, conventional current is + to -. Electron flow is - to +.
            // Let's animate electron flow: Out of Negative (Black/Short line), Into Positive (Long line).
            
            draw();
            requestRef.current = requestAnimationFrame(loop);
        };

        useEffect(() => {
            requestRef.current = requestAnimationFrame(loop);
            return () => cancelAnimationFrame(requestRef.current);
        });

        // --- Rendering ---
        const draw = () => {
            const ctx = canvasRef.current?.getContext('2d');
            if (!ctx) return;

            ctx.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);

            // Layout Constants
            const batteryX = 100;
            const batteryY = CANVAS_HEIGHT / 2;
            const wireColor = '#fbbf24'; // Amber-400
            const offColor = '#4b5563'; // Gray-600
            
            const circuitLeft = 100;
            const circuitRight = 700;
            const circuitTop = 50;
            const circuitBottom = 400;

            const activeColor = isSwitchClosed ? wireColor : offColor;

            // 1. Draw Battery (Left Side)
            drawBattery(ctx, batteryX, batteryY, voltage);

            // 2. Draw Main Loop Wires
            ctx.lineWidth = 4;
            ctx.strokeStyle = activeColor;
            
            // Wire from Battery Top (+) to Circuit Top
            ctx.beginPath();
            ctx.moveTo(batteryX, batteryY - 30);
            ctx.lineTo(batteryX, circuitTop);
            ctx.lineTo(circuitLeft + 50, circuitTop); // Switch gap start
            ctx.stroke();

            // Switch
            ctx.beginPath();
            ctx.moveTo(circuitLeft + 50, circuitTop);
            if (isSwitchClosed) {
                ctx.lineTo(circuitLeft + 100, circuitTop);
            } else {
                ctx.lineTo(circuitLeft + 95, circuitTop - 30); // Open
            }
            ctx.stroke();
            
            // Continue wire from switch
            ctx.beginPath();
            ctx.moveTo(circuitLeft + 100, circuitTop);
            
            if (mode === 'series') {
                drawSeriesCircuit(ctx, circuitLeft + 100, circuitTop, circuitRight, circuitBottom, batteryX, batteryY);
            } else {
                drawParallelCircuit(ctx, circuitLeft + 100, circuitTop, circuitRight, circuitBottom, batteryX, batteryY);
            }

            // Draw Electrons (Dots)
            if (isSwitchClosed && totalCurrent > 0) {
                 // We need paths... this is complex for dynamic drawing.
                 // Let's simplified visual: Just dots moving on the main wires drawn above.
                 // For this "Lab" view, static lines + glowing bulbs is often clearer than complex electron paths.
                 // But let's try adding dots on the main return wire.
                 
                 drawElectronsOnLine(ctx, batteryX, circuitBottom, batteryX, batteryY + 30, totalCurrent); // Return to battery
            }
        };

        const drawSeriesCircuit = (ctx, startX, startY, endX, endY, batX, batY) => {
            // Draw a big loop
            // Wire to Right
            const width = endX - startX;
            const step = width / (bulbCount + 1);
            
            ctx.beginPath();
            ctx.moveTo(startX, startY);
            
            // Draw Bulbs on top wire? Or distributed?
            // Let's distribute horizontally
            for (let i = 0; i < bulbCount; i++) {
                const bx = startX + step * (i + 1);
                const by = startY;
                ctx.lineTo(bx - 20, by);
                ctx.stroke(); // Draw wire to bulb
                drawBulb(ctx, bx, by, bulbData[i]?.p || 0);
                ctx.beginPath();
                ctx.moveTo(bx + 20, by);
            }
            
            ctx.lineTo(endX, startY);
            ctx.lineTo(endX, endY);
            ctx.lineTo(batX, endY);
            ctx.lineTo(batX, batY + 30); // Battery Bottom (-)
            ctx.stroke();

            // Draw Electrons on the path
            if (isSwitchClosed && totalCurrent > 0) {
                // Top wire
                drawElectronsOnLine(ctx, startX, startY, endX, startY, totalCurrent);
                // Right wire
                drawElectronsOnLine(ctx, endX, startY, endX, endY, totalCurrent);
                // Bottom wire
                drawElectronsOnLine(ctx, endX, endY, batX, endY, totalCurrent);
            }
        };

        const drawParallelCircuit = (ctx, startX, startY, endX, endY, batX, batY) => {
            // Top Rail
            ctx.beginPath();
            ctx.moveTo(startX, startY);
            ctx.lineTo(endX, startY);
            ctx.stroke();
            
            // Bottom Rail
            ctx.beginPath();
            ctx.moveTo(batX, endY);
            ctx.lineTo(endX, endY);
            ctx.stroke();
            
            // Rungs (Bulbs)
            const width = endX - startX;
            const step = width / (bulbCount); // Distribute across
            
            for(let i=0; i<bulbCount; i++) {
                const bx = startX + step * i + step/2;
                // Wire down
                ctx.beginPath();
                ctx.moveTo(bx, startY);
                ctx.lineTo(bx, startY + 50);
                ctx.stroke();
                
                // Bulb
                drawBulb(ctx, bx, (startY + endY)/2, bulbData[i]?.p || 0);
                
                // Wire connecting bulb to rails
                ctx.beginPath();
                ctx.moveTo(bx, startY + 50 + 40); // Bulb bottom approx
                // Wait, drawBulb is centered. 
                ctx.moveTo(bx, (startY + endY)/2 - 30);
                ctx.lineTo(bx, startY);
                ctx.stroke();
                
                ctx.beginPath();
                ctx.moveTo(bx, (startY + endY)/2 + 30);
                ctx.lineTo(bx, endY);
                ctx.stroke();

                // Electrons in rungs
                if (isSwitchClosed && totalCurrent > 0) {
                    drawElectronsOnLine(ctx, bx, startY, bx, endY, bulbData[i]?.i);
                }
            }
            
            // Electrons on rails
            if (isSwitchClosed && totalCurrent > 0) {
                // Top rail (current reduces as it goes right)
                // Simplified: just show main flow
                drawElectronsOnLine(ctx, startX, startY, endX, startY, totalCurrent);
                drawElectronsOnLine(ctx, endX, endY, batX, endY, totalCurrent);
            }
        };

        const drawBattery = (ctx, x, y, volts) => {
            ctx.lineWidth = 4;
            ctx.strokeStyle = '#fff';
            // Top plate (+) Long
            ctx.beginPath();
            ctx.moveTo(x - 20, y - 10);
            ctx.lineTo(x + 20, y - 10);
            ctx.stroke();
            // Bottom plate (-) Short
            ctx.lineWidth = 6; // Thicker for negative? No standard is thicker usually short.
            ctx.beginPath();
            ctx.moveTo(x - 10, y + 10);
            ctx.lineTo(x + 10, y + 10);
            ctx.stroke();
            
            ctx.fillStyle = '#facc15';
            ctx.font = 'bold 16px sans-serif';
            ctx.textAlign = 'right';
            ctx.fillText(`${volts}V`, x - 30, y + 5);
        };

        const drawBulb = (ctx, x, y, power) => {
            // Glow
            if (power > 0) {
                const glowRadius = 20 + Math.min(60, power * 5); // Scale glow
                const grad = ctx.createRadialGradient(x, y, 10, x, y, glowRadius);
                grad.addColorStop(0, 'rgba(253, 224, 71, 0.8)');
                grad.addColorStop(1, 'rgba(253, 224, 71, 0)');
                ctx.fillStyle = grad;
                ctx.beginPath(); ctx.arc(x, y, glowRadius, 0, Math.PI*2); ctx.fill();
            }

            // Glass
            ctx.fillStyle = 'rgba(255,255,255,0.2)';
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(x, y, 20, 0, Math.PI*2);
            ctx.fill();
            ctx.stroke();
            
            // Filament
            ctx.beginPath();
            ctx.moveTo(x - 10, y + 15);
            ctx.lineTo(x - 5, y - 5);
            ctx.lineTo(x + 5, y - 5);
            ctx.lineTo(x + 10, y + 15);
            ctx.strokeStyle = '#fbbf24';
            ctx.stroke();
            
            // Info text
            if (power > 0) {
                ctx.fillStyle = 'white';
                ctx.font = '10px monospace';
                ctx.textAlign = 'center';
                ctx.fillText(`${power.toFixed(1)}W`, x, y + 35);
            }
        };

        const drawElectronsOnLine = (ctx, x1, y1, x2, y2, current) => {
            if (current < 0.01) return;
            const dist = Math.hypot(x2 - x1, y2 - y1);
            const angle = Math.atan2(y2 - y1, x2 - x1);
            
            const speed = Math.min(5, current * 2); 
            // We want electron flow (Negative to Positive).
            // Current I is Pos to Neg.
            // So electrons move opposite to drawing direction (if drawn in current direction).
            // Let's assume input x1->x2 is Conventional Current direction.
            // Electrons move x2 -> x1.
            
            ctx.fillStyle = '#fef08a'; // Yellow dots
            
            const spacing = 30;
            const offset = (electronOffsetRef.current * (speed/2)) % spacing; // Animate
            
            for (let d = offset; d < dist; d += spacing) {
                // Move backwards from end
                const ex = x2 - d * Math.cos(angle);
                const ey = y2 - d * Math.sin(angle);
                
                ctx.beginPath();
                ctx.arc(ex, ey, 2, 0, Math.PI*2);
                ctx.fill();
            }
        };

        // Init icons
        useEffect(() => {
            if (window.lucide) window.lucide.createIcons();
        });

        return (
            <div className="min-h-screen bg-slate-900 text-slate-200 font-sans pb-12">
                <nav className="bg-slate-800 border-b border-slate-700 px-6 py-4 flex items-center justify-between sticky top-0 z-10">
                    <div className="flex items-center space-x-3">
                        <div className="bg-yellow-500/20 p-2 rounded-lg">
                            <i data-lucide="zap" className="w-6 h-6 text-yellow-400"></i>
                        </div>
                        <h1 className="text-xl font-bold text-white tracking-wide">Circuit Builder Lab</h1>
                    </div>
                    <div className="text-xs text-slate-400 font-mono bg-slate-900 px-3 py-1 rounded-full border border-slate-700">
                        Topic: Electricity
                    </div>
                </nav>

                <main className="max-w-6xl mx-auto p-4 md:p-6 grid grid-cols-1 lg:grid-cols-12 gap-8">
                    
                    {/* Left: Simulation Canvas */}
                    <div className="lg:col-span-9 flex flex-col gap-6">
                        <div className="bg-slate-950 rounded-2xl border border-slate-700 p-1 shadow-2xl relative overflow-hidden h-[450px]">
                            <canvas 
                                ref={canvasRef} 
                                width={CANVAS_WIDTH} 
                                height={CANVAS_HEIGHT}
                                className="w-full h-full object-contain bg-slate-950 rounded-xl"
                            />
                            
                            <div className="absolute top-4 left-4 bg-slate-900/80 px-4 py-2 rounded-lg border border-slate-700 text-xs shadow-lg space-y-1">
                                <div className="flex justify-between gap-4">
                                    <span className="text-slate-400">Total Current ($I$)</span>
                                    <span className="text-yellow-400 font-mono font-bold">{totalCurrent.toFixed(2)} A</span>
                                </div>
                                <div className="flex justify-between gap-4">
                                    <span className="text-slate-400">Eq. Resistance (Req)</span>
                                    <span className="text-blue-400 font-mono font-bold">{totalResistance.toFixed(1)} Ω</span>
                                </div>
                            </div>
                        </div>

                        {/* Controls */}
                        <div className="bg-slate-800 p-6 rounded-2xl border border-slate-700 flex flex-wrap gap-8 items-center justify-between">
                            
                            {/* Circuit Mode */}
                            <div className="flex bg-slate-900 p-1 rounded-lg border border-slate-700">
                                <button 
                                    onClick={() => setMode('series')}
                                    className={`px-6 py-2 rounded-md text-sm font-bold transition-all ${mode === 'series' ? 'bg-blue-600 text-white shadow-lg' : 'text-slate-400 hover:text-white'}`}
                                >
                                    Series
                                </button>
                                <button 
                                    onClick={() => setMode('parallel')}
                                    className={`px-6 py-2 rounded-md text-sm font-bold transition-all ${mode === 'parallel' ? 'bg-indigo-600 text-white shadow-lg' : 'text-slate-400 hover:text-white'}`}
                                >
                                    Parallel
                                </button>
                            </div>

                            {/* Voltage Slider */}
                            <div className="flex-1 min-w-[200px]">
                                <label className="flex justify-between text-xs text-yellow-300 font-bold mb-1">
                                    Battery Voltage <span>{voltage} V</span>
                                </label>
                                <input 
                                    type="range" min="1" max="24" step="1" 
                                    value={voltage} onChange={(e) => setVoltage(Number(e.target.value))}
                                    className="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer slider-thumb thumb-yellow" 
                                />
                            </div>

                            {/* Bulb Count */}
                            <div className="flex items-center gap-3">
                                <button 
                                    onClick={() => setBulbCount(Math.max(1, bulbCount - 1))}
                                    className="p-2 rounded-lg bg-slate-700 hover:bg-slate-600 text-white transition-colors"
                                    disabled={bulbCount <= 1}
                                >
                                    <i data-lucide="minus" className="w-4 h-4"></i>
                                </button>
                                <div className="text-center">
                                    <div className="text-xl font-bold text-white">{bulbCount}</div>
                                    <div className="text-[10px] text-slate-500 uppercase">Bulbs</div>
                                </div>
                                <button 
                                    onClick={() => setBulbCount(Math.min(5, bulbCount + 1))}
                                    className="p-2 rounded-lg bg-slate-700 hover:bg-slate-600 text-white transition-colors"
                                    disabled={bulbCount >= 5}
                                >
                                    <i data-lucide="plus" className="w-4 h-4"></i>
                                </button>
                            </div>

                            {/* Switch */}
                            <button 
                                onClick={() => setIsSwitchClosed(!isSwitchClosed)}
                                className={`px-6 py-3 rounded-xl font-bold text-sm shadow-lg transition-all flex items-center gap-2 ${isSwitchClosed ? 'bg-emerald-600 hover:bg-emerald-500 text-white' : 'bg-red-600 hover:bg-red-500 text-white'}`}
                            >
                                <i data-lucide="power" className="w-4 h-4"></i>
                                {isSwitchClosed ? "ON" : "OFF"}
                            </button>

                        </div>
                    </div>

                    {/* Right: Theory & Data */}
                    <div className="lg:col-span-3 space-y-6">
                        
                        <div className="bg-slate-800 p-6 rounded-2xl border border-slate-700">
                            <h2 className="text-white font-bold mb-4 flex items-center">
                                <i data-lucide="book-open" className="w-5 h-5 mr-2 text-indigo-400"></i>
                                Properties
                            </h2>
                            
                            <div className="space-y-4 text-sm text-slate-300">
                                {mode === 'series' ? (
                                    <div className="space-y-2">
                                        <div className="bg-blue-900/20 p-3 rounded border border-blue-500/30">
                                            <strong className="text-blue-400 block mb-1">Series Circuit</strong>
                                            <ul className="list-disc pl-4 text-xs space-y-1">
                                                <li>Current is the <strong>same</strong> everywhere.</li>
                                                <li>Voltage <strong>splits</strong> across bulbs.</li>
                                                <li>More bulbs = Dimmer light (Resistance ↑).</li>
                                                <li>One breaks, they all break.</li>
                                            </ul>
                                        </div>
                                        <div className="font-mono text-xs bg-slate-900 p-2 rounded">
                                            Req = R1 + R2 + ...
                                        </div>
                                    </div>
                                ) : (
                                    <div className="space-y-2">
                                        <div className="bg-indigo-900/20 p-3 rounded border border-indigo-500/30">
                                            <strong className="text-indigo-400 block mb-1">Parallel Circuit</strong>
                                            <ul className="list-disc pl-4 text-xs space-y-1">
                                                <li>Voltage is the <strong>same</strong> everywhere.</li>
                                                <li>Current <strong>splits</strong> into branches.</li>
                                                <li>More bulbs = Same brightness (Resistance ↓).</li>
                                                <li>Independent operation.</li>
                                            </ul>
                                        </div>
                                        <div className="font-mono text-xs bg-slate-900 p-2 rounded">
                                            1/Req = 1/R1 + 1/R2 + ...
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>

                        <div className="bg-yellow-900/10 border border-yellow-500/20 p-5 rounded-2xl">
                            <h3 className="text-yellow-400 font-bold text-sm mb-2 flex items-center">
                                <i data-lucide="lightbulb" className="w-4 h-4 mr-2"></i> Observation
                            </h3>
                            <p className="text-xs text-slate-300 leading-relaxed">
                                {mode === 'series' 
                                    ? "Add more bulbs. Notice how they get dimmer? The battery has to push through MORE total resistance." 
                                    : "Add more bulbs. Notice they stay bright? Each bulb gets a direct line to the battery, but the battery drains faster (Higher Total Current)!"}
                            </p>
                        </div>

                    </div>

                </main>
            </div>
        );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
</script>
</body>
</html>
