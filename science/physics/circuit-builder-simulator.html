<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Circuit Builder Lab | Luminous Learner</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@0.263.1"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #e2e8f0; }
        .slider-thumb::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none; width: 16px; height: 16px;
            border-radius: 50%; cursor: pointer; border: 2px solid #ffffff;
        }
        .thumb-yellow::-webkit-slider-thumb { background: #facc15; }
    </style>
</head>
<body>

<div id="root"></div>

<script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const CANVAS_WIDTH = 800;
    const CANVAS_HEIGHT = 450;
    
    // Physics
    const BULB_RESISTANCE = 10; // Ohms

    const App = () => {
        // --- State ---
        const [tab, setTab] = useState('series'); // 'series' or 'parallel'
        
        // Configuration State
        // For Series: rows=1, cols=N
        // For Parallel: rows=N, cols=M
        const [layout, setLayout] = useState({ rows: 1, cols: 2 }); 

        const [voltage, setVoltage] = useState(9.0); // Volts
        const [isSwitchClosed, setIsSwitchClosed] = useState(true);
        
        // Calculated Physics Data
        const [totalCurrent, setTotalCurrent] = useState(0);
        const [totalResistance, setTotalResistance] = useState(0);
        const [bulbStats, setBulbStats] = useState({ v: 0, i: 0, p: 0 }); // Per bulb stats (assuming symmetry)

        const canvasRef = useRef(null);
        const requestRef = useRef();
        const electronOffsetRef = useRef(0);

        // --- Logic helpers ---
        const setSeriesConfig = (n) => {
            setLayout({ rows: 1, cols: n });
            setTab('series');
        };

        const setParallelConfig = (rows, cols) => {
            setLayout({ rows, cols });
            setTab('parallel');
        };

        const reset = () => {
            setVoltage(9.0);
            setIsSwitchClosed(true);
            // Reset to default per tab? Or just voltage/switch.
            // Let's keep current layout.
        };

        // --- Physics Engine ---
        useEffect(() => {
            if (!isSwitchClosed) {
                setTotalCurrent(0);
                setTotalResistance(Infinity);
                setBulbStats({ v: 0, i: 0, p: 0 });
                return;
            }

            const { rows, cols } = layout;
            
            // Resistance of one branch (bulbs in series within branch)
            const R_branch = cols * BULB_RESISTANCE;
            
            // Total Resistance (branches in parallel)
            // 1/Req = rows * (1/R_branch) -> Req = R_branch / rows
            const R_eq = R_branch / rows;
            
            // Total Current
            const I_total = voltage / R_eq;
            
            // Current per branch
            const I_branch = I_total / rows;
            
            // Voltage drop per bulb
            // V = I * R
            const V_bulb = I_branch * BULB_RESISTANCE;
            
            // Power per bulb
            const P_bulb = V_bulb * I_branch;

            setTotalResistance(R_eq);
            setTotalCurrent(I_total);
            setBulbStats({ v: V_bulb, i: I_branch, p: P_bulb });

        }, [layout, voltage, isSwitchClosed]);

        // --- Animation Loop ---
        const loop = () => {
            // Electron speed proportional to current
            const speed = Math.min(10, totalCurrent * 2); 
            electronOffsetRef.current = (electronOffsetRef.current - speed) % 20; 
            
            draw();
            requestRef.current = requestAnimationFrame(loop);
        };

        useEffect(() => {
            requestRef.current = requestAnimationFrame(loop);
            return () => cancelAnimationFrame(requestRef.current);
        });

        // --- Rendering ---
        const draw = () => {
            const ctx = canvasRef.current?.getContext('2d');
            if (!ctx) return;

            ctx.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);

            // Layout Constants
            const batteryX = 100;
            const batteryY = CANVAS_HEIGHT / 2;
            const wireColor = '#fbbf24'; // Amber-400
            const offColor = '#4b5563'; // Gray-600
            const activeColor = isSwitchClosed ? wireColor : offColor;

            const circuitLeft = 100;
            const circuitRight = 700;
            const circuitTop = 50;
            const circuitBottom = 400;

            // 1. Draw Battery (Left Side)
            drawBattery(ctx, batteryX, batteryY, voltage);

            // 2. Draw Main Loop Wires
            ctx.lineWidth = 4;
            ctx.strokeStyle = activeColor;
            
            // Wire from Battery Top (+) to Circuit Top
            ctx.beginPath();
            ctx.moveTo(batteryX, batteryY - 30);
            ctx.lineTo(batteryX, circuitTop);
            ctx.lineTo(circuitLeft + 50, circuitTop); // Switch gap start
            ctx.stroke();

            // Switch
            ctx.beginPath();
            ctx.moveTo(circuitLeft + 50, circuitTop);
            if (isSwitchClosed) {
                ctx.lineTo(circuitLeft + 100, circuitTop);
            } else {
                ctx.lineTo(circuitLeft + 95, circuitTop - 30); // Open
            }
            ctx.stroke();
            
            // Continue wire from switch
            ctx.beginPath();
            ctx.moveTo(circuitLeft + 100, circuitTop);
            
            // Draw Circuit Body
            if (layout.rows === 1) {
                // Series Style Drawing
                drawSeriesVisuals(ctx, circuitLeft + 100, circuitTop, circuitRight, circuitBottom, batteryX, batteryY);
            } else {
                // Parallel Style Drawing
                drawParallelVisuals(ctx, circuitLeft + 100, circuitTop, circuitRight, circuitBottom, batteryX, batteryY);
            }

            // Draw Electrons on return wire
            if (isSwitchClosed && totalCurrent > 0) {
                 drawElectronsOnLine(ctx, batteryX, circuitBottom, batteryX, batteryY + 30, totalCurrent);
            }
        };

        const drawSeriesVisuals = (ctx, startX, startY, endX, endY, batX, batY) => {
            const count = layout.cols;
            const width = endX - startX;
            const step = width / (count + 1);
            
            ctx.beginPath();
            ctx.moveTo(startX, startY);
            
            for (let i = 0; i < count; i++) {
                const bx = startX + step * (i + 1);
                const by = startY;
                ctx.lineTo(bx - 20, by);
                ctx.stroke(); 
                drawBulb(ctx, bx, by, bulbStats.p);
                ctx.beginPath();
                ctx.moveTo(bx + 20, by);
            }
            
            ctx.lineTo(endX, startY);
            ctx.lineTo(endX, endY);
            ctx.lineTo(batX, endY);
            ctx.lineTo(batX, batY + 30);
            ctx.stroke();

            if (isSwitchClosed && totalCurrent > 0) {
                drawElectronsOnLine(ctx, startX, startY, endX, startY, totalCurrent); // Top
                drawElectronsOnLine(ctx, endX, startY, endX, endY, totalCurrent);     // Right
                drawElectronsOnLine(ctx, endX, endY, batX, endY, totalCurrent);       // Bottom
            }
        };

        const drawParallelVisuals = (ctx, startX, startY, endX, endY, batX, batY) => {
            const rows = layout.rows;
            const cols = layout.cols; // Bulbs per branch

            // Top Rail
            ctx.beginPath();
            ctx.moveTo(startX, startY);
            ctx.lineTo(endX, startY);
            ctx.stroke();
            
            // Bottom Rail
            ctx.beginPath();
            ctx.moveTo(batX, endY);
            ctx.lineTo(endX, endY);
            ctx.stroke();
            
            // Branches
            const width = endX - startX;
            const step = width / (rows); 
            
            for(let i=0; i<rows; i++) {
                const branchX = startX + step * i + step/2;
                
                // Draw vertical wire for branch
                ctx.beginPath();
                ctx.moveTo(branchX, startY);
                ctx.lineTo(branchX, endY);
                ctx.stroke(); // Base wire

                // Draw Bulbs on this vertical line
                // Vertical space available
                const vHeight = endY - startY;
                const vStep = vHeight / (cols + 1);

                for (let j=0; j<cols; j++) {
                    const by = startY + vStep * (j + 1);
                    // Clear wire behind bulb
                    ctx.clearRect(branchX - 18, by - 18, 36, 36); 
                    // Redraw bg color (hacky but works for this simple scene)
                    ctx.fillStyle = '#0f172a';
                    ctx.fillRect(branchX - 18, by - 18, 36, 36);
                    
                    drawBulb(ctx, branchX, by, bulbStats.p);
                }

                // Electrons in branch
                if (isSwitchClosed && bulbStats.i > 0) {
                    drawElectronsOnLine(ctx, branchX, startY, branchX, endY, bulbStats.i);
                }
            }
            
            // Electrons on rails
            if (isSwitchClosed && totalCurrent > 0) {
                drawElectronsOnLine(ctx, startX, startY, endX, startY, totalCurrent);
                drawElectronsOnLine(ctx, endX, endY, batX, endY, totalCurrent);
            }
        };

        const drawBattery = (ctx, x, y, volts) => {
            ctx.lineWidth = 4;
            ctx.strokeStyle = '#fff';
            ctx.beginPath(); ctx.moveTo(x - 20, y - 10); ctx.lineTo(x + 20, y - 10); ctx.stroke();
            ctx.lineWidth = 6;
            ctx.beginPath(); ctx.moveTo(x - 10, y + 10); ctx.lineTo(x + 10, y + 10); ctx.stroke();
            
            ctx.fillStyle = '#facc15';
            ctx.font = 'bold 16px sans-serif';
            ctx.textAlign = 'right';
            ctx.fillText(`${volts}V`, x - 30, y + 5);
        };

        const drawBulb = (ctx, x, y, power) => {
            if (power > 0) {
                const glowRadius = 20 + Math.min(60, power * 5); 
                const grad = ctx.createRadialGradient(x, y, 10, x, y, glowRadius);
                grad.addColorStop(0, 'rgba(253, 224, 71, 0.8)');
                grad.addColorStop(1, 'rgba(253, 224, 71, 0)');
                ctx.fillStyle = grad;
                ctx.beginPath(); ctx.arc(x, y, glowRadius, 0, Math.PI*2); ctx.fill();
            }

            ctx.fillStyle = 'rgba(255,255,255,0.2)';
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 2;
            ctx.beginPath(); ctx.arc(x, y, 20, 0, Math.PI*2); ctx.fill(); ctx.stroke();
            
            ctx.beginPath();
            ctx.moveTo(x - 10, y + 15); ctx.lineTo(x - 5, y - 5); ctx.lineTo(x + 5, y - 5); ctx.lineTo(x + 10, y + 15);
            ctx.strokeStyle = '#fbbf24'; ctx.stroke();
            
            if (power > 0) {
                ctx.fillStyle = 'white';
                ctx.font = '10px monospace';
                ctx.textAlign = 'center';
                ctx.fillText(`${power.toFixed(1)}W`, x, y + 35);
            }
        };

        const drawElectronsOnLine = (ctx, x1, y1, x2, y2, current) => {
            if (current < 0.01) return;
            const dist = Math.hypot(x2 - x1, y2 - y1);
            const angle = Math.atan2(y2 - y1, x2 - x1);
            const speed = Math.min(5, current * 2); 
            
            ctx.fillStyle = '#fef08a';
            const spacing = 30;
            const offset = (electronOffsetRef.current * (speed/2)) % spacing;
            
            for (let d = offset; d < dist; d += spacing) {
                const ex = x2 - d * Math.cos(angle);
                const ey = y2 - d * Math.sin(angle);
                ctx.beginPath(); ctx.arc(ex, ey, 2, 0, Math.PI*2); ctx.fill();
            }
        };

        useEffect(() => {
            if (window.lucide) window.lucide.createIcons();
        });

        // Config button helper
        const ConfigBtn = ({ label, active, onClick }) => (
            <button 
                onClick={onClick}
                className={`px-3 py-2 rounded text-xs font-bold transition-all border ${
                    active 
                    ? 'bg-blue-600 border-blue-500 text-white shadow' 
                    : 'bg-slate-800 border-slate-600 text-slate-400 hover:bg-slate-700'
                }`}
            >
                {label}
            </button>
        );

        return (
            <div className="min-h-screen bg-slate-900 text-slate-200 font-sans pb-12">
                <nav className="bg-slate-800 border-b border-slate-700 px-6 py-4 flex items-center justify-between sticky top-0 z-10">
                    <div className="flex items-center space-x-3">
                        <div className="bg-yellow-500/20 p-2 rounded-lg">
                            <i data-lucide="zap" className="w-6 h-6 text-yellow-400"></i>
                        </div>
                        <h1 className="text-xl font-bold text-white tracking-wide">Circuit Builder Lab</h1>
                    </div>
                    <div className="text-xs text-slate-400 font-mono bg-slate-900 px-3 py-1 rounded-full border border-slate-700">
                        Topic: Electricity
                    </div>
                </nav>

                <main className="max-w-6xl mx-auto p-4 md:p-6 grid grid-cols-1 lg:grid-cols-12 gap-8">
                    
                    {/* Left: Simulation Canvas */}
                    <div className="lg:col-span-8 flex flex-col gap-6">
                        <div className="bg-slate-950 rounded-2xl border border-slate-700 p-1 shadow-2xl relative overflow-hidden h-[450px]">
                            <canvas 
                                ref={canvasRef} 
                                width={CANVAS_WIDTH} 
                                height={CANVAS_HEIGHT}
                                className="w-full h-full object-contain bg-slate-950 rounded-xl"
                            />
                            
                            <div className="absolute top-4 left-4 bg-slate-900/80 px-4 py-2 rounded-lg border border-slate-700 text-xs shadow-lg space-y-1">
                                <div className="flex justify-between gap-4">
                                    <span className="text-slate-400">Total Current ($I$)</span>
                                    <span className="text-yellow-400 font-mono font-bold">{totalCurrent.toFixed(2)} A</span>
                                </div>
                                <div className="flex justify-between gap-4">
                                    <span className="text-slate-400">Eq. Resistance ($R_{`eq`}$)</span>
                                    <span className="text-blue-400 font-mono font-bold">{totalResistance.toFixed(1)} Ω</span>
                                </div>
                            </div>
                        </div>

                        {/* Controls */}
                        <div className="bg-slate-800 p-6 rounded-2xl border border-slate-700 space-y-6">
                            
                            {/* Circuit Configuration Section */}
                            <div>
                                <div className="flex items-center gap-4 mb-3 border-b border-slate-700 pb-2">
                                    <button 
                                        onClick={() => { setSeriesConfig(2); }} 
                                        className={`text-sm font-bold pb-2 -mb-2.5 transition-colors ${tab === 'series' ? 'text-blue-400 border-b-2 border-blue-400' : 'text-slate-400 hover:text-slate-200'}`}
                                    >
                                        Series Mode
                                    </button>
                                    <button 
                                        onClick={() => { setParallelConfig(2, 1); }} 
                                        className={`text-sm font-bold pb-2 -mb-2.5 transition-colors ${tab === 'parallel' ? 'text-indigo-400 border-b-2 border-indigo-400' : 'text-slate-400 hover:text-slate-200'}`}
                                    >
                                        Parallel Mode
                                    </button>
                                </div>

                                <div className="flex flex-wrap gap-2">
                                    {tab === 'series' ? (
                                        <>
                                            <ConfigBtn label="1 Bulb" active={layout.cols === 1} onClick={() => setSeriesConfig(1)} />
                                            <ConfigBtn label="2 Bulbs" active={layout.cols === 2} onClick={() => setSeriesConfig(2)} />
                                            <ConfigBtn label="3 Bulbs" active={layout.cols === 3} onClick={() => setSeriesConfig(3)} />
                                            <ConfigBtn label="4 Bulbs" active={layout.cols === 4} onClick={() => setSeriesConfig(4)} />
                                        </>
                                    ) : (
                                        <>
                                            <ConfigBtn label="2 Branches (Total 2)" active={layout.rows === 2 && layout.cols === 1} onClick={() => setParallelConfig(2, 1)} />
                                            <ConfigBtn label="3 Branches (Total 3)" active={layout.rows === 3 && layout.cols === 1} onClick={() => setParallelConfig(3, 1)} />
                                            <ConfigBtn label="4 Branches (Total 4)" active={layout.rows === 4 && layout.cols === 1} onClick={() => setParallelConfig(4, 1)} />
                                            <ConfigBtn label="2 Branches (2x2 Mix)" active={layout.rows === 2 && layout.cols === 2} onClick={() => setParallelConfig(2, 2)} />
                                        </>
                                    )}
                                </div>
                            </div>

                            <div className="flex flex-wrap gap-8 items-center justify-between border-t border-slate-700 pt-6">
                                {/* Voltage Slider */}
                                <div className="flex-1 min-w-[200px]">
                                    <label className="flex justify-between text-xs text-yellow-300 font-bold mb-1">
                                        Battery Voltage <span>{voltage} V</span>
                                    </label>
                                    <input 
                                        type="range" min="1" max="24" step="1" 
                                        value={voltage} onChange={(e) => setVoltage(Number(e.target.value))}
                                        className="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer slider-thumb thumb-yellow" 
                                    />
                                </div>

                                {/* Action Buttons */}
                                <div className="grid grid-cols-2 gap-4 w-full md:w-auto">
                                    <button 
                                        onClick={() => setIsSwitchClosed(!isSwitchClosed)}
                                        className={`px-8 py-3 rounded-xl font-bold text-sm shadow-lg transition-all flex items-center justify-center gap-2 ${isSwitchClosed ? 'bg-emerald-600 hover:bg-emerald-500 text-white' : 'bg-red-600 hover:bg-red-500 text-white'}`}
                                    >
                                        <i data-lucide="power" className="w-4 h-4"></i>
                                        {isSwitchClosed ? "ON" : "OFF"}
                                    </button>
                                    <button 
                                        onClick={reset}
                                        className="px-8 py-3 rounded-xl font-bold text-sm bg-slate-700 hover:bg-slate-600 text-white transition-all flex items-center justify-center gap-2"
                                    >
                                        <i data-lucide="rotate-ccw" className="w-4 h-4"></i>
                                        Reset
                                    </button>
                                </div>
                            </div>

                        </div>
                    </div>

                    {/* Right: Theory & Data */}
                    <div className="lg:col-span-4 space-y-6">
                        
                        <div className="bg-slate-800 p-6 rounded-2xl border border-slate-700">
                            <h2 className="text-white font-bold mb-4 flex items-center">
                                <i data-lucide="book-open" className="w-5 h-5 mr-2 text-indigo-400"></i>
                                Properties
                            </h2>
                            
                            <div className="space-y-4 text-sm text-slate-300">
                                {tab === 'series' ? (
                                    <div className="space-y-2">
                                        <div className="bg-blue-900/20 p-3 rounded border border-blue-500/30">
                                            <strong className="text-blue-400 block mb-1">Series Circuit</strong>
                                            <ul className="list-disc pl-4 text-xs space-y-1">
                                                <li>Current is the <strong>same</strong> everywhere.</li>
                                                <li>Voltage <strong>splits</strong> across bulbs.</li>
                                                <li>More bulbs = Dimmer light (Resistance ↑).</li>
                                            </ul>
                                        </div>
                                        <div className="font-mono text-xs bg-slate-900 p-2 rounded text-center">
                                            $R_{`eq`} = R_1 + R_2 + ...$
                                        </div>
                                    </div>
                                ) : (
                                    <div className="space-y-2">
                                        <div className="bg-indigo-900/20 p-3 rounded border border-indigo-500/30">
                                            <strong className="text-indigo-400 block mb-1">Parallel Circuit</strong>
                                            <ul className="list-disc pl-4 text-xs space-y-1">
                                                <li>Voltage is the <strong>same</strong> for each branch.</li>
                                                <li>Current <strong>splits</strong> into branches.</li>
                                                <li>More branches = Higher Total Current.</li>
                                            </ul>
                                        </div>
                                        <div className="font-mono text-xs bg-slate-900 p-2 rounded text-center">
                                            $1/R_{`eq`} = 1/R_1 + 1/R_2 + ...$
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>

                        <div className="bg-yellow-900/10 border border-yellow-500/20 p-5 rounded-2xl">
                            <h3 className="text-yellow-400 font-bold text-sm mb-2 flex items-center">
                                <i data-lucide="lightbulb" className="w-4 h-4 mr-2"></i> Per Bulb Stats
                            </h3>
                            <div className="grid grid-cols-2 gap-4 text-xs">
                                <div className="bg-slate-900/50 p-2 rounded border border-slate-700/50">
                                    <div className="text-slate-500 mb-1">Voltage</div>
                                    <div className="text-white font-mono font-bold">{bulbStats.v.toFixed(2)} V</div>
                                </div>
                                <div className="bg-slate-900/50 p-2 rounded border border-slate-700/50">
                                    <div className="text-slate-500 mb-1">Current</div>
                                    <div className="text-white font-mono font-bold">{bulbStats.i.toFixed(2)} A</div>
                                </div>
                                <div className="col-span-2 bg-slate-900/50 p-2 rounded border border-slate-700/50">
                                    <div className="text-slate-500 mb-1">Power (Brightness)</div>
                                    <div className="text-yellow-400 font-mono font-bold text-lg">{bulbStats.p.toFixed(1)} W</div>
                                </div>
                            </div>
                        </div>

                    </div>

                </main>
            </div>
        );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
</script>
</body>
</html>
