<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Osmoregulation Loop Simulator | LuminousLearner</title>
    
    <!-- React & Tailwind -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Framer Motion -->
    <script src="https://unpkg.com/framer-motion@10.12.16/dist/framer-motion.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        slate: {
                            850: '#1e293b', 
                            950: '#0F172A', // LuminousLearner Dark Mode Background
                        },
                        emerald: {
                            450: '#10b981',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0F172A; color: #e2e8f0; margin: 0; overflow: hidden; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        
        /* Custom Slider */
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 24px; width: 24px; border-radius: 50%; 
            background: #38bdf8; cursor: pointer; margin-top: -10px; 
            box-shadow: 0 0 10px rgba(56, 189, 248, 0.5); border: 2px solid white;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 6px; cursor: pointer; background: #334155; border-radius: 3px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;
        const { motion, AnimatePresence } = window.Motion;

        const Icon = ({ name, className = "", size = 20 }) => {
            const [svgHtml, setSvgHtml] = useState('');
            useEffect(() => {
                if (window.lucide && window.lucide.icons) {
                    const pascalName = name.split('-').map(part => part.charAt(0).toUpperCase() + part.slice(1)).join('');
                    const iconData = window.lucide.icons[pascalName];
                    if (iconData && typeof window.lucide.createElement === 'function') {
                        const svgElement = window.lucide.createElement(iconData);
                        svgElement.setAttribute('class', className);
                        svgElement.setAttribute('width', size);
                        svgElement.setAttribute('height', size);
                        setSvgHtml(svgElement.outerHTML);
                    }
                }
            }, [name, className, size]);
            if (!svgHtml) return <span className={className} style={{ width: size, height: size, display: 'inline-block' }}></span>;
            return <span dangerouslySetInnerHTML={{ __html: svgHtml }} className="flex items-center justify-center" />;
        };

        // --- COMPONENT: MACRO LOOP DIAGRAM ---
        const MacroLoop = ({ hydration }) => {
            const adhLevel = 100 - hydration; // Inverse relationship
            const isADHHigh = adhLevel > 60;
            const isADHLow = adhLevel < 40;
            
            const signalColor = isADHHigh ? "#facc15" : "#94a3b8";
            const signalOpacity = isADHHigh ? 1 : 0.2;

            return (
                <svg viewBox="0 0 400 300" className="w-full h-full">
                    {/* Brain / Hypothalamus */}
                    <g transform="translate(200, 50)">
                        <path d="M -40 0 Q 0 -30 40 0 Q 40 40 0 50 Q -40 40 -40 0" fill="#e2e8f0" stroke="#64748b" strokeWidth="2" />
                        <text x="0" y="5" textAnchor="middle" fontSize="10" fill="#0f172a" fontWeight="bold">Hypothalamus</text>
                        
                        {/* Pituitary Gland */}
                        <circle cx="0" cy="55" r="10" fill={isADHHigh ? "#ec4899" : "#cbd5e1"} />
                        <text x="0" y="80" textAnchor="middle" fontSize="8" fill="#94a3b8">Pituitary</text>
                    </g>

                    {/* Kidney */}
                    <g transform="translate(200, 250)">
                        <path d="M -30 -20 Q -40 0 -20 20 Q 0 10 20 20 Q 40 0 30 -20 Q 0 -40 -30 -20" fill="#fca5a5" stroke="#ef4444" strokeWidth="2" />
                        <text x="0" y="5" textAnchor="middle" fontSize="10" fill="#7f1d1d" fontWeight="bold">Kidney</text>
                    </g>

                    {/* ADH Path */}
                    <path 
                        d="M 200 70 L 200 220" 
                        stroke={signalColor} strokeWidth="4" strokeDasharray="10,5" 
                        fill="none" opacity={signalOpacity}
                    >
                        {isADHHigh && (
                            <animate attributeName="stroke-dashoffset" from="30" to="0" dur="1s" repeatCount="indefinite" />
                        )}
                    </path>
                    
                    <text x="210" y="150" fontSize="10" fill={signalColor} opacity={signalOpacity} fontWeight="bold">
                        {isADHHigh ? "High ADH" : (isADHLow ? "Low ADH" : "Normal ADH")}
                    </text>

                    {/* Feedback Loop Lines */}
                    <path d="M 100 250 Q 50 150 150 50" stroke="#3b82f6" strokeWidth="2" fill="none" markerEnd="url(#arrow)" opacity="0.5" />
                    <text x="55" y="150" fontSize="10" fill="#60a5fa" transform="rotate(-75 55 150)">Blood Water Potential</text>

                    <defs>
                        <marker id="arrow" markerWidth="10" markerHeight="10" refX="5" refY="5" orient="auto">
                            <path d="M0,0 L0,10 L10,5 z" fill="#3b82f6" />
                        </marker>
                    </defs>
                </svg>
            );
        };

        // --- COMPONENT: MICRO DUCT VIEW ---
        const CollectingDuct = ({ hydration }) => {
            const canvasRef = useRef(null);
            const particlesRef = useRef([]);

            useEffect(() => {
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                
                const width = 300;
                const height = 400;
                
                // Calculate Reabsorption Probability based on ADH
                // Low Hydration (0) -> High ADH -> High Permeability -> High Reabsorption Chance
                // High Hydration (100) -> Low ADH -> Low Permeability -> Low Reabsorption Chance
                const adhLevel = 100 - hydration;
                // Make the effect very distinct:
                // If High ADH, reabsorption chance is high (e.g. 2% per frame) -> Most particles leave
                // If Low ADH, reabsorption chance is low (e.g. 0.1% per frame) -> Most particles stay
                const reabsorbChance = (adhLevel / 100) * 0.08; 

                // Initialize
                if (particlesRef.current.length === 0) {
                    // Pre-fill some
                    for(let i=0; i<20; i++) {
                        particlesRef.current.push({
                            x: 110 + Math.random() * 80,
                            y: Math.random() * height,
                            vx: 0,
                            vy: 2, // Constant speed
                            state: 'in_duct'
                        });
                    }
                }

                const render = () => {
                    ctx.clearRect(0, 0, width, height);

                    // --- Draw Background Structure ---
                    ctx.fillStyle = "#1e293b";
                    ctx.fillRect(0, 0, width, height);

                    // The Duct
                    ctx.fillStyle = "#0f172a";
                    ctx.fillRect(100, 0, 100, height);
                    
                    // Walls
                    const wallColor = "#fbbf24";
                    ctx.fillStyle = wallColor;
                    ctx.fillRect(90, 0, 10, height);
                    ctx.fillRect(200, 0, 10, height);
                    
                    // Aquaporins (Visual)
                    // Opacity linked to ADH level
                    const channelAlpha = Math.max(0.1, adhLevel / 100);
                    ctx.fillStyle = `rgba(59, 130, 246, ${channelAlpha})`;
                    for(let y=20; y<height; y+=40) {
                        ctx.fillRect(90, y, 10, 10);
                        ctx.fillRect(200, y, 10, 10);
                    }

                    // Capillaries
                    ctx.fillStyle = "rgba(239, 68, 68, 0.1)";
                    ctx.fillRect(0, 0, 90, height);
                    ctx.fillRect(210, 0, 90, height);
                    ctx.fillStyle = "#ef4444";
                    ctx.font = "10px sans-serif";
                    ctx.fillText("Capillary", 20, 20);
                    ctx.fillText("Capillary", 230, 20);


                    // --- Particle System ---
                    
                    // Spawn Logic
                    // Constant inflow of filtrate
                    if (Math.random() < 0.4) { // Fixed spawn rate
                         particlesRef.current.push({
                            x: 110 + Math.random() * 80,
                            y: -10,
                            vx: 0,
                            vy: 2, // Constant Gravity Speed
                            state: 'in_duct'
                        });
                    }

                    // Update & Draw
                    let urineCount = 0;

                    for (let i = particlesRef.current.length - 1; i >= 0; i--) {
                        const p = particlesRef.current[i];
                        
                        // Constant vertical movement
                        p.y += p.vy;

                        // Reabsorption Logic
                        if (p.state === 'in_duct') {
                            if (Math.random() < reabsorbChance) {
                                p.state = 'reabsorbing';
                                p.vx = Math.random() > 0.5 ? 2 : -2; // Move out
                            }
                        }

                        if (p.state === 'reabsorbing') {
                            p.x += p.vx;
                            // Visual fade or kill when reaching blood
                            if (p.x < 80 || p.x > 220) {
                                particlesRef.current.splice(i, 1);
                                continue;
                            }
                        }
                        
                        // Count urine (particles reaching bottom)
                        if (p.y > height && p.state === 'in_duct') {
                            // Recycle to keep memory low, or just remove
                            particlesRef.current.splice(i, 1);
                            continue; 
                        }
                        
                        // Draw
                        ctx.beginPath();
                        ctx.arc(p.x, p.y, 3.5, 0, Math.PI*2);
                        // Color: Blue in duct, lighter/fading when reabsorbing
                        ctx.fillStyle = p.state === 'reabsorbing' ? "rgba(96, 165, 250, 0.6)" : "#3b82f6";
                        ctx.fill();
                    }

                    requestAnimationFrame(render);
                };
                render();

            }, [hydration]);

            return <canvas ref={canvasRef} width={300} height={400} className="w-full h-full object-contain" />;
        };

        // --- MAIN APP ---
        const App = () => {
            const [hydration, setHydration] = useState(50); // 0 to 100
            const adhLevel = 100 - hydration;
            
            // Urine Output Calculation
            const urineVolume = Math.max(10, (hydration / 100) * 100); // 10ml to 100ml
            const urineColorIntensity = 1 - (hydration / 100); 
            const urineColorStyle = `hsl(45, 100%, ${95 - (urineColorIntensity * 45)}%)`;

            return (
                <div className="min-h-screen bg-[#0F172A] text-white flex flex-col md:flex-row overflow-hidden font-sans">
                    
                    {/* Sidebar */}
                    <div className="w-full md:w-80 bg-slate-900 border-r border-slate-800 flex flex-col z-10 shadow-xl h-screen shrink-0">
                        <div className="p-6 border-b border-slate-800">
                            <h1 className="text-xl font-bold flex items-center gap-2">
                                <Icon name="droplet" className="text-blue-400" /> Osmoregulation
                            </h1>
                            <p className="text-xs text-slate-400 mt-1">ADH Negative Feedback Loop</p>
                        </div>

                        <div className="p-6 space-y-8 flex-1 overflow-y-auto custom-scrollbar">
                            
                            {/* Hydration Slider */}
                            <div className="space-y-4">
                                <div className="flex justify-between items-end">
                                    <label className="text-xs font-bold text-slate-500 uppercase tracking-widest">Blood Water Potential</label>
                                </div>
                                <div className="relative h-8 flex items-center">
                                    <div className="absolute w-full h-2 rounded-full bg-gradient-to-r from-orange-500 via-blue-500 to-cyan-400 opacity-50"></div>
                                    <input 
                                        type="range" min="0" max="100" step="1"
                                        value={hydration} 
                                        onChange={(e) => setHydration(parseInt(e.target.value))}
                                        className="w-full relative z-10 accent-blue-500"
                                    />
                                </div>
                                <div className="flex justify-between text-[10px] font-bold">
                                    <span className="text-orange-400">Dehydrated</span>
                                    <span className="text-cyan-400">Over-hydrated</span>
                                </div>
                            </div>

                            {/* Status Dashboard */}
                            <div className="space-y-3">
                                <div className="bg-slate-800 p-4 rounded-xl border border-slate-700">
                                    <div className="text-xs text-slate-500 uppercase mb-1">Pituitary Gland</div>
                                    <div className="flex justify-between items-center">
                                        <span className="text-sm font-bold text-white">ADH Release</span>
                                        <span className={`text-lg font-mono font-black ${adhLevel > 60 ? 'text-pink-500 animate-pulse' : 'text-slate-400'}`}>
                                            {adhLevel > 80 ? 'MAX' : adhLevel > 40 ? 'NORMAL' : 'LOW'}
                                        </span>
                                    </div>
                                </div>

                                <div className="bg-slate-800 p-4 rounded-xl border border-slate-700">
                                    <div className="text-xs text-slate-500 uppercase mb-1">Collecting Duct</div>
                                    <div className="flex justify-between items-center">
                                        <span className="text-sm font-bold text-white">Water Reabsorption</span>
                                        <span className="text-sm font-mono text-blue-300">
                                            {adhLevel > 60 ? 'HIGH' : 'LOW'}
                                        </span>
                                    </div>
                                    <div className="mt-2 text-xs text-slate-400 leading-tight">
                                        {adhLevel > 60 ? 'Channels OPEN. Water returns to blood.' : 'Channels CLOSED. Water stays in duct.'}
                                    </div>
                                </div>
                            </div>
                            
                            {/* Urine Result Visual */}
                            <div className="bg-slate-800 p-4 rounded-xl border border-slate-700 flex flex-col items-center">
                                <div className="text-xs font-bold text-slate-500 uppercase mb-4 w-full text-left">Urine Output</div>
                                
                                {/* Beaker */}
                                <div className="w-24 h-32 border-b-4 border-x-2 border-slate-500 rounded-b-xl relative overflow-hidden bg-slate-900/50">
                                    {/* Liquid */}
                                    <div 
                                        className="absolute bottom-0 left-0 right-0 transition-all duration-500"
                                        style={{ 
                                            height: `${urineVolume}%`, 
                                            backgroundColor: urineColorStyle,
                                            opacity: 0.8
                                        }}
                                    ></div>
                                    {/* Marks */}
                                    <div className="absolute right-0 top-0 bottom-0 w-4 border-l border-slate-700 flex flex-col justify-between py-2">
                                        {[...Array(5)].map((_, i) => <div key={i} className="w-2 h-px bg-slate-500"></div>)}
                                    </div>
                                </div>
                                <div className="mt-2 text-center">
                                    <div className="text-lg font-bold text-white">{urineVolume.toFixed(0)} ml/h</div>
                                    <div className="text-xs font-bold" style={{color: urineColorStyle}}>
                                        {hydration < 30 ? 'Concentrated' : hydration > 70 ? 'Dilute' : 'Normal'}
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>

                    {/* Main Stage */}
                    <div className="flex-1 bg-[#020617] relative flex flex-col p-6 overflow-hidden gap-6">
                        
                        <div className="flex-1 flex gap-6 h-full">
                            
                            {/* Left: Macro Diagram */}
                            <div className="flex-1 bg-slate-900 rounded-3xl border border-slate-800 shadow-xl p-4 flex flex-col">
                                <div className="text-xs text-slate-500 uppercase font-bold mb-2">Feedback Loop (Systemic)</div>
                                <div className="flex-1 relative">
                                    <MacroLoop hydration={hydration} />
                                </div>
                            </div>

                            {/* Right: Microscopic View */}
                            <div className="flex-1 bg-slate-900 rounded-3xl border border-slate-800 shadow-xl p-4 flex flex-col">
                                <div className="flex justify-between items-center mb-2">
                                    <span className="text-xs text-slate-500 uppercase font-bold">Collecting Duct (Microscopic)</span>
                                    <div className="flex gap-2 text-[10px]">
                                        <span className="text-blue-400 font-bold animate-pulse">
                                            {adhLevel > 60 ? 'Reabsorbing...' : 'Excreting...'}
                                        </span>
                                    </div>
                                </div>
                                <div className="flex-1 relative bg-black/20 rounded-xl overflow-hidden">
                                    <CollectingDuct hydration={hydration} />
                                    
                                    {/* Visual Labels inside canvas */}
                                    <div className="absolute top-4 left-2 text-[10px] text-slate-500">Filtrate In (Constant)</div>
                                    <div className="absolute bottom-4 left-1/2 -translate-x-1/2 text-[10px] font-bold text-yellow-200 bg-black/40 px-2 py-1 rounded">
                                        Urine Flow
                                    </div>
                                </div>
                            </div>

                        </div>
                        
                        {/* Key Concept */}
                        <div className="bg-blue-900/20 p-4 rounded-xl border border-blue-500/30 text-sm text-slate-300 shrink-0">
                            <div className="font-bold text-blue-400 uppercase mb-1 flex items-center gap-2"><Icon name="info" size={16}/> Negative Feedback Mechanism</div>
                            <p>
                                When water potential is <strong>HIGH</strong> (Over-hydrated) &rarr; Pituitary releases <strong>LESS ADH</strong> &rarr; Collecting duct is <strong>LESS permeable</strong>. <br/>
                                Result: Less water is reabsorbed, more water stays in the duct &rarr; <strong>Large volume of dilute urine</strong>.
                            </p>
                        </div>

                    </div>

                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
