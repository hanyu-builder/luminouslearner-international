<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Infectious Chain Breaker - LuminousLearner International</title>
    
    <!-- React & Tailwind -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Recharts -->
    <script src="https://unpkg.com/prop-types/prop-types.min.js"></script>
    <script src="https://unpkg.com/recharts@2.12.7/umd/Recharts.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Framer Motion -->
    <script src="https://unpkg.com/framer-motion@10.12.16/dist/framer-motion.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0F172A; color: #e2e8f0; margin: 0; overflow: hidden; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        
        /* Pulse Animation for Infected */
        .infected-pulse {
            animation: pulse-red 1s infinite;
        }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 6px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;
        const { AreaChart, Area, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Legend } = window.Recharts;
        const { motion, AnimatePresence } = window.Motion;

        const Icon = ({ name, className = "", size = 20 }) => {
            const [svgHtml, setSvgHtml] = useState('');
            useEffect(() => {
                if (window.lucide && window.lucide.icons) {
                    const pascalName = name.split('-').map(part => part.charAt(0).toUpperCase() + part.slice(1)).join('');
                    const iconData = window.lucide.icons[pascalName];
                    if (iconData && typeof window.lucide.createElement === 'function') {
                        const svgElement = window.lucide.createElement(iconData);
                        svgElement.setAttribute('class', className);
                        svgElement.setAttribute('width', size);
                        svgElement.setAttribute('height', size);
                        setSvgHtml(svgElement.outerHTML);
                    }
                }
            }, [name, className, size]);
            if (!svgHtml) return <span className={className} style={{ width: size, height: size, display: 'inline-block' }}></span>;
            return <span dangerouslySetInnerHTML={{ __html: svgHtml }} className="flex items-center justify-center" />;
        };

        // --- CONSTANTS ---
        const POPULATION_SIZE = 100;
        const RECOVERY_TIME = 800; // Frames to recover
        const CANVAS_WIDTH = 600;
        const CANVAS_HEIGHT = 400;
        const PARTICLE_RADIUS = 4;
        const BASE_INFECTION_RATE = 0.8; // High chance if no protection

        // --- SIMULATION CANVAS ---
        const SimulationCanvas = ({ measures, onStatsUpdate, isRunning, onReset }) => {
            const canvasRef = useRef(null);
            const particlesRef = useRef([]);
            const frameRef = useRef(0);

            // Initialize Population
            const initPopulation = () => {
                const p = [];
                for(let i=0; i<POPULATION_SIZE; i++) {
                    // Start with 1 infected
                    const isInfected = i === 0;
                    p.push({
                        id: i,
                        x: Math.random() * CANVAS_WIDTH,
                        y: Math.random() * CANVAS_HEIGHT,
                        vx: (Math.random() - 0.5) * 2,
                        vy: (Math.random() - 0.5) * 2,
                        status: isInfected ? 'infected' : 'susceptible', // susceptible, infected, recovered
                        timer: 0,
                        quarantined: false
                    });
                }
                particlesRef.current = p;
                frameRef.current = 0;
            };

            useEffect(() => {
                initPopulation();
            }, [onReset]);

            // Simulation Loop
            useEffect(() => {
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                let animationId;

                const update = () => {
                    ctx.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
                    
                    // Draw Quarantine Zone
                    if (measures.quarantine) {
                        ctx.strokeStyle = "#fbbf24";
                        ctx.lineWidth = 2;
                        ctx.setLineDash([5, 5]);
                        ctx.strokeRect(10, 10, 120, 120);
                        ctx.fillStyle = "rgba(251, 191, 36, 0.1)";
                        ctx.fillRect(10, 10, 120, 120);
                        ctx.setLineDash([]);
                        ctx.fillStyle = "#fbbf24";
                        ctx.font = "bold 10px Inter";
                        ctx.fillText("ISOLATION ZONE", 20, 25);
                    }

                    let infectedCount = 0;
                    let recoveredCount = 0;
                    let susceptibleCount = 0;

                    // Logic Factors
                    const speedMultiplier = measures.distancing ? 0.3 : 1.0; // Slow down if distancing
                    const infectionChance = measures.mask ? BASE_INFECTION_RATE * 0.1 : BASE_INFECTION_RATE; // Masks reduce spread chance significantly

                    // Vaccination Logic (Slowly immunize population if active)
                    if (measures.vaccination && frameRef.current % 50 === 0) {
                        const susceptible = particlesRef.current.filter(p => p.status === 'susceptible');
                        if (susceptible.length > 0) {
                            const luckyOne = susceptible[Math.floor(Math.random() * susceptible.length)];
                            luckyOne.status = 'recovered'; // Immune/Vaccinated
                        }
                    }

                    particlesRef.current.forEach(p => {
                        // Move
                        if (!p.quarantined) {
                            p.x += p.vx * speedMultiplier;
                            p.y += p.vy * speedMultiplier;

                            // Bounce walls
                            if (p.x < PARTICLE_RADIUS || p.x > CANVAS_WIDTH - PARTICLE_RADIUS) p.vx *= -1;
                            if (p.y < PARTICLE_RADIUS || p.y > CANVAS_HEIGHT - PARTICLE_RADIUS) p.vy *= -1;
                        }

                        // Quarantine Logic
                        if (measures.quarantine && p.status === 'infected' && !p.quarantined) {
                            // Chance to be detected and moved
                            if (Math.random() < 0.02) {
                                p.quarantined = true;
                                p.x = 20 + Math.random() * 100;
                                p.y = 20 + Math.random() * 100;
                                p.vx = (Math.random() - 0.5); // Move slowly in quarantine
                                p.vy = (Math.random() - 0.5);
                            }
                        }
                        
                        // Keep quarantined inside box
                        if (p.quarantined) {
                            p.x += p.vx * 0.5;
                            p.y += p.vy * 0.5;
                            if (p.x < 15 || p.x > 125) p.vx *= -1;
                            if (p.y < 15 || p.y > 125) p.vy *= -1;
                            
                            // Release if recovered
                            if (p.status === 'recovered') {
                                p.quarantined = false; 
                                p.x = CANVAS_WIDTH / 2; // Release point
                                p.y = CANVAS_HEIGHT / 2;
                            }
                        }

                        // Infection Logic
                        if (p.status === 'infected') {
                            p.timer++;
                            if (p.timer > RECOVERY_TIME) {
                                p.status = 'recovered';
                            }
                            
                            // Spread to neighbors (only if not quarantined)
                            if (!p.quarantined) {
                                particlesRef.current.forEach(other => {
                                    if (other.status === 'susceptible' && !other.quarantined) {
                                        const dx = p.x - other.x;
                                        const dy = p.y - other.y;
                                        const dist = Math.sqrt(dx*dx + dy*dy);
                                        
                                        if (dist < PARTICLE_RADIUS * 3) { // Contact radius
                                            if (Math.random() < infectionChance) {
                                                other.status = 'infected';
                                            }
                                        }
                                    }
                                });
                            }
                        }

                        // Draw
                        ctx.beginPath();
                        ctx.arc(p.x, p.y, PARTICLE_RADIUS, 0, Math.PI * 2);
                        if (p.status === 'susceptible') ctx.fillStyle = '#3b82f6'; // Blue
                        else if (p.status === 'infected') ctx.fillStyle = '#ef4444'; // Red
                        else ctx.fillStyle = '#10b981'; // Green
                        ctx.fill();

                        // Draw Mask visual (White ring)
                        if (measures.mask && !p.quarantined) {
                            ctx.strokeStyle = "white";
                            ctx.lineWidth = 1;
                            ctx.beginPath();
                            ctx.arc(p.x, p.y, PARTICLE_RADIUS + 1, 0, Math.PI * 2);
                            ctx.stroke();
                        }

                        // Counts
                        if (p.status === 'susceptible') susceptibleCount++;
                        if (p.status === 'infected') infectedCount++;
                        if (p.status === 'recovered') recoveredCount++;
                    });

                    // Send stats every 10 frames
                    if (frameRef.current % 10 === 0) {
                        onStatsUpdate({
                            infected: infectedCount,
                            susceptible: susceptibleCount,
                            recovered: recoveredCount,
                            time: frameRef.current
                        });
                    }

                    frameRef.current++;
                    if (isRunning) animationId = requestAnimationFrame(update);
                };

                if (isRunning) {
                    animationId = requestAnimationFrame(update);
                }

                return () => cancelAnimationFrame(animationId);
            }, [measures, isRunning]);

            return <canvas ref={canvasRef} width={600} height={400} className="w-full h-full object-contain bg-slate-900 rounded-xl border border-slate-700" />;
        };

        // --- MAIN APP ---
        const App = () => {
            const [measures, setMeasures] = useState({
                mask: false,
                vaccination: false,
                distancing: false,
                quarantine: false
            });
            
            const [history, setHistory] = useState([]);
            const [isRunning, setIsRunning] = useState(false);
            const [resetKey, setResetKey] = useState(0); // To force reset canvas

            // Update History
            const handleStatsUpdate = (stats) => {
                setHistory(prev => {
                    const newData = [...prev, stats];
                    // Keep graph scrolling if too long
                    // if (newData.length > 200) newData.shift(); 
                    return newData;
                });
                
                // Auto stop if no infected left and some time passed
                if (stats.infected === 0 && stats.time > 100 && isRunning) {
                    setIsRunning(false);
                }
            };

            const toggleMeasure = (key) => {
                setMeasures(prev => ({ ...prev, [key]: !prev[key] }));
            };

            const handleReset = () => {
                setHistory([]);
                setIsRunning(false);
                setMeasures({ mask: false, vaccination: false, distancing: false, quarantine: false });
                setResetKey(k => k + 1);
            };

            // Current stats for display
            const currentStats = history.length > 0 ? history[history.length - 1] : { infected: 1, susceptible: POPULATION_SIZE - 1, recovered: 0 };

            return (
                <div className="min-h-screen bg-[#0F172A] text-white flex flex-col md:flex-row overflow-hidden">
                    
                    {/* Sidebar */}
                    <div className="w-full md:w-80 bg-slate-900 border-r border-slate-800 flex flex-col z-10 shadow-xl h-screen shrink-0">
                        <div className="p-6 border-b border-slate-800">
                            <h1 className="text-xl font-bold flex items-center gap-2">
                                <Icon name="shield-alert" className="text-red-500" /> Chain Breaker
                            </h1>
                            <p className="text-xs text-slate-400 mt-1">Infectious Disease Simulator</p>
                        </div>

                        <div className="p-6 space-y-8 flex-1 overflow-y-auto custom-scrollbar">
                            
                            {/* Status */}
                            <div className="grid grid-cols-3 gap-2 text-center">
                                <div className="bg-slate-800 p-2 rounded-lg border border-slate-700">
                                    <div className="text-xs text-slate-400">Healthy</div>
                                    <div className="text-xl font-bold text-blue-400">{currentStats.susceptible}</div>
                                </div>
                                <div className="bg-slate-800 p-2 rounded-lg border border-red-900/50">
                                    <div className="text-xs text-red-400">Infected</div>
                                    <div className="text-xl font-bold text-red-500 animate-pulse">{currentStats.infected}</div>
                                </div>
                                <div className="bg-slate-800 p-2 rounded-lg border border-emerald-900/50">
                                    <div className="text-xs text-emerald-400">Recovered</div>
                                    <div className="text-xl font-bold text-emerald-500">{currentStats.recovered}</div>
                                </div>
                            </div>

                            {/* Interventions */}
                            <div className="space-y-3">
                                <label className="text-xs font-bold text-slate-500 uppercase tracking-widest px-1">Control Measures</label>
                                
                                <button 
                                    onClick={() => toggleMeasure('mask')}
                                    className={`w-full p-3 rounded-xl border transition-all flex items-center justify-between group
                                        ${measures.mask ? 'bg-sky-600 border-sky-500 text-white shadow-lg' : 'bg-slate-800 border-slate-700 text-slate-400 hover:bg-slate-700'}
                                    `}
                                >
                                    <div className="flex items-center gap-3">
                                        <Icon name="frown" size={20}/>
                                        <div className="text-left">
                                            <div className="text-sm font-bold">Face Masks</div>
                                            <div className="text-[10px] opacity-70">Blocks Transmission (Low %)</div>
                                        </div>
                                    </div>
                                    {measures.mask && <Icon name="check" size={16}/>}
                                </button>

                                <button 
                                    onClick={() => toggleMeasure('distancing')}
                                    className={`w-full p-3 rounded-xl border transition-all flex items-center justify-between group
                                        ${measures.distancing ? 'bg-indigo-600 border-indigo-500 text-white shadow-lg' : 'bg-slate-800 border-slate-700 text-slate-400 hover:bg-slate-700'}
                                    `}
                                >
                                    <div className="flex items-center gap-3">
                                        <Icon name="move-horizontal" size={20}/>
                                        <div className="text-left">
                                            <div className="text-sm font-bold">Social Distancing</div>
                                            <div className="text-[10px] opacity-70">Reduces Movement & Contact</div>
                                        </div>
                                    </div>
                                    {measures.distancing && <Icon name="check" size={16}/>}
                                </button>

                                <button 
                                    onClick={() => toggleMeasure('quarantine')}
                                    className={`w-full p-3 rounded-xl border transition-all flex items-center justify-between group
                                        ${measures.quarantine ? 'bg-yellow-600 border-yellow-500 text-white shadow-lg' : 'bg-slate-800 border-slate-700 text-slate-400 hover:bg-slate-700'}
                                    `}
                                >
                                    <div className="flex items-center gap-3">
                                        <Icon name="ban" size={20}/>
                                        <div className="text-left">
                                            <div className="text-sm font-bold">Quarantine</div>
                                            <div className="text-[10px] opacity-70">Isolates Infected Cases</div>
                                        </div>
                                    </div>
                                    {measures.quarantine && <Icon name="check" size={16}/>}
                                </button>

                                <button 
                                    onClick={() => toggleMeasure('vaccination')}
                                    className={`w-full p-3 rounded-xl border transition-all flex items-center justify-between group
                                        ${measures.vaccination ? 'bg-emerald-600 border-emerald-500 text-white shadow-lg' : 'bg-slate-800 border-slate-700 text-slate-400 hover:bg-slate-700'}
                                    `}
                                >
                                    <div className="flex items-center gap-3">
                                        <Icon name="syringe" size={20}/>
                                        <div className="text-left">
                                            <div className="text-sm font-bold">Vaccination</div>
                                            <div className="text-[10px] opacity-70">Immunizes Population Over Time</div>
                                        </div>
                                    </div>
                                    {measures.vaccination && <Icon name="check" size={16}/>}
                                </button>
                            </div>

                            <div className="grid grid-cols-2 gap-3 pt-4 border-t border-slate-800">
                                <button 
                                    onClick={() => setIsRunning(!isRunning)}
                                    className={`py-3 rounded-xl font-bold flex items-center justify-center gap-2 transition-all shadow-lg
                                        ${isRunning ? 'bg-red-600 hover:bg-red-500 text-white' : 'bg-blue-600 hover:bg-blue-500 text-white'}
                                    `}
                                >
                                    <Icon name={isRunning ? "pause" : "play"} size={18} fill="currentColor"/> {isRunning ? 'Pause' : 'Start'}
                                </button>
                                <button 
                                    onClick={handleReset}
                                    className="py-3 bg-slate-800 hover:bg-slate-700 rounded-xl text-slate-300 font-bold flex items-center justify-center gap-2 border border-slate-600"
                                >
                                    <Icon name="rotate-ccw" size={18}/> Reset
                                </button>
                            </div>

                        </div>
                    </div>

                    {/* Main Stage */}
                    <div className="flex-1 bg-[#020617] relative flex flex-col p-6 overflow-hidden gap-6">
                        
                        {/* Simulation Canvas */}
                        <div className="flex-1 bg-slate-900 rounded-3xl border border-slate-800 shadow-xl relative overflow-hidden flex flex-col items-center justify-center p-4">
                            <SimulationCanvas 
                                measures={measures} 
                                onStatsUpdate={handleStatsUpdate} 
                                isRunning={isRunning}
                                onReset={resetKey}
                            />
                        </div>

                        {/* Epidemic Curve */}
                        <div className="h-48 bg-slate-900 rounded-2xl border border-slate-800 p-4 flex flex-col">
                             <div className="text-xs font-bold text-slate-500 uppercase mb-2 flex items-center gap-2">
                                <Icon name="line-chart" size={14}/> Infection Curve
                            </div>
                            <div className="flex-1 min-h-0">
                                <ResponsiveContainer width="100%" height="100%">
                                    <AreaChart data={history}>
                                        <defs>
                                            <linearGradient id="colorInfected" x1="0" y1="0" x2="0" y2="1">
                                                <stop offset="5%" stopColor="#ef4444" stopOpacity={0.3}/>
                                                <stop offset="95%" stopColor="#ef4444" stopOpacity={0}/>
                                            </linearGradient>
                                            <linearGradient id="colorRecovered" x1="0" y1="0" x2="0" y2="1">
                                                <stop offset="5%" stopColor="#10b981" stopOpacity={0.3}/>
                                                <stop offset="95%" stopColor="#10b981" stopOpacity={0}/>
                                            </linearGradient>
                                        </defs>
                                        <CartesianGrid strokeDasharray="3 3" stroke="#334155" />
                                        <XAxis dataKey="time" hide />
                                        <YAxis hide domain={[0, POPULATION_SIZE]} />
                                        <Tooltip 
                                            contentStyle={{ backgroundColor: '#1e293b', borderColor: '#475569', fontSize: '12px' }}
                                            itemStyle={{ fontSize: '12px' }}
                                        />
                                        <Legend wrapperStyle={{fontSize: '10px'}} iconType="circle"/>
                                        <Area type="monotone" dataKey="infected" stroke="#ef4444" fill="url(#colorInfected)" name="Active Cases" animationDuration={0} isAnimationActive={false} />
                                        <Area type="monotone" dataKey="recovered" stroke="#10b981" fill="url(#colorRecovered)" name="Recovered/Immune" animationDuration={0} isAnimationActive={false} />
                                    </AreaChart>
                                </ResponsiveContainer>
                            </div>
                        </div>

                    </div>

                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
