<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Heart Structure 3D | LuminousLearner</title>
    
    <!-- React & Tailwind -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        slate: {
                            850: '#1e293b', 
                            950: '#0F172A', // LuminousLearner Dark Mode Background
                        },
                        emerald: {
                            450: '#10b981',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0F172A; color: #e2e8f0; margin: 0; overflow: hidden; }
        canvas { outline: none; }
        .info-panel { backdrop-filter: blur(10px); }
        
        /* Pulse Animation for Heartbeat */
        .pulse-btn { animation: pulse 1.5s infinite; }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background-color: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background-color: #475569; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const Icon = ({ name, className = "", size = 20 }) => {
            const [svgHtml, setSvgHtml] = useState('');
            useEffect(() => {
                if (window.lucide && window.lucide.icons) {
                    const pascalName = name.split('-').map(part => part.charAt(0).toUpperCase() + part.slice(1)).join('');
                    const iconData = window.lucide.icons[pascalName];
                    if (iconData && typeof window.lucide.createElement === 'function') {
                        const svgElement = window.lucide.createElement(iconData);
                        svgElement.setAttribute('class', className);
                        svgElement.setAttribute('width', size);
                        svgElement.setAttribute('height', size);
                        setSvgHtml(svgElement.outerHTML);
                    }
                }
            }, [name, className, size]);
            if (!svgHtml) return <span className={className} style={{ width: size, height: size, display: 'inline-block' }}></span>;
            return <span dangerouslySetInnerHTML={{ __html: svgHtml }} className="flex items-center justify-center" />;
        };

        // --- DATA ---
        const PARTS = {
            ra: {
                name: 'Right Atrium',
                desc: 'Receives deoxygenated blood from the body via the Vena Cava.',
                color: '#3b82f6'
            },
            rv: {
                name: 'Right Ventricle',
                desc: 'Pumps deoxygenated blood to the lungs via the Pulmonary Artery. Has thinner walls than the left ventricle.',
                color: '#2563eb'
            },
            la: {
                name: 'Left Atrium',
                desc: 'Receives oxygenated blood from the lungs via the Pulmonary Vein.',
                color: '#ef4444'
            },
            lv: {
                name: 'Left Ventricle',
                desc: 'Pumps oxygenated blood to the rest of the body via the Aorta. Has the thickest muscular wall.',
                color: '#b91c1c'
            },
            aorta: {
                name: 'Aorta',
                desc: 'Main artery carrying oxygenated blood to the body.',
                color: '#f87171'
            },
            pa: {
                name: 'Pulmonary Artery',
                desc: 'Carries deoxygenated blood to the lungs.',
                color: '#60a5fa'
            },
            pv: {
                name: 'Pulmonary Vein',
                desc: 'Carries oxygenated blood from the lungs.',
                color: '#fca5a5'
            },
            vc: {
                name: 'Vena Cava',
                desc: 'Carries deoxygenated blood from the body.',
                color: '#93c5fd'
            },
            // Valves
            tricuspid: {
                name: 'Tricuspid Valve',
                desc: 'Prevents backflow of blood from Right Ventricle to Right Atrium.',
                color: '#ffffff'
            },
            mitral: {
                name: 'Mitral Valve',
                desc: 'Prevents backflow of blood from Left Ventricle to Left Atrium.',
                color: '#ffffff'
            },
            pulmonary_valve: {
                name: 'Pulmonary Valve',
                desc: 'Prevents backflow from Pulmonary Artery to Right Ventricle.',
                color: '#ffffff'
            },
            aortic_valve: {
                name: 'Aortic Valve',
                desc: 'Prevents backflow from Aorta to Left Ventricle.',
                color: '#ffffff'
            }
        };

        // --- 3D SCENE ---
        const HeartScene = ({ onSelect, showFlow }) => {
            const mountRef = useRef(null);
            const sceneRef = useRef(null);
            const frameIdRef = useRef(null);

            useEffect(() => {
                if (!mountRef.current) return;

                const container = mountRef.current;
                let width = container.clientWidth || 100;
                let height = container.clientHeight || 100;

                const scene = new THREE.Scene();
                scene.background = new THREE.Color(0x020617); 
                scene.fog = new THREE.FogExp2(0x020617, 0.02);
                sceneRef.current = scene;

                const camera = new THREE.PerspectiveCamera(45, width / height, 0.1, 1000);
                camera.position.set(0, 5, 25);

                const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                renderer.setSize(width, height);
                renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
                
                while(container.firstChild) container.removeChild(container.firstChild);
                container.appendChild(renderer.domElement);

                const controls = new THREE.OrbitControls(camera, renderer.domElement);
                controls.enableDamping = true;
                controls.autoRotate = true;
                controls.autoRotateSpeed = 0.5;
                controls.minDistance = 10;
                controls.maxDistance = 50;

                // Lights
                const ambientLight = new THREE.AmbientLight(0xffffff, 0.7);
                scene.add(ambientLight);
                const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
                dirLight.position.set(10, 10, 10);
                scene.add(dirLight);
                const pointLight = new THREE.PointLight(0xffaa00, 0.4); // Warm glow
                pointLight.position.set(-5, 5, 5);
                scene.add(pointLight);
                const backLight = new THREE.DirectionalLight(0xffffff, 0.5);
                backLight.position.set(0, 5, -20); // Light up the back for valve viewing
                scene.add(backLight);

                // --- BUILD HEART (Procedural Geometry) ---
                const heartGroup = new THREE.Group();

                // Adjusted opacity to 0.4 for better visibility of internal flow
                const createMat = (color) => new THREE.MeshStandardMaterial({ 
                    color: color, 
                    roughness: 0.3, 
                    metalness: 0.1,
                    transparent: true,
                    opacity: 0.4, 
                    side: THREE.DoubleSide
                });
                
                const valveMat = new THREE.MeshStandardMaterial({ 
                    color: 0xffffff, 
                    roughness: 0.4,
                    emissive: 0xaaaaaa,
                    emissiveIntensity: 0.2
                });

                // 1. Ventricles (Cone/Sphere combo)
                // Right Ventricle
                const rvGeo = new THREE.SphereGeometry(3, 32, 32, 0, Math.PI, 0, Math.PI); // Half sphere
                const rvMesh = new THREE.Mesh(rvGeo, createMat(PARTS.rv.color));
                rvMesh.position.set(-1.5, -2, 0);
                rvMesh.rotation.z = -0.2;
                rvMesh.scale.set(1, 1.5, 0.8);
                rvMesh.userData = { id: 'rv' };
                heartGroup.add(rvMesh);

                // Left Ventricle (Thicker, larger)
                const lvGeo = new THREE.SphereGeometry(3.5, 32, 32, 0, Math.PI, 0, Math.PI);
                const lvMesh = new THREE.Mesh(lvGeo, createMat(PARTS.lv.color));
                lvMesh.position.set(1.5, -2, 0);
                lvMesh.rotation.z = 0.2;
                lvMesh.scale.set(1, 1.6, 1); 
                lvMesh.userData = { id: 'lv' };
                heartGroup.add(lvMesh);

                // 2. Atria (Smaller spheres on top)
                // Right Atrium
                const raGeo = new THREE.SphereGeometry(2.2, 32, 32);
                const raMesh = new THREE.Mesh(raGeo, createMat(PARTS.ra.color));
                raMesh.position.set(-2, 2, 0);
                raMesh.scale.set(1, 0.8, 0.8);
                raMesh.userData = { id: 'ra' };
                heartGroup.add(raMesh);

                // Left Atrium
                const laGeo = new THREE.SphereGeometry(2.2, 32, 32);
                const laMesh = new THREE.Mesh(laGeo, createMat(PARTS.la.color));
                laMesh.position.set(2, 2, 0);
                laMesh.scale.set(1, 0.8, 0.8);
                laMesh.userData = { id: 'la' };
                heartGroup.add(laMesh);

                // 3. Vessels (Tubes)
                // Aorta (Arch)
                const aortaPath = new THREE.CatmullRomCurve3([
                    new THREE.Vector3(1.5, 2, 0),
                    new THREE.Vector3(0, 5, 0),
                    new THREE.Vector3(-1, 6, -1)
                ]);
                const aortaGeo = new THREE.TubeGeometry(aortaPath, 20, 0.8, 16, false);
                const aortaMesh = new THREE.Mesh(aortaGeo, createMat(PARTS.aorta.color));
                aortaMesh.userData = { id: 'aorta' };
                heartGroup.add(aortaMesh);

                // Pulmonary Artery (Trunk)
                const paPath = new THREE.CatmullRomCurve3([
                    new THREE.Vector3(-1.5, 2, 0.5),
                    new THREE.Vector3(0, 4, 1),
                    new THREE.Vector3(2, 5, 0)
                ]);
                const paGeo = new THREE.TubeGeometry(paPath, 20, 0.7, 16, false);
                const paMesh = new THREE.Mesh(paGeo, createMat(PARTS.pa.color));
                paMesh.userData = { id: 'pa' };
                heartGroup.add(paMesh);

                // Vena Cava
                const vcGeo = new THREE.CylinderGeometry(0.7, 0.7, 4, 16);
                const vcMesh = new THREE.Mesh(vcGeo, createMat(PARTS.vc.color));
                vcMesh.position.set(-3, 3, 0);
                vcMesh.rotation.z = 0.5;
                vcMesh.userData = { id: 'vc' };
                heartGroup.add(vcMesh);

                // Pulmonary Veins
                const pvGeo = new THREE.CylinderGeometry(0.6, 0.6, 3, 16);
                const pvMesh = new THREE.Mesh(pvGeo, createMat(PARTS.pv.color));
                pvMesh.position.set(3.5, 3, 0);
                pvMesh.rotation.z = -0.5;
                pvMesh.userData = { id: 'pv' };
                heartGroup.add(pvMesh);
                
                // --- VALVES ---
                // Tricuspid (RA-RV)
                const tricuspidGeo = new THREE.CylinderGeometry(1.2, 1.2, 0.2, 16);
                const tricuspid = new THREE.Mesh(tricuspidGeo, valveMat);
                tricuspid.position.set(-1.8, 0.5, 0);
                tricuspid.userData = { id: 'tricuspid' };
                heartGroup.add(tricuspid);

                // Mitral (LA-LV)
                const mitralGeo = new THREE.CylinderGeometry(1.2, 1.2, 0.2, 16);
                const mitral = new THREE.Mesh(mitralGeo, valveMat);
                mitral.position.set(1.8, 0.5, 0);
                mitral.userData = { id: 'mitral' };
                heartGroup.add(mitral);

                // Pulmonary Valve (RV-PA)
                const pulmonaryValGeo = new THREE.CylinderGeometry(0.6, 0.6, 0.2, 16);
                const pulmonaryVal = new THREE.Mesh(pulmonaryValGeo, valveMat);
                pulmonaryVal.position.set(-1.0, 2.2, 0.5);
                pulmonaryVal.rotation.z = -0.5;
                pulmonaryVal.rotation.x = 0.5;
                pulmonaryVal.userData = { id: 'pulmonary_valve' };
                heartGroup.add(pulmonaryVal);

                // Aortic Valve (LV-Aorta)
                const aorticValGeo = new THREE.CylinderGeometry(0.7, 0.7, 0.2, 16);
                const aorticVal = new THREE.Mesh(aorticValGeo, valveMat);
                aorticVal.position.set(1.0, 2.2, 0);
                aorticVal.userData = { id: 'aortic_valve' };
                heartGroup.add(aorticVal);

                scene.add(heartGroup);

                // --- BLOOD FLOW PARTICLES ---
                const particleCount = 60; // Increased count
                const particles = [];
                const particleGeo = new THREE.SphereGeometry(0.15, 8, 8);

                // Helper to create flow path
                const createParticle = (type) => { // type: 'ox' or 'deox'
                    const mat = new THREE.MeshBasicMaterial({ color: type === 'ox' ? 0xff0000 : 0x0000ff });
                    const mesh = new THREE.Mesh(particleGeo, mat);
                    
                    // Define Path
                    let path;
                    if (type === 'deox') {
                        // VC -> RA -> Tricuspid -> RV -> Pulmonary Valve -> PA
                        path = [
                            new THREE.Vector3(-3.5, 4.5, 0), // VC In
                            new THREE.Vector3(-2, 2, 0), // RA
                            new THREE.Vector3(-1.8, 0.5, 0), // Tricuspid
                            new THREE.Vector3(-1.5, -2, 0), // RV
                            new THREE.Vector3(-1.0, 2.2, 0.5), // Pulmonary Valve
                            new THREE.Vector3(2, 5, 0) // PA Out
                        ];
                    } else {
                        // PV -> LA -> Mitral -> LV -> Aortic Valve -> Aorta
                        path = [
                            new THREE.Vector3(4, 4, 0), // PV In
                            new THREE.Vector3(2, 2, 0), // LA
                            new THREE.Vector3(1.8, 0.5, 0), // Mitral
                            new THREE.Vector3(1.5, -2, 0), // LV
                            new THREE.Vector3(1.0, 2.2, 0), // Aortic Valve
                            new THREE.Vector3(-1, 6, -1) // Aorta Out
                        ];
                    }
                    
                    // Smooth curve
                    const curve = new THREE.CatmullRomCurve3(path);
                    
                    scene.add(mesh);
                    return { mesh, curve, progress: Math.random(), speed: 0.003 + Math.random()*0.003 };
                };

                for(let i=0; i<particleCount; i++) {
                    particles.push(createParticle(i % 2 === 0 ? 'ox' : 'deox'));
                }


                // Interaction
                const raycaster = new THREE.Raycaster();
                const mouse = new THREE.Vector2();
                let hoveredObj = null;

                const onMouseMove = (event) => {
                    const rect = renderer.domElement.getBoundingClientRect();
                    mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
                    mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;

                    raycaster.setFromCamera(mouse, camera);
                    const intersects = raycaster.intersectObjects(heartGroup.children);

                    if (intersects.length > 0) {
                        const obj = intersects[0].object;
                        if (hoveredObj !== obj) {
                            if (hoveredObj) {
                                // Reset previous emissive
                                hoveredObj.material.emissive = hoveredObj.userData.originalEmissive || new THREE.Color(0x000000);
                            }
                            hoveredObj = obj;
                            // Store original emissive
                            if (!obj.userData.originalEmissive) obj.userData.originalEmissive = obj.material.emissive.clone();
                            
                            // Highlighting
                            if (obj.userData.id.includes('valve')) {
                                obj.material.emissive = new THREE.Color(0x444444);
                            } else {
                                obj.material.emissive = new THREE.Color(0x333333);
                            }
                            document.body.style.cursor = 'pointer';
                        }
                    } else {
                        if (hoveredObj) {
                            hoveredObj.material.emissive = hoveredObj.userData.originalEmissive || new THREE.Color(0x000000);
                            hoveredObj = null;
                        }
                        document.body.style.cursor = 'default';
                    }
                };

                const onClick = () => {
                    if (hoveredObj && hoveredObj.userData.id) {
                        onSelect(hoveredObj.userData.id);
                    }
                };

                renderer.domElement.addEventListener('mousemove', onMouseMove);
                renderer.domElement.addEventListener('click', onClick);

                // Animation Loop
                const animate = () => {
                    frameIdRef.current = requestAnimationFrame(animate);
                    controls.update();

                    // Heartbeat Animation (Scale)
                    const time = Date.now() * 0.003;
                    const beat = 1 + Math.sin(time * 3) * 0.02;
                    heartGroup.scale.set(beat, beat, beat);

                    // Particle Flow
                    if (showFlow) {
                        particles.forEach(p => {
                            p.progress += p.speed;
                            if (p.progress > 1) p.progress = 0;
                            const pos = p.curve.getPoint(p.progress);
                            p.mesh.position.copy(pos);
                            p.mesh.visible = true;
                        });
                    } else {
                        particles.forEach(p => p.mesh.visible = false);
                    }

                    renderer.render(scene, camera);
                };
                animate();

                // Resize Observer
                const resizeObserver = new ResizeObserver(() => {
                    if (container.clientWidth && container.clientHeight) {
                        const w = container.clientWidth;
                        const h = container.clientHeight;
                        camera.aspect = w / h;
                        camera.updateProjectionMatrix();
                        renderer.setSize(w, h);
                    }
                });
                resizeObserver.observe(container);

                return () => {
                    cancelAnimationFrame(frameIdRef.current);
                    resizeObserver.disconnect();
                    renderer.domElement.removeEventListener('mousemove', onMouseMove);
                    renderer.domElement.removeEventListener('click', onClick);
                    if (container && renderer.domElement) {
                        container.removeChild(renderer.domElement);
                    }
                    renderer.dispose();
                };
            }, [showFlow]); // Re-run when showFlow changes to update visibility logic if needed (or just use ref)

            return <div ref={mountRef} className="w-full h-full min-h-[300px]" />;
        };

        // --- MAIN APP ---
        const App = () => {
            const [selectedId, setSelectedId] = useState(null);
            const [showFlow, setShowFlow] = useState(true);
            const currentPart = selectedId ? PARTS[selectedId] : null;

            return (
                <div className="min-h-screen bg-[#0F172A] text-white flex flex-col md:flex-row overflow-hidden font-sans">
                    
                    {/* Sidebar */}
                    <div className="w-full md:w-80 bg-slate-900 border-r border-slate-800 flex flex-col z-10 shadow-xl h-screen shrink-0">
                        <div className="p-6 border-b border-slate-800">
                            <h1 className="text-xl font-bold flex items-center gap-2">
                                <Icon name="heart" className="text-red-500" /> Heart 3D
                            </h1>
                            <p className="text-xs text-slate-400 mt-1">Cardiac Anatomy & Circulation</p>
                        </div>

                        <div className="p-6 flex-1 overflow-y-auto">
                            
                            {/* Controls */}
                            <div className="mb-8 space-y-4">
                                <button 
                                    onClick={() => setShowFlow(!showFlow)}
                                    className={`w-full py-3 rounded-xl font-bold flex items-center justify-center gap-2 transition-all border shadow-lg
                                        ${showFlow ? 'bg-red-600 border-red-500 text-white pulse-btn' : 'bg-slate-800 border-slate-700 text-slate-400'}
                                    `}
                                >
                                    <Icon name="activity" size={18}/> {showFlow ? 'Hide Blood Flow' : 'Show Blood Flow'}
                                </button>
                            </div>

                            {/* Info Panel */}
                            {currentPart ? (
                                <div className="space-y-6 animate-in fade-in slide-in-from-left-4">
                                    <div>
                                        <div className="text-xs font-bold text-slate-500 uppercase mb-1">Selected Structure</div>
                                        <h2 className="text-3xl font-black text-white" style={{color: currentPart.color}}>{currentPart.name}</h2>
                                    </div>
                                    
                                    <div className="bg-slate-800 p-4 rounded-xl border border-slate-700">
                                        <p className="text-sm text-slate-300 leading-relaxed">
                                            {currentPart.desc}
                                        </p>
                                    </div>
                                </div>
                            ) : (
                                <div className="h-40 flex flex-col items-center justify-center text-center opacity-50 space-y-4">
                                    <div className="w-16 h-16 rounded-full bg-slate-800 flex items-center justify-center">
                                        <Icon name="mouse-pointer-click" size={24} className="text-blue-400"/>
                                    </div>
                                    <div>
                                        <p className="text-sm text-slate-400">
                                            Click on any part of the heart model<br/>to learn about its function.
                                        </p>
                                    </div>
                                </div>
                            )}

                            {/* Legend */}
                            <div className="mt-8 pt-6 border-t border-slate-800">
                                <div className="text-xs font-bold text-slate-500 uppercase mb-3">Circulation Key</div>
                                <div className="space-y-2 text-xs">
                                    <div className="flex items-center gap-2">
                                        <div className="w-3 h-3 rounded-full bg-red-600 shadow-[0_0_5px_red]"></div>
                                        <span className="text-red-200">Oxygenated Blood (To Body)</span>
                                    </div>
                                    <div className="flex items-center gap-2">
                                        <div className="w-3 h-3 rounded-full bg-blue-600 shadow-[0_0_5px_blue]"></div>
                                        <span className="text-blue-200">Deoxygenated Blood (To Lungs)</span>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>

                    {/* Main Stage */}
                    <div className="flex-1 relative bg-gradient-to-b from-[#0F172A] to-[#1e293b]">
                        <div className="absolute inset-0">
                            <HeartScene onSelect={setSelectedId} showFlow={showFlow} />
                        </div>
                        
                        {/* Overlay Controls Info */}
                        <div className="absolute bottom-8 left-1/2 -translate-x-1/2 bg-slate-900/80 backdrop-blur px-6 py-3 rounded-full border border-white/10 text-xs text-slate-300 pointer-events-none flex items-center gap-4 shadow-xl">
                            <span className="flex items-center gap-1"><Icon name="move" size={14}/> Rotate</span>
                            <span className="w-px h-3 bg-slate-600"></span>
                            <span className="flex items-center gap-1"><Icon name="zoom-in" size={14}/> Zoom</span>
                            <span className="w-px h-3 bg-slate-600"></span>
                            <span className="flex items-center gap-1"><Icon name="mouse-pointer" size={14}/> Select</span>
                        </div>
                    </div>

                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
