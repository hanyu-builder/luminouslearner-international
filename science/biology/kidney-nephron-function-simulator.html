<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kidney Nephron Function | LuminousLearner</title>
    
    <!-- React & Tailwind -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Framer Motion -->
    <script src="https://unpkg.com/framer-motion@10.12.16/dist/framer-motion.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        slate: {
                            850: '#1e293b', 
                            950: '#0F172A', // LuminousLearner Dark Mode Background
                        },
                        emerald: {
                            450: '#10b981',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0F172A; color: #e2e8f0; margin: 0; overflow: hidden; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background-color: #334155; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background-color: #475569; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;
        const { motion, AnimatePresence } = window.Motion;

        const Icon = ({ name, className = "", size = 20 }) => {
            const [svgHtml, setSvgHtml] = useState('');
            useEffect(() => {
                if (window.lucide && window.lucide.icons) {
                    const pascalName = name.split('-').map(part => part.charAt(0).toUpperCase() + part.slice(1)).join('');
                    const iconData = window.lucide.icons[pascalName];
                    if (iconData && typeof window.lucide.createElement === 'function') {
                        const svgElement = window.lucide.createElement(iconData);
                        svgElement.setAttribute('class', className);
                        svgElement.setAttribute('width', size);
                        svgElement.setAttribute('height', size);
                        setSvgHtml(svgElement.outerHTML);
                    }
                }
            }, [name, className, size]);
            if (!svgHtml) return <span className={className} style={{ width: size, height: size, display: 'inline-block' }}></span>;
            return <span dangerouslySetInnerHTML={{ __html: svgHtml }} className="flex items-center justify-center" />;
        };

        // --- DATA ---
        const PARTICLES = {
            water: { id: 'water', name: 'Water', color: '#60a5fa', size: 3 },
            glucose: { id: 'glucose', name: 'Glucose', color: '#facc15', size: 5 },
            urea: { id: 'urea', name: 'Urea', color: '#fb923c', size: 4 },
            salt: { id: 'salt', name: 'Salt', color: '#a78bfa', size: 3 },
            protein: { id: 'protein', name: 'Protein', color: '#ef4444', size: 8 }, 
            rbc: { id: 'rbc', name: 'Red Blood Cell', color: '#b91c1c', size: 10 } 
        };

        const PARTS = [
            { id: 'glomerulus', name: 'Glomerulus', desc: 'High pressure knot of capillaries. Ultrafiltration happens here.', func: 'Ultrafiltration' },
            { id: 'bowman', name: 'Bowman\'s Capsule', desc: 'Cup-shaped structure collecting the filtrate.', func: 'Collection' },
            { id: 'pct', name: 'Proximal Convoluted Tubule (PCT)', desc: 'Selective reabsorption of glucose, amino acids, salts and water.', func: 'Reabsorption (100% Glucose)' },
            { id: 'loop', name: 'Loop of Henle', desc: 'Creates salt gradient in medulla to aid water reabsorption.', func: 'Concentration' },
            { id: 'dct', name: 'Distal Convoluted Tubule (DCT)', desc: 'Fine-tuning of salt and pH balance.', func: 'Secretion & Reabsorption' },
            { id: 'collecting', name: 'Collecting Duct', desc: 'Final water reabsorption controlled by ADH. Urine flows to ureter.', func: 'Water Regulation (ADH)' }
        ];

        // --- MATH HELPERS FOR PATHS ---
        const getLinePoint = (t, p0, p1) => ({
            x: p0.x + (p1.x - p0.x) * t,
            y: p0.y + (p1.y - p0.y) * t
        });

        const getBezierPoint = (t, p0, p1, p2, p3) => {
            const cX = 3 * (p1.x - p0.x);
            const bX = 3 * (p2.x - p1.x) - cX;
            const aX = p3.x - p0.x - cX - bX;
            const cY = 3 * (p1.y - p0.y);
            const bY = 3 * (p2.y - p1.y) - cY;
            const aY = p3.y - p0.y - cY - bY;
            const x = (aX * Math.pow(t, 3)) + (bX * Math.pow(t, 2)) + (cX * t) + p0.x;
            const y = (aY * Math.pow(t, 3)) + (bY * Math.pow(t, 2)) + (cY * t) + p0.y;
            return { x, y };
        };

        // Define Paths as Segments
        // format: { type: 'line'/'bezier', p0, p1, (p2, p3), lengthRatio }
        const PATHS = {
            tubule: [
                { type: 'bezier', p0: {x:150, y:150}, p1: {x:185, y:250}, p2: {x:280, y:150}, p3: {x:300, y:200}, len: 1.2 }, // PCT
                { type: 'line', p0: {x:300, y:200}, p1: {x:300, y:450}, len: 1 }, // Loop Desc
                { type: 'bezier', p0: {x:300, y:450}, p1: {x:300, y:500}, p2: {x:350, y:500}, p3: {x:350, y:450}, len: 0.3 }, // Loop Turn
                { type: 'line', p0: {x:350, y:450}, p1: {x:350, y:200}, len: 1 }, // Loop Asc
                { type: 'bezier', p0: {x:350, y:200}, p1: {x:380, y:100}, p2: {x:450, y:150}, p3: {x:500, y:200}, len: 0.8 }, // DCT
                { type: 'line', p0: {x:500, y:200}, p1: {x:550, y:200}, len: 0.2 }, // To CD
                { type: 'line', p0: {x:550, y:200}, p1: {x:550, y:600}, len: 1.5 } // CD
            ],
            blood: [
                { type: 'line', p0: {x:0, y:120}, p1: {x:130, y:140}, len: 0.5 }, // Afferent
                { type: 'bezier', p0: {x:160, y:130}, p1: {x:300, y:80}, p2: {x:400, y:250}, p3: {x:500, y:250}, len: 1.5 }, // Capillary Net
                { type: 'line', p0: {x:500, y:250}, p1: {x:800, y:250}, len: 1 } // To Vein
            ]
        };

        // --- VISUAL COMPONENT ---
        const NephronCanvas = ({ pressure, adhLevel, glucoseLevel, isRunning, onPartClick }) => {
            const canvasRef = useRef(null);
            const particlesRef = useRef([]);
            
            useEffect(() => {
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                let animationId;
                const width = 800;
                const height = 600;

                // Particle Helper
                const createParticle = (type, pathName) => ({
                    id: Math.random(),
                    type,
                    pathName, // 'tubule' or 'blood'
                    segmentIdx: 0,
                    t: 0,
                    speed: 0.005 + (Math.random() * 0.002),
                    active: true
                });

                const spawnParticles = () => {
                    const count = Math.floor(pressure * 1); 
                    
                    for(let i=0; i<count; i++) {
                        const r = Math.random();
                        let type;
                        if (r < 0.4) type = 'water';
                        else if (r < 0.5) type = 'urea';
                        else if (r < 0.6) type = 'salt';
                        else if (r < 0.7) type = 'rbc';
                        else if (r < 0.8) type = 'protein';
                        else type = 'glucose';

                        // Initial Path Selection (Filtration)
                        let pathName = 'blood'; // Default stay in blood
                        let startSeg = 0;

                        // Logic: Big stays in blood. Small filters IF pressure is enough.
                        const isBig = type === 'rbc' || type === 'protein';
                        if (!isBig && pressure > 0.5) {
                            pathName = 'tubule'; // Filtered!
                        }

                        const p = createParticle(type, pathName);
                        // If blood path, start at seg 0. If tubule, logically starts after glom, but visuals align better if we handle glom separately?
                        // Simplified: All start at afferent visually (seg 0 of blood), then if filtered, jump to tubule seg 0 at glom.
                        // Let's handle the "Jump" in update.
                        p.pathName = 'blood'; // Everyone starts in afferent
                        particlesRef.current.push(p);
                    }
                };

                const updateParticles = () => {
                    for (let i = particlesRef.current.length - 1; i >= 0; i--) {
                        const p = particlesRef.current[i];
                        if (!p.active) continue;

                        const currentPath = PATHS[p.pathName];
                        const seg = currentPath[p.segmentIdx];

                        // Move
                        // Adjust speed by length of segment to keep constant velocity
                        const adjustedSpeed = p.speed / seg.len;
                        p.t += adjustedSpeed * (pressure); // Pressure speeds up flow

                        // Check Segment End
                        if (p.t >= 1) {
                            p.t = 0;
                            p.segmentIdx++;
                            
                            // Check Filtration Point (End of Afferent / Start of Efferent)
                            if (p.pathName === 'blood' && p.segmentIdx === 1) {
                                // We are at Glomerulus/Efferent junction
                                const isBig = p.type === 'rbc' || p.type === 'protein';
                                if (!isBig && pressure > 0.5) {
                                    // Switch to Tubule!
                                    p.pathName = 'tubule';
                                    p.segmentIdx = 0; // Start of PCT
                                }
                            }

                            // Check End of Path
                            if (p.segmentIdx >= PATHS[p.pathName].length) {
                                p.active = false;
                                particlesRef.current.splice(i, 1);
                                continue;
                            }
                        }

                        // Calculate Position
                        const curSeg = PATHS[p.pathName][p.segmentIdx];
                        const pos = curSeg.type === 'bezier' 
                            ? getBezierPoint(p.t, curSeg.p0, curSeg.p1, curSeg.p2, curSeg.p3)
                            : getLinePoint(p.t, curSeg.p0, curSeg.p1);
                        
                        p.x = pos.x;
                        p.y = pos.y;

                        // Jitter for "flow" look
                        p.x += (Math.random()-0.5)*6;
                        p.y += (Math.random()-0.5)*6;

                        // REABSORPTION LOGIC
                        if (p.pathName === 'tubule') {
                            let reabsorbed = false;

                            // PCT (Seg 0): Glucose, Water, Salt
                            if (p.segmentIdx === 0) {
                                if (p.type === 'glucose') {
                                    const threshold = 180;
                                    if (glucoseLevel <= threshold || Math.random() > 0.2) reabsorbed = true;
                                }
                                if ((p.type === 'water' || p.type === 'salt') && Math.random() < 0.03) reabsorbed = true;
                            }
                            // Loop Desc (Seg 1): Water
                            else if (p.segmentIdx === 1 && p.type === 'water' && Math.random() < 0.02) reabsorbed = true;
                            // Loop Asc (Seg 3): Salt
                            else if (p.segmentIdx === 3 && p.type === 'salt' && Math.random() < 0.03) reabsorbed = true;
                            // CD (Seg 6): Water (ADH)
                            else if (p.segmentIdx === 6 && p.type === 'water') {
                                const chance = adhLevel === 'high' ? 0.1 : adhLevel === 'low' ? 0.005 : 0.03;
                                if (Math.random() < chance) reabsorbed = true;
                            }

                            if (reabsorbed) {
                                // Animate move to blood stream visually? 
                                // Ideally find closest point on blood path. 
                                // Simplified: Just switch path to 'blood' at nearest segment (Seg 1 is capillary net)
                                p.pathName = 'blood';
                                p.segmentIdx = 1;
                                p.t = 0.2 + Math.random()*0.6; // Join somewhere in middle
                                // Give visual kick
                                p.y -= 10;
                            }
                        }
                    }
                };

                const drawPath = (pathData, width, color, dashed = false) => {
                    ctx.beginPath();
                    pathData.forEach((seg, i) => {
                        if (i === 0) ctx.moveTo(seg.p0.x, seg.p0.y);
                        if (seg.type === 'line') ctx.lineTo(seg.p1.x, seg.p1.y);
                        else ctx.bezierCurveTo(seg.p1.x, seg.p1.y, seg.p2.x, seg.p2.y, seg.p3.x, seg.p3.y);
                    });
                    ctx.lineWidth = width;
                    ctx.strokeStyle = color;
                    ctx.lineCap = 'round';
                    ctx.lineJoin = 'round';
                    if (dashed) ctx.setLineDash([5, 10]); else ctx.setLineDash([]);
                    ctx.stroke();
                    ctx.setLineDash([]);
                };

                const render = () => {
                    ctx.clearRect(0, 0, width, height);

                    // --- DRAW STRUCTURES ---
                    
                    // 1. Tubule (Background)
                    drawPath(PATHS.tubule, 30, '#fefce8'); // Inner
                    drawPath(PATHS.tubule, 34, '#fcd34d'); // Border (draw first/under or stroke over) - actually standard stroke centers.
                    // Redraw inner to clear border
                    drawPath(PATHS.tubule, 26, '#fefce8');

                    // Bowman's Cup Visual
                    ctx.beginPath(); ctx.arc(150, 150, 35, 0.8, 2*Math.PI - 0.8, true); 
                    ctx.lineWidth = 4; ctx.strokeStyle = '#fcd34d'; ctx.stroke();

                    // 2. Blood Vessels (Peritubular Capillaries)
                    // Draw behind or overlay with transparency
                    // We want to see particles inside, so overlay with low opacity
                    drawPath(PATHS.blood, 40, 'rgba(239, 68, 68, 0.15)'); // Vein track

                    // Labels & Arrows
                    ctx.fillStyle = '#94a3b8'; ctx.font = 'bold 12px Inter';
                    ctx.fillText('Afferent Arteriole', 10, 110);
                    
                    // Glomerulus
                    ctx.fillStyle = 'rgba(220, 38, 38, 0.4)';
                    ctx.beginPath(); ctx.arc(150, 150, 25, 0, Math.PI*2); ctx.fill();
                    ctx.fillStyle = '#ef4444'; ctx.fillText('Glomerulus', 120, 110);

                    // Capillary Label (New Request)
                    ctx.fillStyle = '#f87171'; 
                    ctx.fillText('Peritubular Capillaries (Reabsorption)', 350, 280);
                    
                    // Renal Vein Label (New Request)
                    ctx.fillStyle = '#3b82f6';
                    ctx.fillText('To Renal Vein âž¤', 650, 240);
                    ctx.beginPath(); ctx.moveTo(650, 250); ctx.lineTo(750, 250); 
                    ctx.strokeStyle = '#3b82f6'; ctx.lineWidth = 2; ctx.stroke();

                    // --- PARTICLES ---
                    particlesRef.current.forEach(p => {
                        const info = PARTICLES[p.type];
                        ctx.fillStyle = info.color;
                        ctx.beginPath();
                        ctx.arc(p.x, p.y, info.size, 0, Math.PI*2);
                        ctx.fill();
                    });

                    if (isRunning) {
                        spawnParticles();
                        updateParticles();
                    }

                    animationId = requestAnimationFrame(render);
                };
                render();
                return () => cancelAnimationFrame(animationId);
            }, [pressure, adhLevel, glucoseLevel, isRunning]);

            return <canvas ref={canvasRef} width={800} height={600} className="w-full h-full object-contain bg-slate-900 rounded-xl border border-slate-700" />;
        };

        // --- MAIN APP ---
        const App = () => {
            const [pressure, setPressure] = useState(1.0);
            const [adh, setADH] = useState('normal');
            const [glucose, setGlucose] = useState(90);
            const [isRunning, setIsRunning] = useState(true);
            const [selectedPart, setSelectedPart] = useState(null);

            const urineStatus = useMemo(() => {
                let vol = adh === 'high' ? 'Low (Concentrated)' : adh === 'low' ? 'High (Dilute)' : 'Normal';
                let sugar = glucose > 180 ? 'Detected (Glycosuria)' : 'None';
                let color = adh === 'high' ? 'Dark Yellow' : adh === 'low' ? 'Pale Yellow' : 'Yellow';
                return { vol, sugar, color };
            }, [adh, glucose]);

            return (
                <div className="min-h-screen bg-[#0F172A] text-white flex flex-col md:flex-row overflow-hidden">
                    {/* Sidebar */}
                    <div className="w-full md:w-96 bg-slate-900 border-r border-slate-800 flex flex-col z-10 shadow-xl h-screen shrink-0">
                        <div className="p-6 border-b border-slate-800">
                            <h1 className="text-xl font-bold flex items-center gap-2">
                                <Icon name="activity" className="text-yellow-400" /> Nephron Sim
                            </h1>
                            <p className="text-xs text-slate-400 mt-1">Kidney Function & Urine Formation</p>
                        </div>

                        <div className="p-6 space-y-8 flex-1 overflow-y-auto custom-scrollbar">
                            {/* Physiology Controls */}
                            <div className="space-y-6">
                                <div>
                                    <div className="flex justify-between text-xs mb-2">
                                        <span className="font-bold text-slate-400">Blood Pressure</span>
                                        <span className="font-mono text-red-400">{(pressure*100).toFixed(0)}%</span>
                                    </div>
                                    <input 
                                        type="range" min="0.5" max="1.5" step="0.1"
                                        value={pressure} 
                                        onChange={(e) => setPressure(parseFloat(e.target.value))}
                                        className="w-full accent-red-500"
                                    />
                                </div>

                                <div>
                                    <div className="flex justify-between text-xs mb-2">
                                        <span className="font-bold text-slate-400">Blood Glucose</span>
                                        <span className={`font-mono ${glucose > 180 ? 'text-red-400 animate-pulse' : 'text-blue-400'}`}>{glucose} mg/dL</span>
                                    </div>
                                    <input 
                                        type="range" min="70" max="300" step="10"
                                        value={glucose} 
                                        onChange={(e) => setGlucose(parseInt(e.target.value))}
                                        className="w-full accent-blue-500"
                                    />
                                </div>

                                <div>
                                    <div className="flex justify-between text-xs mb-2">
                                        <span className="font-bold text-slate-400">ADH Level (Hydration)</span>
                                        <span className="font-mono text-yellow-400 uppercase">{adh}</span>
                                    </div>
                                    <div className="flex bg-slate-800 p-1 rounded-lg border border-slate-700">
                                        {['low', 'normal', 'high'].map(level => (
                                            <button 
                                                key={level}
                                                onClick={() => setADH(level)}
                                                className={`flex-1 py-1 text-[10px] font-bold rounded uppercase transition-all ${adh === level ? 'bg-yellow-600 text-white shadow' : 'text-slate-500 hover:text-white'}`}
                                            >
                                                {level}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            </div>

                            {/* Urine Report */}
                            <div className="bg-slate-800 p-4 rounded-xl border border-slate-700 shadow-lg">
                                <div className="text-xs font-bold text-slate-500 uppercase mb-3 flex items-center gap-2">
                                    <Icon name="flask-conical" size={14}/> Urinalysis Result
                                </div>
                                <div className="space-y-2 text-xs text-slate-300">
                                    <div className="flex justify-between border-b border-slate-700 pb-1">
                                        <span>Volume:</span>
                                        <span className="font-bold text-white">{urineStatus.vol}</span>
                                    </div>
                                    <div className="flex justify-between border-b border-slate-700 pb-1">
                                        <span>Color:</span>
                                        <span className="font-bold" style={{color: urineStatus.color === 'Dark Yellow' ? '#fbbf24' : '#fef08a'}}>{urineStatus.color}</span>
                                    </div>
                                    <div className="flex justify-between">
                                        <span>Glucose:</span>
                                        <span className={`font-bold ${urineStatus.sugar !== 'None' ? 'text-red-400' : 'text-emerald-400'}`}>{urineStatus.sugar}</span>
                                    </div>
                                </div>
                            </div>

                            {/* Structure Navigation */}
                            <div className="space-y-2">
                                <label className="text-xs font-bold text-slate-500 uppercase px-1">Anatomy Guide</label>
                                {PARTS.map(part => (
                                    <button 
                                        key={part.id}
                                        onClick={() => setSelectedPart(part)}
                                        className={`w-full text-left p-2 rounded border transition-all text-xs
                                            ${selectedPart?.id === part.id ? 'bg-slate-700 border-blue-500 text-white' : 'bg-slate-800/50 border-slate-700 text-slate-400 hover:bg-slate-800'}
                                        `}
                                    >
                                        {part.name.split(' (')[0]}
                                    </button>
                                ))}
                            </div>
                            
                            <AnimatePresence>
                                {selectedPart && (
                                    <motion.div 
                                        initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0, y: 10 }}
                                        className="bg-blue-900/20 p-3 rounded-xl border border-blue-500/30 text-xs"
                                    >
                                        <div className="font-bold text-blue-400 mb-1">{selectedPart.func}</div>
                                        <p className="text-slate-300">{selectedPart.desc}</p>
                                    </motion.div>
                                )}
                            </AnimatePresence>
                        </div>
                    </div>

                    {/* Main Stage */}
                    <div className="flex-1 bg-[#020617] relative flex flex-col p-6 overflow-hidden gap-6">
                        
                        <div className="flex-1 bg-slate-900 rounded-3xl border border-slate-800 shadow-xl relative overflow-hidden flex flex-col items-center justify-center p-4">
                            <NephronCanvas 
                                pressure={pressure} 
                                adhLevel={adh} 
                                glucoseLevel={glucose} 
                                isRunning={isRunning}
                                onPartClick={setSelectedPart}
                            />

                            {/* Particle Legend */}
                            <div className="absolute top-4 right-4 bg-black/60 backdrop-blur px-3 py-2 rounded-lg border border-white/10 text-[10px] text-slate-300 space-y-1 pointer-events-none">
                                {Object.values(PARTICLES).map(p => (
                                    <div key={p.id} className="flex items-center gap-2">
                                        <div className="w-2 h-2 rounded-full" style={{backgroundColor: p.color}}></div>
                                        <span>{p.name.split(' (')[0]}</span>
                                    </div>
                                ))}
                            </div>

                            <button 
                                onClick={() => setIsRunning(!isRunning)}
                                className="absolute bottom-6 right-6 p-3 rounded-full bg-slate-800 hover:bg-slate-700 text-white border border-slate-600 shadow-lg transition-all"
                            >
                                <Icon name={isRunning ? "pause" : "play"} size={20} fill="currentColor"/>
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
