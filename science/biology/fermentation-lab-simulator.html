<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fermentation Lab | LuminousLearner</title>
    
    <!-- React & Tailwind -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Recharts -->
    <script src="https://unpkg.com/prop-types/prop-types.min.js"></script>
    <script src="https://unpkg.com/recharts@2.12.7/umd/Recharts.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Framer Motion -->
    <script src="https://unpkg.com/framer-motion@10.12.16/dist/framer-motion.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        slate: {
                            850: '#1e293b', 
                            950: '#0F172A', // LuminousLearner Dark Mode Background
                        },
                        emerald: {
                            450: '#10b981',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0F172A; color: #e2e8f0; margin: 0; overflow: hidden; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        
        /* Custom Slider */
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%; 
            background: #fbbf24; cursor: pointer; margin-top: -8px; 
            box-shadow: 0 0 10px rgba(251, 191, 36, 0.5); border: 2px solid white;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; cursor: pointer; background: #334155; border-radius: 2px;
        }

        /* Bubbles */
        .bubble-rise {
            animation: rise var(--speed) linear infinite;
        }
        @keyframes rise {
            0% { transform: translateY(0) scale(0.5); opacity: 0; }
            20% { opacity: 0.8; }
            100% { transform: translateY(-100px) scale(1.2); opacity: 0; }
        }
        
        /* Yeast Wiggle */
        .yeast-wiggle { animation: wiggle 2s ease-in-out infinite; }
        @keyframes wiggle {
            0%, 100% { transform: rotate(0deg); }
            50% { transform: rotate(5deg); }
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background-color: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background-color: #475569; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;
        const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Area, AreaChart } = window.Recharts;
        const { motion, AnimatePresence } = window.Motion;

        const Icon = ({ name, className = "", size = 20 }) => {
            const [svgHtml, setSvgHtml] = useState('');
            useEffect(() => {
                if (window.lucide && window.lucide.icons) {
                    const pascalName = name.split('-').map(part => part.charAt(0).toUpperCase() + part.slice(1)).join('');
                    const iconData = window.lucide.icons[pascalName];
                    if (iconData && typeof window.lucide.createElement === 'function') {
                        const svgElement = window.lucide.createElement(iconData);
                        svgElement.setAttribute('class', className);
                        svgElement.setAttribute('width', size);
                        svgElement.setAttribute('height', size);
                        setSvgHtml(svgElement.outerHTML);
                    }
                }
            }, [name, className, size]);
            if (!svgHtml) return <span className={className} style={{ width: size, height: size, display: 'inline-block' }}></span>;
            return <span dangerouslySetInnerHTML={{ __html: svgHtml }} className="flex items-center justify-center" />;
        };

        // --- LOGIC & COMPONENTS ---

        // Bread View
        const BreadScene = ({ progress, activity }) => {
            // FIX 1: Cap the scale to prevent infinite growth causing layout issues
            // Base scale 0.8 (raw dough), max 2.2 (fully proofed)
            const scale = Math.min(2.2, 0.8 + (progress / 200) * 1.4);
            
            // Safety for animation duration
            const safeActivity = Math.max(0.1, activity);

            return (
                <div className="relative w-full h-full flex items-center justify-center bg-slate-800/50 rounded-xl border-2 border-slate-700 overflow-hidden">
                    <div className="absolute top-4 left-4 text-xs font-bold text-slate-500 uppercase">Oven / Proofing Chamber</div>
                    
                    {/* Bowl Container */}
                    <div className="relative mt-20">
                        <svg width="300" height="250" viewBox="0 -50 300 250" className="overflow-visible">
                            <defs>
                                {/* FIX 3: Improved ClipPath - Allows upward growth but constrains sides/bottom */}
                                <clipPath id="bowlClip">
                                    {/* Matches bowl shape at bottom, extends infinitely up */}
                                    <path d="M 20 50 C 20 150 280 150 280 50 L 280 -300 L 20 -300 Z" />
                                </clipPath>
                            </defs>

                            {/* Bowl Back */}
                            <path d="M 20 50 C 20 150 280 150 280 50" fill="#475569" stroke="#94a3b8" strokeWidth="4" />
                            
                            {/* Dough Group with Anchored Scaling */}
                            <g clipPath="url(#bowlClip)">
                                {/* FIX 2: Anchoring Logic
                                    1. Translate container to bowl bottom center (150, 150)
                                    2. Apply Scale
                                    3. Translate dough geometry so its bottom-center is at (0,0)
                                    Dough Path Bounding Box: roughly y=50 (top) to y=100 (bottom). Center X=150.
                                    So to move bottom-center (150, 100) to (0,0), we translate (-150, -100).
                                */}
                                <g transform="translate(150, 150)">
                                    <g transform={`scale(${scale})`}>
                                        <g transform="translate(-150, -100)">
                                            <motion.path 
                                                d="M 50 50 Q 150 -50 250 50 Q 250 100 150 100 Q 50 100 50 50" 
                                                fill="#fcd34d" stroke="#d97706" strokeWidth="2"
                                                animate={{ 
                                                    d: activity > 0 
                                                        ? "M 45 50 Q 150 -55 255 50 Q 255 105 150 105 Q 45 105 45 50" 
                                                        : "M 50 50 Q 150 -50 250 50 Q 250 100 150 100 Q 50 100 50 50" 
                                                }}
                                                transition={{ repeat: Infinity, duration: 2 / safeActivity, repeatType: "reverse" }}
                                            />
                                            {/* Pores/Texture */}
                                            <circle cx="100" cy="40" r={3} fill="#b45309" opacity="0.2"/>
                                            <circle cx="150" cy="20" r={4} fill="#b45309" opacity="0.2"/>
                                            <circle cx="200" cy="50" r={2} fill="#b45309" opacity="0.2"/>
                                        </g>
                                    </g>
                                </g>
                            </g>

                            {/* Bowl Front (Glass effect) */}
                            <path d="M 20 50 C 20 150 280 150 280 50" fill="none" stroke="#94a3b8" strokeWidth="4" strokeDasharray="10, 5" opacity="0.3" />
                        </svg>
                    </div>

                    {/* Rising CO2 Bubbles (Atmosphere) */}
                    {activity > 0.1 && (
                        <div className="absolute inset-0 pointer-events-none">
                            {[...Array(5)].map((_, i) => (
                                <div key={i} className="absolute w-2 h-2 bg-white/20 rounded-full bubble-rise"
                                     style={{
                                         left: `${40 + Math.random()*20}%`,
                                         top: '60%',
                                         '--speed': `${3 / safeActivity}s`,
                                         animationDelay: `${Math.random()}s`
                                     }}
                                />
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        // Wine View
        const WineScene = ({ progress, activity, alcohol }) => {
            const safeActivity = Math.max(0.1, activity);
            return (
                <div className="relative w-full h-full flex items-center justify-center bg-slate-800/50 rounded-xl border-2 border-slate-700 overflow-hidden">
                    <div className="absolute top-4 left-4 text-xs font-bold text-slate-500 uppercase">Fermentation Flask</div>

                    <div className="relative mt-10">
                        <svg width="200" height="300" viewBox="0 0 200 300">
                            {/* Flask Body */}
                            <path d="M 60 0 L 60 80 L 20 280 Q 100 320 180 280 L 140 80 L 140 0" fill="none" stroke="#cbd5e1" strokeWidth="4" />
                            
                            {/* Liquid */}
                            <path d="M 25 270 Q 100 300 175 270 L 145 120 Q 100 130 55 120 Z" fill="#7e22ce" opacity="0.8" />
                            
                            {/* Bubbles */}
                            {activity > 0.1 && (
                                <g>
                                    <circle cx="100" cy="200" r="3" fill="white" opacity="0.5">
                                        <animate attributeName="cy" from="250" to="120" dur={`${2/safeActivity}s`} repeatCount="indefinite" />
                                    </circle>
                                    <circle cx="80" cy="220" r="2" fill="white" opacity="0.5">
                                        <animate attributeName="cy" from="250" to="120" dur={`${3/safeActivity}s`} repeatCount="indefinite" />
                                    </circle>
                                    <circle cx="120" cy="180" r="4" fill="white" opacity="0.5">
                                        <animate attributeName="cy" from="250" to="120" dur={`${1.5/safeActivity}s`} repeatCount="indefinite" />
                                    </circle>
                                </g>
                            )}

                            {/* Airlock */}
                            <path d="M 60 0 H 140 V -20 H 120 V -40 H 80 V -20 H 60 Z" fill="#cbd5e1" />
                            <circle cx="100" cy="-50" r="15" fill="none" stroke="#cbd5e1" strokeWidth="2" />
                            {/* Airlock Bubble */}
                            {activity > 0.1 && (
                                <circle cx="100" cy="-50" r="5" fill="white" opacity="0.8">
                                    <animate attributeName="r" values="5;8;5" dur={`${1/safeActivity}s`} repeatCount="indefinite" />
                                </circle>
                            )}
                        </svg>
                    </div>
                    
                    <div className="absolute bottom-4 right-4 text-right">
                        <div className="text-xs text-slate-400">Alcohol</div>
                        <div className="text-xl font-mono font-bold text-purple-400">{alcohol.toFixed(1)}%</div>
                    </div>
                </div>
            );
        };

        // Micro View
        const MicroView = ({ activity, population }) => {
            const count = Math.min(20, Math.ceil(population / 10));
            const safeActivity = Math.max(0.1, activity);
            
            return (
                <div className="h-full w-full bg-black/40 rounded-xl p-4 relative overflow-hidden">
                    <div className="absolute top-2 left-2 text-[10px] font-bold text-slate-500 uppercase flex items-center gap-2">
                        <Icon name="microscope" size={12}/> Yeast Cells (x400)
                    </div>
                    
                    <div className="absolute inset-0 flex items-center justify-center">
                        <div className="grid grid-cols-5 gap-4">
                            {[...Array(count)].map((_, i) => (
                                <div key={i} className="relative yeast-wiggle" style={{animationDuration: `${2/(safeActivity)}s`}}>
                                    <div className="w-6 h-8 bg-yellow-200 rounded-[50%] border border-yellow-600"></div>
                                    {activity > 0.2 && (
                                        <motion.div 
                                            className="absolute -top-2 -right-1 w-3 h-4 bg-yellow-200 rounded-[50%] border border-yellow-600"
                                            animate={{ scale: [0.5, 1] }}
                                            transition={{ duration: 2/(safeActivity), repeat: Infinity }}
                                        />
                                    )}
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---
        const App = () => {
            const [mode, setMode] = useState('bread'); // bread, wine
            const [temp, setTemp] = useState(25); // Celsius
            const [sugar, setSugar] = useState(10); // % concentration
            const [isRunning, setIsRunning] = useState(false);
            
            // Simulation State
            const [time, setTime] = useState(0);
            const [co2, setCo2] = useState(0); // Cumulative Volume
            const [alcohol, setAlcohol] = useState(0); // %
            const [population, setPopulation] = useState(10); // Yeast count
            const [history, setHistory] = useState([]);

            // Refs
            const intervalRef = useRef(null);

            // Calculate Rate based on Temp & Sugar
            const calculateActivity = (t, s, alc) => {
                // Temp Factor: Optimal ~35, drops off >45 and <10
                const tempFactor = Math.max(0, 1 - Math.pow((t - 35) / 20, 2));
                // Sugar Factor
                const sugarFactor = Math.min(1, s / 5);
                // Alcohol Inhibition
                const alcFactor = Math.max(0, 1 - (alc / 15));

                return tempFactor * sugarFactor * alcFactor;
            };

            const reset = () => {
                setIsRunning(false);
                setTime(0);
                setCo2(0);
                setAlcohol(0);
                setPopulation(10);
                setHistory([]);
            };

            useEffect(() => {
                if (isRunning) {
                    intervalRef.current = setInterval(() => {
                        const activity = calculateActivity(temp, sugar, alcohol);
                        
                        if (activity <= 0) {
                            setIsRunning(false);
                            return;
                        }

                        const growth = activity * 0.5;
                        const metabolism = activity * population * 0.01;
                        
                        setPopulation(p => Math.min(200, p + growth));
                        setCo2(c => c + metabolism * 2);
                        setAlcohol(a => mode === 'wine' ? Math.min(20, a + metabolism * 0.05) : 0);
                        setSugar(s => Math.max(0, s - metabolism * 0.1));
                        setTime(t => t + 1);
                        
                        setHistory(prev => {
                            const newData = [...prev, { 
                                time: time, 
                                co2: co2, 
                                alcohol: alcohol,
                                rate: activity * 100 
                            }];
                            if (newData.length > 60) newData.shift();
                            return newData;
                        });

                    }, 200);
                }
                return () => clearInterval(intervalRef.current);
            }, [isRunning, temp, sugar, alcohol, population, mode]);

            const currentActivity = calculateActivity(temp, sugar, alcohol);

            return (
                <div className="min-h-screen bg-[#0F172A] text-white flex flex-col md:flex-row overflow-hidden font-sans">
                    
                    {/* Sidebar */}
                    <div className="w-full md:w-80 bg-slate-900 border-r border-slate-800 flex flex-col z-10 shadow-xl h-screen shrink-0">
                        <div className="p-6 border-b border-slate-800">
                            <h1 className="text-xl font-bold flex items-center gap-2">
                                <Icon name="flask-conical" className="text-yellow-400" /> Fermentation
                            </h1>
                            <p className="text-xs text-slate-400 mt-1">Anaerobic Respiration Lab</p>
                        </div>

                        <div className="p-6 space-y-8 flex-1 overflow-y-auto custom-scrollbar">
                            <div className="flex bg-slate-800 p-1 rounded-xl">
                                <button onClick={() => { setMode('bread'); reset(); }} className={`flex-1 py-2 rounded-lg text-xs font-bold transition-all ${mode === 'bread' ? 'bg-yellow-600 text-white shadow' : 'text-slate-400 hover:text-white'}`}>
                                    Bread Baking
                                </button>
                                <button onClick={() => { setMode('wine'); reset(); }} className={`flex-1 py-2 rounded-lg text-xs font-bold transition-all ${mode === 'wine' ? 'bg-purple-600 text-white shadow' : 'text-slate-400 hover:text-white'}`}>
                                    Wine Brewing
                                </button>
                            </div>

                            <div className="space-y-6">
                                <div>
                                    <div className="flex justify-between text-xs mb-2">
                                        <span className="font-bold text-slate-400">Temperature</span>
                                        <span className={`font-mono ${temp > 45 ? 'text-red-500' : temp > 30 ? 'text-emerald-400' : 'text-blue-400'}`}>{temp}°C</span>
                                    </div>
                                    <input 
                                        type="range" min="0" max="60" step="1"
                                        value={temp} 
                                        onChange={(e) => setTemp(parseInt(e.target.value))}
                                        className="w-full accent-yellow-500"
                                    />
                                    <div className="flex justify-between text-[10px] text-slate-500 mt-1">
                                        <span>0°C (Dormant)</span>
                                        <span>60°C (Dead)</span>
                                    </div>
                                </div>

                                <div>
                                    <div className="flex justify-between text-xs mb-2">
                                        <span className="font-bold text-slate-400">Sugar (Substrate)</span>
                                        <span className="font-mono text-white">{sugar.toFixed(1)}%</span>
                                    </div>
                                    <input 
                                        type="range" min="0" max="20" step="0.5"
                                        value={sugar} 
                                        onChange={(e) => setSugar(parseFloat(e.target.value))}
                                        className="w-full accent-yellow-500"
                                    />
                                </div>
                            </div>

                            <div className="h-40 rounded-2xl overflow-hidden border border-slate-700 shadow-lg">
                                <MicroView activity={currentActivity} population={population} />
                            </div>

                            <div className="bg-slate-800 p-4 rounded-xl border border-slate-700">
                                <div className="text-xs font-bold text-slate-500 uppercase mb-2">Reaction Equation</div>
                                <div className="text-xs font-mono text-center text-slate-300">
                                    Glucose &rarr; Ethanol + CO₂ + Energy
                                </div>
                            </div>

                            <div className="flex gap-3 pt-4 border-t border-slate-800">
                                <button 
                                    onClick={() => setIsRunning(!isRunning)}
                                    className={`flex-1 py-3 rounded-xl font-bold flex items-center justify-center gap-2 transition-all shadow-lg
                                        ${isRunning ? 'bg-slate-700 text-slate-300' : 'bg-emerald-600 text-white hover:bg-emerald-500'}
                                    `}
                                >
                                    <Icon name={isRunning ? "pause" : "play"} size={18} fill="currentColor"/>
                                    {isRunning ? 'Pause' : 'Start'}
                                </button>
                                <button onClick={reset} className="p-3 bg-slate-800 hover:bg-slate-700 rounded-xl text-slate-300 border border-slate-600">
                                    <Icon name="rotate-ccw" size={18}/>
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* Main Stage */}
                    <div className="flex-1 bg-[#020617] relative flex flex-col p-6 overflow-hidden gap-6">
                        
                        {/* Visualization */}
                        <div className="flex-[2] bg-slate-900 rounded-3xl border border-slate-800 shadow-xl relative overflow-hidden flex flex-col items-center justify-center p-8">
                            {mode === 'bread' ? (
                                <BreadScene progress={co2} activity={currentActivity} />
                            ) : (
                                <WineScene progress={co2} activity={currentActivity} alcohol={alcohol} />
                            )}
                            
                            {/* Activity Gauge - FIX 2: Adjusted positioning */}
                            <div className="absolute top-8 right-8 flex flex-col items-end">
                                <div className="text-xs font-bold text-slate-500 uppercase mb-1">Reaction Rate</div>
                                <div className="text-2xl font-mono font-black text-yellow-400">
                                    {(currentActivity * 100).toFixed(0)}%
                                </div>
                                {temp > 45 && <div className="text-[10px] text-red-500 font-bold animate-pulse">Enzymes Denatured!</div>}
                                {temp < 10 && <div className="text-[10px] text-blue-400 font-bold">Yeast Dormant</div>}
                            </div>
                        </div>

                        {/* Graph */}
                        <div className="flex-1 bg-slate-900 rounded-2xl border border-slate-800 p-4 flex flex-col relative">
                             <div className="text-xs font-bold text-slate-500 uppercase mb-2 flex items-center gap-2">
                                <Icon name="line-chart" size={14}/> Production Rates
                            </div>
                            <div className="flex-1 min-h-0">
                                <ResponsiveContainer width="100%" height="100%">
                                    <AreaChart data={history}>
                                        <defs>
                                            <linearGradient id="colorCo2" x1="0" y1="0" x2="0" y2="1">
                                                <stop offset="5%" stopColor="#fbbf24" stopOpacity={0.3}/>
                                                <stop offset="95%" stopColor="#fbbf24" stopOpacity={0}/>
                                            </linearGradient>
                                        </defs>
                                        <CartesianGrid strokeDasharray="3 3" stroke="#334155" />
                                        <XAxis dataKey="time" hide />
                                        <YAxis hide />
                                        <Tooltip 
                                            contentStyle={{ backgroundColor: '#1e293b', borderColor: '#475569', fontSize: '12px' }}
                                            itemStyle={{ padding: 0 }}
                                        />
                                        <Area type="monotone" dataKey="co2" name="CO₂ Produced" stroke="#fbbf24" fill="url(#colorCo2)" strokeWidth={2} />
                                        {mode === 'wine' && <Area type="monotone" dataKey="alcohol" name="Alcohol %" stroke="#a855f7" fill="none" strokeWidth={2} />}
                                    </AreaChart>
                                </ResponsiveContainer>
                            </div>
                        </div>

                    </div>

                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
